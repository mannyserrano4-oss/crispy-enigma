<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Comedy Timer</title>
    <meta name="apple-mobile-web-app-title" content="Comedy Timer">
    <meta name="application-name" content="Comedy Timer">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="apple-touch-icon" href="cicon.png">
    <link rel="icon" type="image/png" href="cicon.png">

    <style>
        :root {
            --bg-black: #000000;
            --bg-yellow: #fdd835;
            --bg-red: #d32f2f;
            --text-color: #ffffff;
            --card-bg: #1a1a1a;
            --accent: #2196f3;
            --tab-inactive: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-black);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            transition: background-color 0.5s ease;
        }

        /* --- TABS --- */
        .tab-bar {
            display: flex;
            background: #111;
            padding: 5px;
            gap: 5px;
            z-index: 50; /* Ensure tabs stay above content */
        }

        .tab-btn {
            flex: 1;
            background: var(--tab-inactive);
            color: #888;
            border: none;
            padding: 15px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
        }

        .tab-btn.active {
            background: var(--bg-black);
            color: white;
            border-bottom: 2px solid var(--accent);
        }

        /* --- SCREENS --- */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 50px; /* Space for tab bar */
            left: 0;
            background-color: var(--bg-black); /* Default black for menu screens */
            box-sizing: border-box;
            height: calc(100% - 50px);
        }

        .screen.active { display: flex; }

        /* --- QUICK MODE SCREEN --- */
        #screen-quick {
            padding: 40px;
            align-items: center;
            justify-content: center;
        }

        .quick-group {
            width: 100%;
            max-width: 300px;
            margin-bottom: 30px;
        }

        .quick-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 10px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .quick-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .quick-input {
            flex-grow: 1;
            background: #222;
            border: 1px solid #444;
            color: white;
            font-size: 2rem;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            -webkit-appearance: none;
        }

        /* --- BUILDER SCREEN --- */
        #screen-builder {
            padding: 20px;
        }

        /* Bit List */
        #bit-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-bottom: 20px;
            position: relative;
        }

        .bit-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #333;
            touch-action: pan-y; 
        }

        .bit-card.dragging-active {
            opacity: 0.5;
            background: #333;
            border: 1px dashed #666;
        }

        .bit-info { display: flex; flex-direction: column; gap: 2px; flex-grow: 1; }
        .bit-name { font-weight: bold; font-size: 1.1rem; }
        .bit-time { font-size: 0.9rem; color: #888; }

        .bit-controls { display: flex; align-items: center; gap: 15px; }

        .del-btn {
            background: #422;
            color: #f88;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drag-handle {
            font-size: 1.8rem;
            color: #666;
            padding: 10px;
            cursor: grab;
            touch-action: none;
        }
        .drag-handle:active { color: white; }

        /* Add Bar */
        .add-bar {
            display: flex;
            gap: 10px;
            background: #111;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        input {
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 1rem;
        }
        #new-name { flex-grow: 1; }
        #new-time { width: 50px; text-align: center; }

        .add-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            width: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }

        /* Footer */
        .footer-bar {
            border-top: 1px solid #333;
            padding-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-display { font-size: 0.9rem; color: #aaa; }
        .total-display span { font-size: 1.4rem; color: white; font-weight: bold; display: block; }

        .start-btn {
            background-color: white;
            color: black;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
        }
        .footer-bar .start-btn { width: auto; } 

        /* --- TIMER SCREEN --- */
        #screen-timer {
            top: 0; height: 100%;
            align-items: center;
            justify-content: center;
            z-index: 100;
            
            /* THE FIX: Make transparent so Body color shows through */
            background-color: transparent; 
        }

        #timer-display {
            font-size: 25vw;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            z-index: 2;
            transition: opacity 0.3s;
        }
        @media (min-width: 600px) { #timer-display { font-size: 8rem; } }

        .timer-controls {
            position: absolute;
            bottom: 40px;
            display: flex;
            gap: 30px;
            z-index: 10;
        }

        .icon-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        /* --- CHEAT SHEET --- */
        #cheat-sheet {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 120;
            flex-direction: column;
            padding: 40px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        #cheat-sheet.visible { display: flex; }

        .cs-item {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: white;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .cs-item span { display: block; font-size: 0.9rem; color: #888; margin-top: 5px;}
        .close-cs {
            margin-top: auto;
            background: #333;
            color: white;
            border: none;
            padding: 20px;
            font-size: 1.2rem;
            border-radius: 8px;
        }

        /* --- COLORS --- */
        body.yellow { background-color: var(--bg-yellow); color: black; }
        body.yellow .icon-btn { color: black; border-color: rgba(0,0,0,0.3); background: rgba(0,0,0,0.1); }
        body.red { background-color: var(--bg-red); color: white; }
        body.flash { animation: flash-red 0.5s infinite; }
        @keyframes flash-red { 0% { background: var(--bg-red); } 50% { background: black; } 100% { background: var(--bg-red); } }
        
        /* Logic to hide numbers */
        body.hide-numbers #timer-display { opacity: 0; }

    </style>
</head>
<body>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('builder')">Builder</button>
        <button class="tab-btn" onclick="switchTab('quick')">Quick Mode</button>
    </div>

    <div id="screen-builder" class="screen active">
        
        <div id="bit-list">
            <div style="text-align: center; color: #555; margin-top: 50px; font-style: italic;">
                Add jokes below...
            </div>
        </div>

        <div class="add-bar">
            <input type="text" id="new-name" placeholder="Joke Name">
            <input type="number" id="new-time" placeholder="Min" value="2">
            <button class="add-btn" onclick="addBit()">+</button>
        </div>

        <div class="footer-bar">
            <div class="total-display">TOTAL<span id="total-time-display">0m</span></div>
            <button class="start-btn" id="start-btn" onclick="startSet()" disabled>START</button>
        </div>
    </div>

    <div id="screen-quick" class="screen">
        <div class="quick-group">
            <label class="quick-label">Total Time (Min)</label>
            <div class="quick-input-row">
                <input type="number" id="quick-total" class="quick-input" value="5">
            </div>
        </div>

        <div class="quick-group">
            <label class="quick-label">Light At (Min Left)</label>
            <div class="quick-input-row">
                <input type="number" id="quick-light" class="quick-input" value="1">
            </div>
        </div>

        <button class="start-btn" onclick="startQuickSet()">START TIMER</button>
    </div>

    <div id="screen-timer" class="screen">
        <div id="timer-display">00:00</div>
        
        <div class="timer-controls">
            <button class="icon-btn" onclick="toggleCheatSheet()">üìÑ</button>
            <button class="icon-btn" onclick="toggleNumbers()">üëÅÔ∏è</button>
            <button class="icon-btn" onclick="stopTimer()">‚èπ</button>
        </div>

        <div id="cheat-sheet" onclick="toggleCheatSheet()">
            <div id="cs-content"></div>
            <button class="close-cs">Close</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        let setlist = [];
        let timerInterval = null;
        let endTime = 0;
        let warningTimeMs = 60000; 
        let isNumbersVisible = true;

        // --- TABS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(tabName === 'builder') document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            else document.querySelector('.tab-btn:nth-child(2)').classList.add('active');

            document.getElementById('screen-builder').classList.remove('active');
            document.getElementById('screen-quick').classList.remove('active');
            
            document.getElementById(`screen-${tabName}`).classList.add('active');
        }

        // --- BUILDER LOGIC ---
        function addBit() {
            const nameInput = document.getElementById('new-name');
            const timeInput = document.getElementById('new-time');
            const name = nameInput.value.trim();
            const minutes = parseInt(timeInput.value);

            if (!name || !minutes || minutes <= 0) return;

            setlist.push({ id: Date.now(), name, minutes });
            nameInput.value = '';
            renderList();
        }

        function removeBit(id) {
            setlist = setlist.filter(bit => bit.id !== id);
            renderList();
        }

        // --- TOUCH DRAG ENGINE ---
        let draggingId = null;
        let draggingEl = null;

        function handleTouchStart(e, id) {
            draggingId = id;
            draggingEl = e.target.closest('.bit-card');
            draggingEl.classList.add('dragging-active');
        }

        function handleTouchMove(e) {
            if (!draggingId) return;
            e.preventDefault(); 
            
            const touch = e.touches[0];
            const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
            const cardUnder = elementUnder ? elementUnder.closest('.bit-card') : null;

            if (cardUnder && cardUnder !== draggingEl) {
                const fromIndex = setlist.findIndex(item => item.id === draggingId);
                const toId = parseInt(cardUnder.dataset.id);
                
                if (toId && toId !== draggingId) {
                    const toIndex = setlist.findIndex(item => item.id === toId);
                    
                    const temp = setlist[fromIndex];
                    setlist[fromIndex] = setlist[toIndex];
                    setlist[toIndex] = temp;

                    renderList();
                    
                    const newCards = document.querySelectorAll('.bit-card');
                    draggingEl = newCards[toIndex]; 
                    draggingEl.classList.add('dragging-active');
                }
            }
        }

        function handleTouchEnd(e) {
            if (draggingEl) draggingEl.classList.remove('dragging-active');
            draggingId = null;
            draggingEl = null;
        }

        function renderList() {
            const container = document.getElementById('bit-list');
            const totalDisplay = document.getElementById('total-time-display');
            const startBtn = document.getElementById('start-btn');
            
            container.innerHTML = '';
            let totalMin = 0;

            if (setlist.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #555; margin-top: 50px; font-style: italic;">Add jokes to build your set...</div>';
                startBtn.disabled = true;
                totalDisplay.innerText = "0m";
                return;
            }

            startBtn.disabled = false;

            setlist.forEach((bit, index) => {
                totalMin += bit.minutes;
                
                const div = document.createElement('div');
                div.className = 'bit-card';
                div.dataset.id = bit.id; 
                div.innerHTML = `
                    <div class="bit-info">
                        <div class="bit-name">${index + 1}. ${bit.name}</div>
                        <div class="bit-time">${bit.minutes} min</div>
                    </div>
                    <div class="bit-controls">
                        <button class="del-btn" onclick="removeBit(${bit.id})">√ó</button>
                        <div class="drag-handle" 
                             ontouchstart="handleTouchStart(event, ${bit.id})" 
                             ontouchmove="handleTouchMove(event)" 
                             ontouchend="handleTouchEnd(event)">
                             ‚ò∞
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            totalDisplay.innerText = `${totalMin}m`;
        }

        // --- TIMER LOGIC ---
        function startQuickSet() {
            const total = parseInt(document.getElementById('quick-total').value);
            const light = parseInt(document.getElementById('quick-light').value);
            if (!total || total <= 0) return alert("Invalid Time");
            const csContainer = document.getElementById('cs-content');
            csContainer.innerHTML = `<div class="cs-item">Quick ${total}m Set<span>Light at ${light}m</span></div>`;
            startTimerLogic(total * 60 * 1000, light * 60 * 1000);
        }

        function startSet() {
            let totalMin = setlist.reduce((sum, bit) => sum + bit.minutes, 0);
            const csContainer = document.getElementById('cs-content');
            csContainer.innerHTML = '';
            setlist.forEach((bit, i) => {
                csContainer.innerHTML += `
                    <div class="cs-item">
                        ${i+1}. ${bit.name}
                        <span>${bit.minutes} min</span>
                    </div>`;
            });
            const warningMs = totalMin < 2 ? 30000 : 60000;
            startTimerLogic(totalMin * 60 * 1000, warningMs);
        }

        function startTimerLogic(durationMs, warningThresholdMs) {
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(console.log);

            document.getElementById('screen-builder').classList.remove('active');
            document.getElementById('screen-quick').classList.remove('active');
            document.querySelector('.tab-bar').style.display = 'none'; 
            document.getElementById('screen-timer').classList.add('active');
            
            const now = Date.now();
            endTime = now + durationMs;
            warningTimeMs = warningThresholdMs;

            updateDisplay(durationMs);
            resetColors();

            clearInterval(timerInterval);
            timerInterval = setInterval(tick, 200);
        }

        function tick() {
            const now = Date.now();
            const timeLeft = endTime - now;

            updateDisplay(timeLeft);

            if (timeLeft <= 0) {
                // RED
                if (!document.body.classList.contains('red')) {
                    document.body.classList.add('red');
                    document.body.classList.remove('yellow');
                    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                }
                if (timeLeft < -10000) document.body.classList.add('flash');
            } 
            else if (timeLeft <= warningTimeMs) {
                // YELLOW
                if (!document.body.classList.contains('yellow')) {
                    document.body.classList.add('yellow');
                    if (navigator.vibrate) navigator.vibrate(200);
                }
            }
        }

        function updateDisplay(ms) {
            const isNegative = ms < 0;
            const absMs = Math.abs(ms);
            const totalSeconds = Math.floor(absMs / 1000);
            const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = (isNegative ? "-" : "") + `${m}:${s}`;
        }

        function stopTimer() {
            clearInterval(timerInterval);
            resetColors();
            document.getElementById('screen-timer').classList.remove('active');
            document.querySelector('.tab-bar').style.display = 'flex'; 
            
            if (document.querySelector('.tab-btn:nth-child(1)').classList.contains('active')) {
                document.getElementById('screen-builder').classList.add('active');
            } else {
                document.getElementById('screen-quick').classList.add('active');
            }
        }

        function resetColors() {
            document.body.classList.remove('yellow', 'red', 'flash');
            // We do NOT touch 'hide-numbers' here, so preferences are saved
        }

        function toggleNumbers() {
            isNumbersVisible = !isNumbersVisible;
            if (isNumbersVisible) document.body.classList.remove('hide-numbers');
            else document.body.classList.add('hide-numbers');
        }

        function toggleCheatSheet() {
            document.getElementById('cheat-sheet').classList.toggle('visible');
        }
    </script>
</body>
</html>
