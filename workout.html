<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitLogic Pro | Smart Trainer</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F2F2F7; color: #1C1C1E; -webkit-tap-highlight-color: transparent; }
        .page-transition { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .toggle-checkbox:checked { right: 0; border-color: #34C759; }
        .toggle-checkbox:checked + .toggle-label { background-color: #34C759; }
        
        /* Muscle Selector Buttons */
        .muscle-btn.selected { background-color: #007AFF; color: white; border-color: #007AFF; }
    </style>
</head>
<body class="min-h-screen pb-24">

    <div id="app-header" class="bg-white sticky top-0 z-30 px-6 py-4 shadow-sm flex justify-between items-center">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight text-gray-900">FitLogic <span class="text-blue-500">Pro</span></h1>
            <p class="text-xs text-gray-500 font-medium" id="currentDate">Today</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-1 bg-orange-100 px-3 py-1 rounded-full border border-orange-200">
                <i class="fa-solid fa-fire text-orange-500 text-sm"></i>
                <span id="streakDisplay" class="text-xs font-bold text-orange-700">0</span>
            </div>
            <div class="relative w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center border-2 border-white shadow-sm" onclick="toggleSettings()">
                <span id="userLevel" class="text-xs font-bold text-blue-600">Lvl 1</span>
            </div>
        </div>
    </div>

    <div id="main-container" class="p-6 space-y-6 max-w-lg mx-auto page-transition">

        <div class="card p-5">
            <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('equip-options').classList.toggle('hidden')">
                <h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-toolbox text-gray-500"></i> My Gear</h3>
                <span class="text-xs text-blue-500 font-bold">Edit <i class="fa-solid fa-chevron-down ml-1"></i></span>
            </div>
            <div id="equip-options" class="hidden mt-4 grid grid-cols-2 gap-2 pt-3 border-t border-gray-100">
                </div>
        </div>

        <div>
            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2 ml-1">Focus Area (Select Multiple)</h3>
            <div class="grid grid-cols-3 gap-2" id="muscle-selector">
                <button onclick="toggleMuscle(this, 'Chest')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-3 text-sm font-bold text-gray-600 shadow-sm transition-all active:scale-95">Chest</button>
                <button onclick="toggleMuscle(this, 'Back')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-3 text-sm font-bold text-gray-600 shadow-sm transition-all active:scale-95">Back</button>
                <button onclick="toggleMuscle(this, 'Legs')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-3 text-sm font-bold text-gray-600 shadow-sm transition-all active:scale-95">Legs</button>
                <button onclick="toggleMuscle(this, 'Shoulders')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-3 text-sm font-bold text-gray-600 shadow-sm transition-all active:scale-95">Shoulders</button>
                <button onclick="toggleMuscle(this, 'Arms')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-3 text-sm font-bold text-gray-600 shadow-sm transition-all active:scale-95">Arms</button>
                <button onclick="toggleMuscle(this, 'Core')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-3 text-sm font-bold text-gray-600 shadow-sm transition-all active:scale-95">Core</button>
            </div>
            <p class="text-[10px] text-gray-400 mt-2 ml-1 italic">*Leave all unselected for a Full Body workout.</p>
        </div>

        <button onclick="generateWorkout()" class="w-full bg-black text-white rounded-2xl py-5 shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center gap-1 group">
            <span class="text-lg font-bold group-hover:text-blue-400 transition-colors"><i class="fa-solid fa-bolt mr-2 text-yellow-400"></i> Generate Custom Workout</span>
            <span class="text-xs text-gray-400 font-medium">Science-Based • Auto-Scaling Difficulty</span>
        </button>

        <div>
            <h3 class="text-sm font-bold text-gray-900 mb-3 ml-1">Recent History</h3>
            <div id="historyLog" class="space-y-3"></div>
        </div>
    </div>

    <div id="workout-modal" class="fixed inset-0 bg-white z-50 hidden flex flex-col">
        <div class="bg-white border-b border-gray-100 p-4 flex justify-between items-center shadow-sm z-10">
            <button onclick="closeWorkout()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div>
                <h2 class="font-bold text-lg text-center" id="workoutTitle">Custom Session</h2>
                <div class="text-[10px] text-center text-gray-400" id="workoutSubtitle">Focus: Full Body</div>
            </div>
            <div class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600" id="sessionTimer">00:00</div>
        </div>

        <div id="workout-content" class="flex-1 overflow-y-auto p-6 space-y-6 pb-20 bg-gray-50">
            </div>

        <div class="p-4 border-t border-gray-100 bg-white/95 backdrop-blur">
            <button onclick="finishWorkout()" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl shadow-md active:scale-95 transition-transform">
                Complete Workout <i class="fa-solid fa-check ml-2"></i>
            </button>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="font-bold text-xl mb-4">Settings</h2>
            <div class="space-y-3">
                <button onclick="exportData()" class="w-full bg-blue-50 text-blue-600 font-bold py-3 rounded-lg border border-blue-100 text-sm">Backup Data</button>
                <label class="block w-full cursor-pointer">
                    <div class="w-full bg-gray-50 text-gray-600 font-bold py-3 rounded-lg border border-gray-200 text-sm text-center">Restore Data</div>
                    <input type="file" onchange="importData(this)" class="hidden" accept=".json">
                </label>
                <button onclick="resetApp()" class="w-full text-red-500 text-xs font-bold py-3">Factory Reset</button>
            </div>
            <button onclick="toggleSettings()" class="mt-6 w-full bg-gray-900 text-white font-bold py-3 rounded-lg">Close</button>
        </div>
    </div>

    <script>
        // --- DATA: EXERCISE LIBRARY (Expanded & Detailed) ---
        // benefit: Explains WHY we do it.
        const exerciseLibrary = [
            // CHEST
            { id: 'pushup_std', name: 'Standard Pushups', muscle: 'Chest', equipment: 'None', benefit: 'Builds pectoral mass and core stability.', videoUrl: "" },
            { id: 'db_press', name: 'Dumbbell Floor Press', muscle: 'Chest', equipment: 'Dumbbells', benefit: 'Allows heavy loading of the chest without shoulder strain.', videoUrl: "" },
            { id: 'band_fly', name: 'Resistance Band Fly', muscle: 'Chest', equipment: 'Bands', benefit: 'Isolates the chest squeeze (adduction) which pushups miss.', videoUrl: "" },
            { id: 'db_fly', name: 'Dumbbell Flys (Floor)', muscle: 'Chest', equipment: 'Dumbbells', benefit: 'Expands the chest cavity and targets outer pec fibers.', videoUrl: "" },

            // BACK
            { id: 'pullup', name: 'Pull-ups', muscle: 'Back', equipment: 'Pullup Bar', benefit: 'The king of back exercises. Widens the lats for the V-taper.', videoUrl: "" },
            { id: 'db_row', name: 'One-Arm DB Row', muscle: 'Back', equipment: 'Dumbbells', benefit: 'Thickens the mid-back and fixes muscle imbalances.', videoUrl: "" },
            { id: 'band_row', name: 'Seated Band Row', muscle: 'Back', equipment: 'Bands', benefit: 'Targets the rhomboids and improves posture.', videoUrl: "" },
            { id: 'superman', name: 'Supermans', muscle: 'Back', equipment: 'None', benefit: 'Strengthens the lower back erectors to prevent injury.', videoUrl: "" },

            // LEGS
            { id: 'squat_body', name: 'Air Squats', muscle: 'Legs', equipment: 'None', benefit: 'Fundamental movement for quad and glute development.', videoUrl: "" },
            { id: 'goblet_squat', name: 'Goblet Squats', muscle: 'Legs', equipment: 'Dumbbells', benefit: 'Adds load to squats while forcing core engagement.', videoUrl: "" },
            { id: 'lunge_db', name: 'Weighted Lunges', muscle: 'Legs', equipment: 'Dumbbells', benefit: 'Increases leg stability and glute activation.', videoUrl: "" },
            { id: 'rdl_band', name: 'Band RDLs', muscle: 'Legs', equipment: 'Bands', benefit: 'Isolates the hamstrings and glutes without heavy spinal load.', videoUrl: "" },

            // SHOULDERS
            { id: 'pike_pushup', name: 'Pike Pushups', muscle: 'Shoulders', equipment: 'None', benefit: 'Simulates overhead pressing using bodyweight.', videoUrl: "" },
            { id: 'db_ohp', name: 'Seated DB Press', muscle: 'Shoulders', equipment: 'Dumbbells', benefit: 'Builds deltoid mass for broader shoulders.', videoUrl: "" },
            { id: 'lat_raise_band', name: 'Band Lateral Raises', muscle: 'Shoulders', equipment: 'Bands', benefit: 'Targets the side delt to create shoulder width.', videoUrl: "" },

            // ARMS
            { id: 'db_curl', name: 'Dumbbell Curls', muscle: 'Arms', equipment: 'Dumbbells', benefit: 'Isolates the biceps peak.', videoUrl: "" },
            { id: 'tri_dip', name: 'Chair Dips', muscle: 'Arms', equipment: 'None', benefit: 'Hits all three heads of the triceps.', videoUrl: "" },
            { id: 'band_pushdown', name: 'Band Tricep Pushdowns', muscle: 'Arms', equipment: 'Bands', benefit: 'Constant tension on the triceps without elbow stress.', videoUrl: "" },

            // CORE
            { id: 'plank', name: 'Plank Hold', muscle: 'Core', equipment: 'None', benefit: 'Builds deep core stability and abdominal endurance.', videoUrl: "" },
            { id: 'leg_raise', name: 'Lying Leg Raises', muscle: 'Core', equipment: 'None', benefit: 'Targets the lower abs specifically.', videoUrl: "" },
            { id: 'r_twist', name: 'Russian Twists', muscle: 'Core', equipment: 'None', benefit: 'Targets the obliques for side-ab definition.', videoUrl: "" }
        ];

        const warmups = {
            'Chest': { move: 'Arm Circles & Wall Slides', why: 'Loosens the rotator cuff and chest fascia to prevent shoulder impingement.' },
            'Back': { move: 'Cat-Cow & Band Pull-Aparts', why: 'Activates the scapula so you pull with your back, not your arms.' },
            'Legs': { move: 'Leg Swings & Bodyweight Squats', why: 'Lubricates the knee joints and opens up tight hips.' },
            'Shoulders': { move: 'Arm Cross Swings', why: 'Increases blood flow to the deltoids.' },
            'Arms': { move: 'Wrist Circles', why: 'Prepares wrists for loading.' },
            'Core': { move: 'Cobra Stretch', why: 'Stretches the abdominal wall.' }
        };

        let state = {
            user: { level: 1, xp: 0, streak: 0, lastDate: null },
            equipment: { 'Dumbbells': true, 'Bands': true, 'Pullup Bar': true, 'Barbell': false },
            exerciseData: {},
            history: []
        };
        let selectedMuscles = [];
        let currentSession = [];
        let timerInterval = null;

        // --- INIT ---
        function init() {
            const saved = localStorage.getItem('fitLogicData_v2');
            if (saved) state = JSON.parse(saved);
            updateUI();
            renderEquipmentToggles();
        }

        function updateUI() {
            document.getElementById('streakDisplay').innerText = state.user.streak;
            document.getElementById('userLevel').innerText = "Lvl " + state.user.level;
            
            // Render History
            const histEl = document.getElementById('historyLog');
            histEl.innerHTML = state.history.length ? '' : '<p class="text-center text-gray-400 text-xs py-4">No workouts yet.</p>';
            state.history.slice(0, 3).forEach(log => {
                histEl.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                        <div><p class="text-sm font-bold">${log.title}</p><p class="text-[10px] text-gray-400">${new Date(log.date).toLocaleDateString()}</p></div>
                        <span class="text-xs font-bold text-blue-500">+${log.xp} XP</span>
                    </div>`;
            });
        }

        function renderEquipmentToggles() {
            const container = document.getElementById('equip-options');
            container.innerHTML = '';
            Object.keys(state.equipment).forEach(item => {
                container.innerHTML += `
                    <label class="flex items-center justify-between p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 border border-gray-200">
                        <span class="text-xs font-bold text-gray-700">${item}</span>
                        <input type="checkbox" class="accent-blue-500 w-4 h-4" ${state.equipment[item] ? 'checked' : ''} onchange="toggleEquipment('${item}')">
                    </label>`;
            });
        }

        function toggleEquipment(item) {
            state.equipment[item] = !state.equipment[item];
            saveData();
        }

        function toggleMuscle(btn, muscle) {
            btn.classList.toggle('selected');
            if (selectedMuscles.includes(muscle)) {
                selectedMuscles = selectedMuscles.filter(m => m !== muscle);
            } else {
                selectedMuscles.push(muscle);
            }
        }

        // --- GENERATOR ALGORITHM ---
        function generateWorkout() {
            // 1. Determine Focus Area
            const targets = selectedMuscles.length > 0 ? selectedMuscles : ['Chest', 'Back', 'Legs', 'Shoulders', 'Core', 'Arms'];
            
            // 2. Filter by Equipment AND Muscle
            let sessionExercises = [];
            
            targets.forEach(muscle => {
                // Find all valid exercises for this muscle
                const candidates = exerciseLibrary.filter(ex => {
                    if (ex.muscle !== muscle) return false;
                    // Equipment Check: 'None' works always, otherwise check state
                    return ex.equipment === 'None' || state.equipment[ex.equipment];
                });

                if (candidates.length > 0) {
                    // PREFERENCE LOGIC: If we have Dumbbells/Bands selected, try to pick them over 'None' 70% of the time
                    // This fixes the "equipment doesn't do much" issue.
                    const weighted = candidates.filter(c => c.equipment !== 'None');
                    let choice;
                    
                    if (weighted.length > 0 && Math.random() > 0.3) {
                        choice = weighted[Math.floor(Math.random() * weighted.length)];
                    } else {
                        choice = candidates[Math.floor(Math.random() * candidates.length)];
                    }
                    sessionExercises.push(choice);
                }
            });

            if (sessionExercises.length === 0) {
                alert("No exercises found for these settings! Try enabling more equipment.");
                return;
            }

            // 3. Build Session
            currentSession = sessionExercises.map(ex => {
                const history = state.exerciseData[ex.id] || { reps: 10 };
                return { ...ex, targetReps: history.reps, sets: 3, completed: false };
            });

            // 4. Update Modal UI
            document.getElementById('workoutTitle').innerText = selectedMuscles.length > 0 ? selectedMuscles.join(' + ') : "Full Body";
            document.getElementById('workoutSubtitle').innerText = `${currentSession.length} Exercises • Est. Time: ${currentSession.length * 5} mins`;
            
            renderWorkoutContent();
            document.getElementById('workout-modal').classList.remove('hidden');
            
            // Start Timer
            let sec = 0;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                sec++;
                const m = Math.floor(sec / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                document.getElementById('sessionTimer').innerText = `${m}:${s}`;
            }, 1000);
        }

        function renderWorkoutContent() {
            const container = document.getElementById('workout-content');
            container.innerHTML = '';

            // 1. SMART WARMUP
            // We look at unique muscles in the current session and pull their specific warmups
            const uniqueMuscles = [...new Set(currentSession.map(ex => ex.muscle))];
            let warmupHTML = `<div class="bg-orange-50 p-4 rounded-xl border border-orange-100 mb-4">
                <h3 class="text-orange-800 font-bold text-sm mb-2"><i class="fa-solid fa-heart-pulse mr-2"></i>Smart Warmup</h3>
                <div class="space-y-3">`;
            
            uniqueMuscles.forEach(m => {
                if(warmups[m]) {
                    warmupHTML += `
                    <div>
                        <p class="text-xs font-bold text-gray-800">• ${warmups[m].move}</p>
                        <p class="text-[10px] text-gray-500 italic">${warmups[m].why}</p>
                    </div>`;
                }
            });
            warmupHTML += `</div></div>`;
            container.innerHTML += warmupHTML;

            // 2. EXERCISES
            currentSession.forEach((ex, idx) => {
                // Video Placeholder
                const videoBlock = ex.videoUrl ? 
                    `<iframe class="w-full h-40 rounded-lg mt-2" src="${ex.videoUrl}" frameborder="0" allowfullscreen></iframe>` : 
                    `<div class="w-full h-24 bg-gray-200 rounded-lg mt-2 flex items-center justify-center text-xs text-gray-400 italic">Video Placeholder</div>`;

                container.innerHTML += `
                <div class="card p-5 border-l-4 ${ex.completed ? 'border-green-500 opacity-60' : 'border-blue-500'}">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-lg">${ex.name}</h4>
                        <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-700">${ex.sets} x ${ex.targetReps}</span>
                    </div>
                    
                    <div class="mt-2 mb-3 bg-blue-50 p-2 rounded text-[11px] text-blue-800 border border-blue-100">
                        <strong><i class="fa-solid fa-circle-info mr-1"></i> Why:</strong> ${ex.benefit}
                    </div>

                    ${videoBlock}

                    <div class="grid grid-cols-3 gap-2 mt-4">
                        <button onclick="rate(${idx}, 'hard')" class="py-2 rounded-lg bg-red-50 text-red-600 text-xs font-bold border border-red-100">Too Hard</button>
                        <button onclick="rate(${idx}, 'good')" class="py-2 rounded-lg bg-green-50 text-green-600 text-xs font-bold border border-green-100">Just Right</button>
                        <button onclick="rate(${idx}, 'easy')" class="py-2 rounded-lg bg-blue-50 text-blue-600 text-xs font-bold border border-blue-100">Too Easy</button>
                    </div>
                </div>`;
            });
        }

        function rate(idx, rating) {
            const ex = currentSession[idx];
            currentSession[idx].completed = true;
            
            // Scaling Logic
            if (!state.exerciseData[ex.id]) state.exerciseData[ex.id] = { reps: 10 };
            
            if (rating === 'easy') {
                state.exerciseData[ex.id].reps += 2;
                alert(`Too easy? Next time: ${state.exerciseData[ex.id].reps} Reps.`);
            } else if (rating === 'hard') {
                state.exerciseData[ex.id].reps = Math.max(5, state.exerciseData[ex.id].reps - 2);
                alert(`Reducing volume. Next time: ${state.exerciseData[ex.id].reps} Reps.`);
            }
            
            saveData();
            renderWorkoutContent();
        }

        function finishWorkout() {
            if (currentSession.some(e => !e.completed) && !confirm("Finish incomplete workout?")) return;
            
            const xp = 100 + (currentSession.length * 10);
            state.user.xp += xp;
            state.user.streak++;
            state.user.level = Math.floor(state.user.xp / 500) + 1;
            
            state.history.unshift({ date: Date.now(), title: document.getElementById('workoutTitle').innerText, xp: xp });
            saveData();
            location.reload();
        }

        function saveData() { localStorage.setItem('fitLogicData_v2', JSON.stringify(state)); }
        function closeWorkout() { if(confirm("Discard session?")) { document.getElementById('workout-modal').classList.add('hidden'); clearInterval(timerInterval); }}
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            a.download = "fitlogic_backup.json";
            document.body.appendChild(a); a.click(); a.remove();
        }
        function importData(input) {
            const reader = new FileReader();
            reader.onload = (e) => { state = JSON.parse(e.target.result); saveData(); location.reload(); };
            reader.readAsText(input.files[0]);
        }
        function resetApp() { if(confirm("Delete all data?")) { localStorage.removeItem('fitLogicData_v2'); location.reload(); }}

        init();
    </script>
</body>
</html>
