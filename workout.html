<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FitLogic">
    
    <title>FitLogic 13.0 | Gear Update</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { darkbg: '#121212', darkcard: '#1E1E1E' } } }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .page-transition { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-10px)} 100% {opacity: 1; transform: translateY(0)} }
        .toggle-checkbox:checked { right: 0; border-color: #34C759; }
        .toggle-checkbox:checked + .toggle-label { background-color: #34C759; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .modal-enter { animation: modalPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalPop { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-[#F2F2F7] dark:bg-darkbg text-gray-900 dark:text-gray-100 min-h-screen pb-32 transition-colors duration-300">

    <div id="app-header" class="bg-white/90 dark:bg-darkcard/90 backdrop-blur sticky top-0 z-30 px-6 py-4 pt-14 shadow-sm flex justify-between items-center transition-colors duration-300 border-b dark:border-gray-800">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight">FitLogic <span class="text-blue-600 dark:text-blue-400">13.0</span></h1>
            <p class="text-xs text-gray-500 dark:text-gray-400 font-medium" id="currentDate">Today</p>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="toggleDarkMode()" class="text-gray-400 hover:text-blue-500 dark:text-yellow-400 transition-colors"><i class="fa-solid fa-moon text-xl" id="themeIcon"></i></button>
            <div class="flex items-center gap-1 bg-orange-100 dark:bg-orange-900/30 px-3 py-1 rounded-full border border-orange-200 dark:border-orange-800">
                <i class="fa-solid fa-fire text-orange-500 text-sm"></i>
                <span id="streakDisplay" class="text-xs font-bold text-orange-700 dark:text-orange-400">0</span>
            </div>
            <div class="relative w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center border-2 border-white dark:border-gray-700 shadow-sm cursor-pointer" onclick="toggleSettings()">
                <span id="userLevel" class="text-xs font-bold text-blue-600 dark:text-blue-400">Lvl 1</span>
            </div>
        </div>
    </div>

    <div id="main-container" class="p-6 space-y-6 max-w-lg mx-auto page-transition">

        <div class="bg-white dark:bg-darkcard rounded-2xl p-4 shadow-sm border border-gray-100 dark:border-gray-800">
            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-wide mb-3">This Week</h3>
            <div class="flex justify-between items-center" id="week-visualizer"></div>
        </div>

        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-4 text-white shadow-lg relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex items-center gap-2 mb-2"><span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">Daily Tip</span></div>
                <p class="text-sm font-medium leading-relaxed" id="dailyTipText">Loading...</p>
            </div>
            <i class="fa-solid fa-lightbulb absolute -bottom-4 -right-2 text-8xl text-white/10 rotate-12"></i>
        </div>

        <div>
            <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">Quick Flows (5 Mins)</h3>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="startRoutine('morning')" class="bg-white dark:bg-darkcard rounded-xl p-4 flex flex-col items-center justify-center gap-2 border-b-4 border-yellow-400 shadow-sm hover:brightness-95 transition-all">
                    <i class="fa-solid fa-sun text-2xl text-yellow-500"></i><span class="text-xs font-bold">Morning Flow</span>
                </button>
                <button onclick="startRoutine('night')" class="bg-white dark:bg-darkcard rounded-xl p-4 flex flex-col items-center justify-center gap-2 border-b-4 border-indigo-400 shadow-sm hover:brightness-95 transition-all">
                    <i class="fa-solid fa-moon text-2xl text-indigo-500"></i><span class="text-xs font-bold">Sleep Stretch</span>
                </button>
            </div>
        </div>

        <div id="active-plan-card" class="hidden">
            <div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Current Plan</h3><button onclick="promptQuitPlan()" class="text-[10px] text-red-400 font-bold hover:text-red-500">Quit</button></div>
            <div class="bg-blue-50/50 dark:bg-blue-900/10 border-2 border-blue-500/20 rounded-2xl p-5 relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-xl font-extrabold" id="planNameDisplay">Plan</h2>
                    <p class="text-xs text-blue-600 dark:text-blue-400 font-bold mt-1 mb-4" id="planProgressText">Progress</p>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-4"><div id="planProgressBar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div></div>
                    <button onclick="generateWorkout('plan')" class="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-xl py-3 shadow-md font-bold flex items-center justify-center gap-2"><i class="fa-solid fa-play"></i> Start Next Session</button>
                </div>
            </div>
        </div>

        <div>
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">My Routines</h3>
                <button onclick="openBuilder()" class="text-xs bg-black dark:bg-white dark:text-black text-white px-3 py-1 rounded-full font-bold shadow-lg hover:scale-105 transition-transform">Create New +</button>
            </div>
            
            <div id="custom-routines-list" class="space-y-3"></div>
            <div id="no-custom-msg" class="text-center text-xs text-gray-400 py-4 italic">No saved routines yet. Build one!</div>
        </div>

        <div id="plan-library" class="hidden">
            <h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2 mt-4">4-Week Plans</h3>
            <div class="space-y-3">
                <div class="bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-100 dark:border-gray-800"><div><h4 class="font-bold">Full Body Alpha</h4><p class="text-xs text-gray-500">3x/Week • Strength</p></div><button onclick="promptStartPlan('plan_full_body', 'Full Body Alpha')" class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-lg text-xs font-bold">Start</button></div>
                <div class="bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-100 dark:border-gray-800"><div><h4 class="font-bold">Thick Thighs</h4><p class="text-xs text-gray-500">3x/Week • Legs</p></div><button onclick="promptStartPlan('plan_lower_mass', 'Thick Thighs')" class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-lg text-xs font-bold">Start</button></div>
            </div>
        </div>

        <hr class="border-gray-200 dark:border-gray-800">

        <div>
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Freestyle</h3>
                <button onclick="document.getElementById('freestyle-opts').classList.toggle('hidden')" class="text-xs text-blue-500 font-bold">Options</button>
            </div>
            <div id="freestyle-opts" class="bg-white dark:bg-darkcard rounded-xl p-5 mb-4 space-y-4 hidden border border-gray-100 dark:border-gray-800">
                <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('equip-options').classList.toggle('hidden')"><h3 class="font-bold text-sm"><i class="fa-solid fa-toolbox text-gray-500 mr-2"></i>My Gear</h3><i class="fa-solid fa-chevron-down text-gray-400 text-xs"></i></div>
                <div id="equip-options" class="hidden grid grid-cols-2 gap-2 pt-2 border-t border-gray-100 dark:border-gray-700"></div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Duration</label>
                    <select id="durationSelector" class="w-full bg-gray-50 dark:bg-gray-800 border-none text-sm rounded-lg p-2.5 text-gray-900 dark:text-white"><option value="10">10 Mins</option><option value="20" selected>20 Mins</option><option value="30">30 Mins</option></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Targets</label>
                    <div class="grid grid-cols-3 gap-2" id="muscle-selector">
                        <button onclick="toggleMuscle(this, 'Chest')" class="muscle-btn bg-gray-50 dark:bg-gray-800 dark:text-gray-300 rounded-xl py-2 text-xs font-bold">Chest</button>
                        <button onclick="toggleMuscle(this, 'Back')" class="muscle-btn bg-gray-50 dark:bg-gray-800 dark:text-gray-300 rounded-xl py-2 text-xs font-bold">Back</button>
                        <button onclick="toggleMuscle(this, 'Legs')" class="muscle-btn bg-gray-50 dark:bg-gray-800 dark:text-gray-300 rounded-xl py-2 text-xs font-bold">Legs</button>
                        <button onclick="toggleMuscle(this, 'Arms')" class="muscle-btn bg-gray-50 dark:bg-gray-800 dark:text-gray-300 rounded-xl py-2 text-xs font-bold">Arms</button>
                        <button onclick="toggleMuscle(this, 'Core')" class="muscle-btn bg-gray-50 dark:bg-gray-800 dark:text-gray-300 rounded-xl py-2 text-xs font-bold">Core</button>
                        <button onclick="toggleMuscle(this, 'Shoulders')" class="muscle-btn bg-gray-50 dark:bg-gray-800 dark:text-gray-300 rounded-xl py-2 text-xs font-bold">Shoulders</button>
                    </div>
                </div>
            </div>
            <button onclick="generateWorkout('freestyle')" class="w-full bg-white dark:bg-darkcard border-2 border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 rounded-2xl py-4 font-bold shadow-sm active:scale-95 transition-transform hover:bg-gray-50 dark:hover:bg-gray-800"><i class="fa-solid fa-shuffle mr-2"></i> Random Workout</button>
        </div>
        
        <div id="historyLog" class="space-y-2 pb-10"></div>
    </div>

    <div id="builder-modal" class="fixed inset-0 bg-white dark:bg-darkbg z-50 hidden flex flex-col pt-12">
        <div class="bg-white dark:bg-darkcard border-b border-gray-100 dark:border-gray-800 p-4 flex justify-between items-center shadow-sm z-10">
            <button onclick="closeBuilder()" class="text-gray-400">Cancel</button>
            <h2 class="font-bold text-lg">New Routine</h2>
            <button onclick="saveCustomRoutine()" class="text-blue-500 font-bold">Save</button>
        </div>
        <div class="p-4 bg-gray-50 dark:bg-darkbg flex-1 overflow-y-auto pb-40">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Routine Name</label>
            <input type="text" id="builder-name" placeholder="e.g. Friday Pump" class="w-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 dark:bg-darkcard dark:text-white mb-6 focus:ring-2 focus:ring-blue-500 outline-none">
            
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Select Exercises</label>
            <div id="builder-list" class="space-y-4">
                </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-[#1C1C1E] w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all modal-enter">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 dark:text-white mb-2 text-center">Title</h3>
            <p id="modal-message" class="text-sm text-gray-500 dark:text-gray-400 text-center mb-6">Message</p>
            <div class="grid grid-cols-2 gap-3" id="modal-buttons"></div>
        </div>
    </div>

    <div id="workout-modal" class="fixed inset-0 bg-white dark:bg-darkbg z-50 hidden flex flex-col pt-12">
        <div class="bg-white dark:bg-darkcard border-b border-gray-100 dark:border-gray-800 p-4 flex justify-between items-center shadow-sm z-10">
            <button onclick="promptCloseWorkout()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="text-center"><h2 class="font-bold text-lg" id="workoutTitle">Session</h2></div>
            <div class="text-xs font-mono bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded text-gray-600 dark:text-gray-300" id="sessionTimer">00:00</div>
        </div>
        <div id="workout-content" class="flex-1 overflow-y-auto p-6 space-y-6 pb-40 bg-gray-50 dark:bg-darkbg"></div>
        <div class="absolute bottom-0 w-full bg-white dark:bg-darkcard border-t border-gray-200 dark:border-gray-800 p-4 safe-pb">
             <button onclick="promptFinishWorkout()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-md active:scale-95 transition-transform">Finish <i class="fa-solid fa-check ml-2"></i></button>
        </div>
    </div>

    <div id="rest-overlay" class="fixed inset-0 bg-black/95 z-[60] hidden flex flex-col items-center justify-center text-white">
        <div class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Recover</div>
        <div class="text-7xl font-mono font-bold mb-8 transition-all" id="rest-countdown">00:45</div>
        <div class="flex gap-4">
            <button onclick="addRest(15)" class="px-6 py-2 rounded-full border border-white/30 text-sm hover:bg-white/10">+15s</button>
            <button onclick="skipRest()" class="px-6 py-2 rounded-full bg-white text-black font-bold text-sm">Resume</button>
        </div>
        <div class="mt-8 text-center px-6"><p class="text-xs text-gray-500 uppercase mb-2">Up Next:</p><p class="text-lg font-bold text-blue-400" id="up-next-text">Exercise</p></div>
        <div class="mt-8"><button onclick="toggleAudio()" id="audioBtn" class="text-gray-500 text-sm"><i class="fa-solid fa-volume-high"></i> Sound On</button></div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-darkcard w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="font-bold text-xl mb-4">Settings & Gear</h2>
            
            <div id="equip-settings-list" class="space-y-2 mb-6">
                </div>

            <div class="space-y-3 pt-4 border-t border-gray-100 dark:border-gray-800">
                <button onclick="exportData()" class="w-full bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 font-bold py-3 rounded-lg border border-blue-100 dark:border-blue-900 text-sm">Backup Data</button>
                <label class="block w-full cursor-pointer">
                    <div class="w-full bg-gray-50 dark:bg-gray-800 text-gray-600 dark:text-gray-300 font-bold py-3 rounded-lg border border-gray-200 dark:border-gray-700 text-sm text-center">Restore Data</div>
                    <input type="file" onchange="importData(this)" class="hidden" accept=".json">
                </label>
                <button onclick="promptResetApp()" class="w-full text-red-500 text-xs font-bold py-3">Factory Reset</button>
            </div>
            <button onclick="toggleSettings()" class="mt-6 w-full bg-gray-900 dark:bg-white text-white dark:text-black font-bold py-3 rounded-lg">Close</button>
        </div>
    </div>

    <script>
        const muscleThemes = {
            'Chest': 'bg-blue-50 dark:bg-blue-900/10 border-blue-500 text-blue-900 dark:text-blue-100',
            'Back': 'bg-purple-50 dark:bg-purple-900/10 border-purple-500 text-purple-900 dark:text-purple-100',
            'Legs': 'bg-red-50 dark:bg-red-900/10 border-red-500 text-red-900 dark:text-red-100',
            'Arms': 'bg-pink-50 dark:bg-pink-900/10 border-pink-500 text-pink-900 dark:text-pink-100',
            'Shoulders': 'bg-indigo-50 dark:bg-indigo-900/10 border-indigo-500 text-indigo-900 dark:text-indigo-100',
            'Core': 'bg-emerald-50 dark:bg-emerald-900/10 border-emerald-500 text-emerald-900 dark:text-emerald-100',
            'Neck': 'bg-gray-50 dark:bg-gray-800 border-gray-400 text-gray-900 dark:text-gray-100'
        };
        
        // Gear Icons Map
        const gearIcons = {
            'None': '<i class="fa-solid fa-person text-gray-400"></i>',
            'Dumbbells': '<i class="fa-solid fa-dumbbell text-blue-500"></i>',
            'Bands': '<i class="fa-solid fa-infinity text-purple-500"></i>',
            'Barbell': '<i class="fa-solid fa-weight-hanging text-red-500"></i>',
            'Pullup Bar': '<i class="fa-solid fa-up-long text-green-500"></i>'
        };

        const dailyTips = ["Drink 16oz water immediately.", "20-30g protein after training.", "Aim for 7-8h sleep.", "Creatine helps brain & muscle.", "Cut liquid sugar.", "Dynamic warmups, Static cooldowns.", "Consistency > Intensity.", "Magnesium for sleep.", "Pinch of salt for hydration.", "Track your lifts."];
        
        const exerciseLibrary = [
            // CHEST
            { id: 'pushup_std', name: 'Standard Pushups', muscle: 'Chest', equipment: 'None', howTo: 'Plank position. Lower chest.', benefit: 'Mass & Core.', videoUrl: "" },
            { id: 'db_press', name: 'DB Floor Press', muscle: 'Chest', equipment: 'Dumbbells', howTo: 'Lie back. Press up.', benefit: 'Heavy loading.', videoUrl: "" },
            { id: 'barbell_bench', name: 'Barbell Bench Press', muscle: 'Chest', equipment: 'Barbell', howTo: 'Lie on bench. Lower bar to chest. Press.', benefit: 'King of chest moves.', videoUrl: "" },
            { id: 'band_fly', name: 'Band Flys', muscle: 'Chest', equipment: 'Bands', howTo: 'Hug a tree motion.', benefit: 'Isolation.', videoUrl: "" },
            // BACK
            { id: 'pullup', name: 'Pull-ups', muscle: 'Back', equipment: 'Pullup Bar', howTo: 'Chin over bar.', benefit: 'V-Taper.', videoUrl: "" },
            { id: 'db_row', name: 'DB Row', muscle: 'Back', equipment: 'Dumbbells', howTo: 'Pull weight to hip.', benefit: 'Thick Back.', videoUrl: "" },
            { id: 'barbell_row', name: 'Barbell Row', muscle: 'Back', equipment: 'Barbell', howTo: 'Bent over. Pull bar to waist.', benefit: 'Back density.', videoUrl: "" },
            { id: 'band_row', name: 'Seated Band Row', muscle: 'Back', equipment: 'Bands', howTo: 'Legs straight. Pull band.', benefit: 'Posture.', videoUrl: "" },
            // LEGS
            { id: 'goblet_squat', name: 'Goblet Squat', muscle: 'Legs', equipment: 'Dumbbells', howTo: 'Hold weight at chest. Squat.', benefit: 'Legs & Core.', videoUrl: "" },
            { id: 'barbell_squat', name: 'Barbell Back Squat', muscle: 'Legs', equipment: 'Barbell', howTo: 'Bar on traps. Squat deep.', benefit: 'Overall mass.', videoUrl: "" },
            { id: 'barbell_dl', name: 'Deadlift', muscle: 'Legs', equipment: 'Barbell', howTo: 'Lift bar from floor to hip.', benefit: 'Posterior chain.', videoUrl: "" },
            { id: 'squat_jump', name: 'Jump Squats', muscle: 'Legs', equipment: 'None', howTo: 'Explode up.', benefit: 'Power.', videoUrl: "" },
            // SHOULDERS
            { id: 'barbell_ohp', name: 'Overhead Press', muscle: 'Shoulders', equipment: 'Barbell', howTo: 'Press bar overhead.', benefit: 'Shoulder strength.', videoUrl: "" },
            { id: 'lat_raise', name: 'Lateral Raise', muscle: 'Shoulders', equipment: 'Dumbbells', howTo: 'Raise arms to side.', benefit: 'Width.', videoUrl: "" },
            // ARMS & CORE
            { id: 'curl_bar', name: 'Barbell Curl', muscle: 'Arms', equipment: 'Barbell', howTo: 'Curl bar up.', benefit: 'Bicep Mass.', videoUrl: "" },
            { id: 'plank', name: 'Plank', muscle: 'Core', equipment: 'None', howTo: 'Hold straight line.', benefit: 'Stability.', videoUrl: "" },
            { id: 'leg_raise', name: 'Leg Raises', muscle: 'Core', equipment: 'None', howTo: 'Lift legs.', benefit: 'Lower Abs.', videoUrl: "" },
            // MOBILITY
            { id: 'neck_roll', name: 'Neck Rolls', muscle: 'Neck', equipment: 'None', howTo: 'Roll head.', benefit: 'Tension relief.', videoUrl: "" },
            { id: 'cat_cow', name: 'Cat-Cow', muscle: 'Back', equipment: 'None', howTo: 'Arch/Sink spine.', benefit: 'Mobility.', videoUrl: "" },
            { id: 'child_pose', name: 'Childs Pose', muscle: 'Back', equipment: 'None', howTo: 'Sit on heels.', benefit: 'Decompress.', videoUrl: "" },
            { id: 'butterfly', name: 'Butterfly', muscle: 'Legs', equipment: 'None', howTo: 'Feet together.', benefit: 'Hips.', videoUrl: "" },
            { id: 'thoracic_twist', name: 'T-Spine Twist', muscle: 'Back', equipment: 'None', howTo: 'Reach sky.', benefit: 'Mobility.', videoUrl: "" },
            { id: 'forward_fold', name: 'Forward Fold', muscle: 'Legs', equipment: 'None', howTo: 'Touch toes.', benefit: 'Hamstrings.', videoUrl: "" }
        ];
        const staticPlans = { 'plan_full_body': ['squat_jump', 'pushup_std', 'pullup', 'plank'], 'plan_lower_mass': ['goblet_squat', 'squat_jump', 'plank'] };
        const routineFlows = { 'morning': ['neck_roll', 'cat_cow', 'thoracic_twist', 'squat_jump'], 'night': ['child_pose', 'butterfly', 'forward_fold', 'neck_roll'] };

        let state = { user: { level: 1, xp: 0, streak: 0, audioOn: true, darkMode: false }, activePlan: { id: null, name: null, progress: 0, total: 12 }, equipment: { 'Dumbbells': true, 'Bands': true, 'Pullup Bar': true, 'Barbell': true }, exerciseData: {}, history: [], customRoutines: [] };
        let session = { exercises: [], isPlan: false, timerInt: null };
        let selectedMuscles = [];
        let audioCtx = null; let wakeLock = null;

        function init() {
            const saved = localStorage.getItem('fitLogicData_v13');
            if (saved) state = JSON.parse(saved);
            // Ensure new gear keys exist if loading old data
            if(state.equipment.Bands === undefined) state.equipment.Bands = true;
            if(state.equipment.Barbell === undefined) state.equipment.Barbell = true;
            if(!state.customRoutines) state.customRoutines = [];
            
            if(state.user.darkMode) document.documentElement.classList.add('dark');
            updateThemeIcon(); updateDashboard(); renderEquipmentToggles(); renderTip(); renderWeekVisualizer(); updateAudioBtn(); renderCustomRoutines();
        }

        // --- CUSTOM ROUTINES ---
        function openBuilder() {
            const list = document.getElementById('builder-list');
            list.innerHTML = '';
            const groups = {};
            exerciseLibrary.forEach(ex => { if(!groups[ex.muscle]) groups[ex.muscle] = []; groups[ex.muscle].push(ex); });
            
            Object.keys(groups).forEach(muscle => {
                const grp = document.createElement('div');
                grp.innerHTML = `<h4 class="font-bold text-sm text-gray-800 dark:text-gray-200 mb-2 mt-4 uppercase tracking-wider">${muscle}</h4>`;
                groups[muscle].forEach(ex => {
                    const pr = state.exerciseData[ex.id] ? state.exerciseData[ex.id].reps : 0;
                    const icon = gearIcons[ex.equipment] || '';
                    grp.innerHTML += `
                    <label class="flex items-center gap-3 p-3 bg-white dark:bg-darkcard rounded-xl border border-gray-100 dark:border-gray-800 mb-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                        <input type="checkbox" value="${ex.id}" class="builder-check w-5 h-5 accent-blue-500 rounded">
                        <div class="flex-1">
                            <div class="font-bold text-sm flex items-center gap-2">${ex.name} <span class="text-xs">${icon}</span></div>
                            <div class="text-[10px] text-gray-400">PR: ${pr > 0 ? pr + ' Reps' : '-'}</div>
                        </div>
                    </label>`;
                });
                list.appendChild(grp);
            });
            document.getElementById('builder-modal').classList.remove('hidden');
        }

        function saveCustomRoutine() {
            const name = document.getElementById('builder-name').value;
            if(!name) return alert("Please name your routine");
            const checks = document.querySelectorAll('.builder-check:checked');
            if(checks.length === 0) return alert("Select at least 1 exercise");
            const selectedIds = Array.from(checks).map(c => c.value);
            state.customRoutines.push({ id: Date.now(), name: name, exercises: selectedIds });
            saveData(); closeBuilder(); renderCustomRoutines();
        }
        function closeBuilder() { document.getElementById('builder-modal').classList.add('hidden'); document.getElementById('builder-name').value = ''; }
        function renderCustomRoutines() {
            const list = document.getElementById('custom-routines-list'); const msg = document.getElementById('no-custom-msg');
            list.innerHTML = '';
            if(!state.customRoutines || state.customRoutines.length === 0) { msg.classList.remove('hidden'); return; }
            msg.classList.add('hidden');
            state.customRoutines.forEach(r => {
                const el = document.createElement('div');
                el.className = 'bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm flex justify-between items-center border border-gray-100 dark:border-gray-800';
                el.innerHTML = `<div><h4 class="font-bold">${r.name}</h4><p class="text-xs text-gray-500">${r.exercises.length} Exercises</p></div><div class="flex gap-2"><button onclick="deleteCustomRoutine(${r.id})" class="text-gray-300 hover:text-red-500 p-2"><i class="fa-solid fa-trash"></i></button><button onclick="startCustomRoutine(${r.id})" class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-4 py-2 rounded-lg text-xs font-bold">Start</button></div>`;
                list.appendChild(el);
            });
        }
        function deleteCustomRoutine(id) { if(confirm("Delete?")) { state.customRoutines = state.customRoutines.filter(r => r.id !== id); saveData(); renderCustomRoutines(); } }
        function startCustomRoutine(id) {
            const routine = state.customRoutines.find(r => r.id === id);
            session.exercises = routine.exercises.map(exId => {
                const ex = exerciseLibrary.find(e => e.id === exId);
                const hist = state.exerciseData[ex.id] || { reps: 10, rest: 45 };
                return { ...ex, targetReps: hist.reps, targetRest: hist.rest, sets: 3, completedSets: 0 };
            });
            session.isPlan = false; startWorkoutUI(routine.name);
        }

        // --- DASHBOARD & GEAR ---
        function updateDashboard() {
            document.getElementById('streakDisplay').innerText = state.user.streak; document.getElementById('userLevel').innerText = "Lvl " + state.user.level;
            const planCard = document.getElementById('active-plan-card'); const planLib = document.getElementById('plan-library');
            if (state.activePlan && state.activePlan.id) { planCard.classList.remove('hidden'); planLib.classList.add('hidden'); document.getElementById('planNameDisplay').innerText = state.activePlan.name; document.getElementById('planProgressText').innerText = `Workout ${state.activePlan.progress + 1} of ${state.activePlan.total}`; document.getElementById('planProgressBar').style.width = `${(state.activePlan.progress / state.activePlan.total) * 100}%`; }
            else { planCard.classList.add('hidden'); planLib.classList.remove('hidden'); }
            const histEl = document.getElementById('historyLog'); histEl.innerHTML = state.history.length ? '' : '<p class="text-center text-gray-400 dark:text-gray-500 text-xs py-4">No workouts yet.</p>';
            state.history.slice(0, 5).forEach((log, idx) => { histEl.innerHTML += `<div class="flex justify-between items-center bg-white dark:bg-darkcard p-3 rounded-xl border border-gray-100 dark:border-gray-800 shadow-sm mb-2"><div><p class="text-sm font-bold">${log.title}</p><p class="text-[10px] text-gray-400">${new Date(log.date).toLocaleDateString()}</p></div><div class="flex items-center gap-3"><span class="text-xs font-bold text-blue-500">+${log.xp} XP</span><button onclick="deleteHistoryItem(${idx})" class="text-gray-300 hover:text-red-500 text-xs"><i class="fa-solid fa-trash"></i></button></div></div>`; });
            renderWeekVisualizer();
        }
        function deleteHistoryItem(index) { showModal("Delete?", "Remove entry?", [{ text: "Cancel", class: "bg-gray-100 dark:bg-gray-800" }, { text: "Delete", class: "bg-red-500 text-white", action: () => { state.history.splice(index, 1); saveData(); updateDashboard(); }}]); }

        function renderEquipmentToggles() {
            // Render in Settings Modal
            const sList = document.getElementById('equip-settings-list');
            sList.innerHTML = '';
            Object.keys(state.equipment).forEach(i => {
                sList.innerHTML += `<label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-xl cursor-pointer"><span class="text-sm font-bold text-gray-700 dark:text-gray-300">${i}</span><div class="relative inline-block w-10 align-middle select-none"><input type="checkbox" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" ${state.equipment[i]?'checked':''} onchange="toggleEquipment('${i}')"/><label class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label></div></label>`;
            });
            // Render in Freestyle Options (Short list)
            const fList = document.getElementById('equip-options');
            fList.innerHTML = '';
            Object.keys(state.equipment).forEach(i => {
                fList.innerHTML += `<label class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded-lg cursor-pointer"><span class="text-xs font-bold text-gray-700 dark:text-gray-300">${i}</span><input type="checkbox" class="accent-blue-500 w-4 h-4" ${state.equipment[i]?'checked':''} onchange="toggleEquipment('${i}')"></label>`;
            });
        }
        function toggleEquipment(i) { state.equipment[i] = !state.equipment[i]; saveData(); renderEquipmentToggles(); }
        
        // --- CORE FUNCTIONS ---
        function showModal(title, message, buttons) { const m = document.getElementById('custom-modal'); document.getElementById('modal-title').innerText = title; document.getElementById('modal-message').innerText = message; const c = document.getElementById('modal-buttons'); c.innerHTML = ''; buttons.forEach(b => { const btn = document.createElement('button'); btn.innerText = b.text; btn.className = `w-full py-3 rounded-xl font-bold text-sm ${b.class}`; btn.onclick = () => { m.classList.add('hidden'); if (b.action) b.action(); }; c.appendChild(btn); }); m.classList.remove('hidden'); }
        function promptFinishWorkout() { showModal("Finish Workout?", "Ready to save?", [{ text: "No", class: "bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300" }, { text: "Yes", class: "bg-green-500 text-white", action: executeFinish }]); }
        function promptCloseWorkout() { showModal("Exit Session?", "Unsaved progress.", [{ text: "Resume", class: "bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300" }, { text: "Exit", class: "bg-red-500 text-white", action: executeClose }]); }
        function promptStartPlan(id, name) { showModal("Start Plan?", name, [{ text: "Cancel", class: "bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300" }, { text: "Start", class: "bg-blue-600 text-white", action: () => { state.activePlan = { id: id, name: name, progress: 0, total: 12 }; saveData(); updateDashboard(); } }]); }
        function promptQuitPlan() { showModal("Quit Plan?", "Lose progress?", [{ text: "Keep", class: "bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300" }, { text: "Quit", class: "bg-red-500 text-white", action: () => { state.activePlan = { id: null, name: null, progress: 0, total: 0 }; saveData(); updateDashboard(); } }]); }
        function promptResetApp() { showModal("Factory Reset?", "Delete ALL data?", [{ text: "Cancel", class: "bg-gray-100 dark:bg-gray-800" }, { text: "Delete", class: "bg-red-600 text-white", action: () => { localStorage.removeItem('fitLogicData_v13'); location.reload(); } }]); }
        function promptRate(idx, rating) { const t = rating === 'easy' ? 'Too Easy?' : 'Too Hard?'; const c = rating === 'easy' ? 'Reps +2, Rest -5s' : 'Reps -2, Rest +10s'; showModal(t, `Next: ${c}`, [{ text: "Cancel", class: "bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300" }, { text: "Confirm", class: "bg-blue-600 text-white", action: () => executeRate(idx, rating) }]); }

        function executeFinish() { confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } }); const xp = 100 + (session.exercises.length * 10); state.user.xp += xp; state.user.streak++; state.user.level = Math.floor(state.user.xp / 500) + 1; if (session.isPlan) { state.activePlan.progress++; if(state.activePlan.progress >= state.activePlan.total) { state.activePlan = { id: null, name: null, progress: 0, total: 0 }; showModal("Plan Complete!", "Dedication pays off.", [{text:"Awesome", class:"bg-blue-600 text-white", action:()=>location.reload()}]); return; } } state.history.unshift({ date: Date.now(), title: document.getElementById('workoutTitle').innerText, xp: xp }); saveData(); releaseWakeLock(); setTimeout(() => location.reload(), 1500); }
        function executeClose() { document.getElementById('workout-modal').classList.add('hidden'); clearInterval(session.timerInt); releaseWakeLock(); }
        function executeRate(idx, rating) { const exId = session.exercises[idx].id; if (!state.exerciseData[exId]) state.exerciseData[exId] = { reps: 10, rest: 45 }; let repChange = rating === 'easy' ? 2 : -2; let restChange = rating === 'easy' ? -5 : 10; state.exerciseData[exId].reps = Math.max(5, state.exerciseData[exId].reps + repChange); state.exerciseData[exId].rest = Math.max(15, Math.min(120, state.exerciseData[exId].rest + restChange)); saveData(); session.exercises[idx].targetReps = state.exerciseData[exId].reps; session.exercises[idx].targetRest = state.exerciseData[exId].rest; renderExercises(); }

        function renderExercises() {
            const container = document.getElementById('workout-content'); container.innerHTML = '';
            session.exercises.forEach((ex, idx) => {
                let checks = '';
                for(let i=0; i<ex.sets; i++) { const isDone = i < ex.completedSets; checks += `<div onclick="completeSet(${idx}, ${i})" class="h-8 w-8 rounded-full border-2 flex items-center justify-center cursor-pointer ${isDone ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 dark:border-gray-600 text-gray-300 dark:text-gray-600'}">${i+1}</div>`; }
                const theme = muscleThemes[ex.muscle] || 'bg-gray-50 dark:bg-gray-800 border-gray-400';
                const icon = gearIcons[ex.equipment] || '';
                container.innerHTML += `
                <div class="${theme} p-5 border-l-4 mb-4 rounded-xl shadow-sm relative overflow-hidden">
                    <div class="flex justify-between items-start"><div class="flex items-center gap-2"><h4 class="font-bold text-lg">${ex.name}</h4><span class="text-sm bg-white/50 dark:bg-black/20 p-1 rounded">${icon}</span></div><span class="text-[10px] font-bold opacity-70 uppercase tracking-widest">${ex.muscle}</span></div>
                    <p class="text-xs opacity-80 mt-1">${ex.howTo}</p>
                    <div class="mt-3 flex gap-2 justify-center">${checks}</div>
                    <div class="flex justify-between mt-2 px-4 text-xs font-bold opacity-90"><span>Target: <span id="target-${idx}">${ex.targetReps} Reps</span></span><span>Rest: ${ex.targetRest}s</span></div>
                    <div class="mt-3 pt-3 border-t border-black/10 dark:border-white/10 flex justify-between items-center"><span class="text-[10px] opacity-70">Difficulty:</span><div class="flex gap-1"><button onclick="promptRate(${idx}, 'easy')" class="px-3 py-1 bg-white/50 dark:bg-black/20 text-[10px] rounded hover:bg-white font-bold transition-colors">Too Easy</button><button onclick="promptRate(${idx}, 'hard')" class="px-3 py-1 bg-white/50 dark:bg-black/20 text-[10px] rounded hover:bg-white font-bold transition-colors">Too Hard</button></div></div>
                </div>`;
            });
        }

        // --- UTILS ---
        function toggleDarkMode() { state.user.darkMode = !state.user.darkMode; if(state.user.darkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); updateThemeIcon(); saveData(); }
        function updateThemeIcon() { document.getElementById('themeIcon').className = state.user.darkMode ? 'fa-solid fa-sun text-xl' : 'fa-solid fa-moon text-xl'; }
        function renderWeekVisualizer() { const c = document.getElementById('week-visualizer'); const d = ['S','M','T','W','T','F','S']; const today = new Date(); let h = ''; for(let i=0; i<7; i++) { const isT = (i === today.getDay()); let cls = "bg-gray-100 dark:bg-gray-800 text-gray-300 dark:text-gray-600"; if(isT) { const w = state.history.some(l => new Date(l.date).toDateString() === today.toDateString()); cls = w ? "bg-green-500 text-white" : "bg-blue-100 dark:bg-blue-900 text-blue-500 border-2 border-blue-500"; } h += `<div class="flex flex-col items-center gap-1"><div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${cls}">${d[i]}</div></div>`; } c.innerHTML = h; }
        function renderTip() { document.getElementById('dailyTipText').innerText = dailyTips[Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000) % dailyTips.length]; }
        function toggleMuscle(b, m) { b.classList.toggle('selected'); if(selectedMuscles.includes(m)) selectedMuscles = selectedMuscles.filter(x=>x!==m); else selectedMuscles.push(m); }
        function requestWakeLock() { if ('wakeLock' in navigator) navigator.wakeLock.request('screen').then(w => wakeLock = w).catch(() => {}); }
        function releaseWakeLock() { if (wakeLock) { wakeLock.release(); wakeLock = null; } }
        function playBeep(f) { if(!state.user.audioOn)return; if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type='sine';o.frequency.setValueAtTime(f,audioCtx.currentTime);g.gain.setValueAtTime(0.1,audioCtx.currentTime);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.1); }
        function toggleAudio() { state.user.audioOn = !state.user.audioOn; updateAudioBtn(); saveData(); if(!audioCtx)audioCtx=new AudioContext(); }
        function updateAudioBtn() { document.getElementById('audioBtn').innerHTML = state.user.audioOn ? '<i class="fa-solid fa-volume-high"></i> Sound On' : '<i class="fa-solid fa-volume-xmark"></i> Sound Off'; }
        function startRoutine(type) { const flow = routineFlows[type]; session.exercises = flow.map(id => { const ex = exerciseLibrary.find(e => e.id === id); return { ...ex, targetReps: "1 Set", targetRest: 10, sets: 1, completedSets: 0 }; }); session.isPlan = false; startWorkoutUI(`${type === 'morning' ? 'Morning' : 'Night'} Flow`); }
        function generateWorkout(mode) {
            let list = []; session.isPlan = (mode === 'plan');
            if (session.isPlan) { staticPlans[state.activePlan.id].forEach(id => { const ex = exerciseLibrary.find(e => e.id === id); if(ex) { if(ex.equipment !== 'None' && !state.equipment[ex.equipment]) { const sub = exerciseLibrary.find(s => s.muscle === ex.muscle && (s.equipment === 'None' || state.equipment[s.equipment])); list.push(sub ? sub : ex); } else { list.push(ex); } } }); }
            else { const t = selectedMuscles.length > 0 ? selectedMuscles : ['Chest','Back','Legs','Core']; let p = exerciseLibrary.filter(ex => t.includes(ex.muscle) && (ex.equipment === 'None' || state.equipment[ex.equipment])); for(let i=0; i<4; i++) { if(p.length===0)break; const idx = Math.floor(Math.random()*p.length); list.push(p[idx]); p.splice(idx,1); } }
            if (list.length === 0) { alert("No exercises found!"); return; }
            session.exercises = list.map(ex => { const h = state.exerciseData[ex.id] || { reps: 10, rest: 45 }; return { ...ex, targetReps: h.reps, targetRest: h.rest, sets: 3, completedSets: 0 }; });
            startWorkoutUI(session.isPlan ? state.activePlan.name : "Freestyle Session");
        }
        function startWorkoutUI(t) { requestWakeLock(); document.getElementById('workout-modal').classList.remove('hidden'); document.getElementById('workoutTitle').innerText = t; if(session.timerInt) clearInterval(session.timerInt); let s=0; session.timerInt = setInterval(() => { s++; document.getElementById('sessionTimer').innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }, 1000); renderExercises(); }
        function completeSet(eI, sI) { if (sI === session.exercises[eI].completedSets) { session.exercises[eI].completedSets++; renderExercises(); triggerRest(session.exercises[eI].targetRest || 45, "Next Set"); } }
        let restInt = null;
        function triggerRest(s, t) { const o = document.getElementById('rest-overlay'); const d = document.getElementById('rest-countdown'); document.getElementById('up-next-text').innerText = t; o.classList.remove('hidden'); let l = s; d.innerText = fmt(l); if(restInt) clearInterval(restInt); restInt = setInterval(() => { l--; d.innerText = fmt(l); if(l<=3 && l>0) playBeep(440); if(l===0) { playBeep(880); skipRest(); } }, 1000); }
        function fmt(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        function addRest(s) { triggerRest(parseInt(document.getElementById('rest-countdown').innerText.split(':')[1]) + s, document.getElementById('up-next-text').innerText); }
        function skipRest() { document.getElementById('rest-overlay').classList.add('hidden'); if(restInt) clearInterval(restInt); }
        function saveData() { localStorage.setItem('fitLogicData_v13', JSON.stringify(state)); }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function exportData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); a.download = "fitlogic_backup.json"; document.body.appendChild(a); a.click(); a.remove(); }
        function importData(input) { const r = new FileReader(); r.onload = (e) => { state = JSON.parse(e.target.result); saveData(); location.reload(); }; r.readAsText(input.files[0]); }
        
        init();
    </script>
</body>
</html>
