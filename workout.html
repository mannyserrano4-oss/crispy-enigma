<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FitLogic">
    
    <title>FitLogic 9.0 | Holistic</title>
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F2F2F7; color: #1C1C1E; -webkit-tap-highlight-color: transparent; }
        .page-transition { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .muscle-btn.selected { background-color: #007AFF; color: white; border-color: #007AFF; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-10px)} 100% {opacity: 1; transform: translateY(0)} }
        .toggle-checkbox:checked { right: 0; border-color: #34C759; }
        .toggle-checkbox:checked + .toggle-label { background-color: #34C759; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="min-h-screen pb-32">

    <div id="app-header" class="bg-white/90 backdrop-blur sticky top-0 z-30 px-6 py-4 pt-12 shadow-sm flex justify-between items-center">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight text-gray-900">FitLogic <span class="text-blue-600">9.0</span></h1>
            <p class="text-xs text-gray-500 font-medium" id="currentDate">Today</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-1 bg-orange-100 px-3 py-1 rounded-full border border-orange-200">
                <i class="fa-solid fa-fire text-orange-500 text-sm"></i>
                <span id="streakDisplay" class="text-xs font-bold text-orange-700">0</span>
            </div>
            <div class="relative w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center border-2 border-white shadow-sm cursor-pointer hover:scale-105 transition-transform" onclick="toggleSettings()">
                <span id="userLevel" class="text-xs font-bold text-blue-600">Lvl 1</span>
            </div>
        </div>
    </div>

    <div id="main-container" class="p-6 space-y-6 max-w-lg mx-auto page-transition">

        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-4 text-white shadow-lg relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex items-center gap-2 mb-2">
                    <span class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">Tip of the Day</span>
                </div>
                <p class="text-sm font-medium leading-relaxed" id="dailyTipText">Loading tip...</p>
            </div>
            <i class="fa-solid fa-lightbulb absolute -bottom-4 -right-2 text-8xl text-white/10 rotate-12"></i>
        </div>

        <div>
            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2">Daily Habits (5 Mins)</h3>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="startRoutine('morning')" class="card p-4 flex flex-col items-center justify-center gap-2 hover:bg-yellow-50 transition-colors border-b-4 border-yellow-400">
                    <i class="fa-solid fa-sun text-2xl text-yellow-500"></i>
                    <span class="text-xs font-bold text-gray-800">Morning Flow</span>
                </button>
                <button onclick="startRoutine('night')" class="card p-4 flex flex-col items-center justify-center gap-2 hover:bg-indigo-50 transition-colors border-b-4 border-indigo-400">
                    <i class="fa-solid fa-moon text-2xl text-indigo-500"></i>
                    <span class="text-xs font-bold text-gray-800">Sleep Stretch</span>
                </button>
            </div>
        </div>

        <div id="active-plan-card" class="hidden">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">My Active Plan</h3>
                <button onclick="quitPlan()" class="text-[10px] text-red-400 font-bold hover:text-red-600">Quit Plan</button>
            </div>
            <div class="card p-5 border-2 border-blue-500/20 bg-blue-50/50 relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-xl font-extrabold text-gray-900" id="planNameDisplay">Chest Builder</h2>
                    <p class="text-xs text-blue-600 font-bold mt-1 mb-4" id="planProgressText">Workout 3 of 12</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                        <div id="planProgressBar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    <button onclick="generateWorkout('plan')" class="w-full bg-blue-600 text-white rounded-xl py-3 shadow-md active:scale-95 transition-transform font-bold flex items-center justify-center gap-2">
                        <i class="fa-solid fa-play"></i> Start Next Workout
                    </button>
                </div>
                <i class="fa-solid fa-trophy absolute -bottom-4 -right-4 text-8xl text-blue-100 z-0 opacity-50"></i>
            </div>
        </div>

        <div id="plan-library" class="hidden">
            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2">Available Plans (4 Weeks)</h3>
            <div class="space-y-3">
                <div class="card p-4 flex justify-between items-center">
                    <div><h4 class="font-bold text-gray-900">Full Body Alpha</h4><p class="text-xs text-gray-500">3x/Week • Strength</p></div>
                    <button onclick="startPlan('plan_full_body', 'Full Body Alpha')" class="bg-black text-white px-4 py-2 rounded-lg text-xs font-bold active:scale-95">Start</button>
                </div>
                <div class="card p-4 flex justify-between items-center">
                    <div><h4 class="font-bold text-gray-900">Thick Thighs</h4><p class="text-xs text-gray-500">3x/Week • Legs</p></div>
                    <button onclick="startPlan('plan_lower_mass', 'Thick Thighs')" class="bg-black text-white px-4 py-2 rounded-lg text-xs font-bold active:scale-95">Start</button>
                </div>
            </div>
        </div>

        <hr class="border-gray-200">

        <div>
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Freestyle</h3>
                <button onclick="document.getElementById('freestyle-opts').classList.toggle('hidden')" class="text-xs text-blue-500 font-bold">Show Options</button>
            </div>
            
            <div id="freestyle-opts" class="card p-5 mb-4 space-y-4 hidden">
                <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('equip-options').classList.toggle('hidden')">
                    <h3 class="font-bold text-gray-800 text-sm"><i class="fa-solid fa-toolbox text-gray-500 mr-2"></i>My Gear</h3>
                    <i class="fa-solid fa-chevron-down text-gray-400 text-xs"></i>
                </div>
                <div id="equip-options" class="hidden grid grid-cols-2 gap-2 pt-2 border-t border-gray-100"></div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Duration</label>
                    <select id="durationSelector" class="w-full bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg p-2.5">
                        <option value="10">10 Mins</option>
                        <option value="20" selected>20 Mins</option>
                        <option value="30">30 Mins</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Targets</label>
                    <div class="grid grid-cols-3 gap-2" id="muscle-selector">
                        <button onclick="toggleMuscle(this, 'Chest')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-2 text-xs font-bold text-gray-600 shadow-sm">Chest</button>
                        <button onclick="toggleMuscle(this, 'Back')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-2 text-xs font-bold text-gray-600 shadow-sm">Back</button>
                        <button onclick="toggleMuscle(this, 'Legs')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-2 text-xs font-bold text-gray-600 shadow-sm">Legs</button>
                        <button onclick="toggleMuscle(this, 'Arms')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-2 text-xs font-bold text-gray-600 shadow-sm">Arms</button>
                        <button onclick="toggleMuscle(this, 'Core')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-2 text-xs font-bold text-gray-600 shadow-sm">Core</button>
                        <button onclick="toggleMuscle(this, 'Shoulders')" class="muscle-btn bg-white border border-gray-200 rounded-xl py-2 text-xs font-bold text-gray-600 shadow-sm">Shoulders</button>
                    </div>
                </div>
            </div>

            <button onclick="generateWorkout('freestyle')" class="w-full bg-white border-2 border-gray-200 text-gray-700 rounded-2xl py-4 font-bold shadow-sm active:scale-95 transition-transform">
                <i class="fa-solid fa-shuffle mr-2"></i> Random Workout
            </button>
        </div>
        
        <div id="historyLog" class="space-y-2 pb-10"></div>
    </div>

    <div id="workout-modal" class="fixed inset-0 bg-white z-50 hidden flex flex-col pt-12">
        <div class="bg-white border-b border-gray-100 p-4 flex justify-between items-center shadow-sm z-10">
            <button onclick="closeWorkout()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="text-center">
                <h2 class="font-bold text-lg" id="workoutTitle">Session</h2>
                <div class="text-[10px] text-gray-400" id="workoutSubtitle"></div>
            </div>
            <div class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600" id="sessionTimer">00:00</div>
        </div>
        <div id="workout-content" class="flex-1 overflow-y-auto p-6 space-y-6 pb-40 bg-gray-50"></div>
        <div class="absolute bottom-0 w-full bg-white border-t border-gray-200 p-4 safe-pb">
             <button onclick="finishWorkout()" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl shadow-md active:scale-95 transition-transform">
                Finish <i class="fa-solid fa-check ml-2"></i>
            </button>
        </div>
    </div>

    <div id="rest-overlay" class="fixed inset-0 bg-black/95 z-[60] hidden flex flex-col items-center justify-center text-white">
        <div class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Recover</div>
        <div class="text-7xl font-mono font-bold mb-8 transition-all" id="rest-countdown">00:45</div>
        <div class="flex gap-4">
            <button onclick="addRest(15)" class="px-6 py-2 rounded-full border border-white/30 text-sm hover:bg-white/10">+15s</button>
            <button onclick="skipRest()" class="px-6 py-2 rounded-full bg-white text-black font-bold text-sm">Resume</button>
        </div>
        <div class="mt-8 text-center px-6">
            <p class="text-xs text-gray-500 uppercase mb-2">Up Next:</p>
            <p class="text-lg font-bold text-blue-400" id="up-next-text">Next Exercise</p>
        </div>
        <div class="mt-8">
            <button onclick="toggleAudio()" id="audioBtn" class="text-gray-500 text-sm"><i class="fa-solid fa-volume-high"></i> Sound On</button>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h2 class="font-bold text-xl mb-4">Settings</h2>
            <div class="space-y-3">
                <button onclick="exportData()" class="w-full bg-blue-50 text-blue-600 font-bold py-3 rounded-lg border border-blue-100 text-sm">Backup Data</button>
                <label class="block w-full cursor-pointer">
                    <div class="w-full bg-gray-50 text-gray-600 font-bold py-3 rounded-lg border border-gray-200 text-sm text-center">Restore Data</div>
                    <input type="file" onchange="importData(this)" class="hidden" accept=".json">
                </label>
                <button onclick="resetApp()" class="w-full text-red-500 text-xs font-bold py-3">Factory Reset</button>
            </div>
            <button onclick="toggleSettings()" class="mt-6 w-full bg-gray-900 text-white font-bold py-3 rounded-lg">Close</button>
        </div>
    </div>

    <script>
        // --- DATA & TIPS ---
        const dailyTips = [
            "Drink 16oz of water immediately upon waking to kickstart metabolism.",
            "Eat 20-30g of protein within 2 hours of training to repair muscle.",
            "Sleep is when muscles grow. Aim for 7-8 hours tonight.",
            "Creatine Monohydrate is the most researched supplement for strength.",
            "Reduce liquid sugar (soda/juice) to cut empty calories easily.",
            "Dynamic stretching before workouts; Static stretching after.",
            "Consistency > Intensity. A bad workout is better than no workout.",
            "Magnesium before bed can improve sleep quality and recovery.",
            "Feeling weak? You might be dehydrated. Drink water + pinch of salt.",
            "Tracking your lifts is the only way to ensure Progressive Overload."
        ];

        const exerciseLibrary = [
            // Standard Library
            { id: 'pushup_std', name: 'Standard Pushups', muscle: 'Chest', equipment: 'None', howTo: 'Plank position. Lower chest to floor.', benefit: 'Builds mass and core stability.', videoUrl: "" },
            { id: 'db_press', name: 'Dumbbell Floor Press', muscle: 'Chest', equipment: 'Dumbbells', howTo: 'Lie on back. Press weights up.', benefit: 'Heavy loading safely.', videoUrl: "" },
            { id: 'pullup', name: 'Pull-ups', muscle: 'Back', equipment: 'Pullup Bar', howTo: 'Chin over bar.', benefit: 'V-taper builder.', videoUrl: "" },
            { id: 'db_row', name: 'DB Row', muscle: 'Back', equipment: 'Dumbbells', howTo: 'Hand on chair. Pull weight to hip.', benefit: 'Thickens mid-back.', videoUrl: "" },
            { id: 'goblet_squat', name: 'Goblet Squats', muscle: 'Legs', equipment: 'Dumbbells', howTo: 'Hold weight at chest. Squat deep.', benefit: 'Legs & Core.', videoUrl: "" },
            { id: 'squat_jump', name: 'Jump Squats', muscle: 'Legs', equipment: 'None', howTo: 'Squat and explode up.', benefit: 'Power & Cardio.', videoUrl: "" },
            { id: 'plank', name: 'Plank', muscle: 'Core', equipment: 'None', howTo: 'Elbows under shoulders. Hold.', benefit: 'Core stability.', videoUrl: "" },
            { id: 'leg_raise', name: 'Leg Raises', muscle: 'Core', equipment: 'None', howTo: 'Lie flat. Lift legs.', benefit: 'Lower abs.', videoUrl: "" },
            // NEW Mobility/Stretch Moves
            { id: 'neck_roll', name: 'Neck Rolls', muscle: 'Neck', equipment: 'None', howTo: 'Slowly roll head in circles. 30s each way.', benefit: 'Relieves desk tension.', videoUrl: "" },
            { id: 'cat_cow', name: 'Cat-Cow', muscle: 'Back', equipment: 'None', howTo: 'Hands/knees. Arch back up, then sink belly down.', benefit: 'Spine mobility.', videoUrl: "" },
            { id: 'child_pose', name: 'Childs Pose', muscle: 'Back', equipment: 'None', howTo: 'Kneel, sit on heels, reach arms forward.', benefit: 'Decompresses spine.', videoUrl: "" },
            { id: 'butterfly', name: 'Butterfly Stretch', muscle: 'Legs', equipment: 'None', howTo: 'Sit. Feet together. Push knees down.', benefit: 'Opens hips.', videoUrl: "" },
            { id: 'thoracic_twist', name: 'Thoracic Twists', muscle: 'Back', equipment: 'None', howTo: 'Hands/knees. Reach one arm to sky, look up.', benefit: 'Upper back mobility.', videoUrl: "" },
            { id: 'forward_fold', name: 'Forward Fold', muscle: 'Legs', equipment: 'None', howTo: 'Stand. Reach for toes. Relax neck.', benefit: 'Hamstring release.', videoUrl: "" }
        ];

        const staticPlans = {
            'plan_full_body': ['squat_jump', 'pushup_std', 'pullup', 'plank'],
            'plan_lower_mass': ['goblet_squat', 'squat_jump', 'plank']
        };

        const routineFlows = {
            'morning': ['neck_roll', 'cat_cow', 'thoracic_twist', 'squat_jump'],
            'night': ['child_pose', 'butterfly', 'forward_fold', 'neck_roll']
        };

        // --- STATE ---
        let state = {
            user: { level: 1, xp: 0, streak: 0, audioOn: true },
            activePlan: { id: null, name: null, progress: 0, total: 12 },
            equipment: { 'Dumbbells': true, 'Pullup Bar': true },
            exerciseData: {},
            history: []
        };
        let session = { exercises: [], isPlan: false, timerInt: null };
        let selectedMuscles = [];
        let audioCtx = null;
        let wakeLock = null;

        function init() {
            const saved = localStorage.getItem('fitLogicData_v9');
            if (saved) state = JSON.parse(saved);
            updateDashboard();
            renderEquipmentToggles();
            renderTip();
            updateAudioBtn();
        }

        // --- FEATURES ---
        function renderTip() {
            // Pick tip based on day of year so it rotates daily for everyone
            const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const tip = dailyTips[dayOfYear % dailyTips.length];
            document.getElementById('dailyTipText').innerText = tip;
        }

        function startRoutine(type) {
            const flow = routineFlows[type];
            session.exercises = flow.map(id => {
                const ex = exerciseLibrary.find(e => e.id === id);
                return { ...ex, targetReps: "1 Set", targetRest: 10, sets: 1, completedSets: 0 };
            });
            session.isPlan = false;
            startWorkoutUI(`${type === 'morning' ? 'Morning' : 'Night'} Flow`);
        }

        // --- STANDARD LOGIC ---
        function requestWakeLock() { if ('wakeLock' in navigator) navigator.wakeLock.request('screen').then(w => wakeLock = w).catch(() => {}); }
        function releaseWakeLock() { if (wakeLock) { wakeLock.release(); wakeLock = null; } }
        
        function playBeep(freq, type) {
            if (!state.user.audioOn) return;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type || 'sine';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }
        function toggleAudio() { state.user.audioOn = !state.user.audioOn; updateAudioBtn(); saveData(); if(!audioCtx) audioCtx = new AudioContext(); }
        function updateAudioBtn() { document.getElementById('audioBtn').innerHTML = state.user.audioOn ? '<i class="fa-solid fa-volume-high"></i> Sound On' : '<i class="fa-solid fa-volume-xmark"></i> Sound Off'; }

        function updateDashboard() {
            document.getElementById('streakDisplay').innerText = state.user.streak;
            document.getElementById('userLevel').innerText = "Lvl " + state.user.level;
            const planCard = document.getElementById('active-plan-card');
            const planLib = document.getElementById('plan-library');
            if (state.activePlan && state.activePlan.id) {
                planCard.classList.remove('hidden'); planLib.classList.add('hidden');
                document.getElementById('planNameDisplay').innerText = state.activePlan.name;
                document.getElementById('planProgressText').innerText = `Workout ${state.activePlan.progress + 1} of ${state.activePlan.total}`;
                document.getElementById('planProgressBar').style.width = `${(state.activePlan.progress / state.activePlan.total) * 100}%`;
            } else {
                planCard.classList.add('hidden'); planLib.classList.remove('hidden');
            }
            const histEl = document.getElementById('historyLog');
            histEl.innerHTML = state.history.length ? '' : '<p class="text-center text-gray-400 text-xs py-4">No workouts yet.</p>';
            state.history.slice(0, 3).forEach(log => {
                histEl.innerHTML += `<div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100 shadow-sm"><div><p class="text-sm font-bold">${log.title}</p><p class="text-[10px] text-gray-400">${new Date(log.date).toLocaleDateString()}</p></div><span class="text-xs font-bold text-blue-500">+${log.xp} XP</span></div>`;
            });
        }

        function renderEquipmentToggles() {
            const container = document.getElementById('equip-options'); container.innerHTML = '';
            Object.keys(state.equipment).forEach(item => {
                container.innerHTML += `<label class="flex items-center justify-between p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 border border-gray-200"><span class="text-xs font-bold text-gray-700">${item}</span><input type="checkbox" class="accent-blue-500 w-4 h-4" ${state.equipment[item] ? 'checked' : ''} onchange="toggleEquipment('${item}')"></label>`;
            });
        }
        function toggleEquipment(item) { state.equipment[item] = !state.equipment[item]; saveData(); }
        function toggleMuscle(btn, muscle) {
            btn.classList.toggle('selected');
            if (selectedMuscles.includes(muscle)) selectedMuscles = selectedMuscles.filter(m => m !== muscle); else selectedMuscles.push(muscle);
        }

        function startPlan(id, name) { if(confirm(`Start "${name}" plan?`)) { state.activePlan = { id: id, name: name, progress: 0, total: 12 }; saveData(); updateDashboard(); }}
        function quitPlan() { if(confirm("Quit plan?")) { state.activePlan = { id: null, name: null, progress: 0, total: 0 }; saveData(); updateDashboard(); }}

        function generateWorkout(mode) {
            let selectedList = [];
            session.isPlan = (mode === 'plan');
            if (session.isPlan) {
                const planIds = staticPlans[state.activePlan.id];
                planIds.forEach(id => {
                    const ex = exerciseLibrary.find(e => e.id === id);
                    if(ex) selectedList.push(ex);
                });
            } else {
                const targets = selectedMuscles.length > 0 ? selectedMuscles : ['Chest', 'Back', 'Legs', 'Core'];
                let pool = exerciseLibrary.filter(ex => targets.includes(ex.muscle));
                const num = 4; // Simple count for freestyle
                for (let i = 0; i < num; i++) {
                    if (pool.length === 0) break;
                    const idx = Math.floor(Math.random() * pool.length);
                    selectedList.push(pool[idx]); pool.splice(idx, 1);
                }
            }
            if (selectedList.length === 0) { alert("No exercises found!"); return; }
            session.exercises = selectedList.map(ex => {
                const hist = state.exerciseData[ex.id] || { reps: 10, rest: 45 };
                return { ...ex, targetReps: hist.reps, targetRest: hist.rest, sets: 3, completedSets: 0 };
            });
            startWorkoutUI(session.isPlan ? state.activePlan.name : "Freestyle Session");
        }

        function startWorkoutUI(title) {
            requestWakeLock();
            document.getElementById('workout-modal').classList.remove('hidden');
            document.getElementById('workoutTitle').innerText = title;
            if (session.timerInt) clearInterval(session.timerInt);
            let sec = 0;
            session.timerInt = setInterval(() => {
                sec++;
                const m = Math.floor(sec / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                document.getElementById('sessionTimer').innerText = `${m}:${s}`;
            }, 1000);
            renderExercises();
        }

        function renderExercises() {
            const container = document.getElementById('workout-content'); container.innerHTML = '';
            session.exercises.forEach((ex, idx) => {
                let checks = '';
                for(let i=0; i<ex.sets; i++) {
                    const isDone = i < ex.completedSets;
                    checks += `<div onclick="completeSet(${idx}, ${i})" class="h-8 w-8 rounded-full border-2 flex items-center justify-center cursor-pointer ${isDone ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 text-gray-300'}">${i+1}</div>`;
                }
                const repDisplay = isNaN(ex.targetReps) ? ex.targetReps : `${ex.targetReps} Reps`;
                const rateUI = session.isPlan || ex.sets > 1 ? `<div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center"><span class="text-[10px] text-gray-400">Rate:</span><div class="flex gap-1"><button onclick="rate(${idx}, 'easy')" class="px-3 py-1 bg-gray-100 text-[10px] rounded hover:bg-blue-100 font-bold">Too Easy</button><button onclick="rate(${idx}, 'hard')" class="px-3 py-1 bg-gray-100 text-[10px] rounded hover:bg-red-100 font-bold">Too Hard</button></div></div>` : '';
                
                container.innerHTML += `
                <div class="card p-5 border-l-4 border-blue-500 mb-4">
                    <div class="flex justify-between items-start"><h4 class="font-bold text-lg">${ex.name}</h4></div>
                    <p class="text-xs text-gray-500 mt-1">${ex.howTo}</p>
                    <div class="mt-3 flex gap-2 justify-center">${checks}</div>
                    <div class="flex justify-between mt-1 px-4 text-xs text-gray-400"><span>Target: <span id="target-${idx}" class="font-bold text-black">${repDisplay}</span></span><span>Rest: <span class="font-bold text-black">${ex.targetRest}s</span></span></div>
                    ${rateUI}
                </div>`;
            });
        }

        function completeSet(exIdx, setIdx) {
            if (setIdx === session.exercises[exIdx].completedSets) {
                session.exercises[exIdx].completedSets++;
                renderExercises();
                triggerRest(session.exercises[exIdx].targetRest || 45, "Next Set");
            }
        }

        function rate(idx, rating) {
            const exId = session.exercises[idx].id;
            if (!state.exerciseData[exId]) state.exerciseData[exId] = { reps: 10, rest: 45 };
            if (state.exerciseData[exId].rest === undefined) state.exerciseData[exId].rest = 45;
            let repChange = rating === 'easy' ? 2 : -2;
            let restChange = rating === 'easy' ? -5 : 10;
            state.exerciseData[exId].reps = Math.max(5, state.exerciseData[exId].reps + repChange);
            state.exerciseData[exId].rest = Math.max(15, Math.min(120, state.exerciseData[exId].rest + restChange));
            saveData();
            session.exercises[idx].targetReps = state.exerciseData[exId].reps;
            session.exercises[idx].targetRest = state.exerciseData[exId].rest;
            alert(`${rating === 'easy' ? 'Too Easy?' : 'Too Hard?'} Adjusting next round.\nRep Goal: ${repChange>0?'+':''}${repChange}\nRest: ${restChange>0?'+':''}${restChange}s`);
            renderExercises();
        }

        let restInt = null;
        function triggerRest(seconds, nextText) {
            const overlay = document.getElementById('rest-overlay');
            const display = document.getElementById('rest-countdown');
            document.getElementById('up-next-text').innerText = nextText;
            overlay.classList.remove('hidden');
            let timeLeft = seconds;
            display.innerText = `${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}`;
            if (restInt) clearInterval(restInt);
            restInt = setInterval(() => {
                timeLeft--;
                display.innerText = `${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}`;
                if (timeLeft <= 3 && timeLeft > 0) playBeep(440);
                if (timeLeft === 0) { playBeep(880); skipRest(); }
            }, 1000);
        }
        function addRest(s) { triggerRest(parseInt(document.getElementById('rest-countdown').innerText.split(':')[1]) + s, document.getElementById('up-next-text').innerText); }
        function skipRest() { document.getElementById('rest-overlay').classList.add('hidden'); if (restInt) clearInterval(restInt); }

        function finishWorkout() {
            if(!confirm("Finish & Save?")) return;
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
            const xp = 100 + (session.exercises.length * 10);
            state.user.xp += xp; state.user.streak++; state.user.level = Math.floor(state.user.xp / 500) + 1;
            if (session.isPlan) {
                state.activePlan.progress++;
                if(state.activePlan.progress >= state.activePlan.total) { alert("CONGRATULATIONS! Plan Finished!"); state.activePlan = { id: null, name: null, progress: 0, total: 0 }; }
            }
            state.history.unshift({ date: Date.now(), title: document.getElementById('workoutTitle').innerText, xp: xp });
            saveData();
            releaseWakeLock();
            setTimeout(() => { alert("Great job! Don't forget to hydrate!"); location.reload(); }, 2000);
        }

        function closeWorkout() { if(confirm("Exit?")) { document.getElementById('workout-modal').classList.add('hidden'); clearInterval(session.timerInt); releaseWakeLock(); }}
        function saveData() { localStorage.setItem('fitLogicData_v9', JSON.stringify(state)); }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function exportData() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); a.download = "fitlogic_backup.json"; document.body.appendChild(a); a.click(); a.remove(); }
        function importData(input) { const r = new FileReader(); r.onload = (e) => { state = JSON.parse(e.target.result); saveData(); location.reload(); }; r.readAsText(input.files[0]); }
        function resetApp() { if(confirm("Reset data?")) { localStorage.removeItem('fitLogicData_v9'); location.reload(); }}

        init();
    </script>
</body>
</html>
