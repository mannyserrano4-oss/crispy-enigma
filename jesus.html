<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>The Black Book</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-body: #FFFDF7;
            --bg-card: #FFFFFF;
            --bg-modal: #FFFFFF;
            --text-main: #4A4A4A;
            --text-sub: #9AA0A6;
            --border: #F0F0F0;
            
            --p-blue: #A2D2FF;
            --p-blue-dark: #6495ED;
            --p-green: #B7E4C7;
            --p-green-dark: #52B788;
            --p-pink: #FFC8DD;
            --p-pink-dark: #FF8FAB;
            --p-purple: #CDB4DB;
            --p-purple-dark: #9D4EDD;
            --p-yellow: #FDE2E4;
            --p-gold: #FFD700;
            
            --status-due: #FFD6A5;
            --status-overdue: #FFA69E;
            --status-good: #B7E4C7;
            
            --input-bg: #F7F9FC;
            --input-border: #DDE2E8;
            --shadow: 0 4px 15px rgba(200, 200, 200, 0.25);
        }

        body.dark-mode {
            --bg-body: #1F2026;
            --bg-card: #2C2C35;
            --bg-modal: #2C2C35;
            --text-main: #FFFFFF;
            --text-sub: #A0A0A5;
            --border: #3A3A42;
            
            --p-blue: #4D96FF;
            --p-blue-dark: #82C2F2;
            --p-green: #06D6A0;
            --p-green-dark: #06D6A0;
            --p-pink: #FF758F;
            --p-pink-dark: #FF4D6D;
            --p-purple: #9D4EDD;
            --p-purple-dark: #C77DFF;
            --p-gold: #FFD700;
            
            --status-due: #FF9E00;
            --status-overdue: #FF0054;
            --status-good: #06D6A0;
            
            --input-bg: #18181B;
            --input-border: #3F3F46;
            --shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0; padding-bottom: 140px;
            transition: background-color 0.3s ease;
            /* Prevents blue highlights on mobile tap */
            -webkit-tap-highlight-color: transparent; 
        }

        /* --- HEADER --- */
        .header {
            position: sticky; top: 0; background: var(--bg-body); z-index: 100;
            padding-top: env(safe-area-inset-top); border-bottom: 2px solid var(--border);
        }
        .top-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
        .logo { font-size: 1.5rem; font-weight: 900; letter-spacing: -0.5px; }
        .logo span { font-weight: 300; font-size: 1rem; color: var(--text-sub); }

        .theme-toggle {
            background: var(--input-bg); border: 2px solid var(--input-border); border-radius: 20px;
            width: 50px; height: 26px; position: relative; cursor: pointer;
        }
        .toggle-dot {
            width: 18px; height: 18px; background: var(--p-blue-dark); border-radius: 50%;
            position: absolute; top: 2px; left: 2px; transition: transform 0.3s;
        }
        body.dark-mode .toggle-dot { transform: translateX(24px); background: var(--p-pink); }

        /* Metrics */
        .metrics-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 0 20px 10px 20px; scrollbar-width: none; }
        
        .metric-pill {
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: 16px;
            padding: 14px 18px; 
            min-width: 120px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); /* Stronger shadow for "pop" */
            position: relative;
            overflow: hidden;
            transition: transform 0.1s ease;
        }

        /* Accent bars at the bottom of the pills */
        .metric-pill::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 5px;
            background: var(--p-blue-dark);
            opacity: 0.8;
        }

        /* Green bar for Today's Take */
        .metric-pill:first-child::after {
            background: var(--p-green-dark);
        }

        /* Pink bar for Giveback */
        .metric-pill:last-child::after {
            background: var(--p-pink-dark);
        }

        /* Makes it "squish" when you tap it */
        .metric-pill:active { transform: scale(0.96); }

        .m-lbl { 
            font-size: 0.65rem; 
            text-transform: uppercase; 
            color: var(--text-sub); 
            font-weight: 800; 
            letter-spacing: 0.5px;
            margin-bottom: 6px; 
        }

        .m-val { 
            font-size: 1.3rem; 
            font-weight: 900; 
            color: var(--text-main); 
        }

        .m-val.today { color: var(--p-green-dark); }

        /* Tabs */
        .tabs { display: flex; gap: 10px; padding: 10px 20px; }
        .tab-btn {
            flex: 1; padding: 10px; border: none; background: var(--input-bg); border-radius: 10px;
            color: var(--text-sub); font-weight: 700; transition: all 0.2s;
        }
        .tab-btn.active { background: var(--p-blue); color: #000; box-shadow: 0 2px 10px rgba(162, 210, 255, 0.4); }

        /* List */
        .client-list { padding: 15px 20px; }
        .client-card {
            background: var(--bg-card); border-radius: 18px; padding: 18px; margin-bottom: 15px;
            box-shadow: var(--shadow); border-left: 6px solid var(--status-good); position: relative;
        }
        .client-card.due { border-left-color: var(--status-due); }
        .client-card.overdue { border-left-color: var(--status-overdue); }
        .cc-top { display: flex; justify-content: space-between; align-items: center; }
        .cc-name { font-size: 1.2rem; font-weight: 800; }
        .cc-due { font-size: 0.8rem; font-weight: 600; padding: 4px 8px; border-radius: 6px; background: var(--input-bg); color: var(--text-sub); }
        .cc-info { color: var(--text-sub); font-size: 0.9rem; margin-top: 5px; }
        .loyalty-visual { color: var(--p-blue-dark); font-size: 0.8rem; letter-spacing: 2px; margin-top: 5px;}

        /* Footer */
        .footer-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-card); border-top: 1px solid var(--border);
            padding: 10px 15px; padding-bottom: env(safe-area-inset-bottom);
            display: flex; gap: 15px; align-items: center; z-index: 200;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); box-sizing: border-box;
        }
        .search-wrap { flex: 1; position: relative; }
        .search-input {
            width: 100%; padding: 14px 14px 14px 45px; border-radius: 14px; border: 2px solid var(--p-blue);
            background: var(--input-bg); color: var(--text-main); font-size: 1rem; outline: none; box-sizing: border-box;
        }
        .search-icon { position: absolute; left: 15px; top: 15px; color: var(--p-blue-dark); }
        .fab {
            width: 56px; height: 56px; background: var(--p-pink); color: #000; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 15px var(--p-pink); flex-shrink: 0; cursor: pointer;
        }

        /* Modals */
        .overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 500; backdrop-filter: blur(4px); align-items: flex-end;
        }
        .sheet {
            background: var(--bg-modal); width: 100%; border-radius: 25px 25px 0 0; padding: 25px;
            box-sizing: border-box; max-height: 90vh; overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            -webkit-overflow-scrolling: touch;
        }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

        label { display: block; color: var(--text-sub); font-size: 0.8rem; margin-bottom: 6px; font-weight: 700; text-transform: uppercase;}
        input, select, textarea {
            width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--input-border);
            background: var(--input-bg); color: var(--text-main); font-size: 1rem; margin-bottom: 15px;
            box-sizing: border-box; transition: border-color 0.2s; appearance: none;
        }
        input:focus { border-color: var(--p-blue-dark); outline: none; background: var(--bg-card); }

        #eIcebreaker { color: #1a1a1a !important; }
        #refResults div { color: var(--text-main); background: var(--bg-card); }

        .btn {
            width: 100%; padding: 18px; border-radius: 16px; border: none; font-size: 1rem; font-weight: 700;
            cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-primary { background: var(--p-blue); color: #000; box-shadow: 0 4px 12px rgba(162, 210, 255, 0.4); }
        .btn-green { background: var(--p-green); color: #000; box-shadow: 0 4px 12px rgba(183, 228, 199, 0.4); }
        .btn-red { background: var(--p-pink); color: #000; }
        .btn-ghost { background: transparent; border: 2px solid var(--border); color: var(--text-sub); }
        .btn-teal { background: #2dd4bf; color: #000; box-shadow: 0 4px 12px rgba(45, 212, 191, 0.4); }
        .btn-orange { background: #fb923c; color: #000; box-shadow: 0 4px 12px rgba(251, 146, 60, 0.4); }
        .btn-indigo { background: #818cf8; color: white; box-shadow: 0 4px 12px rgba(129, 140, 248, 0.4); }

        .v-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .v-box { background: var(--input-bg); padding: 15px; border-radius: 14px; text-align: center; border: 1px solid var(--border); }
        .v-big { font-size: 1.4rem; font-weight: 800; display: block; margin-bottom: 4px; }
        
        .formula-box {
            background: var(--input-bg); border: 2px dashed var(--p-blue); padding: 15px; border-radius: 12px;
            text-align: center; font-style: italic; color: var(--p-blue-dark); font-weight: 600; margin-bottom: 20px;
        }
        .contact-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .c-btn {
            padding: 15px; border-radius: 14px; background: var(--input-bg); border: 2px solid var(--p-blue);
            color: var(--p-blue-dark); font-weight: 700; text-align: center; display: flex; align-items: center;
            justify-content: center; gap: 8px; text-decoration: none; cursor: pointer;
        }

        .sms-opt {
            padding: 15px; background: var(--input-bg); border-radius: 12px; margin-bottom: 10px;
            font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .discount-opt {
            padding: 12px; border: 2px solid var(--input-border); border-radius: 12px; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: space-between; cursor: pointer;
        }
        .discount-opt.selected { border-color: var(--p-green-dark); background: rgba(183, 228, 199, 0.2); }
        
        .tag-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag-pill {
            padding: 6px 12px; border-radius: 20px; background: var(--input-bg); border: 1px solid var(--border);
            font-size: 0.8rem; cursor: pointer; transition: all 0.2s; user-select: none;
        }
        .tag-pill.active { background: var(--p-blue); color: black; border-color: var(--p-blue-dark); font-weight: bold; }
        .tag-badge {
            padding: 4px 10px; border-radius: 6px; background: var(--input-bg); font-size: 0.75rem; 
            color: var(--text-sub); border: 1px solid var(--border); font-weight: 600;
        }

        .icebreaker-box {
            background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%);
            border: 2px solid var(--p-gold); color: #5d4037; padding: 15px; border-radius: 14px;
            margin-bottom: 20px; font-weight: 600; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2); animation: popIn 0.3s ease-out;
        }
        body.dark-mode .icebreaker-box { background: linear-gradient(135deg, #fbc02d 0%, #f9a825 100%); color: #212121; }
        @keyframes popIn { from{transform:scale(0.95); opacity:0;} to{transform:scale(1); opacity:1;} }

        .hist-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .confirm-box {
            background: var(--bg-card); padding: 30px; border-radius: 20px; text-align: center; width: 80%;
            max-width: 350px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .confirm-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 10px; }
        .confirm-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        
        #crashModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; color: #ff6b6b;
            z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; box-sizing: border-box; text-align: center;
        }
        .crash-btn {
            background: #ff6b6b; color: black; padding: 15px; width: 100%; border: none; border-radius: 10px;
            font-weight: bold; margin-top: 15px; font-size: 1rem; cursor: pointer;
        }
        .fa-crown { color: var(--p-gold); filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.4)); }
    </style>
</head>
<body class="">

    <div id="crashModal">
        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
        <h2 style="margin:0;">App Crash Detected</h2>
        <p style="color:#aaa; font-size:0.9rem;">Something went wrong. Your data is likely still safe.</p>
        <p id="crashMsg" style="background:#333; padding:10px; border-radius:8px; font-family:monospace; font-size:0.7rem; color:#ff6b6b; word-break: break-all;"></p>
        <button class="crash-btn" onclick="emergencyCopy()">1. Copy Data</button>
        <button class="crash-btn" style="background:#444; color:white;" onclick="factoryReset()">2. Factory Reset</button>
        <button class="crash-btn" style="background:transparent; color:#888; border:1px solid #555;" onclick="location.reload()">3. Reload</button>
    </div>

    <div class="header">
        <div class="top-row">
            <div class="logo">The Black Book <br><span>MAS Barbery</span></div>
            <div style="display:flex; gap:15px; align-items:center;">
                <div class="theme-toggle" onclick="toggleTheme()"><div class="toggle-dot"></div></div>
                <div onclick="openSettings()"><i class="fas fa-cog" style="font-size:1.2rem; color:var(--text-sub);"></i></div>
            </div>
        </div>

        <div class="metrics-scroll">
            <div class="metric-pill">
                <span class="m-lbl">Today's Take</span>
                <span class="m-val today" id="mToday">$0.00</span>
            </div>
            <div class="metric-pill">
                <span class="m-lbl">Total Rev</span>
                <span class="m-val" id="mRev">$0.00</span>
            </div>
            <div class="metric-pill">
                <span class="m-lbl">Giveback</span>
                <span class="m-val" id="mGive">$0.00</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="setTab('all', this)">All</button>
            <button class="tab-btn" onclick="setTab('due', this)">Due</button>
            <button class="tab-btn" onclick="setTab('overdue', this)">Overdue</button>
        </div>
    </div>

    <div id="list" class="client-list"></div>

    <div class="footer-bar">
        <div class="search-wrap">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search..." oninput="render(this.value)">
        </div>
        <div class="fab" style="background:var(--p-blue); margin-right:10px;" onclick="openWalkIn()">
            <i class="fas fa-bolt"></i>
        </div>
        <div class="fab" onclick="openAddModal()">
            <i class="fas fa-plus"></i>
        </div>
    </div>

    <div id="viewModal" class="overlay">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h2 style="margin:0; font-size:1.8rem;" id="vName">Name</h2>
                <div style="font-weight:700; color:var(--p-blue-dark);" onclick="editClient()">EDIT</div>
            </div>
            <p id="vSub" style="color:var(--text-sub); margin-top:-10px;">Phone</p>
            <div id="vBadges" style="margin-bottom:15px; display:flex; gap:5px;"></div>
            
            <div id="vIcebreaker" class="icebreaker-box" style="display:none;">
                <i class="fas fa-lightbulb"></i> <span id="vIceText"></span>
            </div>

            <div id="vTags" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:15px;"></div>

            <div class="formula-box" id="vFormula">"No cut formula saved."</div>

            <div class="contact-grid">
                <a id="btnCall" href="#" class="c-btn"><i class="fas fa-phone"></i> Call</a>
                <div class="c-btn" onclick="openSmsMenu()"><i class="fas fa-comment"></i> Text</div>
                <a id="btnNav" href="#" target="_blank" class="c-btn" style="grid-column: span 2; display: none; background: #34c759; border-color: #248a3d; color: white;">
                    <i class="fas fa-map-marker-alt"></i> Navigate with Apple Maps
                </a>
            </div>
            <a id="btnEmail" href="#" class="c-btn" style="width:100%; box-sizing:border-box; margin-bottom:20px; display:none;">
                <i class="fas fa-envelope"></i> Send Email
            </a>

            <div class="v-grid">
                <div class="v-box">
                    <span class="v-big" id="vLoyalty"></span>
                    <span style="font-size:0.7rem; text-transform:uppercase;">Loyalty</span>
                </div>
                <div class="v-box">
                    <span class="v-big" style="color:var(--p-green-dark)" id="vCredit">$0.00</span>
                    <span style="font-size:0.7rem; text-transform:uppercase;">Ref Credit</span>
                </div>
                <div class="v-box">
                    <span class="v-big" id="vTotalCuts">0</span>
                    <span style="font-size:0.7rem; text-transform:uppercase;">Total Cuts</span>
                </div>
                <div class="v-box">
                    <span class="v-big" id="vLTV">$0.00</span>
                    <span style="font-size:0.7rem; text-transform:uppercase;">LTV</span>
                </div>
            </div>

            <button class="btn btn-green" onclick="openCheckout()"><i class="fas fa-cash-register"></i> Record Cut / Checkout</button>
            <button class="btn btn-ghost" style="color:var(--status-overdue); border-color:var(--status-overdue); margin-top:10px;" onclick="addStrike()">
                <i class="fas fa-ban"></i> Record No-Show (Add Strike)
            </button>
            <button id="btnRemStrike" class="btn btn-ghost" style="color:var(--text-sub); border-color:var(--border); margin-top:10px; display:none;" onclick="removeStrike()">
                <i class="fas fa-eraser"></i> Remove Strike
            </button>

            <button id="btnArchive" class="btn btn-ghost" style="border:none; color:var(--text-sub); font-size:0.9rem; margin-top:10px;" onclick="toggleArchive()">
                <i class="fas fa-archive"></i> Archive Client (Hide)
            </button>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn btn-primary" onclick="openSchedule()"><i class="fas fa-calendar"></i> Schedule</button>
                <button class="btn btn-ghost" onclick="openInsta()" id="btnInsta"><i class="fab fa-instagram"></i> Instagram</button>
            </div>
            
            <button class="btn btn-ghost" style="margin-top:20px; border:none; color:var(--text-sub);" onclick="closeModal('viewModal')">Close</button>
        </div>
    </div>

    <div id="statsModal" class="overlay">
        <div class="sheet">
            <h3>Revenue Stats</h3>
            <p style="color:var(--text-sub); margin-top:-10px; font-size:0.9rem;">Your yearly performance at a glance.</p>
            <div id="statsContent"></div>
            <button class="btn btn-ghost" onclick="closeModal('statsModal')">Close</button>
        </div>
    </div>

    <div id="checkoutModal" class="overlay" style="z-index:800;">
        <div class="sheet">
            <h3>Checkout</h3>
            
            <label>Date of Cut</label>
            <input type="date" id="payDate" style="margin-bottom:15px;">

            <label>Base Price ($)</label>
            <input type="number" id="payPrice" onchange="calcTotal()" inputmode="decimal" min="0" step="0.01">

            <label>Discounts</label>
            <div id="discountList"></div>
            <div id="customDiscBox" style="display:none;">
                <label>Custom Discount (%)</label>
                <input type="number" id="payCustomPct" placeholder="e.g. 50" oninput="calcTotal()" inputmode="decimal">
            </div>

            <label>Tip ($)</label>
            <input type="number" id="payTip" value="0" onchange="calcTotal()" inputmode="decimal">

            <div style="background:var(--input-bg); padding:15px; border-radius:12px; margin:20px 0; text-align:center;">
                <span style="color:var(--text-sub); font-size:0.8rem;">TOTAL REVENUE</span><br>
                <span id="payTotal" style="font-size:2rem; font-weight:800; color:var(--p-green-dark);">$35.00</span>
                <div id="givebackDisplay" style="color:var(--p-pink-dark); font-size:0.9rem; font-weight:700;">Giveback: $0.00</div>
            </div>

            <button class="btn btn-green" onclick="finalizeCut()">Confirm & Save</button>
            
            <button class="btn btn-ghost" id="btnSmartBook" onclick="smartBook()" style="margin-top:10px; border-color:var(--p-purple-dark); color:var(--p-purple-dark);">
                <i class="fas fa-calendar-plus"></i> Book Next: <span id="sbDate">...</span>
            </button>

            <button class="btn btn-red" onclick="closeModal('checkoutModal')">Cancel</button>
        </div>
    </div>

    <div id="walkInModal" class="overlay" style="z-index:900;">
        <div class="sheet">
            <h3>Quick Walk-In</h3>
            <p style="color:var(--text-sub); margin-top:-10px; font-size:0.8rem;">Fast revenue entry (No profile needed).</p>
            
            <label>Service Price ($)</label>
            <input type="number" id="wPrice" value="35" inputmode="decimal">

            <label>Tip ($)</label>
            <input type="number" id="wTip" value="0" inputmode="decimal">

            <button class="btn btn-green" onclick="saveWalkIn()">Record Walk-In</button>
            <button class="btn btn-ghost" onclick="closeModal('walkInModal')">Cancel</button>
        </div>
    </div>

    <div id="editModal" class="overlay">
        <div class="sheet">
            <h3 id="eTitle">Client</h3>
            <form onsubmit="event.preventDefault(); saveClient();">
                <input type="hidden" id="eId">
                <div style="border:2px solid var(--p-blue); padding:15px; border-radius:15px; margin-bottom:15px; background:rgba(162,210,255,0.1);">
                    <label style="color:var(--p-blue-dark)">Identity</label>
                    <input type="text" id="eName" placeholder="Full Name" required style="border-color:var(--p-blue);">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <input type="tel" id="ePhone" placeholder="Phone">
                        <input type="text" id="eInsta" placeholder="Insta @">
                    </div>
                    <input type="email" id="eEmail" placeholder="Email Address">
                    <input type="text" id="eAddr" placeholder="Address">
                </div>

                <div style="border:2px solid var(--p-green); padding:15px; border-radius:15px; margin-bottom:15px; background:rgba(183,228,199,0.1);">
                    <label style="color:var(--p-green-dark)">Service</label>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label>Price</label><input type="number" id="ePrice" value="35" min="0" step="0.01"></div>
                        <div><label>Freq (Wks)</label><input type="number" id="eFreq" value="4" min="1"></div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label>First Cut</label><input type="date" id="eFirst"></div>
                        <div><label>Birthday</label><input type="date" id="eDob"></div>
                    </div>
                    <label style="margin-top:10px;">The Formula</label>
                    <input type="text" id="eFormula" placeholder="e.g. Mid fade, #1.5 into #3">
                </div>

                <div style="border:2px solid var(--p-purple); padding:15px; border-radius:15px; margin-bottom:15px; background:rgba(205,180,219,0.1);">
                    <label style="color:var(--p-purple)">Connection & Vibe</label>
                    
                    <label style="color:var(--p-purple-dark); margin-bottom:5px;">üí° Icebreaker (Ask next time)</label>
                    <input type="text" id="eIcebreaker" placeholder="e.g. Ask how the Mexico trip was" style="border-color:var(--p-gold); background:#fffde7;">
                    
                    <input type="text" id="eRef" placeholder="Referred By..." oninput="searchRef(this.value)">
                    <div id="refResults" style="background:var(--bg-card); display:none; border:1px solid var(--border); padding:10px;"></div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label>Permanent Notes</label>
                        <span onclick="insertDate()" style="font-size:0.7rem; color:var(--p-blue-dark); cursor:pointer; font-weight:bold;">+ Insert Date</span>
                    </div>
                    <textarea id="eNotes" rows="3" placeholder="Permanent info (Wife, Job, etc)"></textarea>
                    
                    <label style="margin-top:10px;">Vibe Tags</label>
                    <div class="tag-grid" id="eTags"></div>
                </div>
                <button class="btn btn-primary">Save Client</button>
                <button type="button" class="btn btn-red" onclick="deleteClient()">Delete</button>
                <button type="button" class="btn btn-ghost" onclick="closeModal('editModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="smsModal" class="overlay" style="z-index: 800;">
        <div class="sheet">
            <h3>Send Text</h3>
            <div class="sms-opt" onclick="sendSms('late')">üèÉ Running Late (15m) <i class="fas fa-chevron-right"></i></div>
            <div class="sms-opt" onclick="sendSms('confirm')">üìÖ Confirm Appointment <i class="fas fa-chevron-right"></i></div>
            <div class="sms-opt" onclick="sendSms('longtime')">üëã Long Time No See <i class="fas fa-chevron-right"></i></div>
            <div class="sms-opt" onclick="sendSms('followup')">‚úÇÔ∏è Follow Up <i class="fas fa-chevron-right"></i></div>
            <div class="sms-opt" onclick="sendSms('review')">‚≠ê Request Review <i class="fas fa-chevron-right"></i></div>
            <div class="sms-opt" onclick="sendSms('custom')">üí¨ Custom Message <i class="fas fa-chevron-right"></i></div>
            <button class="btn btn-red" onclick="closeModal('smsModal')">Cancel</button>
        </div>
    </div>

    <div id="confirmModal" class="overlay" style="align-items:center; justify-content:center; z-index:1000;">
        <div class="confirm-box">
            <div class="confirm-title" id="cMsg">Are you sure?</div>
            <div class="confirm-btns">
                <button class="btn btn-ghost" id="cNo">No</button>
                <button class="btn btn-primary" id="cYes">Yes</button>
            </div>
        </div>
    </div>
    
    <div id="schedModal" class="overlay">
        <div class="sheet">
            <h3>Schedule</h3>
            <label>When?</label>
            <input type="datetime-local" id="schedDate">
            <label>Where?</label>
            <select id="schedLoc"><option value="shop">My Shop</option><option value="client">Client Home</option></select>
            <button class="btn btn-primary" onclick="addToCalendar()">Add to Calendar</button>
            <button class="btn btn-ghost" onclick="closeModal('schedModal')">Cancel</button>
        </div>
    </div>

    <div id="historyModal" class="overlay">
        <div class="sheet">
            <h3>Transaction History</h3>
            <div id="historyList" style="margin-bottom:20px;"></div>
            <button class="btn btn-ghost" onclick="closeModal('historyModal')">Close</button>
        </div>
    </div>

    <div id="settingsModal" class="overlay">
        <div class="sheet">
            <h3>Settings</h3>
            <label>Shop Location</label>
            <input type="text" id="setLoc" placeholder="Address">
            <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            
            <hr style="border-color:var(--border); margin:20px 0;">
            
            <button class="btn btn-green" onclick="openHistory()">View Transaction History</button>
            <button class="btn btn-green" style="background:var(--p-purple); color:black;" onclick="openStats()">View Revenue Stats</button>
            <button class="btn btn-ghost" onclick="toggleArchiveMode()"><span id="archiveLabel">View Archived Clients</span></button>
            
            <hr style="border-color:var(--border); margin:20px 0;">
            
            <button class="btn btn-primary" onclick="exportRobustExcel()">
                <i class="fas fa-file-excel"></i> Download Visual Report (.html)
            </button>
            <button class="btn btn-ghost" onclick="exportHistoryCSV()">
                <i class="fas fa-table"></i> Download Transaction CSV (Tax)
            </button>
            <button class="btn btn-teal" onclick="exportSimpleCSV()">
                <i class="fas fa-user-tag"></i> Download Client List CSV
            </button>
            <button class="btn btn-indigo" style="border: 2px solid var(--p-green-dark); color:var(--p-green-dark);" onclick="exportData()">
                <i class="fas fa-save"></i> Save Full Backup (.json)
            </button>
            
            <hr style="border-color:var(--border); margin:20px 0;">
            <input type="file" id="restoreFile" hidden onchange="restoreData(this)">
            <button class="btn btn-orange" onclick="document.getElementById('restoreFile').click()">Restore From Backup</button>
            <button class="btn btn-red" onclick="closeModal('settingsModal')">Close</button>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
let clients = [];
let history = [];
let settings = { location: '' };
let activeId = null;
let activeFilter = 'all';
let isDark = false;
let viewArchives = false;
let checkoutTotal = 0; 
let checkoutGiveback = 0; 
let selectedDisc = 'none';

const VIBE_TAGS = ['Silent', 'Talkative', 'Tipper', 'Sensitive Skin', 'Sports', 'Chill', 'Late', 'Cash Only', 'Politics', 'Family'];

// --- CORE FUNCTIONS ---
function saveAll() {
    localStorage.setItem('bbClients', JSON.stringify(clients));
    localStorage.setItem('bbHistory', JSON.stringify(history));
    localStorage.setItem('bbSettings', JSON.stringify(settings));
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
}

// Initial Load
try {
    const cRaw = localStorage.getItem('bbClients');
    const hRaw = localStorage.getItem('bbHistory');
    const sRaw = localStorage.getItem('bbSettings');
    if(cRaw) clients = JSON.parse(cRaw);
    if(hRaw) history = JSON.parse(hRaw);
    if(sRaw) settings = JSON.parse(sRaw);
} catch (e) {
    console.error("Data Corruption", e);
}

window.onload = () => {
    if(localStorage.getItem('theme') === 'dark') toggleTheme();
    document.getElementById('setLoc').value = settings.location || '';
    render();
};

// --- RENDER SYSTEM ---
function render(search = '') {
    const list = document.getElementById('list');
    if(!list) return;
    list.innerHTML = '';

    // Update Metrics
    const totalRev = history.reduce((s, h) => s + (Number(h.amount) || 0), 0);
    const totalGive = clients.reduce((s, c) => s + (Number(c.giveback) || 0), 0);
    const todayStr = new Date().toLocaleDateString('en-CA');
    const todayRev = history.filter(h => h.date === todayStr).reduce((s, h) => s + (Number(h.amount) || 0), 0);

    document.getElementById('mToday').innerText = '$' + todayRev.toFixed(2);
    document.getElementById('mRev').innerText = '$' + totalRev.toFixed(2);
    document.getElementById('mGive').innerText = '$' + totalGive.toFixed(2);

    let filtered = clients.filter(c => {
        if(search && !c.name.toLowerCase().includes(search.toLowerCase())) return false;
        if (viewArchives) return c.archived === true;
        if (c.archived === true) return false;
        if(!search && activeFilter === 'due') return getStatus(c) === 'due';
        if(!search && activeFilter === 'overdue') return getStatus(c) === 'overdue';
        return true;
    });

    filtered.sort((a,b) => (activeFilter === 'all') ? (a.name || "").localeCompare(b.name || "") : new Date(a.last || a.first) - new Date(b.last || b.first));

    filtered.forEach(c => {
        const div = document.createElement('div');
        div.className = `client-card ${getStatus(c)}`;
        div.onclick = () => showClient(c.id);
        div.innerHTML = `
            <div class="cc-top">
                <div class="cc-name">${c.name} ${c.strikes > 0 ? 'üö©'.repeat(c.strikes) : ''}</div>
                <div class="cc-due">${getDueStr(c)}</div>
            </div>
            <div class="cc-info">Last: ${formatPretty(c.last)}</div>
            <div class="loyalty-visual">${getLoyaltyVisual(c.loyalty)}</div>
        `;
        list.appendChild(div);
    });
}

// --- TAB & THEME ---
function setTab(t, btn) {
    activeFilter = t;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    render();
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    isDark = document.body.classList.contains('dark-mode');
    saveAll();
}

// --- MODALS ---
function openModal(id) { 
    document.getElementById(id).style.display = 'flex'; 
    document.body.style.overflow = 'hidden'; 
}

function closeModal(id) { 
    document.getElementById(id).style.display = 'none'; 
    document.body.style.overflow = ''; 
}

function openSettings() { openModal('settingsModal'); }
function openWalkIn() { openModal('walkInModal'); }

function showClient(id) {
    activeId = id;
    const c = clients.find(x => x.id == id);
    if(!c) return;
    document.getElementById('vName').innerText = c.name;
    document.getElementById('vSub').innerText = c.phone || 'No Phone';
    document.getElementById('vFormula').innerText = c.formula || "No cut formula saved.";
    document.getElementById('vLoyalty').innerText = getLoyaltyVisual(c.loyalty);
    document.getElementById('vCredit').innerText = `$${(c.credit||0).toFixed(2)}`;
    document.getElementById('vLTV').innerText = `$${(c.spent||0).toFixed(2)}`;
    document.getElementById('btnCall').href = `tel:${c.phone}`;
    
    const navBtn = document.getElementById('btnNav');
    if(c.address) {
        navBtn.style.display = 'flex';
        navBtn.href = `maps://?q=${encodeURIComponent(c.address)}`;
    } else {
        navBtn.style.display = 'none';
    }
    openModal('viewModal');
}

// --- ADD/EDIT CLIENT ---
function openAddModal() {
    activeId = null;
    document.getElementById('eTitle').innerText = 'New Client';
    document.getElementById('eId').value = '';
    document.getElementById('eName').value = '';
    document.getElementById('ePhone').value = '';
    document.getElementById('ePrice').value = 35;
    
    const tagBox = document.getElementById('eTags');
    tagBox.innerHTML = '';
    VIBE_TAGS.forEach(t => {
        const pill = document.createElement('div');
        pill.className = 'tag-pill';
        pill.innerText = t;
        pill.onclick = () => pill.classList.toggle('active');
        tagBox.appendChild(pill);
    });
    openModal('editModal');
}

function saveClient() {
    const id = document.getElementById('eId').value || Date.now().toString();
    const isNew = !document.getElementById('eId').value;
    const tags = Array.from(document.querySelectorAll('#eTags .tag-pill.active')).map(p => p.innerText);
    
    const data = {
        id,
        name: document.getElementById('eName').value,
        phone: document.getElementById('ePhone').value,
        insta: document.getElementById('eInsta').value,
        email: document.getElementById('eEmail').value,
        address: document.getElementById('eAddr').value,
        price: parseFloat(document.getElementById('ePrice').value) || 35,
        freq: parseInt(document.getElementById('eFreq').value) || 4,
        first: document.getElementById('eFirst').value,
        dob: document.getElementById('eDob').value,
        formula: document.getElementById('eFormula').value,
        icebreaker: document.getElementById('eIcebreaker').value,
        notes: document.getElementById('eNotes').value,
        tags: tags,
        strikes: isNew ? 0 : (clients.find(x => x.id == id).strikes || 0),
        loyalty: isNew ? 0 : (clients.find(x => x.id == id).loyalty || 0),
        spent: isNew ? 0 : (clients.find(x => x.id == id).spent || 0)
    };

    if(isNew) clients.push(data);
    else clients[clients.findIndex(x => x.id == id)] = data;
    
    saveAll();
    closeModal('editModal');
    render();
}

// --- ACTIONS ---
function addStrike() {
    const c = clients.find(x => x.id == activeId);
    c.strikes = (c.strikes || 0) + 1;
    saveAll();
    closeModal('viewModal');
    render();
}

function openSmsMenu() { openModal('smsModal'); }

function sendSms(type) {
    const c = clients.find(x => x.id == activeId);
    if(!c.phone) return alert("No phone number!");
    let msg = "";
    if(type === 'late') msg = "Hey! Running 15 mins late.";
    if(type === 'confirm') msg = "Yo, confirming our cut today. Still good?";
    window.location.href = `sms:${c.phone}&body=${encodeURIComponent(msg)}`;
    closeModal('smsModal');
}

// --- CHECKOUT ---
function openCheckout() {
    const c = clients.find(x => x.id == activeId);
    document.getElementById('payPrice').value = c.price || 35;
    document.getElementById('payTip').value = 0;
    openModal('checkoutModal');
    calcTotal();
}

function calcTotal() {
    const base = parseFloat(document.getElementById('payPrice').value) || 0;
    const tip = parseFloat(document.getElementById('payTip').value) || 0;
    checkoutTotal = base + tip;
    document.getElementById('payTotal').innerText = `$${checkoutTotal.toFixed(2)}`;
}

function finalizeCut() {
    const c = clients.find(x => x.id == activeId);
    c.spent = (c.spent || 0) + checkoutTotal;
    c.cuts = (c.cuts || 0) + 1;
    c.last = new Date().toLocaleDateString('en-CA');
    c.loyalty = ((c.loyalty || 0) + 1) % 5;

    history.push({
        clientId: c.id,
        clientName: c.name,
        date: c.last,
        amount: checkoutTotal
    });

    saveAll();
    closeModal('checkoutModal');
    closeModal('viewModal');
    render();
}

// --- HELPERS ---
function getStatus(c) {
    const last = new Date(c.last || c.first || Date.now());
    const diff = (new Date() - last) / (1000 * 60 * 60 * 24);
    if(diff >= 56) return 'overdue';
    if(diff >= (c.freq || 4) * 7) return 'due';
    return 'good';
}

function getDueStr(c) {
    const d = new Date(c.last || c.first || Date.now());
    d.setDate(d.getDate() + ((c.freq || 4) * 7));
    return d.toLocaleDateString(undefined, {month:'short', day:'numeric'});
}

function getLoyaltyVisual(n) {
    let s = '';
    for(let i=0; i<5; i++) s += (i < (n || 0)) ? '‚úÇÔ∏è' : '‚ö™';
    return s;
}

function formatPretty(d) { return d ? new Date(d).toLocaleDateString() : 'Never'; }

function saveSettings() {
    settings.location = document.getElementById('setLoc').value;
    saveAll();
    closeModal('settingsModal');
}

function factoryReset() { if(confirm("Clear ALL data?")) { localStorage.clear(); location.reload(); } }
function emergencyCopy() { navigator.clipboard.writeText(JSON.stringify({clients, history})); alert("Data Copied!"); }
    </script>
</body>
</html>
