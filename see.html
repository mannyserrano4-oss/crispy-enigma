<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>The Black Book</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-body: #FFFDF7;
            --bg-card: #FFFFFF;
            --bg-modal: #FFFFFF;
            --text-main: #4A4A4A;
            --text-sub: #9AA0A6;
            --border: #F0F0F0;
            
            --p-blue: #A2D2FF;
            --p-blue-dark: #6495ED;
            --p-green: #B7E4C7;
            --p-green-dark: #52B788;
            --p-pink: #FFC8DD;
            --p-pink-dark: #FF8FAB;
            --p-purple: #CDB4DB;
            --p-purple-dark: #9D4EDD;
            --p-yellow: #FDE2E4;
            --p-gold: #FFD700;
            
            --status-due: #FFD6A5;
            --status-overdue: #FFA69E;
            --status-good: #B7E4C7;
            
            --input-bg: #F7F9FC;
            --input-border: #DDE2E8;
            --shadow: 0 4px 15px rgba(200, 200, 200, 0.25);
        }

        body.dark-mode {
            --bg-body: #1F2026;
            --bg-card: #2C2C35;
            --bg-modal: #2C2C35;
            --text-main: #FFFFFF;
            --text-sub: #A0A0A5;
            --border: #3A3A42;
            
            --p-blue: #4D96FF;
            --p-blue-dark: #82C2F2;
            --p-green: #06D6A0;
            --p-green-dark: #06D6A0;
            --p-pink: #FF758F;
            --p-pink-dark: #FF4D6D;
            --p-purple: #9D4EDD;
            --p-purple-dark: #C77DFF;
            --p-gold: #FFD700;
            
            --status-due: #FF9E00;
            --status-overdue: #FF0054;
            --status-good: #06D6A0;
            
            --input-bg: #18181B;
            --input-border: #3F3F46;
            --shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0; padding-bottom: 140px;
            transition: background-color 0.3s ease;
            -webkit-tap-highlight-color: transparent; 
        }

        /* --- HEADER --- */
        .header {
            position: sticky; top: 0; background: var(--bg-body); z-index: 100;
            padding-top: env(safe-area-inset-top); border-bottom: 2px solid var(--border);
        }
        .top-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
        .logo { font-size: 1.5rem; font-weight: 900; letter-spacing: -0.5px; }
        .logo span { font-weight: 300; font-size: 1rem; color: var(--text-sub); }

        .theme-toggle {
            background: var(--input-bg); border: 2px solid var(--input-border); border-radius: 20px;
            width: 50px; height: 26px; position: relative; cursor: pointer;
        }
        .toggle-dot {
            width: 18px; height: 18px; background: var(--p-blue-dark); border-radius: 50%;
            position: absolute; top: 2px; left: 2px; transition: transform 0.3s;
        }
        body.dark-mode .toggle-dot { transform: translateX(24px); background: var(--p-pink); }

        .metrics-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 0 20px 10px 20px; scrollbar-width: none; }
        
        .metric-pill {
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: 16px;
            padding: 14px 18px; 
            min-width: 120px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.1s ease;
        }

        .metric-pill::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 5px;
            background: var(--p-blue-dark);
            opacity: 0.8;
        }

        .metric-pill:first-child::after { background: var(--p-green-dark); }
        .metric-pill:last-child::after { background: var(--p-pink-dark); }
        .metric-pill:active { transform: scale(0.96); }

        .m-lbl { 
            font-size: 0.65rem; 
            text-transform: uppercase; 
            color: var(--text-sub); 
            font-weight: 800; 
            letter-spacing: 0.5px;
            margin-bottom: 6px; 
        }

        .m-val { 
            font-size: 1.3rem; 
            font-weight: 900; 
            color: var(--text-main); 
        }

        .m-val.today { color: var(--p-green-dark); }

        .tabs { display: flex; gap: 10px; padding: 10px 20px; }
        .tab-btn {
            flex: 1; padding: 10px; border: none; background: var(--input-bg); border-radius: 10px;
            color: var(--text-sub); font-weight: 700; transition: all 0.2s;
        }
        .tab-btn.active { background: var(--p-blue); color: #000; box-shadow: 0 2px 10px rgba(162, 210, 255, 0.4); }

        .client-list { padding: 15px 20px; }
        .client-card {
            background: var(--bg-card); border-radius: 18px; padding: 18px; margin-bottom: 15px;
            box-shadow: var(--shadow); border-left: 6px solid var(--status-good); position: relative;
        }
        .client-card.due { border-left-color: var(--status-due); }
        .client-card.overdue { border-left-color: var(--status-overdue); }
        .cc-top { display: flex; justify-content: space-between; align-items: center; }
        .cc-name { font-size: 1.2rem; font-weight: 800; }
        .cc-due { font-size: 0.8rem; font-weight: 600; padding: 4px 8px; border-radius: 6px; background: var(--input-bg); color: var(--text-sub); }
        .cc-info { color: var(--text-sub); font-size: 0.9rem; margin-top: 5px; }
        .loyalty-visual { color: var(--p-blue-dark); font-size: 0.8rem; letter-spacing: 2px; margin-top: 5px;}

        .footer-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-card); border-top: 1px solid var(--border);
            padding: 10px 15px; padding-bottom: env(safe-area-inset-bottom);
            display: flex; gap: 15px; align-items: center; z-index: 200;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); box-sizing: border-box;
        }
        .search-wrap { flex: 1; position: relative; }
        .search-input {
            width: 100%; padding: 14px 14px 14px 45px; border-radius: 14px; border: 2px solid var(--p-blue);
            background: var(--input-bg); color: var(--text-main); font-size: 1rem; outline: none; box-sizing: border-box;
        }
        .search-icon { position: absolute; left: 15px; top: 15px; color: var(--p-blue-dark); }
        .fab {
            width: 56px; height: 56px; background: var(--p-pink); color: #000; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 4px 15px var(--p-pink); flex-shrink: 0; cursor: pointer;
        }

        .overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 500; backdrop-filter: blur(4px); align-items: flex-end;
        }
        .sheet {
            background: var(--bg-modal); width: 100%; border-radius: 25px 25px 0 0; padding: 25px;
            box-sizing: border-box; max-height: 90vh; overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            -webkit-overflow-scrolling: touch;
        }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

        label { display: block; color: var(--text-sub); font-size: 0.8rem; margin-bottom: 6px; font-weight: 700; text-transform: uppercase;}
        input, select, textarea {
            width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--input-border);
            background: var(--input-bg); color: var(--text-main); font-size: 1rem; margin-bottom: 15px;
            box-sizing: border-box; transition: border-color 0.2s; appearance: none;
        }
        input:focus { border-color: var(--p-blue-dark); outline: none; background: var(--bg-card); }

        .btn {
            width: 100%; padding: 18px; border-radius: 16px; border: none; font-size: 1rem; font-weight: 700;
            cursor: pointer; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-primary { background: var(--p-blue); color: #000; box-shadow: 0 4px 12px rgba(162, 210, 255, 0.4); }
        .btn-green { background: var(--p-green); color: #000; box-shadow: 0 4px 12px rgba(183, 228, 199, 0.4); }
        .btn-red { background: var(--p-pink); color: #000; }
        .btn-ghost { background: transparent; border: 2px solid var(--border); color: var(--text-sub); }
        .btn-teal { background: #2dd4bf; color: #000; box-shadow: 0 4px 12px rgba(45, 212, 191, 0.4); }
        .btn-orange { background: #fb923c; color: #000; box-shadow: 0 4px 12px rgba(251, 146, 60, 0.4); }
        .btn-indigo { background: #818cf8; color: white; box-shadow: 0 4px 12px rgba(129, 140, 248, 0.4); }

        .v-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .v-box { background: var(--input-bg); padding: 15px; border-radius: 14px; text-align: center; border: 1px solid var(--border); }
        .v-big { font-size: 1.4rem; font-weight: 800; display: block; margin-bottom: 4px; }
        
        .formula-box {
            background: var(--input-bg); border: 2px dashed var(--p-blue); padding: 15px; border-radius: 12px;
            text-align: center; font-style: italic; color: var(--p-blue-dark); font-weight: 600; margin-bottom: 20px;
        }
        .contact-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .c-btn {
            padding: 15px; border-radius: 14px; background: var(--input-bg); border: 2px solid var(--p-blue);
            color: var(--p-blue-dark); font-weight: 700; text-align: center; display: flex; align-items: center;
            justify-content: center; gap: 8px; text-decoration: none; cursor: pointer;
        }

        .sms-opt {
            padding: 15px; background: var(--input-bg); border-radius: 12px; margin-bottom: 10px;
            font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .discount-opt {
            padding: 12px; border: 2px solid var(--input-border); border-radius: 12px; margin-bottom: 8px;
            display: flex; align-items: center; justify-content: space-between; cursor: pointer;
        }
        .discount-opt.selected { border-color: var(--p-green-dark); background: rgba(183, 228, 199, 0.2); }
        
        .tag-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag-pill {
            padding: 6px 12px; border-radius: 20px; background: var(--input-bg); border: 1px solid var(--border);
            font-size: 0.8rem; cursor: pointer; transition: all 0.2s; user-select: none;
        }
        .tag-pill.active { background: var(--p-blue); color: black; border-color: var(--p-blue-dark); font-weight: bold; }
        .tag-badge {
            padding: 4px 10px; border-radius: 6px; background: var(--input-bg); font-size: 0.75rem; 
            color: var(--text-sub); border: 1px solid var(--border); font-weight: 600;
        }

        .icebreaker-box {
            background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%);
            border: 2px solid var(--p-gold); color: #5d4037; padding: 15px; border-radius: 14px;
            margin-bottom: 20px; font-weight: 600; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2); animation: popIn 0.3s ease-out;
        }
        body.dark-mode .icebreaker-box { background: linear-gradient(135deg, #fbc02d 0%, #f9a825 100%); color: #212121; }
        @keyframes popIn { from{transform:scale(0.95); opacity:0;} to{transform:scale(1); opacity:1;} }

        .hist-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .confirm-box {
            background: var(--bg-card); padding: 30px; border-radius: 20px; text-align: center; width: 80%;
            max-width: 350px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .confirm-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 10px; }
        .confirm-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        
        #crashModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; color: #ff6b6b;
            z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; box-sizing: border-box; text-align: center;
        }
        .crash-btn {
            background: #ff6b6b; color: black; padding: 15px; width: 100%; border: none; border-radius: 10px;
            font-weight: bold; margin-top: 15px; font-size: 1rem; cursor: pointer;
        }
        .fa-crown { color: var(--p-gold); filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.4)); }
    </style>
</head>
<body>

    <div id="crashModal">
        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
        <h2 style="margin:0;">App Crash Detected</h2>
        <p style="color:#aaa; font-size:0.9rem;">Something went wrong. Your data is likely still safe.</p>
        <p id="crashMsg" style="background:#333; padding:10px; border-radius:8px; font-family:monospace; font-size:0.7rem; color:#ff6b6b; word-break: break-all;"></p>
        <button class="crash-btn" onclick="emergencyCopy()">1. Copy Data</button>
        <button class="crash-btn" style="background:#444; color:white;" onclick="factoryReset()">2. Factory Reset</button>
        <button class="crash-btn" style="background:transparent; color:#888; border:1px solid #555;" onclick="location.reload()">3. Reload</button>
    </div>

    <div class="header">
        <div class="top-row">
            <div class="logo">The Black Book <br><span>MAS Barbery</span></div>
            <div style="display:flex; gap:15px; align-items:center;">
                <div class="theme-toggle" onclick="toggleTheme()"><div class="toggle-dot"></div></div>
                <div onclick="openSettings()"><i class="fas fa-cog" style="font-size:1.2rem; color:var(--text-sub);"></i></div>
            </div>
        </div>

        <div class="metrics-scroll">
            <div class="metric-pill">
                <span class="m-lbl">Today's Take</span>
                <span class="m-val today" id="mToday">$0.00</span>
            </div>
            <div class="metric-pill">
                <span class="m-lbl">Total Rev</span>
                <span class="m-val" id="mRev">$0.00</span>
            </div>
            <div class="metric-pill">
                <span class="m-lbl">Giveback</span>
                <span class="m-val" id="mGive">$0.00</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="setTab('all', this)">All</button>
            <button class="tab-btn" onclick="setTab('due', this)">Due</button>
            <button class="tab-btn" onclick="setTab('overdue', this)">Overdue</button>
        </div>
    </div>

    <div id="list" class="client-list"></div>

    <div class="footer-bar">
        <div class="search-wrap">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search..." oninput="handleSearch(this.value)">
        </div>
        <div class="fab" style="background:var(--p-blue); margin-right:10px;" onclick="openWalkIn()">
            <i class="fas fa-bolt"></i>
        </div>
        <div class="fab" onclick="openAddModal()">
            <i class="fas fa-plus"></i>
        </div>
    </div>

    <div id="viewModal" class="overlay">
        <div class="sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h2 style="margin:0; font-size:1.8rem;" id="vName">Name</h2>
                <div style="font-weight:700; color:var(--p-blue-dark);" onclick="editClient()">EDIT</div>
            </div>
            <p id="vSub" style="color:var(--text-sub); margin-top:-10px;">Phone</p>
            <div id="vBadges" style="margin-bottom:15px; display:flex; gap:5px;"></div>
            
            <div id="vIcebreaker" class="icebreaker-box" style="display:none;">
                <i class="fas fa-lightbulb"></i> <span id="vIceText"></span>
            </div>

            <div id="vTags" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:15px;"></div>

            <div class="formula-box" id="vFormula">"No cut formula saved."</div>

            <div class="contact-grid">
                <a id="btnCall" href="#" class="c-btn"><i class="fas fa-phone"></i> Call</a>
                <div class="c-btn" onclick="openSmsMenu()"><i class="fas fa-comment"></i> Text</div>
                <a id="btnNav" href="#" target="_blank" class="c-btn" style="grid-column: span 2; display: none; background: #34c759; border-color: #248a3d; color: white;">
                    <i class="fas fa-map-marker-alt"></i> Navigate with Apple Maps
                </a>
            </div>
            <a id="btnEmail" href="#" class="c-btn" style="width:100%; box-sizing:border-box; margin-bottom:20px; display:none;">
                <i class="fas fa-envelope"></i> Send Email
            </a>

            <div class="v-grid">
                <div class="v-box">
                    <span class="v-big" id="vLoyalty"></span>
                    <span style="font-size:0.7rem; text-transform:uppercase;">Loyalty</span>
                </div>
                <div class="v-box">
                    <span class="v-big" style="color:var(--p-green-dark)" id="vCredit">$0.00</span>
                    <span style="font-size:0.7rem; text-transform:uppercase;">Ref Credit</span>
                </div>
                <div class="v-box">
                    <span class="v-big" id="vTotalCuts">0</span>
                    <span style="font-size:0.7rem; text-transform:uppercase;">Total Cuts</span>
                </div>
                <div class="v-box">
                    <span class="v-big" id="vLTV">$0.00</span>
                    <span style="font-size:0.7rem; text-transform:uppercase;">LTV</span>
                </div>
            </div>

            <button class="btn btn-green" onclick="openCheckout()"><i class="fas fa-cash-register"></i> Record Cut / Checkout</button>
            <button class="btn btn-ghost" style="color:var(--status-overdue); border-color:var(--status-overdue); margin-top:10px;" onclick="addStrike()">
                <i class="fas fa-ban"></i> Record No-Show (Add Strike)
            </button>
            <button id="btnRemStrike" class="btn btn-ghost" style="color:var(--text-sub); border-color:var(--border); margin-top:10px; display:none;" onclick="removeStrike()">
                <i class="fas fa-eraser"></i> Remove Strike
            </button>

            <button id="btnArchive" class="btn btn-ghost" style="border:none; color:var(--text-sub); font-size:0.9rem; margin-top:10px;" onclick="toggleArchive()">
                <i class="fas fa-archive"></i> Archive Client (Hide)
            </button>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn btn-primary" onclick="openSchedule()"><i class="fas fa-calendar"></i> Schedule</button>
                <button class="btn btn-ghost" onclick="openInsta()" id="btnInsta"><i class="fab fa-instagram"></i> Instagram</button>
            </div>
            
            <button class="btn btn-ghost" style="margin-top:20px; border:none; color:var(--text-sub);" onclick="closeModal('viewModal')">Close</button>
        </div>
    </div>

    <div id="statsModal" class="overlay">
        <div class="sheet">
            <h3>Revenue Stats</h3>
            <p style="color:var(--text-sub); margin-top:-10px; font-size:0.9rem;">Your yearly performance at a glance.</p>
            <div id="statsContent"></div>
            <button class="btn btn-ghost" onclick="closeModal('statsModal')">Close</button>
        </div>
    </div>

    <div id="checkoutModal" class="overlay" style="z-index:800;">
        <div class="sheet">
            <h3>Checkout</h3>
            
            <label>Date of Cut</label>
            <input type="date" id="payDate" style="margin-bottom:15px;">

            <label>Base Price ($)</label>
            <input type="number" id="payPrice" onchange="calcTotal()" inputmode="decimal">

            <label>Discounts</label>
            <div id="discountList"></div>
            <div id="customDiscBox" style="display:none;">
                <label>Custom Discount (%)</label>
                <input type="number" id="payCustomPct" placeholder="e.g. 50" oninput="calcTotal()" inputmode="decimal">
            </div>

            <label>Tip ($)</label>
            <input type="number" id="payTip" value="0" onchange="calcTotal()" inputmode="decimal">

            <div style="background:var(--input-bg); padding:15px; border-radius:12px; margin:20px 0; text-align:center;">
                <span style="color:var(--text-sub); font-size:0.8rem;">TOTAL REVENUE</span><br>
                <span id="payTotal" style="font-size:2rem; font-weight:800; color:var(--p-green-dark);">$35.00</span>
                <div id="givebackDisplay" style="color:var(--p-pink-dark); font-size:0.9rem; font-weight:700;">Giveback: $0.00</div>
            </div>

            <button class="btn btn-green" onclick="finalizeCut()">Confirm & Save</button>
            
            <button class="btn btn-ghost" id="btnSmartBook" onclick="smartBook()" style="margin-top:10px; border-color:var(--p-purple-dark); color:var(--p-purple-dark);">
                <i class="fas fa-calendar-plus"></i> Book Next: <span id="sbDate">...</span>
            </button>

            <button class="btn btn-red" onclick="closeModal('checkoutModal')">Cancel</button>
        </div>
    </div>

    <div id="walkInModal" class="overlay" style="z-index:900;">
        <div class="sheet">
            <h3>Quick Walk-In</h3>
            <p style="color:var(--text-sub); margin-top:-10px; font-size:0.8rem;">Fast revenue entry (No profile needed).</p>
            
            <label>Service Price ($)</label>
            <input type="number" id="wPrice" value="35" inputmode="decimal">

            <label>Tip ($)</label>
            <input type="number" id="wTip" value="0" inputmode="decimal">

            <button class="btn btn-green" onclick="saveWalkIn()">Record Walk-In</button>
            <button class="btn btn-ghost" onclick="closeModal('walkInModal')">Cancel</button>
        </div>
    </div>

    <div id="editModal" class="overlay">
        <div class="sheet">
            <h3 id="eTitle">Client</h3>
            <form onsubmit="event.preventDefault(); saveClient();">
                <input type="hidden" id="eId">
                <div style="border:2px solid var(--p-blue); padding:15px; border-radius:15px; margin-bottom:15px; background:rgba(162,210,255,0.1);">
                    <label style="color:var(--p-blue-dark)">Identity</label>
                    <input type="text" id="eName" placeholder="Full Name" required style="border-color:var(--p-blue);">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <input type="tel" id="ePhone" placeholder="Phone">
                        <input type="text" id="eInsta" placeholder="Insta @">
                    </div>
                    <input type="email" id="eEmail" placeholder="Email Address">
                    <input type="text" id="eAddr" placeholder="Address">
                </div>

                <div style="border:2px solid var(--p-green); padding:15px; border-radius:15px; margin-bottom:15px; background:rgba(183,228,199,0.1);">
                    <label style="color:var(--p-green-dark)">Service</label>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label>Price</label><input type="number" id="ePrice" value="35"></div>
                        <div><label>Freq (Wks)</label><input type="number" id="eFreq" value="4"></div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label>First Cut</label><input type="date" id="eFirst"></div>
                        <div><label>Birthday</label><input type="date" id="eDob"></div>
                    </div>
                    <label style="margin-top:10px;">The Formula</label>
                    <input type="text" id="eFormula" placeholder="e.g. Mid fade, #1.5 into #3">
                </div>

                <div style="border:2px solid var(--p-purple); padding:15px; border-radius:15px; margin-bottom:15px; background:rgba(205,180,219,0.1);">
                    <label style="color:var(--p-purple)">Connection & Vibe</label>
                    
                    <label style="color:var(--p-purple-dark); margin-bottom:5px;">üí° Icebreaker (Ask next time)</label>
                    <input type="text" id="eIcebreaker" placeholder="e.g. Ask how the Mexico trip was" style="border-color:var(--p-gold); background:#fffde7;">
                    
                    <input type="text" id="eRef" placeholder="Referred By..." oninput="searchRef(this.value)">
                    <div id="refResults" style="background:var(--bg-card); display:none; border:1px solid var(--border); padding:10px;"></div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label>Permanent Notes</label>
                        <span onclick="insertDate()" style="font-size:0.7rem; color:var(--p-blue-dark); cursor:pointer; font-weight:bold;">+ Insert Date</span>
                    </div>
                    <textarea id="eNotes" rows="3" placeholder="Permanent info (Wife, Job, etc)"></textarea>
                    
                    <label style="margin-top:10px;">Vibe Tags</label>
                    <div class="tag-grid" id="eTags"></div>
                </div>

                <div style="border:2px solid #FFD700; padding:15px; border-radius:15px; margin-bottom:15px; background:rgba(255, 215, 0, 0.05);">
                    <label style="color:#b8860b;">Admin: Loyalty & Rewards</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:8px;">
                        <div>
                            <label style="font-size:0.7rem;">Banked Free Cuts</label>
                            <input type="number" id="eBanked" value="0" min="0" inputmode="numeric" pattern="[0-9]*">
                        </div>
                        <div>
                            <label style="font-size:0.7rem;">Points (0-4 ‚úÇÔ∏è)</label>
                            <input type="number" id="eLoyalty" value="0" min="0" max="4" inputmode="numeric" pattern="[0-9]*">
                        </div>
                    </div>
                    <p style="font-size: 0.65rem; color: var(--text-sub); margin: 0; font-style: italic;">
                        *Use this to manually fix mistakes. 5 points automatically = 1 Banked Cut.
                    </p>
                </div>

                <button class="btn btn-primary">Save Client</button>
                <button type="button" class="btn btn-red" onclick="deleteClient()">Delete</button>
                <button type="button" class="btn btn-ghost" onclick="cancelEdit()">Cancel</button>
            </form>
        </div>
    </div>

    <div id="smsModal" class="overlay" style="z-index: 800;">
        <div class="sheet">
            <h3>Send Text</h3>
            <div class="sms-opt" onclick="sendSms('late')">üèÉ Running Late (15m) <i class="fas fa-chevron-right"></i></div>
            <div class="sms-opt" onclick="sendSms('confirm')">üìÖ Confirm Appointment <i class="fas fa-chevron-right"></i></div>
            <div class="sms-opt" onclick="sendSms('longtime')">üëã Long Time No See <i class="fas fa-chevron-right"></i></div>
            <div class="sms-opt" onclick="sendSms('followup')">‚úÇÔ∏è Follow Up <i class="fas fa-chevron-right"></i></div>
            <div class="sms-opt" onclick="sendSms('review')">‚≠ê Request Review <i class="fas fa-chevron-right"></i></div>
            <div class="sms-opt" onclick="sendSms('custom')">üí¨ Custom Message <i class="fas fa-chevron-right"></i></div>
            <button class="btn btn-red" onclick="closeModal('smsModal')">Cancel</button>
        </div>
    </div>

    <div id="confirmModal" class="overlay" style="align-items:center; justify-content:center; z-index:1000;">
        <div class="confirm-box">
            <div class="confirm-title" id="cMsg">Are you sure?</div>
            <div class="confirm-btns">
                <button class="btn btn-ghost" id="cNo">No</button>
                <button class="btn btn-primary" id="cYes">Yes</button>
            </div>
        </div>
    </div>
    
    <div id="schedModal" class="overlay">
        <div class="sheet">
            <h3>Schedule</h3>
            <label>When?</label>
            <input type="datetime-local" id="schedDate">
            <label>Where?</label>
            <select id="schedLoc"><option value="shop">My Shop</option><option value="client">Client Home</option></select>
            <button class="btn btn-primary" onclick="addToCalendar()">Add to Calendar</button>
            <button class="btn btn-ghost" onclick="closeModal('schedModal')">Cancel</button>
        </div>
    </div>

    <div id="historyModal" class="overlay">
        <div class="sheet">
            <h3>Transaction History</h3>
            <div id="historyList" style="margin-bottom:20px;"></div>
            <button class="btn btn-ghost" onclick="closeModal('historyModal')">Close</button>
        </div>
    </div>

    <div id="settingsModal" class="overlay">
        <div class="sheet">
            <h3>Settings</h3>
            <label>Shop Location</label>
            <input type="text" id="setLoc" placeholder="Address">
            <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            
            <hr style="border-color:var(--border); margin:20px 0;">
            
            <button class="btn btn-green" onclick="openHistory()">View Transaction History</button>
            <button class="btn btn-green" style="background:var(--p-purple); color:black;" onclick="openStats()">View Revenue Stats</button>
            <button class="btn btn-ghost" onclick="toggleArchiveMode()"><span id="archiveLabel">View Archived Clients</span></button>
            
            <hr style="border-color:var(--border); margin:20px 0;">
            
            <button class="btn btn-primary" onclick="exportRobustExcel()">
                <i class="fas fa-file-excel"></i> Download Visual Report (.html)
            </button>
            <button class="btn btn-ghost" onclick="exportHistoryCSV()">
                <i class="fas fa-table"></i> Download Transaction CSV (Tax)
            </button>
            <button class="btn btn-teal" onclick="exportSimpleCSV()">
                <i class="fas fa-user-tag"></i> Download Client List CSV
            </button>
            <button class="btn btn-indigo" style="border: 2px solid var(--p-green-dark); color:var(--p-green-dark);" onclick="exportData()">
                <i class="fas fa-save"></i> Save Full Backup (.json)
            </button>
            
            <hr style="border-color:var(--border); margin:20px 0;">
            <input type="file" id="restoreFile" hidden onchange="restoreData(this)">
            <button class="btn btn-orange" onclick="document.getElementById('restoreFile').click()">Restore From Backup</button>
            <button class="btn btn-red" onclick="closeModal('settingsModal')">Close</button>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let clients = [];
        let history = [];
        let settings = { location: '' };
        let activeId = null;
        let activeFilter = 'all';
        let isDark = false;
        let viewArchives = false;
        let selectedDisc = 'none'; 
        let editInitialState = ""; 

        const VIBE_TAGS = ['Silent', 'Talkative', 'Tipper', 'Sensitive Skin', 'Sports', 'Chill', 'Late', 'Cash Only', 'Politics', 'Family'];

        // --- HELPERS ---
        const getTodayIso = () => {
            const d = new Date();
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        };

        window.onerror = function(msg, url, line) {
            showCrashScreen(msg + " (Line " + line + ")");
            return false;
        };

        // --- CORE FUNCTIONS ---
        function saveAll() {
            localStorage.setItem('bbClients', JSON.stringify(clients));
            localStorage.setItem('bbHistory', JSON.stringify(history));
            localStorage.setItem('bbSettings', JSON.stringify(settings));
        }

        try {
            const cRaw = localStorage.getItem('bbClients');
            const hRaw = localStorage.getItem('bbHistory');
            const sRaw = localStorage.getItem('bbSettings');
            if(cRaw) clients = JSON.parse(cRaw);
            if(hRaw) history = JSON.parse(hRaw);
            if(sRaw) settings = JSON.parse(sRaw);
        } catch (e) {
            showCrashScreen("Data Corruption: " + e.message);
        }

        window.onload = () => {
            render();
            document.getElementById('setLoc').value = settings.location || '';
            if(localStorage.getItem('theme') === 'dark') toggleTheme();
        };

        function openModal(id) { 
            document.getElementById(id).style.display = 'flex'; 
            document.body.style.overflow = 'hidden';
        }

        function closeModal(id) { 
            document.getElementById(id).style.display = 'none'; 
            const openModals = document.querySelectorAll('.overlay[style*="display: flex"]');
            if (openModals.length === 0) {
                document.body.style.overflow = '';
            }
        }

        // --- PERFORMANCE FIX: Decouple Math from Rendering ---
        function render(search = '') {
            // Only recalculate metrics if NOT searching
            if (!search) {
                updateMetrics();
            }
            renderList(search);
        }

        function handleSearch(val) {
            // Skips updateMetrics() for lightning speed
            renderList(val);
        }

        function updateMetrics() {
            const totalRev = history.reduce((s, h) => s + (h.amount || 0), 0);
            const totalGive = clients.reduce((s, c) => s + (c.giveback || 0), 0);
            const todayStr = getTodayIso();
            const todayRev = history.filter(h => h.date === todayStr).reduce((s, h) => s + h.amount, 0);

            document.getElementById('mToday').innerText = '$' + todayRev.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('mRev').innerText = '$' + totalRev.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('mGive').innerText = '$' + totalGive.toLocaleString(undefined, {minimumFractionDigits: 2});
        }

        function renderList(search = '') {
            const list = document.getElementById('list');
            list.innerHTML = '';

            let filtered = clients.filter(c => {
                if(search && !c.name.toLowerCase().includes(search.toLowerCase())) return false;
                if (viewArchives) return c.archived === true;
                else if (c.archived === true) return false;

                if(!search && activeFilter === 'due') return getStatus(c) === 'due';
                if(!search && activeFilter === 'overdue') return getStatus(c) === 'overdue';
                return true;
            });

            if (activeFilter === 'all' || search) {
                filtered.sort((a,b) => a.name.localeCompare(b.name));
            } else {
                filtered.sort((a,b) => {
                    const dateA = new Date(a.last || a.first || '2000-01-01');
                    const dateB = new Date(b.last || b.first || '2000-01-01');
                    return dateA - dateB; 
                });
            }

            filtered.forEach(c => {
                const stat = getStatus(c);
                let badges = '';
                if(c.dob && isMonth(c.dob)) badges += `<span class="badge" style="color:var(--p-pink-dark)"><i class="fas fa-birthday-cake"></i></span>`;
                if(c.first && isAnniversary(c.first)) badges += `<span class="badge" style="color:var(--p-purple)"><i class="fas fa-medal"></i></span>`;
                if (c.spent >= 250) badges += `<span style="color:var(--p-gold); margin-left:5px;"><i class="fas fa-crown"></i></span>`;
                let flags = '';
                if(c.strikes > 0) flags = ' ' + 'üö©'.repeat(Math.min(c.strikes, 3));

                const div = document.createElement('div');
                div.className = `client-card ${stat}`;
                div.onclick = () => showClient(c.id);
                div.innerHTML = `
                    <div class="cc-top">
                        <div class="cc-name">${c.name} ${badges}${flags}</div>
                        <div class="cc-due">${getDueStr(c)}</div>
                    </div>
                    <div class="cc-info">Last: ${formatPretty(c.last)}</div>
                    <div class="loyalty-visual">${getLoyaltyVisual(c.loyalty)}</div>
                `;
                list.appendChild(div);
            });
        }

        function showClient(id) {
            activeId = id;
            const c = getClient(id);
            let nameDisplay = c.name;
            if(c.strikes > 0) nameDisplay += ` (${c.strikes} Strike${c.strikes>1?'s':''})`;
            document.getElementById('vName').innerText = nameDisplay;
            document.getElementById('vSub').innerText = c.phone || 'No Phone';
            document.getElementById('vFormula').innerText = c.formula || "No cut formula saved.";
            
            let b = '';
            if(c.dob && isMonth(c.dob)) b += `<span style="background:var(--p-pink); color:black; padding:5px 10px; border-radius:10px; font-size:0.8rem; font-weight:bold;">üéÇ Birthday Month</span>`;
            if(c.first && isAnniversary(c.first)) b += `<span style="background:var(--p-purple); color:black; padding:5px 10px; border-radius:10px; font-size:0.8rem; font-weight:bold;">üèÖ Anniversary Month</span>`;
            document.getElementById('vBadges').innerHTML = b;

            const iceBox = document.getElementById('vIcebreaker');
            if(c.icebreaker && c.icebreaker.trim() !== '') {
                document.getElementById('vIceText').innerText = "Ask about: " + c.icebreaker;
                iceBox.style.display = 'flex';
            } else { iceBox.style.display = 'none'; }

            const tagDiv = document.getElementById('vTags');
            tagDiv.innerHTML = '';
            if(c.tags && c.tags.length > 0) {
                c.tags.forEach(t => { tagDiv.innerHTML += `<span class="tag-badge">${t}</span>`; });
            }

            document.getElementById('vLoyalty').innerText = getLoyaltyVisual(c.loyalty);
            document.getElementById('vCredit').innerText = `$${(c.credit||0).toFixed(2)}`;
            document.getElementById('vTotalCuts').innerText = c.cuts||0;
            document.getElementById('vLTV').innerText = `$${(c.spent||0).toFixed(2)}`;
            
            document.getElementById('btnCall').href = `tel:${c.phone}`;
            document.getElementById('btnInsta').style.display = c.insta ? 'block' : 'none';
            document.getElementById('btnRemStrike').style.display = (c.strikes > 0) ? 'flex' : 'none';

            const emBtn = document.getElementById('btnEmail');
            if(c.email) { emBtn.style.display = 'flex'; emBtn.href = `mailto:${c.email}`; } else { emBtn.style.display = 'none'; }

            const navBtn = document.getElementById('btnNav');
            if (navBtn) {
                if (c.address && c.address.trim() !== '') {
                    navBtn.style.display = 'flex';
                    navBtn.href = `maps://?q=${encodeURIComponent(c.address)}`;
                } else { navBtn.style.display = 'none'; }
            }
            
            const arcBtn = document.getElementById('btnArchive');
            arcBtn.innerHTML = c.archived ? '<i class="fas fa-box-open"></i> Restore Client' : '<i class="fas fa-archive"></i> Archive Client (Hide)';

            openModal('viewModal');
        }

        // --- CHECKOUT & REVENUE ---
        function openCheckout() { 
            const c = getClient(activeId); 
            document.getElementById('payPrice').value = c.price || 35; 
            document.getElementById('payTip').value = 0; 
            document.getElementById('payDate').value = getTodayIso(); 
            document.getElementById('customDiscBox').style.display = 'none'; 
            selectedDisc = 'none'; 
            
            const nextDate = new Date();
            nextDate.setDate(nextDate.getDate() + ((c.freq || 4) * 7));
            document.getElementById('sbDate').innerText = nextDate.toLocaleDateString(undefined, {month:'short', day:'numeric'});
            
            const opts = document.getElementById('discountList'); 
            opts.innerHTML = ''; 
            addOpt(opts, 'none', 'No Discount', true); 
            if((c.banked || 0) > 0) addOpt(opts, 'free', `Redeem 1 Free Cut (Banked: ${c.banked})`); 
            if((c.credit || 0) > 0) addOpt(opts, 'credit', `Redeem $5 Credit (Bal: $${c.credit})`); 
            if( (c.dob && isMonth(c.dob)) || (c.first && isAnniversary(c.first)) ) { addOpt(opts, 'half', `Redeem 50% Off (Special Month)`); } 
            addOpt(opts, 'custom', 'Custom % Discount'); 
            openModal('checkoutModal'); 
            calcTotal(); 
        }

        function calcTotal() { 
            const base = parseFloat(document.getElementById('payPrice').value) || 0; 
            const tip = parseFloat(document.getElementById('payTip').value) || 0; 
            let discount = 0; 
            if(selectedDisc === 'free') discount = base; 
            if(selectedDisc === 'half') discount = base * 0.5; 
            if(selectedDisc === 'credit') discount = Math.min(base, 5); 
            if(selectedDisc === 'custom') { 
                const pct = parseFloat(document.getElementById('payCustomPct').value) || 0; 
                discount = base * (pct / 100); 
            } 
            const giveback = discount; 
            const total = (base - discount) + tip; 
            document.getElementById('payTotal').innerText = `$${total.toFixed(2)}`; 
            document.getElementById('givebackDisplay').innerText = `Giveback: $${giveback.toFixed(2)}`; 
            return { total, giveback };
        }

        async function finalizeCut() {
            const c = getClient(activeId);
            const totals = calcTotal(); 

            let wasFreeFlag = false;
            let wasCreditFlag = false;

            if(selectedDisc === 'free') {
                c.banked = (c.banked || 0) - 1;
                wasFreeFlag = true;
            }
            if(selectedDisc === 'credit') {
                c.credit = Math.max(0, (c.credit || 0) - 5);
                wasCreditFlag = true;
            }

            c.spent = (c.spent || 0) + totals.total;
            c.giveback = (c.giveback || 0) + totals.giveback;
            c.cuts = (c.cuts || 0) + 1;
            c.last = document.getElementById('payDate').value;

            // --- SMART UNDO TRACKING ---
            history.push({
                clientId: c.id,
                clientName: c.name,
                date: c.last,
                amount: totals.total,
                wasFree: wasFreeFlag,
                wasCredit: wasCreditFlag,
                givebackAmt: totals.giveback
            });

            if(selectedDisc !== 'free') {
                c.loyalty = (c.loyalty || 0) + 1;
                if(c.loyalty >= 5) {
                    c.banked = (c.banked || 0) + 1;
                    c.loyalty = 0;
                    await customConfirm("üéâ High Five! Client reached 5 cuts. Free Cut banked.");
                }
            }
            
            saveAll();
            closeModal('checkoutModal');
            closeModal('viewModal');
            render();
        }

        async function smartBook() {
            await finalizeCut(); 
            const c = getClient(activeId);
            const nextDate = new Date();
            nextDate.setDate(nextDate.getDate() + ((c.freq || 4) * 7));
            const iso = nextDate.toISOString().slice(0, 10) + "T10:00";
            document.getElementById('schedDate').value = iso;
            openModal('schedModal');
        }

        function openWalkIn() {
            document.getElementById('wPrice').value = 35;
            document.getElementById('wTip').value = 0;
            openModal('walkInModal');
        }

        function saveWalkIn() {
            const price = parseFloat(document.getElementById('wPrice').value) || 0;
            const tip = parseFloat(document.getElementById('wTip').value) || 0;
            const total = price + tip;

            if (total <= 0) return alert("Please enter an amount.");

            history.push({
                clientId: 'walkin',
                clientName: 'üö∂ Walk-In Client',
                date: getTodayIso(),
                amount: total,
                wasFree: false,
                wasCredit: false,
                givebackAmt: 0
            });

            saveAll();
            closeModal('walkInModal');
            render();
            alert(`Walk-In Recorded: $${total.toFixed(2)}`);
        }

        // --- SMART UNDO FEATURE ---
        async function deleteTransaction(idx) {
            const h = history[idx];
            if(await customConfirm(`Delete $${h.amount.toFixed(2)} entry for ${h.clientName}?\n\nThis will reverse their stats and loyalty.`)) {
                const c = getClient(h.clientId);
                if(c) {
                    c.spent = Math.max(0, (c.spent || 0) - h.amount);
                    c.cuts = Math.max(0, (c.cuts || 0) - 1);
                    c.giveback = Math.max(0, (c.giveback || 0) - (h.givebackAmt || 0));
                    
                    if (h.wasFree) {
                        c.banked = (c.banked || 0) + 1;
                    } else if (h.wasCredit) {
                        c.credit = (c.credit || 0) + 5;
                    } else {
                        // Reverse loyalty point
                        if (c.loyalty === 0 && (c.banked || 0) > 0) {
                            c.banked--;
                            c.loyalty = 4;
                        } else {
                            c.loyalty = Math.max(0, (c.loyalty || 0) - 1);
                        }
                    }
                }
                history.splice(idx, 1);
                saveAll();
                render();
                openHistory();
            }
        }

        function openStats() {
            closeModal('settingsModal');
            const div = document.getElementById('statsContent');
            div.innerHTML = '';
            const years = {};
            history.forEach(h => {
                const y = h.date.split('-')[0];
                if(!years[y]) years[y] = 0;
                years[y] += h.amount;
            });
            let html = '<div class="v-grid">';
            Object.keys(years).sort().reverse().forEach(y => {
                html += `<div class="v-box"><span class="v-big" style="color:var(--p-green-dark)">$${years[y].toFixed(2)}</span><span style="font-size:0.7rem;">${y} Revenue</span></div>`;
            });
            html += '</div>';
            div.innerHTML = html;
            openModal('statsModal');
        }

        async function toggleArchive() {
            const c = getClient(activeId);
            const action = c.archived ? "Restore" : "Archive";
            if(await customConfirm(`${action} this client?`)) {
                c.archived = !c.archived;
                saveAll(); 
                closeModal('viewModal'); 
                render();
            }
        }
        function toggleArchiveMode() {
            viewArchives = !viewArchives;
            document.getElementById('archiveLabel').innerText = viewArchives ? "Back to Active Clients" : "View Archived Clients";
            closeModal('settingsModal'); render();
        }

        function exportHistoryCSV() {
            let csv = "Date,Client,Amount\n";
            history.forEach(h => { csv += `${h.date},${h.clientName.replace(/,/g," ")},${h.amount}\n`; });
            downloadCSV(csv, 'BlackBook_Transactions.csv');
        }
        function exportSimpleCSV() {
            let csv = "Name,Phone,Email,Status,Strikes,Total_Spent,Last_Cut\n";
            clients.forEach(c => {
                const safePhone = `\t${c.phone}`;
                csv += `${c.name.replace(/,/g," ")},${safePhone},${c.email || ''},${getStatus(c)},${c.strikes||0},${c.spent},${c.last}\n`;
            });
            downloadCSV(csv, 'BlackBook_Clients.csv');
        }
        function downloadCSV(content, name) {
            const blob = new Blob([content], {type: 'text/csv;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = name; a.click();
        }
        
        function formatPretty(dateStr) {
            if(!dateStr) return 'Never';
            const [y, m, d] = dateStr.split('-'); 
            const date = new Date(y, m-1, d); 
            const mon = date.toLocaleString('default', { month: 'short' });
            const day = parseInt(d);
            let suff = 'th';
            if(day === 1 || day === 21 || day === 31) suff = 'st';
            if(day === 2 || day === 22) suff = 'nd';
            if(day === 3 || day === 23) suff = 'rd';
            return `${mon} ${day}${suff}, ${y}`;
        }

        function insertDate() {
            const txt = document.getElementById('eNotes');
            const now = new Date();
            txt.value += `\n[${now.getMonth()+1}/${now.getDate()}]: `;
            txt.focus();
        }
        
        function getClient(id) { return clients.find(x => x.id === id); }
        function setTab(t, btn) { activeFilter = t; document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); render(); }
        function isMonth(d) { return new Date(d).getMonth() === new Date().getMonth(); }
        function isAnniversary(d) { const dt = new Date(d); const now = new Date(); return dt.getMonth() === now.getMonth() && dt.getFullYear() !== now.getFullYear(); }
        function openInsta() { const c = getClient(activeId); if(c.insta) window.open(`https://instagram.com/${c.insta.replace('@','')}`); }
        function customConfirm(msg) { return new Promise((resolve) => { document.getElementById('cMsg').innerText = msg; document.getElementById('confirmModal').style.display = 'flex'; document.getElementById('cYes').onclick = () => { document.getElementById('confirmModal').style.display = 'none'; resolve(true); }; document.getElementById('cNo').onclick = () => { document.getElementById('confirmModal').style.display = 'none'; resolve(false); }; }); }
        
        function searchRef(val) { 
            const div = document.getElementById('refResults'); 
            if(!val) { div.style.display='none'; return; } 
            const matches = clients.filter(c => c.name.toLowerCase().includes(val.toLowerCase())); 
            div.innerHTML = ''; 
            if(matches.length){ 
                div.style.display='block'; 
                matches.forEach(m => { 
                    const d = document.createElement('div'); 
                    d.innerText = m.name; 
                    d.style.padding='8px'; 
                    d.style.borderBottom='1px solid #444'; 
                    d.onclick = () => { document.getElementById('eRef').value = m.name; div.style.display='none'; }; 
                    div.appendChild(d); 
                }); 
            } else div.style.display='none'; 
        }

        function openSchedule() { openModal('schedModal'); }
        function openSettings() { openModal('settingsModal'); }
        
        function openHistory() { 
            closeModal('settingsModal'); 
            const div = document.getElementById('historyList'); 
            div.innerHTML = ''; 
            const revHist = [...history].reverse(); 
            if(revHist.length === 0) div.innerHTML = "No transactions yet."; 
            revHist.forEach((h, i) => { 
                const originalIndex = (history.length - 1) - i;
                const row = document.createElement('div'); 
                row.className = 'hist-item'; 
                row.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:700;">${h.clientName}</span>
                        <span style="font-size:0.7rem; color:var(--text-sub);">${formatPretty(h.date)}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:15px;">
                        <b>$${h.amount.toFixed(2)}</b>
                        <i class="fas fa-trash-alt" style="color:#ff6b6b; cursor:pointer;" onclick="deleteTransaction(${originalIndex})"></i>
                    </div>
                `; 
                div.appendChild(row); 
            }); 
            openModal('historyModal'); 
        }

        function addToCalendar() { const c = getClient(activeId); const d = new Date(document.getElementById('schedDate').value); const loc = document.getElementById('schedLoc').value === 'shop' ? settings.location : c.address; const end = new Date(d.getTime() + 7200000); const fmt = (x) => x.toISOString().replace(/-|:|\.\d\d\d/g,""); const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART:${fmt(d)}\nDTEND:${fmt(end)}\nSUMMARY:Cut - ${c.name}\nLOCATION:${loc}\nEND:VEVENT\nEND:VCALENDAR`; const blob = new Blob([ics], {type:'text/calendar;charset=utf-8'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'appt.ics'; a.click(); closeModal('schedModal'); }
        
        function saveSettings() { 
            settings.location = document.getElementById('setLoc').value; 
            saveAll(); 
            closeModal('settingsModal'); 
        }
        
        function exportData() { const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({clients, settings, history})); const a = document.createElement('a'); a.href = s; a.download = 'backup.json'; a.click(); }
        function toggleTheme() { document.body.classList.toggle('dark-mode'); isDark = document.body.classList.contains('dark-mode'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); }
        function getStatus(c) { const refDate = c.last || c.first; if(!refDate) return 'good'; const last = new Date(refDate); const today = new Date(); const days = (today - last)/(1000*60*60*24); const freqDays = (c.freq || 4) * 7; if(days >= 56) return 'overdue'; if(days >= freqDays) return 'due'; return 'good'; }
        function getDueStr(c) { const refDate = c.last || c.first; if(!refDate) return 'Today'; const last = new Date(refDate); last.setDate(last.getDate() + ((c.freq||4)*7)); return last.toLocaleDateString(undefined, {month:'short', day:'numeric'}); }
        function getLoyaltyVisual(n) { n = n || 0; let s = ''; for(let i=0; i<5; i++) { s += (i < n) ? '‚úÇÔ∏è' : '‚ö™'; } return s; }
        
        function exportRobustExcel() {
            let html = '<html><head><style>body{font-family:sans-serif; padding:20px;} table{width:100%; border-collapse:collapse; margin-bottom:40px;} th{background:#4472C4; color:white; padding:10px; text-align:left;} td{border:1px solid #ddd; padding:8px;} .due{color:#e67e22;} .overdue{color:#e74c3c;}</style></head><body>';
            html += '<h1>Black Book Report</h1><p>Generated: ' + new Date().toLocaleDateString() + '</p>';
            html += '<h2>Active Clients</h2><table><tr><th>Name</th><th>Phone</th><th>Status</th><th>Strikes</th><th>LTV</th><th>Last Cut</th></tr>';
            clients.forEach(c => { 
                if(c.archived) return; 
                const stat = getStatus(c); 
                html += `<tr><td><b>${c.name}</b></td><td>${c.phone || ''}</td><td>${stat.toUpperCase()}</td><td>${c.strikes || 0}</td><td>$${(c.spent||0).toFixed(2)}</td><td>${formatPretty(c.last)||''}</td></tr>`; 
            });
            html += '</table><h2>Transaction History</h2><table><tr><th>Date</th><th>Client</th><th>Amount</th></tr>';
            history.forEach(h => { html += `<tr><td>${formatPretty(h.date)}</td><td>${h.clientName}</td><td>$${h.amount.toFixed(2)}</td></tr>`; });
            html += '</table></body></html>';
            const blob = new Blob([html], {type: 'text/html'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'BlackBook_Report.html'; a.click();
        }

        function showCrashScreen(msg) { const m = document.getElementById('crashModal'); document.getElementById('crashMsg').innerText = msg; m.style.display = 'flex'; }
        function emergencyCopy() { const raw = localStorage.getItem('bbClients'); if(navigator.clipboard) { navigator.clipboard.writeText(raw).then(() => alert("Copied!")); } else { prompt("Copy:", raw); } }
        function factoryReset() { if(confirm("This deletes everything. Sure?")) { localStorage.clear(); location.reload(); } }
        
        function addOpt(parent, val, label, selected = false) { 
            const div = document.createElement('div'); 
            div.className = `discount-opt ${selected ? 'selected' : ''}`; 
            div.innerText = label; 
            div.onclick = () => { 
                document.querySelectorAll('.discount-opt').forEach(d => d.classList.remove('selected')); 
                div.classList.add('selected'); 
                selectedDisc = val; 
                document.getElementById('customDiscBox').style.display = val === 'custom' ? 'block' : 'none'; 
                calcTotal(); 
            }; 
            parent.appendChild(div); 
        }
        
        function captureEditState() {
            const fields = ['eName', 'ePhone', 'eInsta', 'eEmail', 'eAddr', 'ePrice', 'eFreq', 'eFirst', 'eDob', 'eRef', 'eNotes', 'eIcebreaker', 'eFormula', 'eBanked', 'eLoyalty'];
            let state = "";
            fields.forEach(f => {
                const el = document.getElementById(f);
                if (el) state += el.value;
            });
            state += Array.from(document.querySelectorAll('#eTags .tag-pill.active')).map(x => x.innerText).join("");
            return state;
        }

        async function cancelEdit() {
            const currentState = captureEditState();
            if (currentState !== editInitialState) {
                if (!await customConfirm("Discard unsaved changes?")) return;
            }
            closeModal('editModal');
        }

        function openAddModal() { 
            document.getElementById('eTitle').innerText = 'New Client'; 
            document.getElementById('eId').value = ''; 
            document.getElementById('eName').value = ''; 
            document.getElementById('ePhone').value = ''; 
            document.getElementById('eInsta').value = ''; 
            document.getElementById('eEmail').value = ''; 
            document.getElementById('eAddr').value = ''; 
            document.getElementById('eRef').value = ''; 
            document.getElementById('eNotes').value = ''; 
            document.getElementById('eIcebreaker').value = ''; 
            document.getElementById('eFormula').value = ''; 
            document.getElementById('ePrice').value = 35; 
            document.getElementById('eFreq').value = 4; 
            document.getElementById('eDob').value = ''; 
            document.getElementById('eBanked').value = 0;
            document.getElementById('eLoyalty').value = 0;
            document.getElementById('eFirst').value = getTodayIso(); 
            const tagBox = document.getElementById('eTags'); tagBox.innerHTML = ''; 
            VIBE_TAGS.forEach(t => { 
                const pill = document.createElement('div'); 
                pill.className = 'tag-pill'; 
                pill.innerText = t; 
                pill.onclick = () => pill.classList.toggle('active'); 
                tagBox.appendChild(pill); 
            });
            editInitialState = captureEditState();
            openModal('editModal'); 
        }
        
        function editClient() { 
            closeModal('viewModal'); 
            const c = getClient(activeId); 
            document.getElementById('eTitle').innerText = 'Edit Client'; 
            document.getElementById('eId').value = c.id; 
            document.getElementById('eName').value = c.name; 
            document.getElementById('ePhone').value = c.phone; 
            document.getElementById('eInsta').value = c.insta; 
            document.getElementById('eEmail').value = c.email || ''; 
            document.getElementById('ePrice').value = c.price; 
            document.getElementById('eAddr').value = c.address; 
            document.getElementById('eFreq').value = c.freq; 
            document.getElementById('eFirst').value = c.first; 
            document.getElementById('eDob').value = c.dob; 
            document.getElementById('eRef').value = c.refBy || ''; 
            document.getElementById('eNotes').value = c.notes; 
            document.getElementById('eIcebreaker').value = c.icebreaker || '';
            document.getElementById('eFormula').value = c.formula || ''; 
            document.getElementById('eBanked').value = c.banked || 0;
            document.getElementById('eLoyalty').value = c.loyalty || 0;
            const tagBox = document.getElementById('eTags');
            tagBox.innerHTML = '';
            const myTags = c.tags || [];
            VIBE_TAGS.forEach(t => {
                const pill = document.createElement('div');
                pill.className = `tag-pill ${myTags.includes(t) ? 'active' : ''}`;
                pill.innerText = t;
                pill.onclick = () => pill.classList.toggle('active');
                tagBox.appendChild(pill);
            });
            editInitialState = captureEditState();
            openModal('editModal'); 
        }

        async function saveClient() { 
            const id = document.getElementById('eId').value || Date.now().toString(); 
            const isNew = !document.getElementById('eId').value; 
            const refName = document.getElementById('eRef').value.trim(); 
            let creditAdd = 0; 

            if(isNew && refName) { 
                const referee = clients.find(x => x.name.toLowerCase() === refName.toLowerCase()); 
                if(referee) { 
                    referee.credit = (referee.credit || 0) + 5; 
                    creditAdd = 5; 
                    await customConfirm(`Linked to ${referee.name}! $5 added to both.`); 
                } else {
                    alert(`Note: No client found named "${refName}". No referral credit applied.`);
                }
            } 
            const selectedTags = Array.from(document.querySelectorAll('#eTags .tag-pill.active')).map(x => x.innerText);
            const formFirst = document.getElementById('eFirst').value; 
            const data = { 
                id: id, name: document.getElementById('eName').value, phone: document.getElementById('ePhone').value, 
                insta: document.getElementById('eInsta').value, email: document.getElementById('eEmail').value, 
                address: document.getElementById('eAddr').value, price: parseFloat(document.getElementById('ePrice').value), 
                freq: parseInt(document.getElementById('eFreq').value), first: formFirst, dob: document.getElementById('eDob').value, 
                refBy: refName, notes: document.getElementById('eNotes').value, icebreaker: document.getElementById('eIcebreaker').value,
                formula: document.getElementById('eFormula').value, tags: selectedTags,
                credit: isNew ? creditAdd : getClient(id).credit, 
                banked: parseInt(document.getElementById('eBanked').value) || 0, 
                loyalty: parseInt(document.getElementById('eLoyalty').value) || 0, 
                spent: isNew ? 0 : getClient(id).spent, 
                giveback: isNew ? 0 : getClient(id).giveback, cuts: isNew ? 0 : getClient(id).cuts, 
                // --- LAST CUT SYNC FIX ---
                last: isNew ? formFirst : getClient(id).last, 
                strikes: isNew ? 0 : (getClient(id).strikes || 0), 
                archived: isNew ? false : (getClient(id).archived || false) 
            }; 
            if(isNew) clients.push(data); 
            else { const idx = clients.findIndex(x => x.id === id); clients[idx] = data; } 
            saveAll(); closeModal('editModal'); render(); 
        }
        
        async function deleteClient() { if(await customConfirm("Permanently delete this client?")) { clients = clients.filter(c => c.id !== document.getElementById('eId').value); saveAll(); closeModal('editModal'); render(); } }
        async function addStrike() { const c = getClient(activeId); if(await customConfirm(`Mark ${c.name} as a No-Show? \n\nAdds a Strike üö©.`)) { c.strikes = (c.strikes || 0) + 1; saveAll(); closeModal('viewModal'); render(); } }
        async function removeStrike() { const c = getClient(activeId); if(await customConfirm("Remove one Strike üö©?")) { c.strikes = Math.max(0, (c.strikes || 0) - 1); saveAll(); closeModal('viewModal'); render(); } }
        function openSmsMenu() { openModal('smsModal'); }

        function sendSms(type) { 
            const c = getClient(activeId); if(!c || !c.phone) return alert('No phone saved.'); 
            const first = c.name.split(' ')[0]; let msg = ''; 
            if(type === 'late') msg = `Hey ${first}, running about 15 mins late. So sorry!`; 
            if(type === 'confirm') msg = `Yo ${first}, just confirming our cut. You still good?`; 
            if(type === 'longtime') msg = `Hey ${first}, been a while! Time to clean up that cut?`; 
            if(type === 'followup') msg = `Appreciate you coming through ${first}! How's the cut treating you?`; 
            if(type === 'review') msg = `Yo ${first}, appreciate the cut! If you have a sec, rate it here:\n\nhttps://mannyserrano4-oss.github.io/crispy-enigma/reviews`; 
            if(type === 'custom') msg = `Hey ${first}, `;
            
            const ua = navigator.userAgent.toLowerCase();
            const isApple = ua.indexOf('iphone') > -1 || ua.indexOf('ipad') > -1;
            const sep = isApple ? '&' : '?';
            
            window.location.href = `sms:${c.phone}${sep}body=${encodeURIComponent(msg)}`; 
            closeModal('smsModal'); 
        }

        function restoreData(input) {
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.clients) { clients = d.clients; settings = d.settings || settings; history = d.history || []; saveAll(); render(); alert('Database Restored Successfully!'); closeModal('settingsModal'); }
                } catch(err) { alert("Error loading file: " + err); }
            };
            r.readAsText(input.files[0]);
        }
    </script>
</body>
</html>
