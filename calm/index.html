<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ZenSpace</title>
    <link rel="stylesheet" href="style.css">
    </head>
<body>

<div id="app" class="glass-container">
    
    <section id="mood-screen">
        <h1 class="fade-in">How do you want to feel?</h1>
        <div class="grid">
            <button onclick="selectMood('528', 'Stress Relief')">528Hz: Stress Relief</button>
            <button onclick="selectMood('396', 'Release Fear')">396Hz: Release Fear</button>
            <button onclick="selectMood('432', 'Inner Peace')">432Hz: Inner Peace</button>
            <button onclick="selectMood('639', 'Relationships')">639Hz: Relationships</button>
        </div>
    </section>

    <section id="song-screen" class="hidden">
        <h2 id="mood-label">Select Track</h2>
        <div class="song-list">
            <button onclick="selectTrack('synth')">Pure Solfeggio (Synth)</button>
            <button onclick="selectTrack('ocean_waves.mp3')">Ocean Waves (MP3)</button>
            <button onclick="selectTrack('forest_rain.mp3')">Forest Rain (MP3)</button>
        </div>
        <button class="back-btn" onclick="showScreen('mood-screen')">← Back</button>
    </section>

    <section id="timer-settings" class="hidden">
        <h2>Duration</h2>
        <div class="timer-grid">
            <button onclick="prepTimer(1)">1m</button>
            <button onclick="prepTimer(3)">3m</button>
            <button onclick="prepTimer(5)">5m</button>
            <button onclick="prepTimer(10)">10m</button>
            <button onclick="prepTimer(20)">20m</button>
            <button onclick="prepTimer(30)">30m</button>
            <button onclick="prepTimer(45)">45m</button>
            <input type="number" id="custom-min" placeholder="Custom Min" onchange="prepTimer(this.value)">
        </div>
        <button class="back-btn" onclick="showScreen('song-screen')">← Back</button>
    </section>

    <section id="meditation-screen" class="hidden">
        <div id="quote-area">
            <p id="quote-text"></p>
        </div>

        <div id="visualizer-container">
            <div class="breathing-circle" id="circle"></div>
            <p id="breath-guide">Breathe In</p>
        </div>

        <div id="display-timer">00:00</div>

        <div class="controls">
            <button id="playPauseBtn" onclick="toggleMeditation()">Start</button>
            <button onclick="resetAll()">Reset</button>
        </div>

        <div class="technique-picker">
            <button onclick="setTechnique('box')">Box Breath</button>
            <button onclick="setTechnique('calm')">4-7-8 Calm</button>
        </div>
    </section>
</div>

<script src="quotes.js"></script>
<script>
    // 1. Initial State
    let state = {
        freq: '528',
        track: 'synth',
        duration: 1,
        timeLeft: 0,
        isActive: false,
        technique: 'box',
        wakeLock: null
    };

    let timerInterval;
    let audioCtx;
    let oscillator;

    // 2. Start-up Logic
    document.addEventListener('DOMContentLoaded', () => {
        // Register Service Worker for Offline Mode
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
        }
        // Force the app to start on the first screen
        showScreen('mood-screen');
    });

    // 3. Navigation
    function showScreen(id) {
        document.querySelectorAll('section').forEach(s => {
            s.classList.add('hidden');
            s.style.display = 'none'; 
        });
        const target = document.getElementById(id);
        if (target) {
            target.classList.remove('hidden');
            target.style.display = 'block';
        }
        hapticFeedback();
    }

    function selectMood(hz, label) {
        state.freq = hz;
        document.getElementById('mood-label').innerText = label;
        showScreen('song-screen');
    }

    function selectTrack(file) {
        state.track = file;
        showScreen('timer-settings');
    }

    function prepTimer(mins) {
        const val = parseInt(mins);
        if (isNaN(val)) return;
        state.duration = val;
        state.timeLeft = val * 60;
        updateTimerDisplay();
        updateThemeColor(val);
        
        // Pick Quote
        if (typeof meditationQuotes !== 'undefined') {
            const list = meditationQuotes[state.freq];
            document.getElementById('quote-text').innerText = list[Math.floor(Math.random() * list.length)];
        }
        
        showScreen('meditation-screen');
    }

    // 4. Meditation Logic
    async function toggleMeditation() {
        hapticFeedback();
        const btn = document.getElementById('playPauseBtn');
        if (!state.isActive) {
            state.isActive = true;
            btn.innerText = "Pause";
            startTimer();
            startAudio();
            if ('wakeLock' in navigator) {
                state.wakeLock = await navigator.wakeLock.request('screen');
            }
        } else {
            stopMeditation();
            btn.innerText = "Start";
        }
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            state.timeLeft--;
            updateTimerDisplay();
            if (state.timeLeft <= 0) {
                stopMeditation();
                hapticFeedback(true);
            }
        }, 1000);
    }

    function stopMeditation() {
        state.isActive = false;
        clearInterval(timerInterval);
        document.getElementById('playPauseBtn').innerText = "Start";
        stopAudio();
        if (state.wakeLock) state.wakeLock.release();
    }

    function startAudio() {
        if (state.track === 'synth') {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.frequency.setValueAtTime(parseFloat(state.freq), audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
        } else {
            window.currentAudio = new Audio(state.track);
            window.currentAudio.loop = true;
            window.currentAudio.play();
        }
    }

    function stopAudio() {
        if (oscillator) oscillator.stop();
        if (window.currentAudio) window.currentAudio.pause();
    }

    function hapticFeedback(isLong = false) {
        if (navigator.vibrate) {
            navigator.vibrate(isLong ? [100, 50, 100] : 10);
        }
    }

    function updateTimerDisplay() {
        const m = Math.floor(state.timeLeft / 60);
        const s = state.timeLeft % 60;
        document.getElementById('display-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function updateThemeColor(mins) {
        const colors = { 1: '#f9d5e5', 5: '#d1eaee', 10: '#e2f0cb', 20: '#ffdac1', 45: '#b5ead7' };
        document.body.style.backgroundColor = colors[mins] || '#f3e5f5';
    }

    function setTechnique(type) {
        hapticFeedback();
        const circle = document.getElementById('circle');
        const guide = document.getElementById('breath-guide');
        if (type === 'box') {
            circle.style.animation = "boxBreath 16s infinite";
            guide.innerText = "Box Breathing: In, Hold, Out, Hold";
        } else {
            circle.style.animation = "calmBreath 19s infinite";
            guide.innerText = "4-7-8: In, Hold, Out";
        }
    }

    function resetAll() {
        stopMeditation();
        showScreen('mood-screen');
    }
</script>
</body>
</html>
