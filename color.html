<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAS Color Lab | Pro</title>
    <style>
        :root { --bg: #0a0a0c; --card: #16161a; --text: #ececed; --accent: #38bdf8; --border: #2d2d33; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 380px; border-right: 1px solid var(--border); padding: 24px; overflow-y: auto; background: var(--card); display: flex; flex-direction: column; gap: 15px; z-index: 10; }
        .drop-zone { border: 2px dashed var(--accent); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; background: rgba(56, 189, 248, 0.03); }
        
        .wheel-container { position: relative; width: 220px; height: 220px; margin: 10px auto; }
        #color-wheel { width: 100%; height: 100%; border-radius: 50%; cursor: crosshair; border: 3px solid var(--border); }
        #wheel-cursor { position: absolute; width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%); box-shadow: 0 0 4px black; }

        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 10px; }
        .swatch { aspect-ratio: 1/1; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; display: flex; align-items: flex-end; justify-content: center; font-size: 8px; padding-bottom: 2px; text-shadow: 0 0 2px black; }
        .swatch.active { border-color: var(--accent); transform: scale(1.1); }

        .definition-card { font-size: 0.8rem; line-height: 1.5; background: rgba(56, 189, 248, 0.05); padding: 12px; border-radius: 10px; border: 1px solid rgba(56, 189, 248, 0.15); }

        .main-stage { flex: 1; background: #000; position: relative; overflow: hidden; }
        #canvas-holder { transform-origin: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        canvas#editor-canvas { max-width: 90vw; max-height: 85vh; image-rendering: pixelated; cursor: crosshair; }

        /* Magnifier Glass */
        #magnifier { position: fixed; width: 100px; height: 100px; border: 3px solid var(--accent); border-radius: 50%; pointer-events: none; display: none; overflow: hidden; z-index: 100; background: #000; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        #mag-canvas { width: 200%; height: 200%; image-rendering: pixelated; }

        .zoom-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(22,22,26,0.9); padding: 10px 20px; border-radius: 50px; display: flex; gap: 20px; align-items: center; border: 1px solid var(--border); backdrop-filter: blur(10px); }
        .action-btn { background: var(--accent); color: #000; border: none; padding: 10px 15px; border-radius: 30px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="drop-zone" onclick="document.getElementById('file-input').click()">
            <div style="font-weight: 800; color: var(--accent);">IMPORT QR OR DESIGN</div>
            <input type="file" id="file-input" accept="image/*" hidden>
        </div>

        <select id="harmony-mode" class="action-btn" style="background:#000; color:#fff; border:1px solid var(--border); width:100%;">
            <option value="analogous">Analogous</option>
            <option value="monochromatic">Monochromatic</option>
            <option value="complementary">Complementary</option>
            <option value="triad">Triad</option>
        </select>

        <div class="wheel-container">
            <canvas id="color-wheel"></canvas>
            <div id="wheel-cursor"></div>
        </div>

        <div id="theory-definition" class="definition-card"><b>Analogous:</b> Colors next to each other. Best for smooth, nature-inspired blends.</div>

        <div style="font-size:0.75rem; color:var(--accent); font-weight:bold; margin-top:10px;">SUGGESTED PALETTE</div>
        <div class="palette-grid" id="palette-display"></div>

        <button class="action-btn" id="download-btn" style="margin-top:auto">EXPORT DESIGN</button>
    </aside>

    <main class="main-stage" id="stage">
        <div id="canvas-holder">
            <canvas id="editor-canvas"></canvas>
        </div>
        <div id="magnifier"><canvas id="mag-canvas"></canvas></div>
        
        <div class="zoom-bar">
            <span style="font-size: 0.7rem;">ZOOM: <span id="z-val">1</span>x</span>
            <input type="range" id="z-slider" min="1" max="10" step="0.1" value="1">
            <div id="active-hex" style="font-family:monospace; color:var(--accent);">#PICK COLOR</div>
        </div>
    </main>

    <script>
        const editor = document.getElementById('editor-canvas'), eCtx = editor.getContext('2d', {willReadFrequently: true});
        const wheel = document.getElementById('color-wheel'), wCtx = wheel.getContext('2d');
        const mag = document.getElementById('magnifier'), magCanvas = document.getElementById('mag-canvas'), mCtx = magCanvas.getContext('2d');
        const paletteDisplay = document.getElementById('palette-display'), zSlider = document.getElementById('z-slider'), holder = document.getElementById('canvas-holder');
        const theoryBox = document.getElementById('theory-definition'), activeHexDisplay = document.getElementById('active-hex');

        let imgData = null, originalData = null, scale = 1, pX = 0, pY = 0, start = {x:0, y:0}, isDrag = false;
        let selectedSourceRGB = null, baseHSL = {h: 200, s: 100, l: 50};

        const theories = {
            analogous: "<b>Analogous:</b> Adjacent colors. <b>Great for</b> serene, comfortable vibes like nature.",
            monochromatic: "<b>Monochromatic:</b> Shades of one hue. <b>Great for</b> clean, professional barber branding.",
            complementary: "<b>Complementary:</b> Opposites. <b>Great for</b> high-contrast QR codes that must pop.",
            triad: "<b>Triad:</b> Three equal spaces. <b>Great for</b> vibrant, balanced streetwear designs."
        };

        // 1. Setup Wheel
        wheel.width = wheel.height = 400;
        function drawWheel() {
            const r = 200;
            for(let i=0; i<360; i++) {
                wCtx.beginPath(); wCtx.moveTo(r,r); wCtx.arc(r,r,r, (i-1)*Math.PI/180, (i+1)*Math.PI/180);
                wCtx.fillStyle = `hsl(${i}, 100%, 50%)`; wCtx.fill();
            }
        }
        drawWheel();

        // 2. File Handling
        document.getElementById('file-input').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    editor.width = img.width; editor.height = img.height;
                    eCtx.drawImage(img, 0, 0);
                    imgData = eCtx.getImageData(0,0,img.width,img.height);
                    originalData = eCtx.getImageData(0,0,img.width,img.height);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        // 3. Eyedropper & Magnifier
        editor.onmousemove = (e) => {
            if(!imgData) return;
            mag.style.display = 'block';
            mag.style.left = (e.clientX + 20) + 'px'; mag.style.top = (e.clientY + 20) + 'px';
            
            const rect = editor.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / (rect.width / editor.width));
            const y = Math.floor((e.clientY - rect.top) / (rect.height / editor.height));
            
            // Draw into magnifier canvas
            mCtx.clearRect(0,0,magCanvas.width,magCanvas.height);
            mCtx.drawImage(editor, x-5, y-5, 10, 10, 0, 0, magCanvas.width, magCanvas.height);
        };
        editor.onmouseleave = () => mag.style.display = 'none';

        editor.onclick = (e) => {
            const rect = editor.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / (rect.width / editor.width));
            const y = Math.floor((e.clientY - rect.top) / (rect.height / editor.height));
            const pixel = eCtx.getImageData(x, y, 1, 1).data;
            selectedSourceRGB = {r: pixel[0], g: pixel[1], b: pixel[2]};
            activeHexDisplay.innerText = rgbToHex(pixel[0], pixel[1], pixel[2]);
        };

        // 4. Harmony & Palette
        wheel.onclick = (e) => {
            const rect = wheel.getBoundingClientRect();
            const x = e.clientX - rect.left - 110, y = e.clientY - rect.top - 110;
            baseHSL.h = (Math.atan2(y, x) * 180 / Math.PI + 450) % 360;
            updatePalette();
        };

        function updatePalette() {
            const mode = document.getElementById('harmony-mode').value;
            theoryBox.innerHTML = theories[mode];
            paletteDisplay.innerHTML = '';
            
            const offsets = {analogous:[-30,0,30], complementary:[0,180], triad:[0,120,240], monochromatic:[0]}[mode];
            const lightness = mode === 'monochromatic' ? [30,50,70,80,90] : [50,50,50];

            offsets.forEach((off, i) => {
                (mode === 'monochromatic' ? lightness : [50]).forEach(l => {
                    const hex = hslToHex((baseHSL.h + off) % 360, 100, l);
                    const s = document.createElement('div');
                    s.className = 'swatch'; s.style.background = hex; s.innerText = hex;
                    s.onclick = () => { if(selectedSourceRGB) applyRecolor(selectedSourceRGB, hexToRgb(hex)); };
                    paletteDisplay.appendChild(s);
                });
            });
        }

        function applyRecolor(target, replacement) {
            const data = imgData.data;
            for(let i=0; i<data.length; i+=4) {
                if(data[i] === target.r && data[i+1] === target.g && data[i+2] === target.b) {
                    data[i]=replacement.r; data[i+1]=replacement.g; data[i+2]=replacement.b;
                }
            }
            eCtx.putImageData(imgData, 0, 0);
            selectedSourceRGB = replacement;
            activeHexDisplay.innerText = rgbToHex(replacement.r, replacement.g, replacement.b);
        }

        // 5. Utils & Zoom
        zSlider.oninput = () => {
            scale = zSlider.value; document.getElementById('z-val').innerText = scale;
            holder.style.transform = `translate(-50%, -50%) scale(${scale})`;
        };

        function rgbToHex(r,g,b) { return "#"+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('').toUpperCase(); }
        function hexToRgb(hex) { return {r:parseInt(hex.slice(1,3),16), g:parseInt(hex.slice(3,5),16), b:parseInt(hex.slice(5,7),16)}; }
        function hslToHex(h,s,l) {
            l/=100; const a=s*Math.min(l,1-l)/100;
            const f=n=>{const k=(n+h/30)%12; return Math.round(255*(l-a*Math.max(Math.min(k-3,9-k,1),-1))).toString(16).padStart(2,'0');};
            return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
        }

        document.getElementById('download-btn').onclick = () => {
            const a = document.createElement('a'); a.download = 'MAS-Recolor.png'; a.href = editor.toDataURL(); a.click();
        };
        document.getElementById('harmony-mode').onchange = updatePalette;
    </script>
</body>
</html>
