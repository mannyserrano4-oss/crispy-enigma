<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MAS Barbery</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* iOS Dark Palette */
            --bg: #000000;
            --card-bg: #1c1c1e;
            --modal-bg: #2c2c2e;
            --text-main: #ffffff;
            --text-sub: #8e8e93;
            --separator: #38383a;
            
            /* Branding & Status */
            --blue: #0A84FF;
            --green: #30D158;
            --red: #FF453A;
            --orange: #FF9F0A;
            --gold: #FFD60A;
            --purple: #BF5AF2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: 120px; /* Space for FAB and bottom reach */
            -webkit-tap-highlight-color: transparent;
        }

        /* --- NAVIGATION & HEADER --- */
        .glass-header {
            position: sticky;
            top: 0;
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--separator);
            z-index: 100;
            padding-top: env(safe-area-inset-top);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }

        .app-title {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* Metrics Scroller */
        .metrics-container {
            display: flex;
            overflow-x: auto;
            padding: 10px 15px;
            gap: 12px;
            scrollbar-width: none;
        }
        .metrics-container::-webkit-scrollbar { display: none; }

        .metric-card {
            background: var(--modal-bg);
            min-width: 100px;
            padding: 10px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .metric-label { font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; margin-bottom: 4px; }
        .metric-value { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        .metric-value.money { color: var(--green); }

        /* Segmented Control (Tabs) */
        .segment-control {
            margin: 10px 15px 15px 15px;
            background: rgba(118, 118, 128, 0.24);
            border-radius: 9px;
            padding: 2px;
            display: flex;
        }
        .segment-btn {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-main);
            padding: 8px 0;
            font-size: 13px;
            font-weight: 600;
            border-radius: 7px;
            transition: all 0.2s ease;
        }
        .segment-btn.active {
            background: #636366;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
        }

        /* --- CLIENT CARDS --- */
        .client-list { padding: 0 15px; }

        .client-card {
            background: var(--card-bg);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }

        /* Status Indicators (Left Border Strip) */
        .status-strip {
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 6px;
        }
        .s-overdue .status-strip { background: var(--red); }
        .s-due .status-strip { background: var(--orange); }
        .s-good .status-strip { background: var(--green); }

        .card-content { padding: 16px 16px 16px 22px; } /* Extra left padding for strip */

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .client-name { font-size: 1.3rem; font-weight: 700; color: white; display: flex; align-items: center; gap: 8px; }
        .client-info { color: var(--text-sub); font-size: 0.9rem; margin-top: 4px; display: flex; gap: 10px; }
        
        .ltv-badge {
            background: rgba(48, 209, 88, 0.15);
            color: var(--green);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* Loyalty Progress */
        .loyalty-wrapper { margin: 12px 0; }
        .loyalty-track { background: #3a3a3c; height: 8px; border-radius: 4px; overflow: hidden; }
        .loyalty-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--purple)); width: 0%; transition: width 0.5s ease; }
        .loyalty-text { font-size: 0.75rem; color: var(--text-sub); margin-top: 4px; display: flex; justify-content: space-between; }

        /* Action Grid */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            border-top: 1px solid var(--separator);
        }
        .action-btn {
            background: none;
            border: none;
            padding: 15px 0;
            color: var(--blue);
            font-size: 1.2rem;
            border-right: 1px solid var(--separator);
        }
        .action-btn:last-child { border-right: none; }
        .action-btn:active { background: rgba(255,255,255,0.1); }
        .btn-cut { color: var(--green); }
        .btn-alert { color: var(--orange); }

        /* --- FLOATING BUTTON --- */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 25px;
            width: 65px;
            height: 65px;
            background: var(--blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            box-shadow: 0 4px 20px rgba(10, 132, 255, 0.4);
            z-index: 500;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        /* --- MODAL STYLING --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: flex-end; /* Sheet style */
        }
        .modal-sheet {
            background: var(--card-bg);
            width: 100%;
            height: 90%;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

        .form-section {
            background: var(--modal-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .section-title {
            color: var(--text-sub);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title i { color: var(--blue); }

        .input-group { margin-bottom: 12px; }
        input, select, textarea {
            width: 100%;
            background: #1c1c1e;
            border: 1px solid #3a3a3c;
            color: white;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px; /* Prevents zoom on iOS */
            box-sizing: border-box;
        }
        input:focus { border-color: var(--blue); outline: none; }

        .btn-main {
            width: 100%;
            padding: 18px;
            background: var(--blue);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        /* --- ACTION SHEET --- */
        .action-sheet-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sheet-btn {
            background: var(--modal-bg);
            padding: 18px;
            border-radius: 14px;
            color: white;
            font-size: 1.1rem;
            border: none;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .sheet-btn i { width: 25px; text-align: center; }

        /* Search Results */
        .search-results {
            background: #333;
            border-radius: 0 0 10px 10px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
        .search-item { padding: 12px; border-bottom: 1px solid #444; }
    </style>
</head>
<body>

    <header class="glass-header">
        <div class="top-bar">
            <div class="app-title">MAS Barbery <span style="font-weight:normal; color:#555;">& Beardcraft</span></div>
            <div onclick="openSettings()"><i class="fas fa-cog" style="font-size:1.2rem;"></i></div>
        </div>

        <div class="metrics-container">
            <div class="metric-card">
                <span class="metric-label">Revenue</span>
                <span class="metric-value money" id="mGlobalRev">$0</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">Giveback</span>
                <span class="metric-value" id="mGivenBack">$0</span>
            </div>
            <div class="metric-card">
                <span class="metric-label">Active Clients</span>
                <span class="metric-value" id="mTotalCuts">0</span>
            </div>
        </div>

        <div class="segment-control">
            <button class="segment-btn active" onclick="setTab('due', this)">Due</button>
            <button class="segment-btn" onclick="setTab('overdue', this)">Overdue</button>
            <button class="segment-btn" onclick="setTab('all', this)">All Clients</button>
        </div>
    </header>

    <div id="clientList" class="client-list">
        </div>

    <div class="fab" onclick="openModal('clientModal')">
        <i class="fas fa-plus"></i>
    </div>

    <div id="clientModal" class="modal-overlay">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 style="margin:0; font-size:1.5rem;" id="modalTitle">New Client</h2>
                <button onclick="closeModal('clientModal')" style="background:none; border:none; color:var(--blue); font-size:1rem; font-weight:bold;">Cancel</button>
            </div>

            <form id="clientForm" onsubmit="event.preventDefault(); saveClient();">
                <input type="hidden" id="cId">
                
                <div class="form-section" style="border-left: 4px solid var(--blue);">
                    <div class="section-title"><i class="fas fa-id-card"></i> Identity</div>
                    <div class="input-group">
                        <input type="text" id="cName" placeholder="Client Name" required>
                    </div>
                    <div class="input-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="tel" id="cPhone" placeholder="Phone #">
                        <input type="text" id="cInsta" placeholder="Instagram (@)">
                    </div>
                    <div class="input-group">
                        <input type="text" id="cAddress" placeholder="Home Address (Optional)">
                    </div>
                    <div class="input-group">
                        <label style="font-size:0.8rem; color:#666; display:block; margin-bottom:5px;">Birthday (Secret)</label>
                        <input type="date" id="cDob">
                    </div>
                </div>

                <div class="form-section" style="border-left: 4px solid var(--gold);">
                    <div class="section-title"><i class="fas fa-cut"></i> Service Details</div>
                    <div class="input-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label style="font-size:0.7rem;">Default Price</label>
                            <input type="number" id="cPrice" value="35">
                        </div>
                        <div>
                            <label style="font-size:0.7rem;">Frequency (Wks)</label>
                            <input type="number" id="cFreq" value="4">
                        </div>
                    </div>
                    <div class="input-group">
                        <label style="font-size:0.7rem;">First Cut Date</label>
                        <input type="date" id="cFirstCut">
                    </div>
                </div>

                <div class="form-section" style="border-left: 4px solid var(--purple);">
                    <div class="section-title"><i class="fas fa-users"></i> Connection</div>
                    <div class="input-group">
                        <input type="text" id="cRefName" placeholder="Referred By (Type to Search...)" oninput="searchRef(this.value)">
                        <div id="refList" class="search-results"></div>
                    </div>
                    <div class="input-group">
                        <textarea id="cNotes" rows="3" placeholder="Notes (Fade type, life updates...)"></textarea>
                    </div>
                </div>

                <button class="btn-main">Save Client</button>
                <button type="button" class="btn-main" style="background:var(--modal-bg); color:var(--red);" onclick="deleteClientWrapper()">Delete</button>
                <div style="height:50px;"></div> </form>
        </div>
    </div>

    <div id="smsSheet" class="modal-overlay">
        <div class="modal-sheet" style="height:auto;">
            <h3 style="margin-top:0;">Contact Client</h3>
            <div class="action-sheet-options">
                <button class="sheet-btn" onclick="sendSMS('confirm')"><i class="fas fa-check" style="color:var(--green)"></i> Confirm Appointment</button>
                <button class="sheet-btn" onclick="sendSMS('late')"><i class="fas fa-running" style="color:var(--orange)"></i> Running Late (15m)</button>
                <button class="sheet-btn" onclick="sendSMS('longtime')"><i class="fas fa-clock" style="color:var(--blue)"></i> "Long Time No See"</button>
                <button class="sheet-btn" onclick="sendSMS('custom')"><i class="fas fa-comment"></i> Custom Message</button>
                <button class="sheet-btn" style="color:var(--red); justify-content:center;" onclick="closeModal('smsSheet')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="scheduleSheet" class="modal-overlay">
        <div class="modal-sheet" style="height:auto;">
            <h3 style="margin-top:0;">Add to Calendar</h3>
            <div class="form-section">
                <label>Date & Time</label>
                <input type="datetime-local" id="schedDate">
            </div>
            <button class="btn-main" onclick="addToCalendar()">Add to Apple Calendar</button>
            <button class="btn-main" style="background:var(--card-bg); color:var(--red);" onclick="closeModal('scheduleSheet')">Cancel</button>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-sheet" style="height:auto;">
            <h3>Settings</h3>
            <div class="form-section">
                <label>Barbershop Address (For Calendar)</label>
                <input type="text" id="sLocation" placeholder="Full Address">
            </div>
            <button class="btn-main" onclick="backupData()">Export Backup / Excel</button>
            <input type="file" id="restoreFile" style="display:none" onchange="restoreData(this)">
            <button class="btn-main" style="background:var(--card-bg); color:var(--text-main);" onclick="document.getElementById('restoreFile').click()">Restore Backup</button>
            <button class="btn-main" style="background:transparent; color:var(--blue);" onclick="closeModal('settingsModal')">Close</button>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let clients = JSON.parse(localStorage.getItem('masClients')) || [];
        let settings = JSON.parse(localStorage.getItem('masSettings')) || { location: '' };
        let currentTab = 'due';
        let activeClient = null;

        // --- INIT ---
        window.onload = () => {
            document.getElementById('sLocation').value = settings.location;
            render();
        };

        // --- LOGIC: STATUS & MATH ---
        function getStatus(c) {
            const last = new Date(c.lastCut);
            const today = new Date();
            const weeksSince = (today - last) / (1000 * 60 * 60 * 24 * 7);
            const freqWeeks = c.freq || 4;

            if (weeksSince >= 8) return 'overdue'; // Hard rule: 8 weeks
            if (weeksSince >= freqWeeks) return 'due';
            return 'good';
        }

        // --- RENDER ENGINE ---
        function render() {
            const list = document.getElementById('clientList');
            list.innerHTML = '';
            
            // Metrics Calculation
            const totalRev = clients.reduce((s, c) => s + (c.totalSpent || 0), 0);
            const totalGiven = clients.reduce((s, c) => s + (c.redeemed || 0), 0);
            document.getElementById('mGlobalRev').innerText = '$' + totalRev.toLocaleString();
            document.getElementById('mGivenBack').innerText = '$' + totalGiven.toLocaleString();
            document.getElementById('mTotalCuts').innerText = clients.length;

            // Sorting & Filtering
            let filtered = clients.filter(c => {
                const s = getStatus(c);
                if (currentTab === 'all') return true;
                if (currentTab === 'due') return s === 'due';
                if (currentTab === 'overdue') return s === 'overdue';
            });

            // Sort alphabetical
            filtered.sort((a,b) => a.name.localeCompare(b.name));

            if (filtered.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:#555;">
                    <i class="fas fa-box-open" style="font-size:2rem; margin-bottom:10px;"></i><br>
                    No clients in this section.
                </div>`;
                return;
            }

            filtered.forEach(c => {
                const status = getStatus(c);
                const statusClass = `s-${status}`; // s-due, s-overdue, s-good
                const loyaltyPct = Math.min((c.loyalty / 6) * 100, 100);
                
                // Badges
                let badges = '';
                if(c.insta) badges += `<span style="color:#E1306C; font-size:0.8rem; margin-right:8px;"><i class="fab fa-instagram"></i></span>`;
                if(c.dob && new Date(c.dob).getMonth() === new Date().getMonth()) badges += `<span style="color:var(--gold); font-size:0.8rem;"><i class="fas fa-birthday-cake"></i></span>`;

                const card = document.createElement('div');
                card.className = `client-card ${statusClass}`;
                card.innerHTML = `
                    <div class="status-strip"></div>
                    <div class="card-content" onclick="editClient('${c.id}')">
                        <div class="card-header">
                            <div>
                                <div class="client-name">${c.name} ${badges}</div>
                                <div class="client-info">
                                    <span><i class="fas fa-history"></i> ${c.freq}w</span>
                                    <span><i class="fas fa-phone"></i> ${c.phone}</span>
                                </div>
                            </div>
                            <div class="ltv-badge">$${c.totalSpent}</div>
                        </div>

                        <div class="loyalty-wrapper">
                            <div class="loyalty-track"><div class="loyalty-fill" style="width:${loyaltyPct}%"></div></div>
                            <div class="loyalty-text">
                                <span>${c.loyalty}/6 Cuts towards Free</span>
                                <span>Last: ${c.lastCut}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-grid">
                        <button class="action-btn" onclick="openSMSSheet('${c.id}')"><i class="fas fa-comment-dots"></i></button>
                        <button class="action-btn" onclick="window.location.href='tel:${c.phone}'"><i class="fas fa-phone"></i></button>
                        <button class="action-btn" onclick="openSchedule('${c.id}')"><i class="fas fa-calendar-plus"></i></button>
                        <button class="action-btn btn-cut" onclick="recordCut('${c.id}')"><i class="fas fa-cut"></i></button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // --- CLIENT ACTIONS ---
        function saveClient() {
            const id = document.getElementById('cId').value || Date.now().toString();
            const isNew = !document.getElementById('cId').value;
            
            const client = {
                id: id,
                name: document.getElementById('cName').value,
                phone: document.getElementById('cPhone').value,
                price: parseFloat(document.getElementById('cPrice').value) || 35,
                insta: document.getElementById('cInsta').value,
                address: document.getElementById('cAddress').value,
                dob: document.getElementById('cDob').value,
                firstCut: document.getElementById('cFirstCut').value || new Date().toISOString().split('T')[0],
                freq: parseInt(document.getElementById('cFreq').value) || 4,
                refBy: document.getElementById('cRefName').value,
                notes: document.getElementById('cNotes').value,
                // Preserve stats if editing
                lastCut: isNew ? new Date().toISOString().split('T')[0] : getClient(id).lastCut,
                loyalty: isNew ? 0 : getClient(id).loyalty,
                totalSpent: isNew ? 0 : getClient(id).totalSpent,
                redeemed: isNew ? 0 : getClient(id).redeemed
            };

            if (isNew) clients.push(client);
            else {
                const idx = clients.findIndex(c => c.id === id);
                clients[idx] = { ...clients[idx], ...client };
            }

            localStorage.setItem('masClients', JSON.stringify(clients));
            closeModal('clientModal');
            render();
        }

        function recordCut(id) {
            event.stopPropagation(); // Stop card click
            const c = getClient(id);
            const today = new Date();
            let price = c.price;
            let discount = 0;
            let msg = "Cut Recorded!";

            // Logic: Birthday Check
            if (c.dob) {
                if (new Date(c.dob).getMonth() === today.getMonth()) {
                    if(confirm("It's their birthday month! Apply 50% off?")) {
                        price = price / 2;
                        discount += price;
                        msg += " (Birthday Disc Applied)";
                    }
                }
            }

            // Logic: Loyalty Check
            if (c.loyalty >= 5) { // Currently at 5, this makes 6
                if(confirm("Client hit 6 cuts! Redeem FREE cut?")) {
                    discount += c.price; // The value given away
                    price = 0;
                    c.loyalty = 0; // Reset
                    msg += " (Free Cut Redeemed)";
                } else {
                    c.loyalty = 6; // Keep banking? simplified to cycle
                }
            } else {
                c.loyalty += 1;
            }

            c.lastCut = today.toISOString().split('T')[0];
            c.totalSpent += price;
            c.redeemed += discount;

            localStorage.setItem('masClients', JSON.stringify(clients));
            alert(msg);
            render();
        }

        function deleteClientWrapper() {
             const id = document.getElementById('cId').value;
             if(confirm("Are you sure? This cannot be undone.")) {
                 clients = clients.filter(c => c.id !== id);
                 localStorage.setItem('masClients', JSON.stringify(clients));
                 closeModal('clientModal');
                 render();
             }
        }

        // --- UTILS & MODALS ---
        function getClient(id) { return clients.find(c => c.id === id); }
        
        function setTab(tab, btn) {
            currentTab = tab;
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render();
        }

        function openModal(id) {
            if(id === 'clientModal') {
                document.getElementById('clientForm').reset();
                document.getElementById('cId').value = '';
                document.getElementById('cFirstCut').valueAsDate = new Date();
                document.getElementById('modalTitle').innerText = 'New Client';
            }
            document.getElementById(id).style.display = 'flex';
        }
        
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function editClient(id) {
            const c = getClient(id);
            document.getElementById('cId').value = c.id;
            document.getElementById('cName').value = c.name;
            document.getElementById('cPhone').value = c.phone;
            document.getElementById('cPrice').value = c.price;
            document.getElementById('cInsta').value = c.insta;
            document.getElementById('cAddress').value = c.address;
            document.getElementById('cDob').value = c.dob;
            document.getElementById('cFirstCut').value = c.firstCut;
            document.getElementById('cFreq').value = c.freq;
            document.getElementById('cRefName').value = c.refBy || '';
            document.getElementById('cNotes').value = c.notes;
            
            document.getElementById('modalTitle').innerText = 'Edit Client';
            document.getElementById('clientModal').style.display = 'flex';
        }

        // --- SMS & CALENDAR ---
        function openSMSSheet(id) {
            event.stopPropagation();
            activeClient = getClient(id);
            document.getElementById('smsSheet').style.display = 'flex';
        }

        function sendSMS(type) {
            if(!activeClient) return;
            const name = activeClient.name.split(' ')[0];
            let msg = '';
            
            if(type === 'confirm') msg = `Yo ${name}, confirm cut at MAS Barbery?`;
            else if(type === 'late') msg = `Hey ${name}, running about 15m late. My bad!`;
            else if(type === 'longtime') msg = `Yo ${name}, been a while! Time to get fresh?`;
            
            window.location.href = `sms:${activeClient.phone}&body=${encodeURIComponent(msg)}`;
            closeModal('smsSheet');
        }

        function openSchedule(id) {
            event.stopPropagation();
            activeClient = getClient(id);
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('schedDate').value = now.toISOString().slice(0,16);
            document.getElementById('scheduleSheet').style.display = 'flex';
        }

        function addToCalendar() {
            const startVal = document.getElementById('schedDate').value;
            const startDate = new Date(startVal);
            const endDate = new Date(startDate.getTime() + (2 * 60 * 60 * 1000)); // 2 hr block
            const formatTime = (d) => d.toISOString().replace(/-|:|\.\d\d\d/g,"");
            
            const ics = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${formatTime(startDate)}
DTEND:${formatTime(endDate)}
SUMMARY:Cut - ${activeClient.name}
DESCRIPTION:Freq: ${activeClient.freq}w | Price: $${activeClient.price}
LOCATION:${settings.location}
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.setAttribute('download', 'cut.ics');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            closeModal('scheduleSheet');
        }

        // --- SEARCH REF ---
        function searchRef(val) {
            const div = document.getElementById('refList');
            div.innerHTML = '';
            if(!val) { div.style.display = 'none'; return; }
            const matches = clients.filter(c => c.name.toLowerCase().includes(val.toLowerCase()));
            if(matches.length > 0) {
                div.style.display = 'block';
                matches.forEach(m => {
                    const i = document.createElement('div');
                    i.className = 'search-item';
                    i.innerText = m.name;
                    i.onclick = () => { document.getElementById('cRefName').value = m.name; div.style.display = 'none'; };
                    div.appendChild(i);
                });
            } else div.style.display = 'none';
        }

        // --- SETTINGS ---
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
        document.getElementById('sLocation').addEventListener('change', (e) => {
            settings.location = e.target.value;
            localStorage.setItem('masSettings', JSON.stringify(settings));
        });

        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({clients, settings}));
            const dLink = document.createElement('a');
            dLink.setAttribute("href", dataStr);
            dLink.setAttribute("download", "mas_backup.json");
            document.body.appendChild(dLink);
            dLink.click();
        }

        function restoreData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = JSON.parse(e.target.result);
                if(data.clients) {
                    clients = data.clients;
                    settings = data.settings || settings;
                    localStorage.setItem('masClients', JSON.stringify(clients));
                    localStorage.setItem('masSettings', JSON.stringify(settings));
                    render();
                    alert('Restored!');
                    closeModal('settingsModal');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
