<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Black Book Ops</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --subtext: #94a3b8;
            --border: #334155; --input-bg: #020617;
            --accent: #818cf8; --red: #f87171; --gold: #fbbf24; 
            --green: #4ade80; --blue: #60a5fa; --purple: #c084fc;
        }
        body.light-mode {
            --bg: #f1f5f9; --card: #ffffff; --text: #334155; --subtext: #64748b;
            --border: #e2e8f0; --input-bg: #f8fafc;
            --accent: #4f46e5; --red: #ef4444; --gold: #d97706; --green: #16a34a; --blue: #2563eb; --purple: #9333ea;
        }
        body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; margin:0; display:flex; flex-direction:column; height:100vh; overflow:hidden; transition: background 0.3s; }

        /* HEADER */
        .header { padding: 15px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;}
        h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; color: var(--accent); font-weight: 800; }
        .icon-btn { font-size: 1.4rem; cursor: pointer; opacity: 0.9; background:none; border:none; padding:0 8px; color: var(--text); }

        /* DASHBOARD */
        .dashboard { padding: 15px; background: var(--bg); display: flex; gap: 10px; overflow-x: auto; flex-shrink: 0; border-bottom: 1px solid var(--border); scrollbar-width: none; }
        .dash-card { background: var(--card); min-width: 100px; padding: 10px; border-radius: 12px; border: 1px solid var(--border); text-align: center; cursor: pointer; transition: 0.2s; }
        .dash-card.active { border-color: var(--accent); background: var(--input-bg); transform: translateY(-2px); }
        .dash-count { font-size: 1.3rem; font-weight: bold; }
        .dash-lbl { font-size: 0.7rem; text-transform: uppercase; color: var(--subtext); margin-top: 5px; font-weight: bold; }
        .d-red .dash-count { color: var(--red); } .d-gold .dash-count { color: var(--gold); } .d-blue .dash-count { color: var(--blue); } .d-purple .dash-count { color: var(--purple); }

        /* SEARCH & LIST */
        .search-deck { padding: 10px 15px; background: var(--bg); flex-shrink: 0; }
        .search-input { width: 100%; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 10px; font-size: 1rem; box-sizing: border-box; }
        #client-list { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; }

        /* CLIENT CARD */
        .client-card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .client-name { font-size: 1.1rem; font-weight: bold; }
        
        .badges { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 10px; text-transform: uppercase; font-weight: bold; border: 1px solid currentColor; }
        .b-red { color: var(--red); background: rgba(248,113,113,0.1); } .b-gold { color: var(--gold); background: rgba(251,191,36,0.1); } .b-blue { color: var(--blue); background: rgba(96,165,250,0.1); } .b-green { color: var(--green); background: rgba(74,222,128,0.1); }

        .client-details { display: none; padding: 15px; border-top: 1px solid var(--border); background: var(--input-bg); }
        .client-card.open .client-details { display: block; }

        /* DETAILS COMPONENTS */
        .prog-bar { height: 6px; background: var(--border); border-radius: 3px; margin: 10px 0; overflow: hidden; }
        .prog-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.3s; }
        
        .detail-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .detail-box { flex: 1; background: var(--card); padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        .detail-lbl { font-size: 0.65rem; color: var(--accent); margin-bottom: 3px; font-weight: bold; letter-spacing: 1px; }
        .detail-txt { font-size: 0.95rem; color: var(--text); }

        /* BUTTONS */
        .btn-full { width: 100%; padding: 12px; background: var(--card); border: 1px solid var(--border); color: var(--subtext); border-radius: 8px; margin-bottom: 15px; cursor: pointer; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .btn-main { background: var(--green); color: #000; border:none; font-weight:bold; padding: 15px; width:100%; border-radius: 8px; font-size:1rem; margin-bottom: 10px; cursor: pointer; display:block;}
        .action-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .btn-act { padding: 10px 5px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 0.8rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(4px); z-index: 100; display: none; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 20px 0; }
        .modal-content { background: var(--card); width: 90%; max-width: 400px; padding: 20px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 80px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        /* CONFIRM MODAL SPECIFIC */
        .confirm-title { font-size: 1.2rem; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .confirm-btns { display: flex; gap: 10px; }
        .btn-yes { flex: 1; background: var(--green); color: black; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-no { flex: 1; background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 15px; border-radius: 8px; cursor: pointer; }

        /* FORM ELEMENTS */
        .form-group { margin-bottom: 12px; }
        .form-lbl { display: block; margin-bottom: 5px; font-size: 0.75rem; font-weight:bold; color: var(--subtext); }
        .form-input { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        
        .fab { position: fixed; bottom: 30px; right: 20px; background: var(--accent); color: white; width: 60px; height: 60px; border-radius: 30px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: 0 5px 20px rgba(0,0,0,0.4); cursor: pointer; border: none; z-index: 500; }
        
        /* FULL PROFILE READ ONLY */
        .ro-row { display: flex; border-bottom: 1px solid var(--border); padding: 12px 0; }
        .ro-lbl { width: 100px; color: var(--subtext); font-size: 0.9rem; }
        .ro-val { flex: 1; color: var(--text); font-weight: bold; font-size: 0.9rem; }

        .chip-container { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 8px; padding-bottom: 5px; }
        .chip { padding: 6px 12px; background: var(--border); color: var(--text); border-radius: 20px; font-size: 0.75rem; white-space: nowrap; cursor: pointer; border: 1px solid transparent; }
        .chip:active { background: var(--accent); color:white; }
        
        .radio-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .radio-opt { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 8px; text-align: center; cursor: pointer; background: var(--input-bg); }
        .radio-opt.selected { border-color: var(--accent); background: rgba(129, 140, 248, 0.1); color: var(--accent); font-weight: bold; }

    </style>
</head>
<body>

    <div class="header">
        <h1>Black Book Ops</h1>
        <div style="display:flex; gap:5px; align-items:center;">
            <button class="icon-btn" onclick="toggleTheme()">‚óë</button>
            <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="icon-btn" onclick="exportData()">üíæ</button>
        </div>
    </div>

    <div class="dashboard">
        <div class="dash-card d-red" onclick="filter('due', this)">
            <div class="dash-count" id="d-due">0</div><div class="dash-lbl">Due</div>
        </div>
        <div class="dash-card d-gold" onclick="filter('bday', this)">
            <div class="dash-count" id="d-bday">0</div><div class="dash-lbl">B-Day Wk</div>
        </div>
        <div class="dash-card d-purple" onclick="filter('ghosts', this)">
            <div class="dash-count" id="d-ghost">0</div><div class="dash-lbl">Ghosts</div>
        </div>
        <div class="dash-card active" onclick="filter('all', this)">
            <div class="dash-count" id="d-all">0</div><div class="dash-lbl">All</div>
        </div>
    </div>

    <div class="search-deck">
        <input type="search" id="search" class="search-input" placeholder="Search name, phone, notes..." onkeyup="render()">
    </div>

    <div id="client-list"></div>
    <button class="fab" onclick="openClientModal()">+</button>

    <div id="confirm-modal" class="modal" style="z-index: 600;">
        <div class="modal-content" style="margin-top: 30vh;">
            <div id="confirm-msg" class="confirm-title">Message</div>
            <div class="confirm-btns">
                <button id="btn-no" class="btn-no">No</button>
                <button id="btn-yes" class="btn-yes">Yes</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h3>Shop Settings</h3>
            <div class="form-group"><label class="form-lbl">Shop Address</label><input id="s-shop-addr" class="form-input" placeholder="123 Barber Ln..."></div>
            <button class="btn-main" onclick="saveSettings()">SAVE</button>
            <button class="btn-full" onclick="document.getElementById('file-input').click()">üìÇ Restore Backup</button>
            <input type="file" id="file-input" hidden onchange="importData(this)">
            <button class="btn-no" style="width:100%" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="cal-modal" class="modal">
        <div class="modal-content">
            <h3>Schedule Cut</h3>
            <input type="hidden" id="cal-id">
            <div class="form-group"><label class="form-lbl">Date</label><input type="date" id="cal-date" class="form-input"></div>
            <div class="form-group"><label class="form-lbl">Time</label><input type="time" id="cal-time" class="form-input"></div>
            
            <label class="form-lbl">Location</label>
            <div class="radio-group">
                <div class="radio-opt selected" id="loc-shop" onclick="selLoc('shop')">My Shop</div>
                <div class="radio-opt" id="loc-client" onclick="selLoc('client')">Client's</div>
            </div>
            <input type="text" id="cal-addr" class="form-input" placeholder="Address...">

            <button class="btn-main" onclick="generateICS()">ADD TO CALENDAR</button>
            <button class="btn-no" style="width:100%" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--accent)" id="ro-title">Client Name</h3>
            <div id="ro-content"></div>
            <button class="btn-main" onclick="editFromProfile()">EDIT PROFILE</button>
            <button class="btn-no" style="width:100%" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="client-modal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center;">Edit Profile</h3>
            <input type="hidden" id="c-id">
            <div class="form-group"><label class="form-lbl">Name</label><input id="c-name" class="form-input"></div>
            
            <div class="flex">
                <div class="grow form-group"><label class="form-lbl">Phone</label><input type="tel" id="c-phone" class="form-input"></div>
                <div class="grow form-group"><label class="form-lbl">Price ($)</label><input type="number" id="c-price" class="form-input"></div>
            </div>
            
            <div class="form-group"><label class="form-lbl">Address</label><input id="c-addr" class="form-input"></div>
            <div class="form-group"><label class="form-lbl">IG</label><input id="c-social" class="form-input"></div>

            <div class="flex">
                <div class="grow form-group"><label class="form-lbl">Birthday</label><input type="date" id="c-dob" class="form-input"></div>
                <div class="grow form-group"><label class="form-lbl">First Cut</label><input type="date" id="c-start" class="form-input"></div>
            </div>

            <div class="form-group"><label class="form-lbl">Referred By</label>
                <input id="c-ref" class="form-input" list="ref-list" oninput="updateRefList(this.value)">
                <datalist id="ref-list"></datalist>
            </div>

            <div class="flex">
                <div class="grow form-group"><label class="form-lbl">Freq (Wks)</label><input type="number" id="c-freq" class="form-input"></div>
                <div class="grow form-group"><label class="form-lbl">Last Cut</label><input type="date" id="c-last" class="form-input"></div>
            </div>

            <div class="form-group"><label class="form-lbl">SIDES</label>
                <div class="chip-container"><span class="chip" onclick="fill('c-sides','Skin Fade')">Skin Fade</span><span class="chip" onclick="fill('c-sides','Taper')">Taper</span><span class="chip" onclick="fill('c-sides','#1')">#1</span></div>
                <input id="c-sides" class="form-input">
            </div>
            <div class="form-group"><label class="form-lbl">TOP</label>
                 <div class="chip-container"><span class="chip" onclick="fill('c-top','Crop')">Crop</span><span class="chip" onclick="fill('c-top','Trim')">Trim</span><span class="chip" onclick="fill('c-top','Texture')">Texture</span></div>
                <input id="c-top" class="form-input">
            </div>
             <div class="form-group"><label class="form-lbl">Notes</label><textarea id="c-notes" class="form-input" rows="3"></textarea></div>

            <button class="btn-main" onclick="saveClient()">SAVE</button>
            <button class="btn-no" style="width:100%" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <script>
        // --- STATE ---
        let clients = JSON.parse(localStorage.getItem('bb_clients_v3') || '[]');
        let shopSettings = JSON.parse(localStorage.getItem('bb_settings') || '{"addr":""}');
        let filterType = 'all';
        let tempId = null; // Used for passing IDs between modals

        // --- INIT ---
        if(localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
        render();

        // --- RENDER ---
        function render() {
            updateDash();
            const list = document.getElementById('client-list');
            const query = document.getElementById('search').value.toLowerCase();
            list.innerHTML = '';

            let visible = clients.filter(c => 
                c.name.toLowerCase().includes(query) || 
                (c.notes && c.notes.toLowerCase().includes(query)) ||
                (c.phone && c.phone.includes(query))
            );
            
            const today = new Date(); today.setHours(0,0,0,0);
            
            if(filterType === 'due') visible = visible.filter(c => getDueDate(c) <= today);
            if(filterType === 'bday') visible = visible.filter(c => isThisWeek(c.dob));
            if(filterType === 'ghosts') visible = visible.filter(c => {
                if(!c.lastVisit) return false;
                return Math.ceil((today - new Date(c.lastVisit))/86400000) > 90;
            });

            visible.sort((a,b) => a.name.localeCompare(b.name));

            visible.forEach(c => {
                // Badges
                let badges = '';
                if(isThisWeek(c.dob)) badges += `<span class="badge b-gold">üéÇ BDAY</span>`;
                const yrs = getYears(c.start);
                if(yrs > 0 && isThisWeek(c.start)) badges += `<span class="badge b-blue">üéâ ${yrs}YR</span>`;
                if(c.ltv > 500) badges += `<span class="badge b-green">üíé $${c.ltv}</span>`;
                else badges += `<span class="badge" style="border:1px solid var(--subtext); color:var(--subtext)">LTV: $${c.ltv||0}</span>`;

                // Due logic
                const due = getDueDate(c);
                const daysTill = due ? Math.ceil((due - today)/86400000) : 999;
                let dueTxt = due ? (daysTill < 0 ? `Overdue ${Math.abs(daysTill)}d` : `Due ${daysTill}d`) : '';
                let dueCol = daysTill < 0 ? 'var(--red)' : 'var(--subtext)';

                // Bank Logic
                let offer = '';
                if(c.free>0) offer = `${c.free} FREE CUTS`;
                else if(c.credit>0) offer = `$${c.credit} CR`;

                const div = document.createElement('div');
                div.className = 'client-card';
                div.innerHTML = `
                    <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
                        <div><div class="client-name">${c.name}</div><div class="badges">${badges}</div></div>
                        <div style="text-align:right">
                            <div style="font-size:0.75rem;font-weight:bold;color:var(--gold)">${offer}</div>
                            <div style="font-size:0.7rem;color:${dueCol}">${dueTxt}</div>
                        </div>
                    </div>
                    <div class="client-details">
                        <div class="bank-box">
                            <div class="bank-item"><div class="bank-val">${(c.cuts%6)}/6</div><div class="bank-lbl">Loyalty</div></div>
                            <div class="bank-item"><div class="bank-val">${c.cuts}</div><div class="bank-lbl">Total</div></div>
                            <div class="bank-item"><div class="bank-val">$${c.credit}</div><div class="bank-lbl">Credit</div></div>
                        </div>
                        
                        <div class="detail-row">
                            <div class="detail-box"><div class="detail-lbl">SIDES</div><div class="detail-txt">${c.sides||'-'}</div></div>
                            <div class="detail-box"><div class="detail-lbl">TOP</div><div class="detail-txt">${c.top||'-'}</div></div>
                        </div>
                        <div class="detail-box"><div class="detail-lbl">NOTES</div><div class="detail-txt">${c.notes||'-'}</div></div>

                        <button class="btn-full" onclick="viewFull('${c.id}')">üìÑ View Full Profile</button>
                        <button class="btn-main" onclick="startCutFlow('${c.id}')">‚úÇÔ∏è RECORD CUT</button>
                        
                        <div class="action-grid">
                            <button class="btn-act" onclick="window.location='tel:${c.phone}'">üìû Call</button>
                            <button class="btn-act" onclick="openText('${c.id}')">üí¨ Text</button>
                            <button class="btn-act" onclick="openSchedule('${c.id}')">üìÖ Sched</button>
                            <button class="btn-act" onclick="downloadVCard('${c.id}')">üë§ Save</button>
                            <button class="btn-act" style="grid-column:span 4; color:var(--red); border-color:var(--border);" onclick="delClient('${c.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- WORKFLOWS ---
        function startCutFlow(id) {
            tempId = id;
            customConfirm("Did the haircut style change?", 
                () => { // YES
                    openClientModal(id); 
                    // We hook the save to continue the flow? No, simple is better. 
                    // User edits, saves, then clicks record again or we assume they just wanted to edit.
                    alert("Update style, Save, then click Record Cut again to finish.");
                },
                () => { // NO
                    finishCut(id);
                }
            );
        }

        function finishCut(id) {
            const c = clients.find(x=>x.id==id);
            const priceStr = prompt("Price paid today?", c.price || 0);
            if(priceStr === null) return;
            const paid = parseFloat(priceStr) || 0;

            // Check rewards
            if(c.free > 0 || c.credit > 0) {
                if(confirm(`Client has ${c.free} free cuts and $${c.credit} credit. Redeem something?`)) {
                    if(c.free > 0 && confirm("Use 1 Free Cut?")) c.free--;
                    else if(c.credit > 0) {
                        const use = prompt(`Available Credit: $${c.credit}. Amount to use:`, c.credit);
                        if(use) c.credit -= Math.min(parseFloat(use), c.credit);
                    }
                }
            }

            c.lastVisit = new Date().toISOString().split('T')[0];
            c.cuts++;
            c.ltv = (c.ltv || 0) + paid;
            if(c.cuts % 6 === 0) { c.free++; alert("üéâ 6th Cut Reached! Free cut added."); }
            save(); render();
        }

        // --- FULL PROFILE VIEW ---
        function viewFull(id) {
            const c = clients.find(x=>x.id==id);
            tempId = id; // Store for edit button
            document.getElementById('ro-title').innerText = c.name;
            let html = `
                <div class="ro-row"><div class="ro-lbl">Phone</div><div class="ro-val">${c.phone||'-'}</div></div>
                <div class="ro-row"><div class="ro-lbl">Address</div><div class="ro-val">${c.addr||'-'}</div></div>
                <div class="ro-row"><div class="ro-lbl">Social</div><div class="ro-val">${c.social||'-'}</div></div>
                <div class="ro-row"><div class="ro-lbl">Birthday</div><div class="ro-val">${c.dob||'-'}</div></div>
                <div class="ro-row"><div class="ro-lbl">First Cut</div><div class="ro-val">${c.start||'-'}</div></div>
                <div class="ro-row"><div class="ro-lbl">Last Cut</div><div class="ro-val">${c.lastVisit||'-'}</div></div>
                <div class="ro-row"><div class="ro-lbl">Referred By</div><div class="ro-val">${c.ref||'-'}</div></div>
                <div class="ro-row"><div class="ro-lbl">Default $</div><div class="ro-val">$${c.price||'-'}</div></div>
            `;
            document.getElementById('ro-content').innerHTML = html;
            document.getElementById('profile-modal').style.display = 'flex';
        }
        function editFromProfile() {
            closeModals();
            openClientModal(tempId);
        }

        // --- SCHEDULING ---
        function openSchedule(id) {
            const c = clients.find(x=>x.id==id);
            document.getElementById('cal-id').value = id;
            document.getElementById('cal-date').value = new Date().toISOString().split('T')[0];
            // Default to shop
            selLoc('shop');
            document.getElementById('cal-modal').style.display = 'flex';
        }

        function selLoc(type) {
            const c = clients.find(x=>x.id == document.getElementById('cal-id').value);
            document.querySelectorAll('.radio-opt').forEach(r=>r.classList.remove('selected'));
            document.getElementById('loc-'+type).classList.add('selected');
            
            if(type === 'shop') document.getElementById('cal-addr').value = shopSettings.addr;
            else document.getElementById('cal-addr').value = c.addr || '';
        }

        function generateICS() {
            const id = document.getElementById('cal-id').value;
            const c = clients.find(x=>x.id==id);
            const d = document.getElementById('cal-date').value;
            const t = document.getElementById('cal-time').value;
            const loc = document.getElementById('cal-addr').value;
            
            if(!d || !t) return alert("Date/Time required");
            
            const start = new Date(`${d}T${t}`);
            const end = new Date(start.getTime() + 45*60000); // 45 min default
            const fmt = date => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            
            const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:Cut: ${c.name}\nDTSTART:${fmt(start)}\nDTEND:${fmt(end)}\nLOCATION:${loc}\nDESCRIPTION:${c.notes||''}\nEND:VEVENT\nEND:VCALENDAR`;
            
            // File download method (Best for iOS)
            const blob = new Blob([ics], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'appointment.ics';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            closeModals();
        }

        // --- CONTACTS ---
        function downloadVCard(id) {
            const c = clients.find(x=>x.id==id);
            // Enhanced VCF format for iOS
            const vcf = `BEGIN:VCARD\nVERSION:3.0\nN:${c.name};;;;\nFN:${c.name}\nTEL;type=CELL;type=VOICE;type=pref:${c.phone||''}\nADR;type=HOME;type=pref:;;${c.addr||''};;;;\nNOTE:Black Book Notes: ${c.notes||''}\nEND:VCARD`;
            const blob = new Blob([vcf], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${c.name.replace(/\s/g,'_')}.vcf`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => document.body.removeChild(a), 100);
        }

        // --- SYSTEM CORE ---
        function updateDash() {
            const today = new Date(); today.setHours(0,0,0,0);
            let counts = { due:0, bday:0, ghost:0, all: clients.length };
            clients.forEach(c => {
                if(getDueDate(c) <= today) counts.due++;
                if(isThisWeek(c.dob)) counts.bday++;
                if(c.lastVisit && Math.ceil((today - new Date(c.lastVisit))/86400000) > 90) counts.ghost++;
            });
            document.getElementById('d-due').innerText = counts.due;
            document.getElementById('d-bday').innerText = counts.bday;
            document.getElementById('d-ghost').innerText = counts.ghost;
            document.getElementById('d-all').innerText = counts.all;
        }

        // --- CUSTOM CONFIRM MODAL ---
        function customConfirm(msg, yesFn, noFn) {
            const m = document.getElementById('confirm-modal');
            document.getElementById('confirm-msg').innerText = msg;
            m.style.display = 'flex';
            document.getElementById('btn-yes').onclick = function() { m.style.display='none'; yesFn(); };
            document.getElementById('btn-no').onclick = function() { m.style.display='none'; if(noFn) noFn(); };
        }

        // --- SETTINGS ---
        function openSettings() {
            document.getElementById('s-shop-addr').value = shopSettings.addr;
            document.getElementById('settings-modal').style.display = 'flex';
        }
        function saveSettings() {
            shopSettings.addr = document.getElementById('s-shop-addr').value;
            localStorage.setItem('bb_settings', JSON.stringify(shopSettings));
            closeModals();
        }

        // --- STANDARD UTILS ---
        function openClientModal(id) {
            const c = id ? clients.find(x=>x.id==id) : {id:'',name:'',phone:'',price:'',addr:'',social:'',dob:'',start:new Date().toISOString().split('T')[0],ref:'',freq:'',last:'',sides:'',top:'',notes:''};
            for(let k in c) {
                const el = document.getElementById('c-'+k);
                if(el) el.value = c[k];
            }
            // Ref List
            const dl = document.getElementById('ref-list'); dl.innerHTML = '';
            clients.forEach(cl => { if(cl.id !== c.id) dl.innerHTML += `<option value="${cl.name}">`; });
            
            document.getElementById('client-modal').style.display = 'flex';
        }

        function saveClient() {
            const id = document.getElementById('c-id').value;
            const name = document.getElementById('c-name').value;
            if(!name) return alert("Name required");
            const refName = document.getElementById('c-ref').value;

            let clientData = {
                name, phone: document.getElementById('c-phone').value,
                price: parseFloat(document.getElementById('c-price').value)||0,
                addr: document.getElementById('c-addr').value, social: document.getElementById('c-social').value,
                dob: document.getElementById('c-dob').value, start: document.getElementById('c-start').value,
                ref: refName, freq: parseInt(document.getElementById('c-freq').value)||0,
                lastVisit: document.getElementById('c-last').value,
                sides: document.getElementById('c-sides').value, top: document.getElementById('c-top').value,
                notes: document.getElementById('c-notes').value,
            };

            if(id) {
                const idx = clients.findIndex(x=>x.id==id);
                clients[idx] = {...clients[idx], ...clientData};
            } else {
                clientData.id = Date.now().toString();
                clientData.cuts=0; clientData.free=0; clientData.credit=0; clientData.ltv=0;
                clients.push(clientData);
                if(refName) {
                    const referrer = clients.find(c => c.name.toLowerCase() === refName.toLowerCase() && c.id !== clientData.id);
                    if(referrer) { referrer.credit+=5; clientData.credit+=5; alert("Referral linked! $5 credits."); }
                }
            }
            save(); closeModals(); render();
        }

        function delClient(id) { customConfirm("Delete permanently?", () => { clients = clients.filter(x=>x.id!=id); save(); render(); }); }
        
        function getDueDate(c) {
            if(!c.lastVisit || !c.freq) return null;
            const d = new Date(c.lastVisit); d.setDate(d.getDate() + (c.freq*7)); d.setHours(0,0,0,0); return d;
        }
        function isThisWeek(dStr) {
            if(!dStr) return false; 
            const d=new Date(dStr); const now=new Date(); now.setHours(0,0,0,0);
            const thisYear = new Date(now.getFullYear(), d.getMonth(), d.getDate()+1);
            const diff = Math.ceil((thisYear - now) / 86400000);
            if(diff >= 0 && diff <= 7) return true;
            const nextYear = new Date(now.getFullYear()+1, d.getMonth(), d.getDate()+1);
            const diffNext = Math.ceil((nextYear - now) / 86400000);
            return diffNext >= 0 && diffNext <= 7;
        }
        function getYears(dStr) { if(!dStr) return 0; return new Date().getFullYear() - new Date(dStr).getFullYear(); }
        function setToday(id) { document.getElementById(id).value = new Date().toISOString().split('T')[0]; }
        function fill(id,v) { document.getElementById(id).value = v; }
        function filter(t, el) { filterType=t; document.querySelectorAll('.dash-card').forEach(d=>d.classList.remove('active')); el.classList.add('active'); render(); }
        function toggleMenu() { document.getElementById('save-menu').classList.toggle('show'); }
        function toggleTheme() { document.body.classList.toggle('light-mode'); localStorage.setItem('theme', document.body.classList.contains('light-mode')?'light':'dark'); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
        function save() { localStorage.setItem('bb_clients_v3', JSON.stringify(clients)); }
        
        function openText(id) {
            const c = clients.find(x=>x.id==id);
            if(!c.phone) return alert("No phone.");
            window.location = `sms:${c.phone}`;
        }
        function openGiftModal() {
             const name = prompt("Manual $5 Referral Credit. Enter Client Name:");
             if(name) { const c=clients.find(x=>x.name.toLowerCase().includes(name.toLowerCase())); if(c){c.credit+=5;save();render();alert(`$5 added to ${c.name}`);} else alert("Not found");}
        }
        function exportData(type) {
            if(type==='json') {
                const b = new Blob([JSON.stringify(clients)], {type:'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `bb_backup_${Date.now()}.json`; a.click();
            } else {
                let csv = "Name,Phone,LTV,LastVisit\n" + clients.map(c=>`"${c.name}","${c.phone}",${c.ltv},${c.lastVisit}`).join('\n');
                const b = new Blob([csv], {type:'text/csv'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `bb_export.csv`; a.click();
            }
        }
        function importData(el) {
            if(!el.files[0])return;
            const fr = new FileReader(); fr.onload=e=>{ clients=JSON.parse(e.target.result); save(); render(); alert("Restored!"); };
            fr.readAsText(el.files[0]);
        }
    </script>
</body>
</html>
