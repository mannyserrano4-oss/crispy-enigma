<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Black Book Ops</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --subtext: #94a3b8;
            --border: #334155; --input-bg: #020617;
            --accent: #6366f1; --red: #f43f5e; --gold: #f59e0b; 
            --green: #10b981; --blue: #3b82f6; --purple: #a855f7;
        }
        body.light-mode {
            --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --subtext: #64748b;
            --border: #cbd5e1; --input-bg: #f8fafc;
        }

        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; height: 100dvh; display: grid; grid-template-rows: auto auto 1fr; 
            overflow: hidden;
        }

        /* HEADER */
        .header { 
            padding: 15px 20px; background: var(--card); border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; z-index: 20;
        }
        h1 { margin: 0; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); font-weight: 900; }
        .icon-btn { font-size: 1.4rem; background: none; border: none; cursor: pointer; padding: 5px; }

        /* DASHBOARD */
        .dashboard { 
            padding: 12px; background: var(--bg); display: flex; gap: 10px; 
            overflow-x: auto; border-bottom: 1px solid var(--border); 
            scrollbar-width: none; flex-shrink: 0;
        }
        .dash-card { 
            background: var(--card); min-width: 100px; padding: 10px; border-radius: 12px; 
            border: 1px solid var(--border); text-align: center; cursor: pointer; 
        }
        .dash-card.active { border-color: var(--accent); background: rgba(99, 102, 241, 0.1); }
        .dash-count { font-size: 1.4rem; font-weight: 800; }
        .dash-lbl { font-size: 0.65rem; text-transform: uppercase; font-weight: 700; color: var(--subtext); margin-top: 4px; }
        .d-red .dash-count { color: var(--red); } .d-gold .dash-count { color: var(--gold); }
        .d-blue .dash-count { color: var(--blue); } .d-purple .dash-count { color: var(--purple); }

        /* SCROLL AREA */
        #main-area {
            position: relative; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 15px; padding-bottom: 100px; display: flex; flex-direction: column; gap: 15px;
        }

        /* SEARCH */
        .search-input { 
            width: 100%; background: var(--input-bg); border: 1px solid var(--border); 
            color: var(--text); padding: 12px 15px; border-radius: 10px; 
            font-size: 1rem; box-sizing: border-box; outline: none; margin-bottom: 10px;
        }
        .search-input:focus { border-color: var(--accent); }

        /* CARDS */
        .client-card { 
            background: var(--card); border-radius: 16px; border: 1px solid var(--border); 
            overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex-shrink: 0;
            transition: background 0.3s;
        }
        .client-card.new-item { background: rgba(99, 102, 241, 0.2); }

        .card-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .card-header.due { border-left: 4px solid var(--red); }
        
        .client-name { font-size: 1.1rem; font-weight: 800; }
        .badges { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .badge { font-size: 0.6rem; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; }
        .b-gold { background: rgba(245, 158, 11, 0.15); color: var(--gold); }
        .b-blue { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
        .b-green { background: rgba(16, 185, 129, 0.15); color: var(--green); }
        .b-ltv { border: 1px solid var(--subtext); color: var(--subtext); }

        .client-details { display: none; padding: 15px; background: var(--input-bg); border-top: 1px solid var(--border); }
        .client-card.open .client-details { display: block; }

        /* BANK */
        .bank-box { display: flex; gap: 8px; margin-bottom: 15px; background: var(--card); padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
        .bank-item { flex: 1; text-align: center; }
        .bank-val { font-size: 1.3rem; font-weight: 900; }
        .bank-lbl { font-size: 0.6rem; font-weight: 700; color: var(--subtext); text-transform: uppercase; }
        
        /* NOTES */
        .detail-box { flex: 1; background: var(--card); padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 10px; }
        .detail-lbl { font-size: 0.65rem; color: var(--accent); font-weight: 800; margin-bottom: 6px; letter-spacing: 1px; }
        .detail-txt { font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; color: var(--text); }

        /* BUTTONS */
        .btn-main { width: 100%; padding: 16px; background: var(--green); color: #000; border: none; border-radius: 12px; font-size: 1rem; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-bottom: 12px; }
        .btn-full { width: 100%; padding: 12px; background: var(--card); border: 1px solid var(--border); color: var(--text); font-weight: 600; border-radius: 10px; margin-bottom: 12px; cursor: pointer; }
        
        .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .btn-act { background: var(--card); border: 1px solid var(--border); color: var(--subtext); padding: 10px 5px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; text-decoration: none;}
        .btn-act span { font-size: 1.2rem; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 20px 0; }
        .modal-content { background: var(--card); width: 90%; max-width: 400px; padding: 20px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.5); margin-bottom: 80px; }

        /* ZONES */
        .zone { border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid transparent; }
        .z-blue { background: rgba(59, 130, 246, 0.05); border-color: rgba(59, 130, 246, 0.2); } .z-blue .z-title { color: var(--blue); }
        .z-gold { background: rgba(245, 158, 11, 0.05); border-color: rgba(245, 158, 11, 0.2); } .z-gold .z-title { color: var(--gold); }
        .z-green { background: rgba(16, 185, 129, 0.05); border-color: rgba(16, 185, 129, 0.2); } .z-green .z-title { color: var(--green); }
        .z-title { font-size: 0.7rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: block; }

        .form-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .form-group { flex: 1; min-width: 0; }
        .form-lbl { display: block; font-size: 0.75rem; color: var(--subtext); margin-bottom: 5px; font-weight: 600; }
        .form-input { width: 100%; padding: 12px; background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        
        .input-group-date { display: flex; width:100%; }
        .input-group-date .form-input { border-radius: 8px 0 0 8px; flex: 1; min-width: 0; }
        .btn-today { padding: 0 10px; background: var(--border); color: var(--text); border: 1px solid var(--border); border-radius: 0 8px 8px 0; cursor: pointer; font-size: 0.8rem; font-weight:bold;}

        .fab { position: fixed; bottom: 30px; right: 20px; background: var(--accent); color: white; width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4); cursor: pointer; border: none; z-index: 500; }
        
        .list-option { width: 100%; padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 1rem; background: var(--card); color: var(--text); text-align: left; border:none; }
        .dropdown { position: absolute; top: 60px; right: 15px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: none; flex-direction: column; width: 180px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 200; }
        .dropdown.show { display: flex; }

        .ro-row { display: flex; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .ro-lbl { width: 120px; color: var(--subtext); font-size: 0.9rem; }
        .ro-val { flex: 1; color: var(--text); font-weight: 700; font-size: 0.95rem; }
        .stat-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .stat-val { font-weight: bold; color: var(--accent); }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid var(--green); }
        .toggle-lbl { font-size: 0.9rem; font-weight: bold; color: var(--green); }
        .toggle-input { width: 20px; height: 20px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Black Book Ops</h1>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="icon-btn" onclick="toggleTheme()">‚óë</button>
            <button class="icon-btn" onclick="openCreditModal()">üéÅ</button>
            <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="icon-btn" onclick="toggleMenu()">üíæ</button>
        </div>
    </div>

    <div id="save-menu" class="dropdown">
        <button class="list-option" onclick="exportData('json')">Backup File</button>
        <button class="list-option" onclick="exportData('csv')">Export Excel</button>
        <button class="list-option" onclick="document.getElementById('file-input').click()">Restore</button>
    </div>
    <input type="file" id="file-input" hidden onchange="importData(this)">

    <div class="dashboard">
        <div class="dash-card d-red" onclick="filter('due', this)">
            <div class="dash-count" id="d-due">0</div><div class="dash-lbl">Due</div>
        </div>
        <div class="dash-card d-gold" onclick="filter('bday', this)">
            <div class="dash-count" id="d-bday">0</div><div class="dash-lbl">B-Day</div>
        </div>
        <div class="dash-card d-purple" onclick="filter('ghosts', this)">
            <div class="dash-count" id="d-ghost">0</div><div class="dash-lbl">Ghosts</div>
        </div>
        <div class="dash-card active" onclick="filter('all', this)" id="btn-all">
            <div class="dash-count" id="d-all">0</div><div class="dash-lbl">All</div>
        </div>
    </div>

    <div id="main-area">
        <input type="search" id="search" class="search-input" placeholder="Search name, notes, phone..." onkeyup="render()">
        <div id="client-list"></div>
    </div>

    <button class="fab" onclick="openClientModal()">+</button>

    <div id="confirm-modal" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="margin-top: 30vh;">
            <div id="confirm-msg" style="font-size:1.2rem; font-weight:bold; text-align:center; margin-bottom:20px;">Msg</div>
            <div style="display:flex; gap:10px;">
                <button id="btn-no" style="flex:1; padding:15px; border-radius:10px; background:var(--card); border:1px solid var(--border); color:var(--text); font-weight:bold;">No</button>
                <button id="btn-yes" style="flex:1; padding:15px; border-radius:10px; background:var(--green); border:none; color:black; font-weight:bold;">Yes</button>
            </div>
        </div>
    </div>

    <div id="list-modal" class="modal">
        <div class="modal-content">
            <h3 id="list-title" style="margin-top:0; color:var(--text);">Select</h3>
            <div id="list-options"></div>
            <button class="list-option" style="text-align:center; color:var(--red); margin-top:10px;" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <div id="credit-modal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; margin-top:0;">Add Credit</h3>
            <div class="form-group">
                <label class="form-lbl">Client Name</label>
                <input id="credit-input" class="form-input" list="ref-list" placeholder="Start typing..." oninput="updateRefList()">
                <datalist id="ref-list"></datalist>
            </div>
            <button class="btn-main" onclick="applyCredit()">ADD $5 CREDIT</button>
            <button class="btn-full" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; margin-top:0;">Business Report</h3>
            <div style="margin-bottom:20px;">
                <div class="stat-row"><span>Total Revenue</span><span class="stat-val" id="st-rev">$0</span></div>
                <div class="stat-row"><span>Total Cuts</span><span class="stat-val" id="st-cuts">0</span></div>
                <div class="stat-row"><span>Redeemed Value</span><span class="stat-val" id="st-red">$0</span></div>
                <div class="stat-row"><span>Referrals</span><span class="stat-val" id="st-ref">0</span></div>
            </div>
            <h3 style="text-align:center;">Settings</h3>
            <div class="form-group"><label class="form-lbl">Shop Address</label><input id="s-shop-addr" class="form-input"></div>
            <button class="btn-main" onclick="saveSettings()">SAVE</button>
            <button class="btn-full" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="cal-modal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; margin-top:0;">Schedule Cut</h3>
            <input type="hidden" id="cal-id">
            <div class="form-row">
                <div class="form-group"><label class="form-lbl">Date</label><input type="date" id="cal-date" class="form-input"></div>
                <div class="form-group"><label class="form-lbl">Time</label><input type="time" id="cal-time" class="form-input"></div>
            </div>
            <div class="form-group">
                <label class="form-lbl">Location</label>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="chip" onclick="selLoc('shop')">üìç My Shop</button>
                    <button class="chip" onclick="selLoc('client')">üè† Client House</button>
                </div>
                <input id="cal-addr" class="form-input" placeholder="Address...">
            </div>
            <button class="btn-main" onclick="generateICS()">ADD TO CALENDAR (2HR)</button>
            <button class="btn-full" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h3 id="ro-title" style="text-align:center; color:var(--accent); margin-top:0; font-size:1.5rem;">Name</h3>
            <div id="ro-content"></div>
            <div style="height:20px;"></div>
            <button class="btn-main" onclick="editFromProfile()">EDIT PROFILE</button>
            <button class="btn-full" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="client-modal" class="modal">
        <div class="modal-content">
            <h2 style="text-align:center; margin:0 0 20px 0;">Client Profile</h2>
            <input type="hidden" id="c-id">
            <div class="form-group"><input id="c-name" class="form-input" placeholder="Client Name" style="font-size:1.2rem; font-weight:800; text-align:center;"></div>
            
            <div class="zone z-blue">
                <span class="z-title">üîµ Contact</span>
                <div class="form-row">
                    <div class="form-group"><label class="form-lbl">Phone</label><input type="tel" id="c-phone" class="form-input"></div>
                    <div class="form-group"><label class="form-lbl">Price $</label><input type="number" id="c-price" class="form-input" placeholder="35"></div>
                </div>
                <div class="form-group"><label class="form-lbl">Social</label><input id="c-social" class="form-input"></div>
                <div class="form-group"><label class="form-lbl">Address</label><input id="c-addr" class="form-input"></div>
            </div>
            
            <div class="zone z-gold">
                <span class="z-title">üü° Timeline</span>
                <div class="form-row">
                    <div class="form-group"><label class="form-lbl">Birthday</label><div class="input-group-date"><input type="date" id="c-dob" class="form-input"></div></div>
                    <div class="form-group"><label class="form-lbl">First Cut</label><div class="input-group-date"><input type="date" id="c-start" class="form-input"></div></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-lbl">Referred By</label><input id="c-ref" class="form-input" list="ref-list" oninput="updateRefList()"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-lbl">Freq (Wks)</label><input type="number" id="c-freq" class="form-input" placeholder="4"></div>
                    <div class="form-group"><label class="form-lbl">Last Cut</label><div class="input-group-date"><input type="date" id="c-last" class="form-input"><button class="btn-today" onclick="setToday('c-last')">Today</button></div></div>
                </div>
                <div class="toggle-row">
                    <span class="toggle-lbl">Count Last Cut as Cut #1?</span>
                    <input type="checkbox" id="c-count-first" class="toggle-input">
                </div>
            </div>

            <div class="zone z-green">
                <span class="z-title">üü¢ The Cut</span>
                <div class="form-group"><label class="form-lbl">Notes</label><textarea id="c-notes" class="form-input" rows="5"></textarea></div>
            </div>

            <button class="btn-main" onclick="saveClient()">SAVE PROFILE</button>
            <button class="btn-full" onclick="closeModals()">Cancel</button>
        </div>
    </div>

    <script>
        let clients = JSON.parse(localStorage.getItem('bb_clients_v3') || '[]');
        let shopSettings = JSON.parse(localStorage.getItem('bb_settings') || '{"addr":""}');
        let filterType = 'all';
        let tempId = null;
        let pendingCutId = null; 

        if(localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
        render();

        function getLocalToday() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function dateToLocal(dateStr) {
            if(!dateStr || dateStr.length < 10) return null;
            const parts = dateStr.split('-');
            return new Date(parts[0], parts[1] - 1, parts[2]); 
        }

        function render() {
            updateDash();
            const list = document.getElementById('client-list');
            if(!list) return;
            const query = document.getElementById('search').value.toLowerCase();
            list.innerHTML = '';

            const today = new Date(); today.setHours(0,0,0,0);

            let visible = clients.filter(c => {
                const nameMatch = (c.name || '').toLowerCase().includes(query);
                const noteMatch = (c.notes || '').toLowerCase().includes(query);
                const phoneMatch = (c.phone || '').includes(query);
                return nameMatch || noteMatch || phoneMatch;
            });

            if(filterType === 'due') visible = visible.filter(c => getDueDate(c) <= today);
            if(filterType === 'bday') visible = visible.filter(c => isThisWeek(c.dob));
            if(filterType === 'ghosts') visible = visible.filter(c => c.lastVisit && Math.ceil((today - dateToLocal(c.lastVisit))/86400000) > 90);

            visible.sort((a,b) => (a.name || '').localeCompare(b.name || ''));

            visible.forEach(c => {
                let badges = '';
                if(c.ltv > 500) badges += `<span class="badge b-green">üíé $${c.ltv}</span>`;
                else badges += `<span class="badge b-ltv">LTV: $${c.ltv||0}</span>`;

                if(isThisWeek(c.dob)) badges += `<span class="badge b-gold">üéÇ BDAY</span>`;
                const yrs = getYears(c.start);
                if(yrs > 0 && isThisWeek(c.start)) badges += `<span class="badge b-blue">üéâ ${yrs}YR</span>`;

                const due = getDueDate(c);
                const daysTill = due ? Math.ceil((due - today)/86400000) : 999;
                let dueTxt = due ? (daysTill < 0 ? `Overdue ${Math.abs(daysTill)}d` : `Due ${daysTill}d`) : '';
                let dueCol = daysTill < 0 ? 'var(--red)' : 'var(--subtext)';
                
                let lastCutTxt = 'New';
                if(c.lastVisit && c.lastVisit.includes('-')) {
                    const parts = c.lastVisit.split('-');
                    lastCutTxt = `${parts[1]}/${parts[2]}/${parts[0]}`; 
                }
                
                let cardClass = daysTill < 0 ? 'card-header due' : 'card-header';
                let offer = c.free > 0 ? `${c.free} FREE` : (c.credit > 0 ? `$${c.credit} CR` : '');

                let socialBtn = '';
                if(c.social) {
                    socialBtn = `<button class="btn-act" onclick="window.open('https://instagram.com/${c.social.replace('@','')}')"><span>üì∏</span>IG</button>`;
                }

                let punch = (c.loyalty || 0); 
                let loyaltyText = `${punch}/5`;
                if(punch >= 5) loyaltyText = "EARNED FREE!";

                const div = document.createElement('div');
                div.className = 'client-card';
                if(c.isNew) { div.classList.add('new-item'); delete c.isNew; setTimeout(()=>save(true), 2000); }

                div.innerHTML = `
                    <div class="${cardClass}" onclick="this.parentElement.classList.toggle('open')">
                        <div><div class="client-name">${c.name}</div><div class="badges">${badges}</div></div>
                        <div style="text-align:right">
                            <div style="font-size:0.8rem; font-weight:800; color:var(--gold);">${offer}</div>
                            <div style="font-size:0.7rem; color:var(--text); margin-top:2px;">${lastCutTxt}</div>
                            <div style="font-size:0.7rem; color:${dueCol};">${dueTxt}</div>
                        </div>
                    </div>
                    <div class="client-details">
                        <div class="bank-box">
                            <div class="bank-item"><div class="bank-val">${c.cuts}</div><div class="bank-lbl">Total Cuts</div></div>
                            <div class="bank-item"><div class="bank-val">${loyaltyText}</div><div class="bank-lbl">Loyalty</div></div>
                            <div class="bank-item"><div class="bank-val" style="color:var(--gold)">$${c.credit||0}</div><div class="bank-lbl">Credit</div></div>
                        </div>
                        <div class="bank-item"><button class="btn-act" style="width:100%; border:1px solid var(--gold); color:var(--gold); margin-bottom:10px;" onclick="openRedeem('${c.id}')">üèÜ REDEEM</button></div>
                        <div class="detail-box" style="margin-bottom:10px;"><div class="detail-lbl">NOTES</div><div class="detail-txt">${c.notes||'-'}</div></div>
                        <button class="btn-full" onclick="viewFull('${c.id}')">üìÑ View Full Profile</button>
                        <button class="btn-main" onclick="startCutFlow('${c.id}')">‚úÇÔ∏è RECORD CUT</button>
                        <div class="action-grid">
                            <button class="btn-act" onclick="window.location='tel:${c.phone}'"><span>üìû</span>Call</button>
                            <button class="btn-act" onclick="openText('${c.id}')"><span>üí¨</span>Text</button>
                            ${socialBtn}
                            <button class="btn-act" onclick="openSchedule('${c.id}')"><span>üìÖ</span>Sched</button>
                            <button class="btn-act" onclick="downloadVCard('${c.id}')"><span>üë§</span>Save</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- DASHBOARD UPDATE (RESTORED) ---
        function updateDash() {
            const today = new Date(); today.setHours(0,0,0,0);
            let counts = { due: 0, bday: 0, ghost: 0, all: clients.length };
            
            clients.forEach(c => {
                if (getDueDate(c) <= today) counts.due++;
                if (isThisWeek(c.dob)) counts.bday++;
                if (c.lastVisit && Math.ceil((today - dateToLocal(c.lastVisit)) / 86400000) > 90) counts.ghost++;
            });

            if(document.getElementById('d-due')) document.getElementById('d-due').innerText = counts.due;
            if(document.getElementById('d-bday')) document.getElementById('d-bday').innerText = counts.bday;
            if(document.getElementById('d-ghost')) document.getElementById('d-ghost').innerText = counts.ghost;
            if(document.getElementById('d-all')) document.getElementById('d-all').innerText = counts.all;
        }

        function saveClient() {
            try {
                const idEl = document.getElementById('c-id');
                const nameEl = document.getElementById('c-name');
                if (!nameEl || !nameEl.value) { alert("Name is required!"); return; }

                const id = idEl.value;
                const ref = document.getElementById('c-ref').value;
                const lastVal = document.getElementById('c-last').value;
                
                const toggleEl = document.getElementById('c-count-first');
                const countFirst = toggleEl ? toggleEl.checked : false;
                
                let data = {
                    name: nameEl.value, 
                    phone: document.getElementById('c-phone').value,
                    price: parseFloat(document.getElementById('c-price').value)||35,
                    addr: document.getElementById('c-addr').value, 
                    social: document.getElementById('c-social').value,
                    dob: document.getElementById('c-dob').value, 
                    start: document.getElementById('c-start').value, 
                    ref: ref,
                    freq: parseInt(document.getElementById('c-freq').value)||4, 
                    lastVisit: lastVal,
                    notes: document.getElementById('c-notes').value
                };

                if (id) {
                    const idx = clients.findIndex(x => x.id == id);
                    if (idx > -1) clients[idx] = {...clients[idx], ...data};
                } else {
                    data.id = Date.now().toString(); 
                    data.cuts = 0; data.free = 0; data.credit = 0; 
                    data.ltv = 0; data.loyalty = 0; data.redeemedVal = 0;
                    
                    if (lastVal && countFirst) { data.cuts = 1; data.loyalty = 1; }
                    clients.push(data);
                    data.isNew = true; 
                    
                    if (ref) {
                        const referrer = clients.find(c => c.name.toLowerCase() === ref.toLowerCase() && c.id !== data.id);
                        if (referrer) { referrer.credit += 5; data.credit += 5; alert("Referral matched! $5 credits applied."); }
                    }
                }

                save(); 
                closeModals(); 
                document.getElementById('search').value = '';
                filterType = 'all';
                document.querySelectorAll('.dash-card').forEach(d => d.classList.remove('active'));
                const allBtn = document.getElementById('btn-all');
                if(allBtn) allBtn.classList.add('active');
                render();

            } catch (err) { alert("Error Saving: " + err.message); }
        }

        // --- CUT LOGIC ---
        function startCutFlow(id) {
            const c = clients.find(x=>x.id==id);
            if(c.free > 0) {
                customConfirm(`üåü Client has ${c.free} FREE CUT available.\nRedeem it now?`, 
                    () => { c.free--; c.redeemedVal=(c.redeemedVal||0)+(c.price||35); processStats(c, 0); },
                    () => { proceedToPaid(c, false); } 
                );
            } else if (isThisWeek(c.dob)) {
                customConfirm("üéÇ Birthday Week!\nRedeem 1/2 OFF Cut?",
                    () => { proceedToPaid(c, true); },
                    () => { proceedToPaid(c, false); }
                );
            } else {
                proceedToPaid(c, false);
            }
        }

        function proceedToPaid(c, isHalfOff) {
            let defPrice = c.price || 35;
            if(isHalfOff) defPrice = defPrice / 2;

            const price = prompt("Price paid today? (Enter 0 if unpaid)", defPrice);
            if(price === null) return;
            let paid = parseFloat(price)||0;

            if(c.credit > 0 && paid > 0) {
                const use = prompt(`Credit Balance: $${c.credit}.\nHow much to use?`, 0);
                if(use !== null) {
                    let creditUsed = parseFloat(use)||0;
                    if(creditUsed > c.credit) creditUsed = c.credit;
                    c.credit -= creditUsed;
                    c.redeemedVal = (c.redeemedVal || 0) + creditUsed; 
                }
            }
            processStats(c, paid);
        }

        function processStats(c, paid) {
            c.lastVisit = getLocalToday();
            c.cuts = (c.cuts || 0) + 1;
            c.ltv = (c.ltv || 0) + paid;
            c.loyalty = (c.loyalty || 0) + 1;
            if(c.loyalty >= 5) {
                c.free = (c.free || 0) + 1;
                c.loyalty = 0;
                alert("üéâ 5 Cuts Reached! Free Cut added to bank.");
            }
            save(); render();
        }

        // --- REDEEM ---
        function openRedeem(id) {
            const c=clients.find(x=>x.id==id);
            const opts=[];
            if(isThisWeek(c.start)) opts.push({lbl:"üéâ Redeem Anniversary Cut", fn:()=>{
                const price = prompt("Enter Tip Amount (or 0):", 0);
                const tip = parseFloat(price)||0;
                c.redeemedVal=(c.redeemedVal||0)+(c.price||35);
                c.lastVisit = getLocalToday();
                c.cuts++;
                c.ltv+=tip; 
                save(); render();
            }});
            if(c.free>0) opts.push({lbl:`Use Free Cut (${c.free})`, fn:()=>{ c.free--; c.redeemedVal=(c.redeemedVal||0)+(c.price||35); save(); render(); }});
            if(c.credit>0) opts.push({lbl:`Use Credit ($${c.credit})`, fn:()=>{
               const u=prompt("Amt:",c.credit); if(u) { c.credit-=Math.min(parseFloat(u),c.credit); save(); render(); }
            }});
            if(opts.length===0) return alert("No rewards available.");
            openListModal("Redeem", opts);
        }

        // --- UTILS ---
        function updateRefList() { 
            const dl=document.getElementById('ref-list'); 
            if(!dl) return;
            dl.innerHTML=''; 
            clients.forEach(cl=>{dl.innerHTML+=`<option value="${cl.name}">`}); 
        }
        
        function openClientModal(id) {
            let c = {id:'',name:'',phone:'',price:35,addr:'',social:'',dob:'',start:getLocalToday(),ref:'',freq:4,last:'',notes:''};
            if (id) { const found = clients.find(x=>x.id==id); if(found) c = found; }
            for(let k in c) { const el = document.getElementById('c-'+k); if(el) el.value = c[k]; }
            const toggle = document.getElementById('c-count-first');
            if(toggle) toggle.checked = false;
            updateRefList(); 
            document.getElementById('client-modal').style.display = 'flex';
        }
        
        function viewFull(id) {
            const c = clients.find(x=>x.id==id); tempId=id;
            document.getElementById('ro-title').innerText = c.name;
            const fmt = (d) => { if(!d || d.length < 10) return '-'; const parts = d.split('-'); return `${parts[1]}/${parts[2]}/${parts[0]}`; };
            let html = `<div class="ro-row"><div class="ro-lbl">Phone</div><div class="ro-val">${c.phone||'-'}</div></div>
                        <div class="ro-row"><div class="ro-lbl">Address</div><div class="ro-val">${c.addr||'-'}</div></div>
                        <div class="ro-row"><div class="ro-lbl">Social</div><div class="ro-val">${c.social||'-'}</div></div>
                        <div class="ro-row"><div class="ro-lbl">Birthday</div><div class="ro-val">${fmt(c.dob)}</div></div>
                        <div class="ro-row"><div class="ro-lbl">First Cut</div><div class="ro-val">${fmt(c.start)}</div></div>
                        <div class="ro-row"><div class="ro-lbl">Last Cut</div><div class="ro-val">${fmt(c.lastVisit)}</div></div>
                        <div class="ro-row"><div class="ro-lbl">Referred By</div><div class="ro-val">${c.ref||'-'}</div></div>
                        <div class="ro-row"><div class="ro-lbl">Default $</div><div class="ro-val">$${c.price||35}</div></div>`;
            document.getElementById('ro-content').innerHTML = html;
            document.getElementById('profile-modal').style.display = 'flex';
        }
        
        function editFromProfile() { closeModals(); openClientModal(tempId); }
        
        function openText(id) {
            const c = clients.find(x=>x.id==id); 
            if(!c.phone) return alert("No phone."); 
            const n = c.name.split(' ')[0]; 
            const opts = [{lbl:"Running Late", txt:`Hey ${n}, running a bit behind schedule. Thanks!`}, {lbl:"Confirm Cut", txt:`Hey ${n}, confirming our cut tomorrow. Still good?`}, {lbl:"Follow Up", txt:`Hey ${n}, checking in on the fresh cut. All good?`}, {lbl:"Custom", txt:''}]; 
            const sep = navigator.userAgent.match(/iPhone|iPad/i) ? '&' : '?'; 
            openListModal("Send Text", opts.map(o=>({lbl: o.lbl, fn: ()=>{ window.location = `sms:${c.phone}${sep}body=${encodeURIComponent(o.txt)}`; }}))); 
        }
        
        function downloadVCard(id) {
            const c = clients.find(x=>x.id==id);
            const vcf = `BEGIN:VCARD\nVERSION:3.0\nN:${c.name};;;;\nFN:${c.name}\nTEL;type=CELL;type=VOICE;type=pref:${c.phone||''}\nADR;type=HOME;type=pref:;;${c.addr||''};;;;\nNOTE:Black Book Notes: ${c.notes||''}\nEND:VCARD`;
            const blob = new Blob([vcf], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${c.name.replace(/\s/g,'_')}.vcf`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => document.body.removeChild(a), 100);
        }

        function openCreditModal() { updateRefList(); document.getElementById('credit-input').value=''; document.getElementById('credit-modal').style.display='flex'; }
        
        function applyCredit() { 
            const n=document.getElementById('credit-input').value; 
            const c=clients.find(x=>x.name.toLowerCase()===n.toLowerCase()); 
            if(c){c.credit+=5;save();render();alert("Credit Added");closeModals();}
            else alert("Not found"); 
        }
        
        function openSettings() {
            let rev=clients.reduce((a,b)=>a+(b.ltv||0),0); 
            let cuts=clients.reduce((a,b)=>a+(b.cuts||0),0); 
            let refs=clients.filter(c=>c.ref&&c.ref.length>0).length; 
            let red=clients.reduce((a,b)=>a+(b.redeemedVal||0),0); 
            document.getElementById('st-rev').innerText=`$${rev}`; 
            document.getElementById('st-cuts').innerText=cuts; 
            document.getElementById('st-ref').innerText=refs; 
            document.getElementById('st-red').innerText=`$${red}`; 
            document.getElementById('s-shop-addr').value=shopSettings.addr; 
            document.getElementById('settings-modal').style.display='flex'; 
        }
        
        function customConfirm(msg,yes,no) { 
            document.getElementById('confirm-msg').innerText=msg; 
            document.getElementById('confirm-modal').style.display='flex'; 
            document.getElementById('btn-yes').onclick=()=>{document.getElementById('confirm-modal').style.display='none';yes();}; 
            document.getElementById('btn-no').onclick=()=>{document.getElementById('confirm-modal').style.display='none';if(no)no();}; 
        }
        
        function openListModal(title, options, callback) { 
            document.getElementById('list-title').innerText=title; 
            const c=document.getElementById('list-options'); c.innerHTML=''; 
            options.forEach(o=>{
                const b=document.createElement('button'); b.className='list-option'; b.innerText=o.lbl; 
                b.onclick=()=>{o.fn(); closeModals(); if(callback)callback();}; 
                c.appendChild(b);
            }); 
            document.getElementById('list-modal').style.display='flex'; 
        }
        
        function getDueDate(c) { if(!c.lastVisit||!c.freq)return null; const d=dateToLocal(c.lastVisit); d.setDate(d.getDate()+(c.freq*7)); return d; }
        function isThisWeek(dStr) { if(!dStr)return false; const d=dateToLocal(dStr); const n=new Date(); n.setHours(0,0,0,0); const ty=new Date(n.getFullYear(),d.getMonth(),d.getDate()); const diff=(ty-n)/86400000; return diff>=-7 && diff<=7; }
        function getYears(dStr) { if(!dStr)return 0; return new Date().getFullYear()-dateToLocal(dStr).getFullYear(); }
        function setToday(id) { document.getElementById(id).value=getLocalToday(); }
        function fill(id,v) { document.getElementById(id).value=v; }
        function filter(t,el) { filterType=t; document.querySelectorAll('.dash-card').forEach(d=>d.classList.remove('active')); el.classList.add('active'); render(); }
        function toggleMenu() { document.getElementById('save-menu').classList.toggle('show'); }
        function toggleTheme() { document.body.classList.toggle('light-mode'); localStorage.setItem('theme', document.body.classList.contains('light-mode')?'light':'dark'); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
        function save(skipRender) { localStorage.setItem('bb_clients_v3', JSON.stringify(clients)); if(!skipRender) render(); }
        function saveSettings() { shopSettings.addr=document.getElementById('s-shop-addr').value; localStorage.setItem('bb_settings', JSON.stringify(shopSettings)); closeModals(); }
        function exportData(type) { toggleMenu(); if(type==='json'){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(clients)],{type:'application/json'})); a.download=`bb_${Date.now()}.json`; a.click();} else { let csv="Name,Phone,LTV\n"+clients.map(c=>`"${c.name}","${c.phone}",${c.ltv}`).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`bb.csv`; a.click(); }}
        function importData(el) { if(!el.files[0])return; const fr=new FileReader(); fr.onload=e=>{clients=JSON.parse(e.target.result); save(); render(); alert("Restored!");}; fr.readAsText(el.files[0]); }
        function openSchedule(id) { const c=clients.find(x=>x.id==id); document.getElementById('cal-id').value=id; document.getElementById('cal-date').value=getLocalToday(); selLoc('shop'); document.getElementById('cal-modal').style.display='flex'; }
        function selLoc(type) { const c=clients.find(x=>x.id==document.getElementById('cal-id').value); document.getElementById('cal-addr').value = type==='shop' ? (shopSettings.addr||'') : (c.addr||''); }
        function generateICS() { const c=clients.find(x=>x.id==document.getElementById('cal-id').value); const d=document.getElementById('cal-date').value; const t=document.getElementById('cal-time').value; const loc=document.getElementById('cal-addr').value; if(!d||!t) return alert("Date/Time needed"); const startRaw = d.replace(/-/g, '') + 'T' + t.replace(/:/g, '') + '00'; let h = parseInt(t.split(':')[0]) + 2; let m = parseInt(t.split(':')[1]); if(h>=24) h-=24; const endRaw = d.replace(/-/g, '') + 'T' + (h<10?'0':'')+h + (m<10?'0':'')+m + '00'; const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:Cut: ${c.name}\nDTSTART:${startRaw}\nDTEND:${endRaw}\nLOCATION:${loc}\nDESCRIPTION:${c.notes||'Haircut'}\nEND:VEVENT\nEND:VCALENDAR`; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([ics], {type: 'text/calendar'})); a.download = 'appointment.ics'; document.body.appendChild(a); a.click(); document.body.removeChild(a); closeModals(); }
    </script>
</body>
</html>
