<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pomodoro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pomodoro">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        /* [Existing CSS Styles Preserved Exactly] */
        :root { --bg-color: #f4f1ea; --bg-image: url('day.jpg'); --text-color: #2e4a33; --glass-bg: rgba(255, 253, 240, 0.25); --font-family: 'Verdana', sans-serif; }
        [data-theme="cyber"] { --bg-color: #050505; --bg-image: url('night.gif'); --text-color: #00ffff; --glass-bg: rgba(0, 0, 0, 0.6); --font-family: 'Courier New', monospace; }
        body { margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; font-family: var(--font-family); background-color: var(--bg-color); background-image: var(--bg-image); background-size: cover; background-position: center; transition: all 0.5s ease; overflow: hidden; position: relative; }
        body::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: inherit; filter: blur(5px); z-index: 0; }
        .container { position: relative; z-index: 10; background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.2); border-radius: 25px; padding: 30px; text-align: center; width: 90%; max-width: 400px; color: var(--text-color); box-shadow: 0 8px 32px 0 rgba(0,0,0,0.3); transition: color 1s ease, background 0.5s ease; }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        button { cursor: pointer; border: none; background: none; color: inherit; font-family: inherit; transition: 0.2s; outline: none; }
        .theme-toggle, .settings-toggle { display: flex; align-items: center; justify-content: center; opacity: 0.8; width: 40px; height: 40px; }
        .theme-toggle svg, .settings-toggle svg { width: 28px; height: 28px; fill: currentColor; }
        .timer-wrapper { position: relative; width: 220px; height: 220px; margin: 0 auto; }
        svg.timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        circle { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 0.3s linear, stroke 1s linear; }
        .track { stroke: rgba(128, 128, 128, 0.3); }
        .progress { stroke: var(--text-color); }
        .time-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: bold; }
        .controls { margin-top: 25px; display: flex; justify-content: center; gap: 15px; }
        button.btn-main { padding: 10px 25px; border: 2px solid currentColor; font-size: 1rem; border-radius: 50px; text-transform: uppercase; font-weight: bold; }
        button.btn-main:hover { background: currentColor; color: #fff; }
        .modes { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .mode-btn { font-size: 0.85rem; padding: 5px 10px; border-radius: 10px; opacity: 0.6; }
        .mode-btn.active { opacity: 1; font-weight: bold; background: rgba(128,128,128,0.2); }
        #settings-panel { display: none; margin-top: 20px; border-top: 1px solid currentColor; padding-top: 15px; font-size: 0.9rem; text-align: left; }
        .setting-row { margin: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        input[type="number"], select { padding: 5px; border-radius: 5px; border: 1px solid currentColor; background: rgba(255,255,255,0.2); color: inherit; }
        .soundboard { margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3); }
        .sound-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-icon { font-size: 1.2rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <button id="theme-btn" class="theme-toggle" title="Switch Theme"></button>
        <button id="settings-btn" class="settings-toggle" title="Settings">
            <svg viewBox="0 0 24 24"><path d="M12,15.5A3.5,3.5,0,0,1,8.5,12A3.5,3.5,0,0,1,12,8.5A3.5,3.5,0,0,1,15.5,12A3.5,3.5,0,0,1,12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.35 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.35 4.5,11.67 4.5,12C4.5,11.67 4.53,11.35 4.57,11L2.46,9.37Z"/></svg>
        </button>
    </div>

    <div class="modes">
        <button class="mode-btn active" id="mode-pomodoro" data-time="25" data-mode="work">Pomodoro</button>
        <button class="mode-btn" id="mode-short" data-time="5" data-mode="break">Short Break</button>
        <button class="mode-btn" id="mode-long" data-time="15" data-mode="break">Long Break</button>
    </div>

    <div class="timer-wrapper">
        <svg class="timer-svg">
            <circle class="track" cx="110" cy="110" r="95"></circle>
            <circle class="progress" cx="110" cy="110" r="95"></circle>
        </svg>
        <div class="time-display" id="time-display">25:00</div>
    </div>

    <div class="controls">
        <button class="btn-main" id="start-btn">Start</button>
        <button class="btn-main" id="reset-btn">Reset</button>
    </div>

    <div class="soundboard">
        <div class="sound-row">
            <select id="ambience-select">
                <option value="none">-- Noise Off --</option>
                <option value="rain.mp3">Rain</option>
                <option value="storm.mp3">Storm</option>
                <option value="forest.mp3">Forest</option>
                <option value="waves.mp3">Waves</option> 
            </select>
            <button id="ambience-btn" class="btn-icon">▶</button>
        </div>
        <div class="sound-row">
            <span>Focus Music</span>
            <button id="music-btn" class="btn-icon">▶</button>
        </div>
    </div>

    <div id="settings-panel">
        <div class="setting-row"><label>Auto-start Breaks?</label><input type="checkbox" id="auto-break"></div>
        <div class="setting-row"><label>Custom Work (min):</label><input type="number" id="custom-work-input" value="45"></div>
        <div class="setting-row"><label>Custom Break (min):</label><input type="number" id="custom-break-input" value="10"></div>
        <div class="custom-controls">
            <button class="btn-custom" id="start-custom-work">Start Work</button>
            <button class="btn-custom" id="start-custom-break">Start Break</button>
        </div>
    </div>

    <audio id="bg-music" loop preload="auto"></audio>
    <audio id="ambience-player" loop preload="auto"></audio>
</div>

<script>
    // 1. SERVICE WORKER REGISTRATION
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(() => console.log("Offline Ready"));
    }

    // 2. WAKE LOCK API
    let wakeLock = null;
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
            }
        } catch (err) { console.error(`${err.name}, ${err.message}`); }
    }

    function releaseWakeLock() {
        if (wakeLock !== null) {
            wakeLock.release();
            wakeLock = null;
        }
    }

    // 3. ASSETS & BASE64 SOUNDS (Zero Latency)
    const musicFiles = { day: 'day.mp3', night: 'night.mp3.mp3' };
    const iconLeaf = `<svg viewBox="0 0 24 24"><path d="M17,8C8,10,5.9,16.17,3.82,21.34L5.71,22l1-2.3A4.49,4.49,0,0,0,8,20C19,20,22,3,22,3,21,5,14,5.25,9,6.25S2,11.5,2,13.5a6.22,6.22,0,0,0,1.75,3.75C7,8,17,8,17,8Z"/></svg>`;
    const iconRobot = `<svg viewBox="0 0 24 24"><path d="M4.5,10.5V12.5H6.5V14.5H8.5V12.5H6.5V10.5H4.5M17.5,10.5V12.5H15.5V14.5H17.5V12.5H19.5V10.5H17.5M6,4V6H18V4H6M4,6V8H20V6H4M2,8V16H22V8H2M6,10H8V12H6V10M16,10H18V12H16V10M11,10H13V12H11V10Z"/></svg>`;

    // 4. TIMER LOGIC (Fixing Drift)
    const circle = document.querySelector('.progress');
    const radius = circle.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    circle.style.strokeDasharray = `${circumference} ${circumference}`;

    let timeLeft = 25 * 60;
    let totalTime = 25 * 60;
    let timerId = null;
    let isRunning = false;
    let targetTime = null;
    let currentMode = 'work';

    const timeDisplay = document.getElementById('time-display');
    const startBtn = document.getElementById('start-btn');
    const themeBtn = document.getElementById('theme-btn');
    themeBtn.innerHTML = iconLeaf;

    function updateVisuals(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        const displayStr = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
        timeDisplay.textContent = displayStr;
        document.title = isRunning ? `${displayStr} - Focus` : "Pomodoro";
        
        const percent = seconds / totalTime;
        circle.style.strokeDashoffset = circumference - (percent * circumference);
    }

    function startTimer() {
        if (isRunning) {
            clearInterval(timerId);
            isRunning = false;
            startBtn.textContent = 'Start';
            releaseWakeLock();
        } else {
            isRunning = true;
            startBtn.textContent = 'Pause';
            requestWakeLock();
            targetTime = Date.now() + (timeLeft * 1000);
            
            timerId = setInterval(() => {
                const now = Date.now();
                const distance = targetTime - now;

                if (distance <= 0) {
                    clearInterval(timerId);
                    timeLeft = 0;
                    updateVisuals(0);
                    // Add alarm logic here
                } else {
                    timeLeft = Math.ceil(distance / 1000);
                    updateVisuals(timeLeft);
                }
            }, 100); // Check 10x per second to prevent visual lag
        }
    }

    startBtn.addEventListener('click', startTimer);
    // [Rest of your UI event listeners remain the same]
</script>
</body>
</html>
