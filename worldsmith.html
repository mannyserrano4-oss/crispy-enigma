<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WorldSmith">
    <link rel="apple-touch-icon" href="icon.png">

    <title>The World Smith</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    
    <style>
        /* --- PASTEL THEME VARIABLES --- */
        :root {
            /* Default: DARK (Moonlight Pastel) */
            --bg-body: #23242a;
            --bg-panel: #2d2e36;
            --bg-input: #383942;
            --text-main: #e0e0e0;
            --text-muted: #9496a8;
            --border: #3f414d;
            
            --accent: #b59af7;      /* Pastel Lavender */
            --accent-dim: #7d6bb0;
            --accent-sec: #ffb7b2;  /* Pastel Coral */
            
            --card-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        body.light-mode {
            /* LIGHT (Sunrise Pastel) */
            --bg-body: #fdf6e3;     /* Cream/Parchment */
            --bg-panel: #eee8d5;
            --bg-input: #fbfbfb;
            --text-main: #586e75;
            --text-muted: #93a1a1;
            --border: #d3d0c2;
            
            --accent: #2aa198;      /* Pastel Teal */
            --accent-dim: #6c71c4;
            --accent-sec: #cb4b16;  /* Pastel Orange */
            
            --card-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        body {
            margin: 0; background-color: var(--bg-body); color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh; display: flex; overflow: hidden;
            transition: background 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- SIDEBAR NAV --- */
        .sidebar {
            width: 70px; background: var(--bg-panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; padding-top: env(safe-area-inset-top); z-index: 100;
            padding-bottom: env(safe-area-inset-bottom); box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .nav-btn {
            width: 48px; height: 48px; border-radius: 14px; border: none; background: transparent;
            color: var(--text-muted); font-size: 1.3rem; margin-bottom: 15px; cursor: pointer; transition: 0.2s;
        }
        .nav-btn:hover { color: var(--accent); background: var(--bg-input); }
        .nav-btn.active { color: var(--bg-panel); background: var(--accent); box-shadow: 0 4px 12px var(--accent-dim); }

        /* --- MAIN AREA --- */
        .main-stage { flex: 1; position: relative; display: flex; overflow: hidden; padding-top: env(safe-area-inset-top); }

        /* --- TABS --- */
        .view-section { display: none; width: 100%; height: 100%; padding: 20px; box-sizing: border-box; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .view-section.active { display: block; }

        /* --- WRITING DESK --- */
        #view-write { display: none; width:100%; height:100%; padding: 0; }
        .writer-layout { display: flex; height: 100%; }
        
        .editor-container { flex: 1; padding: 40px 10%; overflow-y: auto; background: var(--bg-body); transition: background 0.3s; }
        .editor-title {
            width: 100%; background: transparent; border: none; color: var(--accent); font-size: 2.2rem;
            font-family: 'Georgia', serif; font-weight: bold; margin-bottom: 20px; outline: none;
        }
        .editor-area {
            width: 100%; height: 80vh; background: transparent; border: none; color: var(--text-main);
            font-size: 1.25rem; line-height: 1.8; font-family: 'Georgia', serif; resize: none; outline: none;
        }

        /* --- WIKI SIDEBAR --- */
        .wiki-panel {
            width: 320px; background: var(--bg-panel); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 15px; transition: margin-right 0.3s;
        }
        .wiki-search {
            width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text-main); border-radius: 8px; margin-bottom: 15px;
        }
        .wiki-card {
            background: var(--bg-input); padding: 12px; border-radius: 8px; margin-bottom: 10px;
            border-left: 4px solid var(--accent); cursor: pointer; box-shadow: var(--card-shadow);
        }
        .wiki-card h4 { margin: 0 0 5px 0; color: var(--accent); }
        .wiki-card small { display: block; color: var(--text-muted); font-size: 0.85rem; }

        /* --- MOBILE --- */
        @media (max-width: 768px) {
            .writer-layout { flex-direction: column; }
            .wiki-panel { width: 100%; height: 250px; border-left: none; border-top: 1px solid var(--border); order: -1; display:none;}
            .editor-container { padding: 20px; }
            .wb-grid { display: flex; flex-direction: column; }
            .wb-list { height: 200px; }
            .sidebar { width: 60px; }
            .nav-btn { width: 40px; height: 40px; font-size: 1.1rem; }
        }

        /* --- WORLD BUILDER GRID --- */
        .wb-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: 100%; }
        .wb-list { background: var(--bg-panel); border-radius: 12px; padding: 15px; overflow-y: auto; border: 1px solid var(--border); }
        .wb-detail { background: var(--bg-panel); border-radius: 12px; padding: 30px; overflow-y: auto; border: 1px solid var(--border); }
        
        .category-header { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-top: 20px; margin-bottom: 8px; font-weight: 700; }
        .entity-item { padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; }
        .entity-item:hover { background: var(--bg-input); }
        .entity-item.active { background: var(--bg-input); color: var(--accent); border-left: 3px solid var(--accent); font-weight: 600; }

        /* --- FORMS --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; color: var(--accent); font-size: 0.85rem; margin-bottom: 8px; font-weight: 700; text-transform: uppercase; }
        input, select, textarea {
            width: 100%; padding: 12px; background: var(--bg-input); border: 2px solid var(--border); color: var(--text-main);
            border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size:16px; transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; }

        /* --- TIMELINE (DRAG & DROP) --- */
        .timeline-container {
            display: flex; gap: 20px; padding: 20px; overflow-x: auto; height: 100%; align-items: flex-start;
            /* Allow scrolling horizontally, but we will use JS to make dragging nice */
        }
        .timeline-card {
            min-width: 280px; width: 280px; background: var(--bg-panel); border-top: 4px solid var(--accent-sec);
            padding: 20px; border-radius: 12px; position: relative; box-shadow: var(--card-shadow);
            cursor: grab; flex-shrink: 0; border: 1px solid var(--border);
        }
        .timeline-card:active { cursor: grabbing; transform: scale(1.02); }
        .timeline-card h4 { margin-top: 0; color: var(--accent-sec); font-size: 1.1rem; }
        .timeline-handle {
            position: absolute; top: 10px; right: 10px; color: var(--text-muted); cursor: grab; padding: 5px;
        }

        /* --- UTILS --- */
        .btn { padding: 10px 20px; background: var(--accent); border: none; color: var(--bg-panel); border-radius: 8px; cursor: pointer; font-weight: 800; }
        .btn:hover { opacity: 0.9; }
        .btn-new { width: 100%; margin-bottom: 15px; background: var(--bg-input); color: var(--text-muted); border: 2px dashed var(--border); }
        .btn-new:hover { border-color: var(--accent); color: var(--accent); }

        /* --- CRASH GUARD --- */
        #crashModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; color: #ff6b6b;
            z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; box-sizing: border-box; text-align: center; font-family: monospace;
        }
        .crash-btn {
            background: #ff6b6b; color: black; padding: 15px; width: 100%; border: none; border-radius: 10px;
            font-weight: bold; margin-top: 15px; font-size: 1rem; cursor: pointer;
        }
    </style>
</head>
<body class="">

    <div id="crashModal">
        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
        <h2 style="margin:0;">System Failure</h2>
        <p style="color:#aaa; font-size:0.9rem;">The app crashed. Don't worry, your data is safe.</p>
        <div id="crashMsg" style="background:#333; padding:15px; border-radius:8px; font-size:0.8rem; color:#ff9999; text-align:left; width:100%; margin-bottom:20px; word-break: break-all;"></div>
        <button class="crash-btn" onclick="emergencyCopy()">1. Copy Raw Data</button>
        <button class="crash-btn" style="background:#444; color:white;" onclick="factoryReset()">2. Factory Reset</button>
        <button class="crash-btn" style="background:transparent; color:#888; border:1px solid #555;" onclick="location.reload()">3. Try Reloading</button>
    </div>

    <div class="sidebar">
        <div style="color:var(--accent); font-size:1.6rem; margin-bottom:30px; margin-top:20px;"><i class="fas fa-dragon"></i></div>
        
        <button class="nav-btn active" onclick="setTab('write')" title="Write"><i class="fas fa-pen-nib"></i></button>
        <button class="nav-btn" onclick="setTab('world')" title="World"><i class="fas fa-globe-americas"></i></button>
        <button class="nav-btn" onclick="setTab('chars')" title="Characters"><i class="fas fa-users"></i></button>
        <button class="nav-btn" onclick="setTab('plot')" title="Timeline"><i class="fas fa-project-diagram"></i></button>
        
        <div style="margin-top:auto;"></div>
        <button class="nav-btn" onclick="toggleTheme()" title="Toggle Theme"><i class="fas fa-adjust"></i></button>
        <button class="nav-btn" onclick="saveToDisk()" title="Save Backup"><i class="fas fa-save"></i></button>
        <button class="nav-btn" onclick="document.getElementById('loadInput').click()" title="Load Backup"><i class="fas fa-upload"></i></button>
        <input type="file" id="loadInput" hidden onchange="loadFromDisk(this)">
    </div>

    <div class="main-stage">
        
        <div id="view-write" class="view-section active" style="padding:0;">
            <div class="writer-layout">
                <div class="editor-container">
                    <input type="text" id="chapterTitle" class="editor-title" placeholder="Chapter Title..." oninput="autoSave()">
                    <textarea id="chapterContent" class="editor-area" placeholder="Start writing..." oninput="autoSave()"></textarea>
                </div>
                <div class="wiki-panel" id="wikiPanel">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0; color:var(--accent);">World Wiki</h4>
                        <button class="btn" style="padding:4px 10px; font-size:0.8rem;" onclick="toggleWiki()">Hide</button>
                    </div>
                    <input type="text" class="wiki-search" placeholder="Search Names, Places..." oninput="searchWiki(this.value)">
                    <div id="wikiResults"></div>
                </div>
                <button onclick="toggleWiki()" style="position:absolute; top:20px; right:20px; z-index:50; background:var(--bg-panel); color:var(--accent); border:1px solid var(--accent); border-radius:50%; width:44px; height:44px; display:none; box-shadow:0 4px 10px rgba(0,0,0,0.2);" id="mobWikiBtn"><i class="fas fa-book"></i></button>
            </div>
        </div>

        <div id="view-world" class="view-section">
            <div class="wb-grid">
                <div class="wb-list">
                    <button class="btn btn-new" onclick="createNewEntity('world')">+ New Entry</button>
                    <div id="worldList"></div>
                </div>
                <div class="wb-detail">
                    <form id="worldForm" onsubmit="event.preventDefault(); saveEntity('world');">
                        <input type="hidden" id="wId">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h2 style="margin:0; color:var(--accent);">World Entry</h2>
                            <button class="btn">Save Changes</button>
                        </div>
                        <hr style="border:0; border-bottom:1px solid var(--border); margin:20px 0;">
                        <div class="form-group"><label>Name</label><input type="text" id="wName" required></div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="wType">
                                <option value="Race">Race / Species</option>
                                <option value="Location">Location / Kingdom</option>
                                <option value="Religion">Religion / Deity</option>
                                <option value="Faction">Faction / Politics</option>
                                <option value="Magic">Magic System</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Region / Origin</label><input type="text" id="wRegion"></div>
                        <div class="form-group"><label>Relations / Conflicts</label><textarea id="wRelations" rows="3"></textarea></div>
                        <div class="form-group"><label>Description & Lore</label><textarea id="wDesc" rows="10"></textarea></div>
                    </form>
                </div>
            </div>
        </div>

        <div id="view-chars" class="view-section">
            <div class="wb-grid">
                <div class="wb-list">
                    <button class="btn btn-new" onclick="createNewEntity('char')">+ New Character</button>
                    <div id="charList"></div>
                </div>
                <div class="wb-detail">
                    <form id="charForm" onsubmit="event.preventDefault(); saveEntity('char');">
                        <input type="hidden" id="cId">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h2 style="margin:0; color:var(--accent);">Character Profile</h2>
                            <button class="btn">Save Changes</button>
                        </div>
                        <hr style="border:0; border-bottom:1px solid var(--border); margin:20px 0;">
                        <div class="form-group"><label>Name</label><input type="text" id="cName" required></div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div class="form-group"><label>Race</label><input type="text" id="cRace"></div>
                            <div class="form-group"><label>Role</label><input type="text" id="cRole"></div>
                        </div>
                        <div class="form-group"><label>Goal (Point B)</label><input type="text" id="cGoal"></div>
                        <div class="form-group"><label>The Lie (Point A)</label><input type="text" id="cLie"></div>
                        <div class="form-group"><label>Deity / Beliefs</label><input type="text" id="cGod"></div>
                        <div class="form-group"><label>Connections</label><textarea id="cConn" rows="3"></textarea></div>
                        <div class="form-group"><label>Notes</label><textarea id="cNotes" rows="8"></textarea></div>
                    </form>
                </div>
            </div>
        </div>

        <div id="view-plot" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div>
                    <h2 style="margin:0; color:var(--accent);">Timeline</h2>
                    <small style="color:var(--text-muted);">Drag cards to reorder events</small>
                </div>
                <button class="btn" onclick="addEvent()">+ Add Event</button>
            </div>
            <div class="timeline-container" id="timelineList"></div>
        </div>

    </div>

    <script>
        // --- CRASH GUARD ---
        window.onerror = function(msg, url, line) {
            const m = document.getElementById('crashModal');
            document.getElementById('crashMsg').innerHTML = `<strong>Error:</strong> ${msg}<br><strong>Line:</strong> ${line}`;
            m.style.display = 'flex';
            return false;
        };
        function emergencyCopy() {
            const raw = localStorage.getItem('worldSmithDB');
            if(navigator.clipboard) { navigator.clipboard.writeText(raw).then(() => alert("Data Copied!")); } 
            else { prompt("Copy your data manually:", raw); }
        }
        function factoryReset() {
            if(confirm("This will WIPE all local data. Are you sure?")) {
                localStorage.clear(); location.reload();
            }
        }

        // --- APP STATE ---
        let db = { writing: { title: '', content: '' }, world: [], chars: [], timeline: [] };
        let isLight = false;

        window.onload = () => {
            try {
                const saved = localStorage.getItem('worldSmithDB');
                if(saved) db = JSON.parse(saved);
                
                // Theme Check
                if(localStorage.getItem('wsTheme') === 'light') toggleTheme(true);

                document.getElementById('chapterTitle').value = db.writing.title || '';
                document.getElementById('chapterContent').value = db.writing.content || '';
                
                refreshLists();
                renderTimeline();
                searchWiki('');
                
                if(window.innerWidth < 768) document.getElementById('mobWikiBtn').style.display = 'block';

                // INIT SORTABLE (DRAG AND DROP)
                initSortable();

            } catch(e) { throw new Error("Data Corruption: " + e.message); }
        };

        // --- THEME TOGGLE ---
        function toggleTheme(forceLight) {
            if(forceLight || !isLight) {
                document.body.classList.add('light-mode'); isLight = true;
            } else {
                document.body.classList.remove('light-mode'); isLight = false;
            }
            localStorage.setItem('wsTheme', isLight ? 'light' : 'dark');
        }

        // --- DRAG AND DROP LOGIC (SORTABLE JS) ---
        function initSortable() {
            const el = document.getElementById('timelineList');
            new Sortable(el, {
                animation: 150,
                ghostClass: 'blue-background-class',
                delay: 100, // Small delay prevents accidental drags on touch
                delayOnTouchOnly: true,
                onEnd: function (evt) {
                    // Reorder the DB array based on the new DOM order
                    const newOrder = [];
                    const cards = el.querySelectorAll('.timeline-card');
                    cards.forEach(card => {
                        const id = parseInt(card.getAttribute('data-id'));
                        const item = db.timeline.find(x => x.id === id);
                        if(item) newOrder.push(item);
                    });
                    db.timeline = newOrder;
                    persist();
                }
            });
        }

        // --- NAVIGATION ---
        function setTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(tabId === 'write') searchWiki('');
        }

        // --- DATA OPS ---
        function autoSave() {
            db.writing.title = document.getElementById('chapterTitle').value;
            db.writing.content = document.getElementById('chapterContent').value;
            persist();
        }
        function persist() { localStorage.setItem('worldSmithDB', JSON.stringify(db)); }

        function createNewEntity(type) {
            const id = Date.now().toString();
            const empty = type === 'world' 
                ? { id, name: 'New Entry', type: 'Location', region: '', relations: '', desc: '' }
                : { id, name: 'New Character', race: '', role: '', goal: '', lie: '', god: '', conn: '', notes: '' };
            if(type === 'world') db.world.push(empty); else db.chars.push(empty);
            persist(); refreshLists(); loadEntity(type, id);
        }

        function saveEntity(type) {
            if(type === 'world') {
                const id = document.getElementById('wId').value;
                const idx = db.world.findIndex(x => x.id === id);
                if(idx > -1) db.world[idx] = {
                    id, name: document.getElementById('wName').value, type: document.getElementById('wType').value,
                    region: document.getElementById('wRegion').value, relations: document.getElementById('wRelations').value,
                    desc: document.getElementById('wDesc').value
                };
            } else {
                const id = document.getElementById('cId').value;
                const idx = db.chars.findIndex(x => x.id === id);
                if(idx > -1) db.chars[idx] = {
                    id, name: document.getElementById('cName').value, race: document.getElementById('cRace').value,
                    role: document.getElementById('cRole').value, goal: document.getElementById('cGoal').value,
                    lie: document.getElementById('cLie').value, god: document.getElementById('cGod').value,
                    conn: document.getElementById('cConn').value, notes: document.getElementById('cNotes').value
                };
            }
            persist(); refreshLists(); alert('Saved!');
        }

        function loadEntity(type, id) {
            // Find entity
            const data = type === 'world' ? db.world.find(x => x.id === id) : db.chars.find(x => x.id === id);
            if(!data) return;
            
            // Highlight active in list
            document.querySelectorAll('.entity-item').forEach(el => el.classList.remove('active'));
            // (Simple highlighting logic based on ID match in onclick - could be improved but sufficient)
            
            if(type === 'world') {
                document.getElementById('wId').value = data.id; document.getElementById('wName').value = data.name;
                document.getElementById('wType').value = data.type; document.getElementById('wRegion').value = data.region;
                document.getElementById('wRelations').value = data.relations; document.getElementById('wDesc').value = data.desc;
            } else {
                document.getElementById('cId').value = data.id; document.getElementById('cName').value = data.name;
                document.getElementById('cRace').value = data.race; document.getElementById('cRole').value = data.role;
                document.getElementById('cGoal').value = data.goal; document.getElementById('cLie').value = data.lie;
                document.getElementById('cGod').value = data.god; document.getElementById('cConn').value = data.conn;
                document.getElementById('cNotes').value = data.notes;
            }
        }

        function refreshLists() {
            const wList = document.getElementById('worldList'); wList.innerHTML = '';
            ['Race', 'Location', 'Religion', 'Faction', 'Magic'].forEach(t => {
                const items = db.world.filter(x => x.type === t);
                if(items.length > 0) {
                    wList.innerHTML += `<div class="category-header">${t}s</div>`;
                    items.forEach(item => wList.innerHTML += `<div class="entity-item" onclick="loadEntity('world', '${item.id}')">${item.name}</div>`);
                }
            });
            const cList = document.getElementById('charList'); cList.innerHTML = '';
            db.chars.forEach(item => cList.innerHTML += `<div class="entity-item" onclick="loadEntity('char', '${item.id}')">${item.name} <small style="color:var(--text-muted)">(${item.race})</small></div>`);
        }

        // --- TIMELINE ---
        function addEvent() {
            const title = prompt("Event Title:");
            if(title) { db.timeline.push({ id: Date.now(), title, desc: 'Description...' }); persist(); renderTimeline(); }
        }
        function deleteEvent(id) {
            if(confirm("Delete this event?")) { db.timeline = db.timeline.filter(x => x.id !== id); persist(); renderTimeline(); }
        }
        function updateEvent(id, val) { const ev = db.timeline.find(x => x.id === id); if(ev) { ev.desc = val; persist(); } }
        
        function renderTimeline() {
            const div = document.getElementById('timelineList'); div.innerHTML = '';
            db.timeline.forEach((ev) => {
                div.innerHTML += `
                    <div class="timeline-card" data-id="${ev.id}">
                        <div class="timeline-handle"><i class="fas fa-grip-lines"></i></div>
                        <h4>${ev.title}</h4>
                        <textarea style="width:100%; height:80px; font-size:0.9rem;" onchange="updateEvent(${ev.id}, this.value)">${ev.desc}</textarea>
                        <button class="btn" style="background:var(--bg-input); color:var(--text-muted); margin-top:5px; font-size:0.7rem; padding:4px 8px;" onclick="deleteEvent(${ev.id})">Delete</button>
                    </div>`;
            });
        }

        // --- WIKI ---
        function toggleWiki() {
            const p = document.getElementById('wikiPanel');
            if(window.innerWidth < 768) {
                p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
            } else {
                p.style.marginRight = p.style.marginRight === '-320px' ? '0' : '-320px';
            }
        }
        function searchWiki(term) {
            const res = document.getElementById('wikiResults'); res.innerHTML = ''; term = term.toLowerCase();
            db.world.forEach(w => {
                if(w.name.toLowerCase().includes(term) || w.type.toLowerCase().includes(term)) {
                    res.innerHTML += `<div class="wiki-card"><h4>${w.name} <small>${w.type}</small></h4><small>${w.desc.substring(0, 60)}...</small></div>`;
                }
            });
            db.chars.forEach(c => {
                if(c.name.toLowerCase().includes(term) || c.race.toLowerCase().includes(term)) {
                    res.innerHTML += `<div class="wiki-card" style="border-left-color: var(--accent-sec);"><h4>${c.name} <small>${c.race}</small></h4><small>Goal: ${c.goal}</small></div>`;
                }
            });
        }

        // --- EXPORT / IMPORT ---
        function saveToDisk() {
            const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = 'WorldSmith_Backup.json'; a.click();
        }
        function loadFromDisk(input) {
            const r = new FileReader();
            r.onload = (e) => {
                try { db = JSON.parse(e.target.result); persist(); location.reload(); } catch(err) { alert("Invalid File"); }
            };
            r.readAsText(input.files[0]);
        }
    </script>
</body>
</html>
