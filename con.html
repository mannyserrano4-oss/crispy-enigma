<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAS Design Engine | Clean Build</title>
    <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer_v1.2.6.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #38bdf8; --border: #334155; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        .container { width: 100%; max-width: 850px; background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .drop-zone { border: 2px dashed var(--accent); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; background: rgba(56, 189, 248, 0.05); margin-bottom: 15px; }
        
        /* Fixed Controls Layout */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .control-group { display: flex; flex-direction: column; gap: 4px; font-size: 0.75rem; font-weight: bold; color: var(--accent); }
        select, button, input[type="range"] { padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: #0f172a; color: white; font-size: 0.9rem; }
        button { background: var(--accent); color: #0f172a; border: none; font-weight: bold; cursor: pointer; }

        .preview-window { width: 100%; aspect-ratio: 1/1; background: #000; border: 2px solid var(--border); border-radius: 12px; position: relative; overflow: hidden; touch-action: none; cursor: grab; display: flex; align-items: center; justify-content: center; }
        
        #pan-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; transform-origin: center; transition: transform 0.05s linear; }
        #zoom-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        
        /* Critical SVG Scaling Fix */
        svg { width: 100% !important; height: 100% !important; max-width: 100%; max-height: 100%; display: block; overflow: visible !important; }
        canvas, img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .status-bar { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: #888; margin-bottom: 8px; }
        #loading { color: var(--accent); font-weight: bold; display: none; }
        .hint { font-size: 0.65rem; color: #64748b; margin-bottom: 10px; text-align: center; line-height: 1.2; }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="text-align:center; margin: 0 0 10px 0;">MAS Design Engine</h2>
        <div class="hint">FIX: Lower "Color Count" to 5-8 to remove gray spots. Zoom from center active.</div>
        
        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
            <span>Tap to Upload</span>
            <input type="file" id="file-input" accept="image/*" hidden>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Format</label>
                <select id="format">
                    <option value="image/svg+xml">SVG (Vector)</option>
                    <option value="image/png">PNG</option>
                </select>
            </div>
            <div class="control-group">
                <label>Zoom: <span id="zoom-val">1x</span></label>
                <input type="range" id="zoom-slider" min="1" max="100" step="1" value="1">
            </div>
            <div class="control-group">
                <label>Color Count: <span id="color-val">8</span></label>
                <input type="range" id="color-slider" min="2" max="32" value="8">
            </div>
            <div class="control-group">
                <label>Simplify Detail</label>
                <input type="range" id="detail-slider" min="0" max="2" step="0.1" value="0.5">
            </div>
        </div>

        <div class="status-bar">
            <span id="loading">CLEANING PATHS...</span>
            <button onclick="resetView()" style="padding: 2px 8px; font-size: 0.6rem;">RESET VIEW</button>
        </div>

        <div class="preview-window" id="viewport">
            <div id="pan-container">
                <div id="zoom-content"></div>
            </div>
        </div>

        <button id="download-btn" style="width:100%; margin-top: 15px; display:none; padding: 12px;">Download Final File</button>
    </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const zoomSlider = document.getElementById('zoom-slider');
        const colorSlider = document.getElementById('color-slider');
        const detailSlider = document.getElementById('detail-slider');
        const zoomVal = document.getElementById('zoom-val');
        const colorVal = document.getElementById('color-val');
        const panContainer = document.getElementById('pan-container');
        const zoomContent = document.getElementById('zoom-content');
        const formatSelect = document.getElementById('format');
        const downloadBtn = document.getElementById('download-btn');
        const loading = document.getElementById('loading');

        let originalImg = null;
        let scale = 1, pointX = 0, pointY = 0, start = { x: 0, y: 0 }, isDragging = false;

        function updateTransform() { panContainer.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
        function resetView() { scale = 1; pointX = 0; pointY = 0; zoomSlider.value = 1; zoomVal.innerText = '1x'; updateTransform(); }

        zoomSlider.oninput = () => { scale = parseFloat(zoomSlider.value); zoomVal.innerText = `${scale}x`; updateTransform(); };
        colorSlider.oninput = () => { colorVal.innerText = colorSlider.value; if(originalImg) processFile(); };
        detailSlider.oninput = () => { if(originalImg) processFile(); };

        // Pan Logic
        const startDrag = (e) => {
            isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            start = { x: clientX - pointX, y: clientY - pointY };
        };
        const duringDrag = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            pointX = clientX - start.x; pointY = clientY - start.y;
            updateTransform();
        };
        const viewport = document.getElementById('viewport');
        viewport.addEventListener('mousedown', startDrag);
        viewport.addEventListener('touchstart', startDrag);
        window.addEventListener('mousemove', duringDrag);
        window.addEventListener('touchmove', duringDrag, { passive: false });
        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('touchend', () => isDragging = false);

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                originalImg = new Image();
                originalImg.onload = processFile;
                originalImg.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };

        async function processFile() {
            loading.style.display = 'inline';
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const max = 1500; 
            let w = originalImg.width, h = originalImg.height;
            const r = Math.min(max/w, max/h);
            canvas.width = w * r; canvas.height = h * r;
            ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height);

            setTimeout(() => {
                const target = formatSelect.value;
                zoomContent.innerHTML = '';
                if (target === "image/svg+xml") {
                    const options = { 
                        ltres: parseFloat(detailSlider.value), 
                        qtres: parseFloat(detailSlider.value), 
                        pathomit: 0.1, 
                        numberofcolors: parseInt(colorSlider.value), 
                        viewbox: true // CRITICAL: Ensures SVG scales correctly
                    };
                    zoomContent.innerHTML = ImageTracer.imagedataToSVG(ctx.getImageData(0,0,canvas.width,canvas.height), options);
                } else {
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL(target, 1.0);
                    zoomContent.appendChild(img);
                }
                loading.style.display = 'none';
                downloadBtn.style.display = 'block';
            }, 50);
        }

        formatSelect.onchange = () => { if(originalImg) processFile(); };
        downloadBtn.onclick = () => {
            const target = formatSelect.value;
            const a = document.createElement('a');
            if (target === "image/svg+xml") {
                const blob = new Blob([zoomContent.innerHTML], {type: 'image/svg+xml'});
                a.href = URL.createObjectURL(blob);
                a.download = 'MAS-CleanDesign.svg';
            } else {
                a.href = zoomContent.querySelector('img').src;
                a.download = `MAS-CleanDesign.png`;
            }
            a.click();
        };
    </script>
</body>
</html>
