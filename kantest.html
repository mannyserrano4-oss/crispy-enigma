<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuestBoard RPG</title>
    <style>
        :root {
            /* Base Theme - Light (Soft Pastels) */
            --bg-color: #fdf6e3;
            --text-color: #586e75;
            --card-bg: #ffffff;
            --accent: #268bd2;
            --success: #859900;
            --danger: #dc322f;
            --column-bg: #eee8d5;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --radius: 12px;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-color: #002b36;
            --text-color: #839496;
            --card-bg: #073642;
            --column-bg: #00212b;
            --shadow: 0 4px 6px rgba(0,0,0,0.4);
        }

        /* Unlocked Themes handled via JS class injection on Body */
        body.theme-wolf { --bg-color: #3e3b36; --column-bg: #5c5549; --text-color: #dcdccc; --accent: #8c7b6c; --card-bg: #4a453d; }
        body.theme-neon { --bg-color: #0a0a0a; --column-bg: #141414; --text-color: #e0e0e0; --accent: #0ff; --card-bg: #1a1a1a; --success: #39ff14; --danger: #ff0055; }
        body.theme-aperture { --bg-color: #ffffff; --column-bg: #f0f0f0; --text-color: #333; --accent: #ff9900; --card-bg: #fff; --radius: 2px; }
        body.theme-eldritch { --bg-color: #1a0f1a; --column-bg: #2d1b2d; --text-color: #a464a4; --accent: #6a006a; --card-bg: #220022; }
        body.theme-vaporwave { --bg-color: #2b0f36; --column-bg: #3f1a52; --text-color: #00d9ff; --accent: #ff00ff; --card-bg: #4c2063; }
        body.theme-blueprint { --bg-color: #0044cc; --column-bg: #003399; --text-color: #ffffff; --accent: #ffffff; --card-bg: #0055ff; border: 1px dashed white; }
        body.theme-terminal { --bg-color: #000; --column-bg: #111; --text-color: #0f0; --accent: #0f0; --card-bg: #000; border: 1px solid #0f0; }
        body.theme-gold { --bg-color: #1a1a1a; --column-bg: #2a2a2a; --text-color: #d4af37; --accent: #ffd700; --card-bg: #000; border: 1px solid #d4af37; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: var(--font); background: var(--bg-color); color: var(--text-color); transition: background 0.3s, color 0.3s; padding-bottom: 80px; }

        /* HUD & Controls */
        #hud { padding: 15px; background: var(--card-bg); position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 10px; }
        .hud-top { display: flex; justify-content: space-between; align-items: center; }
        .level-badge { font-weight: bold; font-size: 1.2rem; color: var(--accent); }
        .progress-container { width: 100%; height: 8px; background: var(--column-bg); border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s ease; }
        
        /* Buttons */
        button { background: var(--accent); color: white; border: none; padding: 8px 16px; border-radius: var(--radius); font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        button.secondary { background: var(--column-bg); color: var(--text-color); }
        button.danger { background: var(--danger); }
        .icon-btn { padding: 8px; font-size: 1.2rem; background: transparent; color: var(--text-color); }

        /* Search */
        #search-bar { width: 100%; padding: 10px; border-radius: var(--radius); border: 1px solid var(--column-bg); background: var(--bg-color); color: var(--text-color); font-size: 1rem; }

        /* Kanban Columns */
        .board { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; height: calc(100vh - 160px); gap: 15px; padding: 15px; }
        .column { min-width: 85vw; background: var(--column-bg); border-radius: var(--radius); padding: 15px; display: flex; flex-direction: column; scroll-snap-align: center; height: 100%; }
        .column-header { font-weight: bold; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; }

        /* Cards */
        .card { background: var(--card-bg); padding: 15px; margin-bottom: 10px; border-radius: var(--radius); box-shadow: var(--shadow); transition: transform 0.2s; position: relative; border-left: 4px solid transparent; }
        .card.priority-High { border-left-color: var(--danger); }
        .card.priority-Med { border-left-color: var(--accent); }
        .card.priority-Low { border-left-color: var(--success); }
        .card h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .card-meta { font-size: 0.8rem; opacity: 0.7; display: flex; justify-content: space-between; margin-bottom: 10px; }
        
        /* Subtasks */
        .subtask-list { list-style: none; padding: 0; margin: 10px 0; }
        .subtask-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 0.9rem; }
        .subtask-check { width: 18px; height: 18px; cursor: pointer; }

        /* Card Actions */
        .card-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .action-btn { font-size: 0.8rem; padding: 5px 10px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--card-bg); width: 90%; max-width: 500px; padding: 20px; border-radius: var(--radius); max-height: 85vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border-radius: var(--radius); border: 1px solid var(--column-bg); background: var(--bg-color); color: var(--text-color); }
        
        /* Zen Mode */
        body.zen-mode #hud, body.zen-mode .board { display: none; }
        body.zen-mode .column { display: none; } /* Hide all columns initially */
        body.zen-mode #zen-active-container { display: flex; flex-direction: column; align-items: center; padding: 20px; height: 100vh; background: var(--bg-color); }
        body.zen-mode .zen-card { width: 100%; max-width: 600px; margin-bottom: 20px; }
        #zen-exit { position: fixed; bottom: 20px; right: 20px; opacity: 0.3; width: 30px; height: 30px; cursor: pointer; border: 1px solid var(--text-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* Canvas for FX */
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 2000; }

        /* Story Text Style */
        .story-text { font-family: "Georgia", serif; line-height: 1.6; font-size: 1.1rem; white-space: pre-wrap; }
        .story-chapter { margin-bottom: 2rem; border-bottom: 1px solid var(--accent); padding-bottom: 1rem; }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div id="hud">
    <div class="hud-top">
        <div id="level-display" class="level-badge">LVL 1</div>
        <div style="display:flex; gap:10px;">
             <button class="icon-btn" onclick="toggleThemeMode()">‚óë</button>
             <button class="icon-btn" onclick="openMenu()">‚ò∞</button>
        </div>
    </div>
    <div class="progress-container">
        <div id="xp-bar" class="progress-bar"></div>
    </div>
    <input type="text" id="search-bar" placeholder="Search tasks or steps..." onkeyup="renderBoard()">
</div>

<div class="board" id="main-board">
    <div class="column" id="col-staging">
        <div class="column-header">
            Staging 
            <button onclick="openAddTask()" style="font-size:1.2rem; padding:0 8px;">+</button>
        </div>
        <div id="list-staging"></div>
    </div>

    <div class="column" id="col-active">
        <div class="column-header">Active Mission</div>
        <div id="list-active"></div>
    </div>

    <div class="column" id="col-victory">
        <div class="column-header">Victory</div>
        <div id="list-victory"></div>
    </div>
</div>

<div id="zen-active-container" style="display:none;">
    <h2 style="opacity:0.5; margin-bottom:30px;">FOCUS</h2>
    <div id="zen-list"></div>
    <div id="zen-exit" onclick="toggleZen(false)">‚úï</div>
</div>

<div class="modal-overlay" id="menu-modal">
    <div class="modal">
        <h2>System Menu</h2>
        <div id="utility-stats" style="display:none; padding:10px; background:var(--column-bg); border-radius:var(--radius); margin-bottom:15px;">
            <h3>üìä Status Report</h3>
            <p>Total XP: <span id="stat-total-xp">0</span></p>
            <p>Tasks Completed: <span id="stat-tasks">0</span></p>
            <p>Prestige Rank: <span id="stat-prestige">0</span></p>
        </div>

        <h3>Settings</h3>
        <button class="secondary" onclick="toggleZen(true)" id="btn-zen" style="display:none; width:100%; margin-bottom:10px;">Enter Zen Mode</button>
        
        <h3>Themes</h3>
        <select id="theme-selector" onchange="changeTheme(this.value)" style="width:100%; padding:10px; border-radius:var(--radius); margin-bottom:10px;">
            <option value="default">Default (Pastel/Dark)</option>
            <option value="wolf" disabled>üîí Lvl 5: The Wolf</option>
            <option value="neon" disabled>üîí Lvl 10: Neon City</option>
            <option value="aperture" disabled>üîí Lvl 12: Aperture</option>
            <option value="eldritch" disabled>üîí Lvl 15: Eldritch</option>
            <option value="vaporwave" disabled>üîí Lvl 18: Vaporwave</option>
            <option value="blueprint" disabled>üîí Lvl 20: Blueprint</option>
            <option value="terminal" disabled>üîí Lvl 25: Terminal</option>
            <option value="gold" disabled>üîí Lvl 30: Gold Standard</option>
        </select>

        <h3>Data Management</h3>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="secondary" onclick="exportData()">Backup</button>
            <button class="secondary" onclick="triggerImport()">Restore</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(this)">
        </div>

        <div id="prestige-section" style="display:none; border-top:1px solid var(--text-color); padding-top:20px;">
            <button class="danger" style="width:100%" onclick="prestigeReset()">üéñÔ∏è PRESTIGE RESET</button>
            <p style="font-size:0.8rem; color:var(--danger)">Resets Level & XP. Grants +10% XP Multiplier & Star Badge.</p>
        </div>

        <div id="story-library-btn" style="display:none; margin-top:15px;">
            <button style="width:100%; background: purple;" onclick="openStoryModal()">üìñ The Archives (Story)</button>
        </div>

        <button onclick="closeModal('menu-modal')" style="width:100%; margin-top:20px;">Close</button>
    </div>
</div>

<div class="modal-overlay" id="task-modal">
    <div class="modal">
        <h2 id="modal-title">New Mission</h2>
        <div class="form-group">
            <label>Mission Title</label>
            <input type="text" id="inp-title">
        </div>
        <div class="form-group">
            <label>Priority</label>
            <select id="inp-priority">
                <option value="Low">Low (100 XP)</option>
                <option value="Med" selected>Med (150 XP)</option>
                <option value="High">High (200 XP)</option>
            </select>
        </div>
        <div class="form-group">
            <label>Deadline</label>
            <input type="datetime-local" id="inp-deadline">
        </div>
        <div class="form-group">
            <label>Subtasks (One per line)</label>
            <textarea id="inp-subtasks" rows="4"></textarea>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="secondary" onclick="closeModal('task-modal')">Cancel</button>
            <button onclick="saveTask()">Save Mission</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="story-modal">
    <div class="modal">
        <h2>The Archives</h2>
        <div id="story-content" class="story-text"></div>
        <button onclick="closeModal('story-modal')" style="width:100%; margin-top:20px;">Close</button>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let player = {
        level: 1,
        xp: 0,
        prestige: 0,
        totalXpEarned: 0,
        completedTasks: 0,
        settings: {
            darkMode: false,
            theme: 'default'
        }
    };

    let tasks = [];
    let editingId = null;

    // --- INITIALIZATION ---
    window.onload = function() {
        if(localStorage.getItem('qb_player')) {
            player = JSON.parse(localStorage.getItem('qb_player'));
            tasks = JSON.parse(localStorage.getItem('qb_tasks'));
        }
        applySettings();
        checkUnlocks();
        renderBoard();
        updateStats();
    };

    function saveData() {
        localStorage.setItem('qb_player', JSON.stringify(player));
        localStorage.setItem('qb_tasks', JSON.stringify(tasks));
        checkUnlocks();
        updateStats();
    }

    // --- GAME LOGIC ---
    function getXpRequired(lvl) {
        return 500 + ((lvl - 1) * 50);
    }

    function addXP(amount, isCheck = false) {
        // Prestige Multiplier
        let mult = 1 + (player.prestige * 0.1);
        let finalAmount = Math.floor(amount * mult);
        
        // Critical Success (5% chance)
        let isCrit = Math.random() < 0.05;
        if(isCrit) {
            finalAmount += 50;
            showToast("CRITICAL SUCCESS! +50 XP");
        }

        player.xp += finalAmount;
        player.totalXpEarned += finalAmount;

        // Check Level Up
        let req = getXpRequired(player.level);
        if (player.xp >= req) {
            player.xp -= req;
            player.level++;
            showToast(`LEVEL UP! WELCOME TO LEVEL ${player.level}`);
            fireConfetti('level');
        }

        saveData();
        return { gained: finalAmount, crit: isCrit };
    }

    function checkUnlocks() {
        const unlocks = [
            { lvl: 2, id: 'utility-stats', type: 'el' },
            { lvl: 5, val: 'wolf', type: 'theme' },
            { lvl: 8, id: 'btn-zen', type: 'el' },
            { lvl: 10, val: 'neon', type: 'theme' },
            { lvl: 12, val: 'aperture', type: 'theme' },
            { lvl: 15, val: 'eldritch', type: 'theme' },
            { lvl: 18, val: 'vaporwave', type: 'theme' },
            { lvl: 20, val: 'blueprint', type: 'theme' },
            { lvl: 25, val: 'terminal', type: 'theme' },
            { lvl: 30, val: 'gold', type: 'theme' },
            { lvl: 50, id: 'prestige-section', type: 'el' }
        ];

        // Prestige Rewards
        if(player.prestige >= 1) document.getElementById('story-library-btn').style.display = 'block';

        unlocks.forEach(u => {
            if (player.level >= u.lvl) {
                if(u.type === 'el') document.getElementById(u.id).style.display = 'block';
                if(u.type === 'theme') {
                    let opt = document.querySelector(`option[value="${u.val}"]`);
                    if(opt) {
                        opt.disabled = false;
                        opt.text = opt.text.replace('üîí ', '');
                    }
                }
            }
        });
    }

    // --- TASK LOGIC ---
    function saveTask() {
        const title = document.getElementById('inp-title').value;
        if(!title) return;

        const subText = document.getElementById('inp-subtasks').value;
        const subtasks = subText.split('\n').filter(t => t.trim() !== '').map(t => ({ text: t, done: false }));

        const newTask = {
            id: editingId || Date.now(),
            title: title,
            priority: document.getElementById('inp-priority').value,
            deadline: document.getElementById('inp-deadline').value,
            subtasks: subtasks,
            status: editingId ? tasks.find(t => t.id === editingId).status : 'staging',
            winXP: 0,
            completedDate: null
        };

        if(editingId) {
            const idx = tasks.findIndex(t => t.id === editingId);
            tasks[idx] = newTask;
            editingId = null;
        } else {
            tasks.push(newTask);
        }

        closeModal('task-modal');
        saveData();
        renderBoard();
    }

    function moveTask(id, dest) {
        const t = tasks.find(x => x.id === id);
        
        // LOGIC: Retreat Penalty
        if (t.status === 'victory' && dest !== 'victory') {
            if(!confirm("RETREAT WARNING: You will lose the XP earned from this task + 50 XP Penalty. Proceed?")) return;
            
            // Deduct XP
            player.xp = Math.max(0, player.xp - t.winXP - 50); // Prevent negative XP for now
            showToast(`RETREAT! Lost ${t.winXP + 50} XP`);
            t.winXP = 0;
            t.completedDate = null;
            player.completedTasks--;
        }

        // LOGIC: Victory Calculation
        if (dest === 'victory' && t.status !== 'victory') {
            let base = t.priority === 'High' ? 200 : t.priority === 'Med' ? 150 : 100;
            let bonusMsg = "";
            
            // Deadline Logic
            if(t.deadline) {
                const now = new Date();
                const due = new Date(t.deadline);
                const diffHours = (due - now) / 36e5;

                if (diffHours > 24) {
                    base = Math.floor(base * 1.2);
                    bonusMsg += " (Early +20%)";
                } else if (now > due) {
                    base = Math.floor(base * 0.8);
                    bonusMsg += " (Late -20%)";
                }
            }

            const result = addXP(base);
            t.winXP = result.gained;
            t.completedDate = new Date().toISOString();
            player.completedTasks++;
            
            let fxType = 'paper';
            if(player.level >= 10) fxType = 'star';
            if(player.level >= 20) fxType = 'coin';
            if(player.level >= 30) fxType = 'gem';
            
            fireConfetti(fxType);
            showToast(`Victory! +${result.gained} XP${bonusMsg}`);
        }

        t.status = dest;
        saveData();
        renderBoard();
    }

    function toggleSubtask(taskId, subIdx) {
        const t = tasks.find(x => x.id === taskId);
        t.subtasks[subIdx].done = !t.subtasks[subIdx].done;
        
        if(t.subtasks[subIdx].done) {
            addXP(10, true); // +10 XP for checkbox
        } else {
             // Deduct if unchecked? User didn't specify, but standard RPG logic usually prevents farming checkboxes.
             // We'll leave it as free dopamine for now as per "Keeps dopamine flowing"
        }
        saveData();
        renderBoard();
    }

    function deleteTask(id) {
        if(confirm("Delete this mission permanently?")) {
            tasks = tasks.filter(t => t.id !== id);
            saveData();
            renderBoard();
        }
    }

    // --- RENDERING ---
    function renderBoard() {
        const filter = document.getElementById('search-bar').value.toLowerCase();
        
        ['staging', 'active', 'victory'].forEach(col => {
            const container = document.getElementById(`list-${col}`);
            const zenContainer = document.getElementById('zen-list');
            if(col === 'active') zenContainer.innerHTML = ''; // Clear Zen

            container.innerHTML = '';
            
            tasks.filter(t => t.status === col).forEach(t => {
                // Search Logic
                let match = t.title.toLowerCase().includes(filter);
                t.subtasks.forEach(s => { if(s.text.toLowerCase().includes(filter)) match = true; });
                
                if(!match) return;

                const card = createCardHTML(t);
                container.appendChild(card);
                
                // Zen Mode Copy
                if(col === 'active') {
                    const zCard = createCardHTML(t, true);
                    zCard.classList.add('zen-card');
                    zenContainer.appendChild(zCard);
                }
            });
        });
    }

    function createCardHTML(t, isZen = false) {
        const div = document.createElement('div');
        div.className = `card priority-${t.priority}`;
        if(player.settings.theme === 'blueprint') div.style.borderStyle = "dashed";

        let dateStr = "";
        if(t.deadline) {
            const d = new Date(t.deadline);
            dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        let subHtml = '<ul class="subtask-list">';
        t.subtasks.forEach((s, i) => {
            subHtml += `<li class="subtask-item">
                <input type="checkbox" class="subtask-check" ${s.done ? 'checked' : ''} onchange="toggleSubtask(${t.id}, ${i})">
                <span style="${s.done ? 'text-decoration:line-through; opacity:0.6' : ''}">${s.text}</span>
            </li>`;
        });
        subHtml += '</ul>';

        // Actions
        let btns = '';
        if(t.status === 'staging') btns = `<button class="action-btn" onclick="moveTask(${t.id}, 'active')">Start Mission</button>`;
        if(t.status === 'active') btns = `
            <button class="action-btn secondary" onclick="moveTask(${t.id}, 'staging')">Hold</button>
            <button class="action-btn" onclick="moveTask(${t.id}, 'victory')">Complete</button>`;
        if(t.status === 'victory') btns = `<button class="action-btn danger" onclick="moveTask(${t.id}, 'active')">Retreat (-XP)</button>`;
        
        // Delete button only in Staging or Victory to prevent accidental active deletion
        let delBtn = `<button class="action-btn secondary" style="margin-right:auto" onclick="deleteTask(${t.id})">üóëÔ∏è</button>`;

        div.innerHTML = `
            <h3>${t.title}</h3>
            <div class="card-meta">
                <span>${t.priority} Priority</span>
                <span>${dateStr ? 'üìÖ ' + dateStr : ''}</span>
            </div>
            ${subHtml}
            <div class="card-actions">
                ${delBtn}
                ${btns}
            </div>
        `;
        return div;
    }

    function updateStats() {
        document.getElementById('level-display').innerText = `LVL ${player.level} ${player.prestige > 0 ? '‚ú™'.repeat(player.prestige) : ''}`;
        const req = getXpRequired(player.level);
        const pct = (player.xp / req) * 100;
        document.getElementById('xp-bar').style.width = `${pct}%`;

        // Stats Panel
        document.getElementById('stat-total-xp').innerText = player.totalXpEarned;
        document.getElementById('stat-tasks').innerText = player.completedTasks;
        document.getElementById('stat-prestige').innerText = player.prestige;
    }

    // --- UI/THEMES ---
    function toggleThemeMode() {
        player.settings.darkMode = !player.settings.darkMode;
        applySettings();
        saveData();
    }

    function changeTheme(val) {
        player.settings.theme = val;
        applySettings();
        saveData();
    }

    function applySettings() {
        const body = document.body;
        // Dark Mode
        if(player.settings.darkMode) body.classList.add('dark-mode');
        else body.classList.remove('dark-mode');

        // Theme Classes
        body.className = body.className.replace(/theme-\w+/g, ''); // clear old
        if(player.settings.theme !== 'default') {
            body.classList.add(`theme-${player.settings.theme}`);
        }
        
        document.getElementById('theme-selector').value = player.settings.theme;
        
        // Add dark-mode back if needed
        if(player.settings.darkMode) body.classList.add('dark-mode');
    }

    function toggleZen(active) {
        if(active) document.body.classList.add('zen-mode');
        else document.body.classList.remove('zen-mode');
        closeModal('menu-modal');
    }

    function openAddTask() {
        document.getElementById('modal-title').innerText = "New Mission";
        document.getElementById('inp-title').value = "";
        document.getElementById('inp-subtasks').value = "";
        editingId = null;
        document.getElementById('task-modal').style.display = 'flex';
    }

    function openMenu() { document.getElementById('menu-modal').style.display = 'flex'; updateStats(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showToast(msg) {
        const t = document.createElement('div');
        t.style.position = 'fixed'; t.style.bottom = '20px'; t.style.left = '50%';
        t.style.transform = 'translateX(-50%)'; t.style.background = 'rgba(0,0,0,0.8)';
        t.style.color = '#fff'; t.style.padding = '10px 20px'; t.style.borderRadius = '20px';
        t.style.zIndex = '3000'; t.innerText = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    // --- BACKUP / RESTORE ---
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({player, tasks}));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "questboard_backup_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function triggerImport() { document.getElementById('import-file').click(); }
    
    function importData(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if(json.player && json.tasks) {
                    player = json.player;
                    tasks = json.tasks;
                    saveData();
                    location.reload();
                }
            } catch(err) { alert("Invalid Backup File"); }
        };
        reader.readAsText(file);
    }

    // --- PRESTIGE ---
    function prestigeReset() {
        if(!confirm("‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è\nThis will reset your Level to 1 and XP to 0.\nYou will gain +10% XP multiplier.\nAre you sure?")) return;
        
        player.level = 1;
        player.xp = 0;
        player.prestige++;
        saveData();
        location.reload();
    }

    // --- STORY SYSTEM ---
    const stories = {
        1: `<h3>Chapter I: The Frost and the Flame</h3>
<p>The wind howled outside the obsidian walls of the Bastion, a sound like a thousand dying wolves. You stood at the parapet, looking out over the endless white. They called it the Long Silence‚Äîthe winter that had lasted a generation. But you were not just a watcher anymore. You had begun the climb.</p>
<p>In the old texts, preserved by the Orders of Ink and Bone, it was written that authority is not given, but forged. Like the Valyrian steel of old, or the Shardplate of the Radiants, your will had to be hammered into shape. Every task you completed was a strike of that hammer.</p>
<p>You remembered the Alchemist's words: "When you want something, all the universe conspires in helping you to achieve it." But the universe was cold here. It did not care. You had to <i>make</i> it care. You had to burn bright enough to melt the snow.</p>
<p>The nebula overhead swirled with colors unseen by common men‚Äîviolets and deep, bruising blues. You felt the surge of something ancient in your blood. The First Oath. Life before death. Strength before weakness. Journey before destination. You had taken the first step out of the staging area of your life. The mission was active.</p>`,
        
        2: `<h3>Chapter II: The Golden Cage</h3>
<p>You had ascended. The world below looked like a map drawn by a child, small and insignificant. With the Midas touch, everything you handled turned to success, but gold is a heavy metal. It weighs down the soul.</p>
<p>The court of the High Lords was a viper's nest. They smiled with teeth of pearl and eyes of flint. You navigated their treachery not with swords, but with completed objectives. High Priority tasks were your shield; Critical Successes your dagger.</p>
<p>"Power resides where men believe it resides," the eunuch had once whispered. You built your power brick by brick, checkmark by checkmark. But the cold was still there. The impact winter had not ended; it had merely moved inside your heart.</p>
<p>You looked at your hands. They were glowing, not with warmth, but with the cold light of efficiency. You were becoming something more than human. Something inevitable.</p>`,
        
        3: `<h3>Chapter III: The Glitch in the Weave</h3>
<p>The sky flickered. For a moment, the sun was a square of dead pixels, black against the azure. You blinked, and it was gone, but you knew what you saw. The simulation was straining under the weight of your progress.</p>
<p>You had pushed too far. Like an Edgedancer sliding on friction-less light, you were moving faster than the world could render. The logic of the universe‚Äîthe +10 XPs, the Penalties, the Levels‚Äîwas laying bare before you. You saw the strings.</p>
<p>It was terrifying. It was exhilarating. You were the storm now. You were the one who knocks. The reality of the board was bending to your will. Tasks completed themselves before you even touched them. But the void was watching. And the void was hungry.</p>`,
        
        4: `<h3>Finale: The Architect</h3>
<p>There is no snow anymore. There is no gold. There is no glitch. There is only the Board. You stand in the center of infinity, the white space of the Staging Area stretching out forever.</p>
<p>You realize now that the Victory column was never a destination. It was a graveyard of ambition. The joy was never in the having, but in the doing. The Alchemist found his treasure under the tree where he started. You found yours in the daily grind.</p>
<p>You are the Herald of your own destiny. You have spoken the final oaths. You have survived the winter. You are the master of the two worlds.</p>
<p>Now... what is your next task?</p>`
    };

    function openStoryModal() {
        let content = "";
        if(player.prestige >= 1) content += stories[1];
        if(player.prestige >= 2) content += stories[2];
        if(player.prestige >= 3) content += stories[3];
        if(player.prestige >= 4) content += stories[4];
        
        document.getElementById('story-content').innerHTML = content || "<p>You must Prestige to unlock the Archives.</p>";
        document.getElementById('story-modal').style.display = 'flex';
    }

    // --- FX SYSTEM (CONFETTI) ---
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function fireConfetti(type) {
        // Type: 'paper', 'star', 'coin', 'gem', 'level'
        const count = type === 'level' ? 200 : 50;
        for(let i=0; i<count; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: type === 'level' ? canvas.height + 10 : -10,
                vx: (Math.random() - 0.5) * 10,
                vy: type === 'level' ? (Math.random() * -15) - 5 : (Math.random() * 5) + 2,
                size: Math.random() * 8 + 4,
                color: `hsl(${Math.random()*360}, 100%, 50%)`,
                type: type,
                life: 100
            });
        }
        animateConfetti();
    }

    function animateConfetti() {
        if(particles.length === 0) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach((p, i) => {
            p.x += p.vx;
            p.y += p.vy;
            p.life--;
            
            ctx.fillStyle = p.color;
            ctx.beginPath();
            
            if(p.type === 'star' || (p.type === 'level' && Math.random()>0.5)) {
                drawStar(ctx, p.x, p.y, 5, p.size, p.size/2);
            } else if (p.type === 'coin') {
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            } else if (p.type === 'gem') {
                ctx.rect(p.x, p.y, p.size, p.size); // Diamond simplified
            } else {
                ctx.fillRect(p.x, p.y, p.size, p.size); // Paper square
            }
            
            ctx.fill();
        });

        particles = particles.filter(p => p.life > 0 && p.y < canvas.height + 20);
        if(particles.length > 0) requestAnimationFrame(animateConfetti);
        else ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawStar(cx, cy, cx_x, cy_y, spikes, outerRadius, innerRadius) {
        let rot = Math.PI / 2 * 3;
        let x = cx;
        let y = cy;
        let step = Math.PI / spikes;

        ctx.beginPath();
        ctx.moveTo(cx, cy - outerRadius);
        for (let i = 0; i < spikes; i++) {
            x = cx + Math.cos(rot) * outerRadius;
            y = cy + Math.sin(rot) * outerRadius;
            ctx.lineTo(x, y);
            rot += step;

            x = cx + Math.cos(rot) * innerRadius;
            y = cy + Math.sin(rot) * innerRadius;
            ctx.lineTo(x, y);
            rot += step;
        }
        ctx.lineTo(cx, cy - outerRadius);
        ctx.closePath();
    }

</script>
</body>
</html>
