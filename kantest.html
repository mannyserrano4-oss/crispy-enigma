<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mission Control</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <script>window.onerror = function(msg, url, line) { alert("System Error:\n" + msg + "\nLine: " + line); return true; };</script>

    <style>
        :root {
            /* DEFAULT (Tactical Dark) */
            --bg: #181825; --card-bg: #262636; --col-bg: #1e1e2e;
            --text: #cdd6f4; --subtext: #9399b2; --border: #313244;
            --p-red: #f38ba8; --p-orange: #fab387; --p-blue: #89b4fa;   
            --p-green: #a6e3a1; --p-purple: #cba6f7;
            
            --in-title: #313244; --in-date: #232336; --in-prio: #2a2a3c;
            --radius: 16px; 
            --shadow: 0 6px 15px rgba(0,0,0,0.25);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-head: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* --- THEME PACKS --- */
        body.theme-light { 
            --bg: #eff1f5; --card-bg: #ffffff; --col-bg: #e6e9ef; 
            --text: #4c4f69; --subtext: #9ca0b0; --border: #bcc0cc; 
            --in-title:#e6e9ef; --in-date:#dce0e8; --in-prio:#e6e9ef;
            --p-red: #d20f39; --p-orange: #fe640b; --p-blue: #1e66f5; 
        }
        
        body.theme-wolf { 
            --bg: #1c1917; --card-bg: #292524; --col-bg: #0c0a09; 
            --text: #e7e5e4; --subtext: #a8a29e; --border: #44403c; 
            --p-red: #9f1239; --p-orange: #b45309; --p-blue: #1e40af; --p-green: #15803d; --p-purple: #a21caf; 
            --in-title: #44403c; --in-date: #292524; --in-prio: #57534e;
            --font-main: Georgia, serif; --radius: 4px; 
        }
        
        body.theme-neon { 
            --bg: #000000; --card-bg: #0a0a0a; --col-bg: #111; 
            --text: #ffffff; --subtext: #888; --border: #333; 
            --p-red: #ff0055; --p-orange: #ff9900; --p-blue: #00f3ff; --p-green: #00ff66; --p-purple: #bc13fe; 
            --in-title: #222; --in-date: #000; --in-prio: #222;
            --font-main: 'Courier New', monospace; --radius: 0px; 
        }
        body.theme-neon .card { border: 1px solid var(--p-blue); box-shadow: 0 0 10px var(--p-blue); }
        
        body.theme-aperture { 
            --bg: #d1d1d1; --card-bg: #ffffff; --col-bg: #e0e0e0; 
            --text: #333; --subtext: #666; --border: #999; 
            --p-red: #e74c3c; --p-orange: #ffa500; --p-blue: #00a5ff; --p-green: #00a5ff; --p-purple: #333; 
            --in-title: #f2f2f2; --in-date: #e6e6e6; --in-prio: #f2f2f2;
            --font-main: Helvetica, Arial, sans-serif; --radius: 20px; 
        }

        body.theme-horror { 
            --bg: #0f0000; --card-bg: #1a0505; --col-bg: #2b0a0a; 
            --text: #ffcccc; --subtext: #804040; --border: #4d0000; 
            --p-red: #ff0000; --p-orange: #cc6600; --p-blue: #660000; --p-green: #336633;
            --in-title: #330000; --in-date: #220000; --in-prio: #330000;
            --font-main: 'Verdana', sans-serif; --radius: 2px;
        }

        body.theme-vapor { 
            --bg: #2d1b4e; --card-bg: #1b1030; --col-bg: #432c7a; 
            --text: #ffd166; --subtext: #ef476f; --border: #118ab2; 
            --p-red: #ef476f; --p-orange: #ffd166; --p-blue: #118ab2; --p-green: #06d6a0; --p-purple: #d783ff; 
            --in-title: #240046; --in-date: #10002b; --in-prio: #240046;
            background: linear-gradient(180deg, #2d1b4e 0%, #000 100%);
        }

        body.theme-blueprint { 
            --bg: #1e3a8a; --card-bg: #172554; --col-bg: #1e40af; 
            --text: #bfdbfe; --subtext: #60a5fa; --border: #93c5fd; 
            --p-red: #fff; --p-orange: #fff; --p-blue: #fff; --p-green: #fff; --p-purple: #fff; 
            --in-title: #172554; --in-date: #1e3a8a; --in-prio: #172554;
            --font-main: 'Courier New', monospace; --radius: 0px; 
            background-image: linear-gradient(#3b82f6 1px, transparent 1px), linear-gradient(90deg, #3b82f6 1px, transparent 1px); background-size: 20px 20px;
        }
        body.theme-blueprint .card { border: 2px solid #fff; box-shadow: none; }

        body.theme-terminal { 
            --bg: #000; --card-bg: #000; --col-bg: #000; 
            --text: #22c55e; --subtext: #15803d; --border: #22c55e; 
            --p-red: #22c55e; --p-orange: #22c55e; --p-blue: #22c55e; --p-green: #22c55e; --p-purple: #22c55e; 
            --in-title: #000; --in-date: #000; --in-prio: #000;
            --font-main: 'Courier New', monospace; --radius: 0px; 
        }
        body.theme-terminal .card, body.theme-terminal .column, body.theme-terminal .uniform-input { border: 1px dashed var(--text); }
        
        body.theme-gold { 
            --bg: #0f0f0f; --card-bg: #1c1c1c; --col-bg: #141414; 
            --text: #fcd34d; --subtext: #b45309; --border: #78350f; 
            --p-red: #991b1b; --p-green: #f59e0b; --p-purple: #d97706; --p-blue: #fcd34d; 
            --in-title: #2d2d2d; --in-date: #000; --in-prio: #2d2d2d;
            --font-main: Georgia, serif; --radius: 8px; 
        }
        body.theme-gold .level-badge { background: linear-gradient(to right, #fcd34d, #b45309); color: black; }
        
        /* PRESTIGE THEMES */
        body.theme-nebula { 
            --bg: #0b0014; --card-bg: #1a0b2e; --col-bg: #11051f; 
            --text: #e0ccff; --subtext: #8a64b5; --border: #4a2b6b; 
            --p-red: #ff3366; --p-green: #00ffcc; --p-purple: #bb00ff; --p-blue: #00ccff; 
            --in-title: #240046; --in-date: #10002b; --in-prio: #240046;
            background: radial-gradient(circle at 50% 50%, #1a0b2e 0%, #000000 100%); --font-head: 'Verdana', sans-serif; 
        }
        body.theme-nebula .level-badge { background: linear-gradient(90deg, #ff00cc, #3333ff); box-shadow: 0 0 15px #bb00ff; }
        
        body.theme-midas { 
            --bg: #080808; --card-bg: #141414; --col-bg: #0d0d0d; 
            --text: #d4af37; --subtext: #8a7324; --border: #d4af37; 
            --p-red: #ff4444; --p-green: #d4af37; --p-purple: #ffd700; --p-blue: #c5a028; 
            --in-title: #1a1a1a; --in-date: #000; --in-prio: #1a1a1a;
            --radius: 2px; --font-main: 'Times New Roman', serif; 
        }
        body.theme-midas .card { border: 1px solid #d4af37; box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        
        body.theme-glitch { 
            --bg: #121212; --card-bg: #000000; --col-bg: #1a1a1a; 
            --text: #ffffff; --subtext: #555555; --border: #333333; 
            --p-red: #ff003c; --p-green: #05ffa1; --p-blue: #00f0ff; --p-purple: #ff003c; 
            --in-title: #111; --in-date: #050505; --in-prio: #111;
            --font-main: 'Courier New', monospace; 
        }
        body.theme-glitch .card-title { text-shadow: 2px 0 var(--p-red), -2px 0 var(--p-blue); }

        /* --- CORE STYLES --- */
        body { background-color: var(--bg); color: var(--text); font-family: var(--font-main); margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.5s, color 0.5s; }
        body.zen-mode .header, body.zen-mode .xp-bar-container, body.zen-mode .fab, body.zen-mode .control-deck { display: none !important; }
        body.zen-mode .board { height: 100vh; padding-top: max(20px, env(safe-area-inset-top)); }
        #exit-zen { position: fixed; top: 10px; right: 10px; z-index: 1000; opacity: 0.3; display: none; }
        body.zen-mode #exit-zen { display: block; }

        .xp-bar-container { background: var(--col-bg); padding: 15px 20px; padding-top: max(15px, env(safe-area-inset-top)); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        .level-badge { background: linear-gradient(135deg, var(--p-purple), var(--p-blue)); color: #000; font-weight: 900; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; box-shadow: 0 2px 10px rgba(0,0,0,0.2); white-space: nowrap; font-family: var(--font-head); }
        .xp-track { flex: 1; height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; position: relative; }
        .xp-fill { height: 100%; background: var(--p-green); width: 0%; transition: width 0.5s ease-out, background 0.2s; }
        .xp-fill.damage { background: var(--p-red); } 
        .xp-text { font-size: 0.7rem; color: var(--subtext); font-weight: bold; width: 80px; text-align: right; }

        .header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 2px; color: var(--p-blue); font-weight: 900; font-family: var(--font-head); }
        .icon-btn { font-size: 1.4rem; background: none; border: none; cursor: pointer; padding: 8px; opacity: 0.8; color: var(--text); }

        /* CONTROL DECK (Search + Briefing) */
        .control-deck { padding: 0 20px 10px 20px; display: flex; gap: 15px; align-items: center; margin-top: 15px; }
        .radar-box { flex: 1; position: relative; }
        .radar-input { width: 100%; background: var(--col-bg); border: 1px solid var(--border); border-radius: 20px; padding: 8px 15px 8px 35px; color: var(--text); font-family: inherit; font-size: 0.9rem; box-sizing: border-box; }
        .radar-input:focus { outline: none; border-color: var(--p-blue); }
        .radar-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 0.8rem; }
        .briefing { font-size: 0.7rem; color: var(--subtext); font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 40%; text-align: right; }

        .board { flex: 1; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; padding: 10px; gap: 15px; scroll-behavior: smooth; }
        .column { min-width: 88vw; background: var(--col-bg); border-radius: var(--radius); display: flex; flex-direction: column; scroll-snap-align: center; border: 1px solid var(--border); }
        @media (min-width: 600px) { .column { min-width: 340px; } }
        .col-header { padding: 15px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; font-family: var(--font-head); color: var(--subtext); }
        .task-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }
        .empty-msg { text-align: center; color: var(--subtext); font-style: italic; font-size: 0.8rem; margin-top: 50px; opacity: 0.5; }

        .card { background: var(--card-bg); padding: 16px; border-radius: var(--radius); box-shadow: var(--shadow); transition: transform 0.2s, opacity 0.2s; border-left: 0; position: relative; overflow: hidden; }
        .card:active { transform: scale(0.98); }
        .card-actions { display:flex; gap:10px; margin-top:10px; justify-content:space-between; align-items:center; border-top:1px solid var(--border); padding-top:10px; }
        .btn-quick { background: var(--col-bg); border:1px solid var(--border); color:var(--text); width:30px; height:35px; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; font-size:1.1rem; }
        .edit-btn { color: var(--p-purple); border-color: var(--p-purple); font-size:1rem; width: auto; padding: 0 15px;}

        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .slide-enter { animation: slideIn 0.3s forwards; }
        .slide-right { animation: slideOutRight 0.3s forwards; }
        .slide-left { animation: slideOutLeft 0.3s forwards; }
        @keyframes slideOutRight { to { transform: translateX(100%); opacity: 0; } }
        @keyframes slideOutLeft { to { transform: translateX(-100%); opacity: 0; } }

        .card-top { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: center; }
        .card-title { font-weight: bold; font-size: 1.1rem; color: var(--text); }
        .card-date { font-size: 0.7rem; background: var(--border); padding: 4px 8px; border-radius: 6px; color: var(--subtext); height: fit-content; font-weight: 600; }
        .card-date.overdue { background: var(--p-red); color: #000; }
        .prio-pill { font-size: 0.65rem; padding: 3px 8px; border-radius: 10px; font-weight: 800; text-transform: uppercase; margin-right: 5px; color:#000; }
        .pill-High { background: var(--p-red); } .pill-Med { background: var(--p-orange); } .pill-Low { background: var(--p-blue); }
        .tag-pill { font-size: 0.65rem; padding: 3px 8px; border-radius: 10px; font-weight: 800; text-transform: uppercase; background: var(--border); color: var(--text); margin-right: 5px; }
        
        .progress-track { background: var(--border); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 12px; }
        .progress-fill { height: 100%; background: var(--p-green); width: 0%; transition: width 0.3s; }
        .card-meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--subtext); margin-top: 8px; font-weight: 600; }

        .fab { position: fixed; bottom: 30px; right: 20px; background: var(--p-purple); color: #000; width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; box-shadow: 0 8px 30px rgba(0,0,0,0.4); cursor: pointer; border: none; z-index: 999999; transition: transform 0.2s; }
        .fab:active { transform: rotate(90deg); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 20px 0; }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 450px; padding: 25px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.6); margin-bottom: 80px; }
        
        .form-label { display: block; font-size: 0.75rem; color: var(--subtext); font-weight: 800; margin-bottom: 8px; letter-spacing: 1px; text-transform: uppercase; }
        .uniform-input { width: 100%; height: 54px; padding: 0 14px; background: var(--col-bg); border: 1px solid var(--border); color: var(--text); border-radius: 12px; font-size: 1.1rem; box-sizing: border-box; margin-bottom: 18px; font-family: inherit; -webkit-appearance: none; appearance: none; }
        .input-base:focus { outline: none; border-color: var(--p-purple); }
        .input-title { background: var(--in-title); font-weight: bold; }
        .input-date { background: var(--in-date); color: var(--p-blue); }
        .input-select { background: var(--in-prio); color: var(--p-orange); }
        .input-step { background: transparent; border: 1px dashed var(--subtext); color: var(--subtext); }

        .form-row { display: flex; gap: 12px; margin-bottom: 18px; align-items: stretch; }
        .fixed-height { height: 50px; box-sizing: border-box; }
        
        .check-item { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; padding: 8px; background: var(--col-bg); border-radius: 10px; }
        .check-box { width: 28px; height: 28px; border-radius: 8px; border: 2px solid var(--subtext); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .check-box.checked { background: var(--p-green); border-color: var(--p-green); }
        .check-box.checked::after { content:'‚úì'; color:black; font-weight:900; font-size:1rem; }
        .check-text { flex: 1; background: transparent; border: none; color: var(--text); font-size: 1.1rem; }
        .check-del { color: var(--p-red); cursor: pointer; padding: 8px; font-weight: bold; font-size: 1.2rem; opacity: 0.5; }

        .btn-main { width: 100%; padding: 18px; background: var(--p-purple); color: #000; border: none; border-radius: 16px; font-weight: 800; font-size: 1.1rem; cursor: pointer; margin-top: 10px; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(196, 181, 253, 0.3); }
        .btn-sec { width: 100%; padding: 14px; background: transparent; border: 1px solid var(--border); color: var(--subtext); border-radius: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 0.95rem; }
        
        #xp-toast { position: fixed; top: 90px; left: 50%; transform: translateX(-50%); background: var(--p-green); color: black; font-weight: 900; padding: 10px 20px; border-radius: 20px; opacity: 0; pointer-events: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: opacity 0.3s, transform 0.3s; z-index: 2000; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        #xp-toast.loss { background: var(--p-red); }
        #xp-toast.crit { background: var(--gold); border: 2px solid white; transform: translateX(-50%) scale(1.2); }
        .confetti { position: fixed; width: 20px; height: 20px; top: -20px; z-index: 3000; font-size:20px; text-align:center; }
        
        .dropdown { position: absolute; top: 60px; right: 15px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; display: none; flex-direction: column; width: 240px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 200; overflow: hidden; max-height: 80vh; overflow-y: auto;}
        .dropdown.show { display: flex; }
        .dd-item { padding: 15px; text-align: left; background: none; border: none; border-bottom: 1px solid var(--border); color: var(--text); font-size: 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .dd-locked { opacity: 0.5; pointer-events: none; }
        .dd-badge { font-size: 0.65rem; background: var(--border); padding: 2px 6px; border-radius: 4px; color: var(--subtext); font-weight: bold; }
        .dd-sect { padding:10px; font-size:0.7rem; color:var(--subtext); font-weight:bold; background:var(--col-bg); letter-spacing:1px; }
        
        #codex-popup { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--card-bg); border: 1px solid var(--p-purple); padding: 15px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); max-width: 90%; width: 300px; z-index: 2000; opacity: 0; pointer-events: none; transition: 0.5s; text-align: center; }
        #codex-popup.active { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
        .codex-text { font-style: italic; font-size: 0.9rem; color: var(--text); margin-bottom: 5px; }
        .codex-src { font-size: 0.7rem; color: var(--p-purple); font-weight: bold; text-transform: uppercase; }
        
        #story-modal .modal-content { background: #1a1a1a; border: 2px solid #b45309; }
        .story-header { font-family: Georgia, serif; text-align: center; color: #fcd34d; font-size: 1.5rem; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .story-body { font-family: Georgia, serif; color: #e7e5e4; line-height: 1.6; font-size: 1.1rem; white-space: pre-wrap; height: 60vh; overflow-y: auto; padding-right: 10px; }
        .story-lock { text-align: center; color: #666; padding: 50px 0; font-style: italic; }

        /* CONFIRM MODAL */
        #confirm-modal { z-index: 200000; }
        #confirm-modal .modal-content { border: 2px solid var(--p-red); text-align: center; }
    </style>
</head>
<body>

    <button class="btn-sec" id="exit-zen" onclick="toggleZen()">Exit Zen</button>

    <div class="xp-bar-container">
        <div class="level-badge" id="lvl-badge">LVL 1</div>
        <div class="xp-track"><div class="xp-fill" id="xp-fill"></div></div>
        <div class="xp-text" id="xp-text">0 XP</div>
    </div>

    <div class="control-deck">
        <div class="radar-box">
            <span class="radar-icon">üîç</span>
            <input type="text" id="radar-search" class="radar-input" placeholder="Radar Search..." onkeyup="filterTasks()">
        </div>
        <div class="briefing" id="briefing-text">Loading...</div>
    </div>

    <div id="xp-toast"><span>+10 XP</span></div>
    
    <div id="codex-popup">
        <div class="codex-text" id="codex-text">"Quote"</div>
        <div class="codex-src" id="codex-src">- Source</div>
    </div>

    <div class="header">
        <h1>Mission Control</h1>
        <div style="display:flex; gap:10px;">
            <button class="icon-btn" onclick="openStory()" id="btn-story">üìñ</button>
            <button class="icon-btn" onclick="toggleArchiveView()" id="btn-archive">üì¶</button>
            <button class="icon-btn" onclick="toggleMenu()">üé®</button>
        </div>
    </div>

    <div id="save-menu" class="dropdown">
        <div class="dd-sect">VISUALS</div>
        <button class="dd-item" onclick="setConfetti('square'); closeMenu()">üéâ Default Confetti</button>
        <button class="dd-item" id="fx-star" onclick="setConfetti('star'); closeMenu()">‚≠ê Stars <span class="dd-badge">LVL 10</span></button>
        <button class="dd-item" id="fx-coin" onclick="setConfetti('coin'); closeMenu()">ü™ô Coins <span class="dd-badge">LVL 20</span></button>
        <button class="dd-item" id="fx-gem" onclick="setConfetti('gem'); closeMenu()">üíé Gems <span class="dd-badge">LVL 30</span></button>

        <div class="dd-sect">THEME LOCKER</div>
        <button class="dd-item" onclick="setTheme('default'); closeMenu()">Tactical Dark</button>
        <button class="dd-item" onclick="setTheme('light'); closeMenu()">Clean Light</button>
        <button class="dd-item" id="theme-wolf" onclick="setTheme('wolf'); closeMenu()">The Wolf <span class="dd-badge">LVL 5</span></button>
        <button class="dd-item" id="theme-neon" onclick="setTheme('neon'); closeMenu()">Neon City <span class="dd-badge">LVL 10</span></button>
        <button class="dd-item" id="theme-aperture" onclick="setTheme('aperture'); closeMenu()">Aperture <span class="dd-badge">LVL 12</span></button>
        <button class="dd-item" id="theme-horror" onclick="setTheme('horror'); closeMenu()">Eldritch <span class="dd-badge">LVL 15</span></button>
        <button class="dd-item" id="theme-vapor" onclick="setTheme('vapor'); closeMenu()">Vaporwave <span class="dd-badge">LVL 18</span></button>
        <button class="dd-item" id="theme-blueprint" onclick="setTheme('blueprint'); closeMenu()">Blueprint <span class="dd-badge">LVL 20</span></button>
        <button class="dd-item" id="theme-terminal" onclick="setTheme('terminal'); closeMenu()">Terminal <span class="dd-badge">LVL 25</span></button>
        <button class="dd-item" id="theme-gold" onclick="setTheme('gold'); closeMenu()">Gold Standard <span class="dd-badge">LVL 30</span></button>
        
        <div class="dd-sect" style="color:var(--p-orange)">PRESTIGE TIERS</div>
        <button class="dd-item" id="theme-nebula" onclick="setTheme('nebula'); closeMenu()">Nebula <span class="dd-badge" style="background:var(--p-purple);color:#000">P 1</span></button>
        <button class="dd-item" id="theme-midas" onclick="setTheme('midas'); closeMenu()">Midas <span class="dd-badge" style="background:var(--p-orange);color:#000">P 2</span></button>
        <button class="dd-item" id="theme-glitch" onclick="setTheme('glitch'); closeMenu()">The Glitch <span class="dd-badge" style="background:var(--p-red);color:#000">P 3</span></button>

        <div class="dd-sect">UPGRADES</div>
        <button class="dd-item" id="feat-status" onclick="showStatusReport(); closeMenu()">üìä Status Report <span class="dd-badge">LVL 2</span></button>
        <button class="dd-item" id="feat-zen" onclick="toggleZen(); closeMenu()">üßò Zen Mode <span class="dd-badge">LVL 8</span></button>
        <button class="dd-item" id="feat-prestige" onclick="doPrestige(); closeMenu()" style="color:var(--p-orange)">üéñÔ∏è PRESTIGE <span class="dd-badge">LVL 50</span></button>

        <div class="dd-sect">DATA</div>
        <button class="dd-item" onclick="exportData(); closeMenu()">Backup</button>
        <button class="dd-item" onclick="document.getElementById('file-input').click(); closeMenu()">Restore</button>
    </div>
    <input type="file" id="file-input" hidden onchange="importData(this)">

    <div class="board" id="main-board">
        <div class="column"><div class="col-header h-0">Staging <span id="count-0">0</span></div><div class="task-list" id="col-0"></div></div>
        <div class="column"><div class="col-header h-1">Active <span id="count-1">0</span></div><div class="task-list" id="col-1"></div></div>
        <div class="column"><div class="col-header h-2">Victory <span id="count-2">0</span></div><div class="task-list" id="col-2"></div></div>
    </div>

    <button class="fab" onclick="openEditor()">+</button>

    <div id="viewer" class="modal">
        <div class="modal-content">
            <h2 id="v-title" style="margin-top:0; text-align:center;"></h2>
            <div class="card-meta" style="margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                <span id="v-prio" class="prio-pill"></span>
                <span id="v-tag" class="tag-pill" style="display:none;"></span>
                <span id="v-date" class="card-date"></span>
            </div>
            <span class="form-label">TACTICAL STATUS</span>
            <div id="v-checks" style="margin-bottom:20px;"></div>
            <button class="btn-main" onclick="switchToEdit()">‚úèÔ∏è EDIT MISSION</button>
            <button class="btn-sec" onclick="closeViewer()" style="border:none;">Close</button>
        </div>
    </div>

    <div id="editor" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0; text-align:center;">Edit Mission</h2>
            <input type="hidden" id="e-id">
            <span class="form-label">MISSION OBJECTIVE</span>
            <input id="e-title" class="uniform-input input-title" placeholder="e.g. Campaign Launch">
            
            <span class="form-label">CATEGORY TAG</span>
            <input id="e-tag" class="uniform-input input-base" placeholder="e.g. Work, Gym, Life">

            <div class="form-row">
                <div style="flex:1">
                    <span class="form-label">DEADLINE</span>
                    <input type="date" id="e-date" class="uniform-input input-date" style="margin-bottom:0;">
                </div>
                <div style="flex:1">
                    <span class="form-label">PRIORITY</span>
                    <select id="e-prio" class="uniform-input input-select" style="margin-bottom:0;">
                        <option value="Low">Low</option>
                        <option value="Med">Med</option>
                        <option value="High">High</option>
                    </select>
                </div>
            </div>
            <span class="form-label">TACTICAL CHECKLIST</span>
            <div id="e-checks"></div>
            <div class="form-row" style="margin-top:10px;">
                <input id="new-step-input" class="uniform-input input-step" placeholder="+ Add Step (Press Enter)" style="margin-bottom:0;" onkeypress="handleStepEnter(event)">
            </div>
            
            <button class="btn-main" onclick="saveCard()">SAVE CHANGES</button>
            <div class="form-row" style="margin-top:10px;">
                <button class="btn-sec" id="btn-archive-toggle" onclick="toggleArchiveTask()">üßä Archive</button>
                <button class="btn-sec" onclick="confirmDelete()" style="color:var(--p-red); border-color:var(--p-red);">üíÄ ABORT</button>
            </div>
            <button class="btn-sec" onclick="closeEditor()" style="border:none;">Cancel</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h2 style="color:var(--p-red); margin-top:0;">‚ö†Ô∏è WARNING</h2>
            <p id="confirm-msg" style="margin-bottom:20px; font-size:1.1rem; color:var(--text);">ABORT MISSION?<br><span style="font-size:0.9rem; opacity:0.8;">Penalty: -50 XP (Plus lost step XP)</span></p>
            <div class="form-row">
                <button class="btn-sec" onclick="closeConfirm()">NO</button>
                <button class="btn-main" style="background:var(--p-red); color:black;" id="confirm-yes-btn">YES, ABORT</button>
            </div>
        </div>
    </div>

    <div id="story-modal" class="modal">
        <div class="modal-content">
            <div class="story-header">THE SUNLESS AGE</div>
            <div class="story-body" id="story-content"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-sec" onclick="changeChapter(-1)">Prev</button>
                <button class="btn-sec" onclick="changeChapter(1)">Next</button>
            </div>
            <button class="btn-sec" onclick="document.getElementById('story-modal').style.display='none'" style="width:100%; border:none; margin-top:10px;">Close Book</button>
        </div>
    </div>

    <script>
        let tasks = JSON.parse(localStorage.getItem('mc_tasks') || '[]');
        let userXP = parseInt(localStorage.getItem('mc_xp') || '0');
        let prestige = parseInt(localStorage.getItem('mc_prestige') || '0');
        let currentTheme = localStorage.getItem('theme') || 'default';
        let confettiStyle = localStorage.getItem('mc_fx') || 'square';
        let showArchive = false;
        let currentChapter = 1;
        let currentViewId = null;
        let taskToDeleteId = null;
        let searchTerm = "";
        
        const RANKS = ["Rookie", "Operative", "Specialist", "Tactician", "Mercenary", "Commander", "Warlord", "Vanguard", "Titan", "Legend"];
        const CODEX = [
            { t: "Life before death. Strength before weakness. Journey before destination.", s: "Stormlight" },
            { t: "The most important step a man can take. It's not the first one, is it? It's the next one.", s: "Stormlight" },
            { t: "It's the possibility of having a dream come true that makes life interesting.", s: "Alchemist" },
            { t: "When you want something, all the universe conspires in helping you to achieve it.", s: "Alchemist" },
            { t: "Chaos isn't a pit. Chaos is a ladder.", s: "GoT" },
            { t: "A lion does not concern himself with the opinion of sheep.", s: "GoT" },
            { t: "Winter is coming.", s: "GoT" },
            { t: "Discipline is freedom.", s: "Codex" }
        ];
        const STORY = {
            1: "CHAPTER I: THE EMBER\n\nThe endless frost began not with a bang, but a whisper. The sun simply... dimmed. Years turned to decades of twilight. Civilization crumbled into the snow.\n\nI am Kael, a scavenger of the Old World. Yesterday, digging through the ruins of a tech-spire, I found it. Not food, not fuel, but a sword. It wasn't cold steel. It hummed. A faint, golden heat radiated from the blade.\n\nThey say the Alchemists of old trapped sunlight in metal. If that's true, I'm holding the only warmth left in the world. And the Shadows are coming for it.",
            2: "CHAPTER II: THE FROZEN COURT\n\nI traveled South, following the faint pull of the blade. The Capital still stands, a fortress of black ice and iron. The Lords play their games of thrones while the poor freeze outside the walls.\n\nI tried to barter entry, but the guards saw the sword. Now I am a prisoner, or a guest? The High Warden wants the weapon. He says it belongs to the 'Vanguard,' a mythical order of knights.\n\nI must choose. Give him the sword and live in luxury while the world dies? Or escape, and find the source of the blade's power? The whispers in my mind are getting louder. 'Protect the Light.'",
            3: "CHAPTER III: THE ALCHEMIST'S MIRROR\n\nI chose the snow. I ran. The blade guided me to a mountain peak above the cloud layer. There was no temple, only a cave, and an old woman reflecting starlight with mirrors.\n\n'You look for a savior,' she laughed. 'But the sword is just a key.'\n\nShe showed me the truth. The sun didn't die. We blocked it. The 'Shield' meant to protect us from solar flares froze in place. The sword unlocks the atmospheric controls. But the climb to the Zenith Spire is a suicide mission. Vampiric creatures nest there. I am afraid. But the sword is burning hot now. It knows.",
            4: "FINALE: THE ZENITH\n\nThe climb took everything. My gear, my strength, my blood. I stand at the Zenith controls. The Shadows surround me, screeching in the thin air.\n\nI plunge the blade into the console. Not a key, but a spark. The machine roars. The sky tears open. For the first time in a century, a beam of pure, unfiltered gold hits the snow.\n\nThe Shadows burn away. The ice weeps. I fall to my knees, blinded, weeping with it. The Sunless Age is over. I am the Vanguard. And I am warm."
        };

        // --- INIT ---
        initApp();

        function initApp() {
            setTheme(currentTheme, true); 
            render();
            updateXP();
        }

        // --- CORE LOGIC ---
        function getLevel(xp) {
            let lvl = 1; let req = 500; let gap = 500;
            while(xp >= req) { lvl++; gap += 50; req += gap; }
            return { level: lvl, nextReq: req, prevReq: req - gap };
        }

        function updateXP() {
            localStorage.setItem('mc_xp', userXP);
            localStorage.setItem('mc_prestige', prestige);
            const stats = getLevel(userXP);
            const pct = Math.max(0, Math.min(100, ((userXP - stats.prevReq) / (stats.nextReq - stats.prevReq)) * 100));
            
            let badgeText = `LVL ${stats.level}: ${RANKS[Math.min(stats.level-1, RANKS.length-1)]}`;
            if(prestige > 0) badgeText += ` ${"‚ú™".repeat(prestige)}`;
            
            document.getElementById('lvl-badge').innerText = badgeText;
            document.getElementById('xp-fill').style.width = `${pct}%`;
            const xpText = document.getElementById('xp-text');
            if(xpText) xpText.innerText = `${userXP} / ${stats.nextReq}`;
            
            checkUnlocks(stats.level);
        }

        function updateLiveXP(amount) {
            const mult = 1 + (prestige * 0.1);
            const finalAmt = Math.floor(amount * mult);
            const oldLvl = getLevel(userXP).level;
            userXP += finalAmt;
            if(userXP < 0) userXP = 0; 
            const newLvl = getLevel(userXP).level;
            
            if(amount > 0 && Math.random() < 0.05) { userXP += 50; showToast("CRITICAL SUCCESS! +50 XP", false); showCodex(); }
            if(newLvl > oldLvl) { showToast("LEVEL UP!", false); showCodex(); }
            if(newLvl < oldLvl) { showToast("LEVEL LOST", true); } 
            
            updateXP();
        }

        function doPrestige() {
            const stats = getLevel(userXP);
            if(stats.level < 50) return alert("MUST REACH LEVEL 50 TO PRESTIGE.");
            if(confirm("WARNING: Resets Level to 1. Keeps Themes & Unlocks Story Chapter. Do it?")) {
                userXP = 0; prestige++; updateXP();
                alert(`PRESTIGE ${prestige} UNLOCKED! Story Chapter ${prestige} Available.`);
                closeMenu();
            }
        }

        function showCodex() {
            const quote = CODEX[Math.floor(Math.random() * CODEX.length)];
            const el = document.getElementById('codex-popup');
            document.getElementById('codex-text').innerText = `"${quote.t}"`;
            document.getElementById('codex-src').innerText = quote.s;
            el.classList.add('active');
            setTimeout(() => el.classList.remove('active'), 5000);
        }

        function openStory() {
            currentChapter = prestige === 0 ? 1 : prestige; 
            renderChapter();
            document.getElementById('story-modal').style.display = 'flex';
        }

        function changeChapter(dir) {
            currentChapter += dir;
            if(currentChapter < 1) currentChapter = 1;
            if(currentChapter > 4) currentChapter = 4;
            renderChapter();
        }

        function renderChapter() {
            const content = document.getElementById('story-content');
            if(prestige >= currentChapter) {
                content.innerText = STORY[currentChapter];
                content.classList.remove('story-lock');
            } else {
                content.innerHTML = `<div class="story-lock">üîí LOCKED<br><br>Reach Prestige ${currentChapter} to decode this chronicle.</div>`;
            }
        }

        function showToast(msg, isLoss) {
            const t = document.getElementById('xp-toast');
            t.querySelector('span').innerText = msg;
            t.className = isLoss ? 'loss' : '';
            
            if(isLoss && lastDeletedTask && prestige >= 1) {
                if(!t.querySelector('.btn-undo')) {
                    const btn = document.createElement('button');
                    btn.className = 'btn-undo';
                    btn.innerText = 'TIME WARP (UNDO)';
                    btn.onclick = undoDelete;
                    t.appendChild(btn);
                }
            } else {
                const existingBtn = t.querySelector('.btn-undo');
                if(existingBtn) existingBtn.remove();
            }

            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0px) scale(1)';
            const bar = document.getElementById('xp-fill');
            if(isLoss) bar.classList.add('damage'); else bar.classList.remove('damage');
            
            if(undoTimeout) clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => { 
                t.style.opacity = '0'; t.style.transform = 'translate(-50%, 10px)'; bar.classList.remove('damage'); 
                lastDeletedTask = null;
            }, 5000);
        }

        function undoDelete() {
            if(lastDeletedTask) {
                tasks.push(lastDeletedTask);
                updateLiveXP(lastDeletedTask.xpLost);
                save(); render();
                showToast("TIMELINE RESTORED", false);
                lastDeletedTask = null;
            }
        }

        function checkUnlocks(level) {
            const unlockAll = prestige > 0;
            const locks = {
                'theme-wolf': 5, 'theme-neon': 10, 'theme-aperture': 12, 'theme-horror': 15,
                'theme-vapor': 18, 'theme-blueprint': 20, 'theme-terminal': 25, 'theme-gold': 30,
                'theme-nebula': 999, 'theme-midas': 999, 'theme-glitch': 999, 
                'feat-status': 2, 'feat-zen': 8, 'feat-prestige': 50,
                'fx-star': 10, 'fx-coin': 20, 'fx-gem': 30
            };
            for(let id in locks) {
                const btn = document.getElementById(id);
                if(!btn) continue;
                let isUnlocked = false;
                if(id === 'theme-nebula') isUnlocked = prestige >= 1;
                else if(id === 'theme-midas') isUnlocked = prestige >= 2;
                else if(id === 'theme-glitch') isUnlocked = prestige >= 3;
                else isUnlocked = unlockAll || level >= locks[id];
                
                if(isUnlocked) { btn.classList.remove('dd-locked'); if(btn.innerText.includes('üîí')) btn.innerText = btn.innerText.replace(' üîí', ''); } 
                else { btn.classList.add('dd-locked'); if(!btn.innerText.includes('üîí')) btn.innerText += ' üîí'; }
            }
        }

        function setTheme(name, force) {
            const stats = getLevel(userXP);
            const reqs = { 'wolf': 5, 'neon': 10, 'aperture': 12, 'horror': 15, 'vapor': 18, 'blueprint': 20, 'terminal': 25, 'gold': 30 };
            const pReqs = { 'nebula': 1, 'midas': 2, 'glitch': 3 };
            if(!force) {
                if(pReqs[name] && prestige < pReqs[name]) return alert(`LOCKED! Reach Prestige ${pReqs[name]} to unlock.`);
                if(reqs[name] && prestige === 0 && stats.level < reqs[name]) return alert(`LOCKED! Reach Level ${reqs[name]} to unlock.`);
            }
            document.body.className = ''; 
            if(name !== 'default') document.body.classList.add(`theme-${name}`);
            currentTheme = name;
            localStorage.setItem('theme', name);
        }

        function setConfetti(type) {
            const stats = getLevel(userXP);
            const reqs = { 'star': 10, 'coin': 20, 'gem': 30 };
            if(prestige === 0 && reqs[type] && stats.level < reqs[type]) return alert(`Locked until Level ${reqs[type]}`);
            confettiStyle = type;
            localStorage.setItem('mc_fx', type);
        }

        function launchConfetti() {
            const emojis = { 'square': '', 'star': '‚≠ê', 'coin': 'ü™ô', 'gem': 'üíé' };
            const icon = emojis[confettiStyle];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.innerText = icon;
                c.style.left = Math.random()*100 + 'vw';
                if(confettiStyle === 'square') {
                    c.style.width = '10px'; c.style.height = '10px';
                    c.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                }
                c.style.animation = `fall ${Math.random()*1+1}s linear forwards`;
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 2000);
            }
        }
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
        document.head.appendChild(styleSheet);

        // --- FILTERING ---
        function filterTasks() {
            searchTerm = document.getElementById('radar-search').value.toLowerCase();
            render();
        }

        // --- RENDER ENGINE ---
        function render() {
            [0, 1, 2].forEach(i => { document.getElementById(`col-${i}`).innerHTML = ''; document.getElementById(`count-${i}`).innerText = '0'; });
            const today = new Date().toISOString().split('T')[0];
            
            let activeCount = 0;
            let highPrioCount = 0;

            tasks.forEach(t => {
                if (showArchive && !t.archived) return;
                if (!showArchive && t.archived) return;
                
                // DEEP SEARCH: TITLE + TAG + STEPS
                const tag = t.tag || '';
                const stepsMatch = t.steps.some(s => s.text.toLowerCase().includes(searchTerm));
                if(searchTerm && !t.title.toLowerCase().includes(searchTerm) && !tag.toLowerCase().includes(searchTerm) && !stepsMatch) {
                    return;
                }

                if(t.col === 1 && !t.archived) {
                    activeCount++;
                    if(t.prio === 'High') highPrioCount++;
                }

                const total = t.steps.length;
                const done = t.steps.filter(s => s.done).length;
                const pct = total === 0 ? 0 : (done / total) * 100;
                
                let dateHtml = '';
                if(t.date) {
                    const isOverdue = t.date < today && t.col !== 2;
                    const dateObj = new Date(t.date + 'T00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    dateHtml = `<span class="card-date ${isOverdue?'overdue':''}">${dateStr}</span>`;
                }

                const div = document.createElement('div');
                div.className = `card slide-enter p-${t.prio||'Med'}`;
                div.id = `card-${t.id}`;
                div.onclick = () => openViewer(t.id);
                
                const tagHtml = t.tag ? `<span class="tag-pill">${t.tag}</span>` : '';

                div.innerHTML = `<div class="card-top"><span class="card-title">${t.title}</span>${dateHtml}</div>
                                 <div style="margin-bottom:5px;">
                                    <span class="prio-pill pill-${t.prio}">${t.prio}</span>
                                    ${tagHtml}
                                 </div>
                                 <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                                 <div class="card-meta"><span>${done}/${total} Steps</span><span>${pct.toFixed(0)}%</span></div>
                                 <div class="card-actions">
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, -1)">‚Üê</div>
                                    <div class="btn-quick edit-btn" onclick="event.stopPropagation(); openEditor('${t.id}')">‚úèÔ∏è</div>
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, 1)">‚Üí</div>
                                 </div>`;
                const colId = t.col !== undefined ? t.col : 0;
                document.getElementById(`col-${colId}`).appendChild(div);
            });
            
            [0, 1, 2].forEach(i => { 
                const col = document.getElementById(`col-${i}`);
                if(col.innerHTML === '') col.innerHTML = `<div class="empty-msg">Awaiting Orders...</div>`;
                document.getElementById(`count-${i}`).innerText = tasks.filter(t => (t.col||0) === i && !t.archived).length; 
            });
            document.querySelector('h1').innerText = showArchive ? "Cryo-Storage üßä" : "Mission Control üöÄ";
            
            document.getElementById('briefing-text').innerText = `Active: ${activeCount} | Critical: ${highPrioCount}`;
        }

        // --- CAMERA TRACKING ---
        function scrollToColumn(colIdx) {
            const board = document.getElementById('main-board');
            const cols = document.querySelectorAll('.column');
            if (cols[colIdx]) {
                const isMobile = window.innerWidth < 600;
                const scrollLeft = isMobile ? cols[colIdx].offsetLeft - 10 : cols[colIdx].offsetLeft;
                board.scrollTo({ left: scrollLeft, behavior: 'smooth' });
            }
        }

        // --- VIEWER ---
        function openViewer(id) {
            const t = tasks.find(x => x.id === id);
            if(!t) return;
            currentViewId = id;
            document.getElementById('v-title').innerText = t.title;
            document.getElementById('v-prio').innerText = t.prio;
            document.getElementById('v-prio').className = `prio-pill pill-${t.prio}`;
            
            const tagEl = document.getElementById('v-tag');
            if(t.tag) { tagEl.innerText = t.tag; tagEl.style.display = 'inline-block'; } 
            else { tagEl.style.display = 'none'; }

            if(t.date) {
                const dateObj = new Date(t.date + 'T00:00');
                document.getElementById('v-date').innerText = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else { document.getElementById('v-date').innerText = "No Deadline"; }
            
            const container = document.getElementById('v-checks');
            container.innerHTML = '';
            t.steps.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `<div class="check-box ${s.done?'checked':''}" onclick="toggleStepDone('${id}', ${idx})"></div><span class="check-text" style="border:none;">${s.text}</span>`;
                container.appendChild(div);
            });
            document.getElementById('viewer').style.display = 'flex';
        }

        function toggleStepDone(taskId, stepIdx) {
            const t = tasks.find(x => x.id === taskId);
            t.steps[stepIdx].done = !t.steps[stepIdx].done;
            if(t.steps[stepIdx].done) { showToast("+10 XP", false); updateLiveXP(10); }
            else { showToast("-10 XP", true); updateLiveXP(-10); }
            save(); openViewer(taskId); render(); 
        }

        function switchToEdit() { closeViewer(); openEditor(currentViewId); }
        function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

        // --- EDITOR ---
        function openEditor(id = null) {
            const t = id ? tasks.find(x => x.id === id) : { id: '', title: '', steps: [], col: 0, prio:'Med', date:'', tag: '', archived:false };
            document.getElementById('e-id').value = t.id;
            document.getElementById('e-title').value = t.title;
            document.getElementById('e-date').value = t.date;
            document.getElementById('e-prio').value = t.prio || 'Med';
            document.getElementById('e-tag').value = t.tag || '';
            document.getElementById('btn-archive-toggle').innerText = t.archived ? "üî• Thaw" : "üßä Archive";
            const container = document.getElementById('e-checks');
            container.innerHTML = '';
            t.steps.forEach(s => addEditStep(s.text, s.done));
            document.getElementById('editor').style.display = 'flex';
        }

        function addEditStep(text = '', done = false) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `<div class="check-box ${done?'checked':''}" onclick="this.classList.toggle('checked')"></div><input type="text" class="check-text" value="${text}" placeholder="Step..."><span class="check-del" onclick="this.parentElement.remove()">‚úï</span>`;
            document.getElementById('e-checks').appendChild(div);
        }

        function handleStepEnter(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('new-step-input');
                if(input.value.trim()) { addEditStep(input.value.trim()); input.value = ''; input.focus(); }
            }
        }

        function saveCard() {
            const id = document.getElementById('e-id').value;
            const title = document.getElementById('e-title').value;
            if(!title) return alert("Title required");
            const steps = [];
            document.querySelectorAll('#e-checks .check-item').forEach(el => {
                steps.push({ text: el.querySelector('.check-text').value.trim(), done: el.querySelector('.check-box').classList.contains('checked') });
            });
            const tag = document.getElementById('e-tag').value.trim();

            if(id) {
                const idx = tasks.findIndex(x => x.id === id);
                tasks[idx] = { ...tasks[idx], title, steps, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag };
            } else {
                tasks.push({ id: Date.now().toString(), title, steps, col: 0, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag, archived: false });
            }
            save(); closeEditor(); render();
        }

        // --- CONFIRMATION ---
        function confirmDelete() {
            taskToDeleteId = document.getElementById('e-id').value;
            if(!taskToDeleteId) return; 
            document.getElementById('confirm-yes-btn').onclick = executeDelete;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; taskToDeleteId = null; }

        function executeDelete() {
            if(taskToDeleteId) {
                const t = tasks.find(x => x.id === taskToDeleteId);
                const sunkXP = t.steps.filter(s=>s.done).length * 10;
                const totalLoss = sunkXP + 50;
                tasks = tasks.filter(x => x.id !== taskToDeleteId);
                updateLiveXP(-totalLoss);
                showToast(`FAILED (-${totalLoss} XP)`, true);
                save(); closeConfirm(); closeEditor(); render();
            }
        }

        function deleteCard() { confirmDelete(); }
        function closeEditor() { document.getElementById('editor').style.display = 'none'; }
        
        function toggleArchiveTask() {
            const id = document.getElementById('e-id').value;
            const t = tasks.find(x => x.id === id);
            t.archived = !t.archived; save(); closeEditor(); render();
        }

        function moveCardLogic(idx, dir) {
            let newCol = (tasks[idx].col || 0) + dir;
            if(newCol < 0) newCol = 0; if(newCol > 2) newCol = 2;
            const task = tasks[idx];
            if(task.col !== 2 && newCol === 2) { calculateFinishXP(task); launchConfetti(); task.winXP = calculateFinishValue(task); }
            if(task.col === 2 && newCol !== 2) { 
                const refund = task.winXP || 100;
                const totalLoss = refund + 50; 
                showToast(`RETREAT (-${totalLoss})`, true); updateLiveXP(-totalLoss); task.winXP = 0; 
            }
            task.col = newCol; save(); updateXP(); render();
            setTimeout(() => scrollToColumn(newCol), 100);
        }

        function calculateFinishValue(task) {
            let base = 100; if(task.prio === 'Med') base = 150; if(task.prio === 'High') base = 200;
            let multiplier = 1.0;
            if(task.date) {
                const due = new Date(task.date); const today = new Date();
                due.setHours(0,0,0,0); today.setHours(0,0,0,0);
                if(today < due) multiplier = 1.2; else if(today > due) multiplier = 0.8;
            }
            return Math.floor(base * multiplier);
        }

        function calculateFinishXP(task) {
            const total = calculateFinishValue(task);
            showToast(`VICTORY! (+${total} XP)`, false); updateLiveXP(total);
        }

        function updateLiveXP(amount) {
            const pMult = 1 + (prestige * 0.1); 
            let final = Math.floor(amount * pMult);
            if(amount > 0 && Math.random() < 0.05) { final += 50; showToast("CRITICAL SUCCESS! (+50)", false); showCodex(); }
            userXP += final; if(userXP < 0) userXP = 0; updateXP();
        }

        function updateXP() {
            localStorage.setItem('mc_xp', userXP); localStorage.setItem('mc_prestige', prestige);
            const stats = getLevel(userXP);
            const pct = Math.max(0, Math.min(100, ((userXP - stats.prevReq) / (stats.nextReq - stats.prevReq)) * 100));
            document.getElementById('lvl-badge').innerText = `LVL ${stats.level}`;
            document.getElementById('xp-fill').style.width = `${pct}%`;
            document.getElementById('xp-text').innerText = `${userXP} / ${stats.nextReq}`;
            checkUnlocks(stats.level);
        }

        function getLevel(xp) {
            let lvl = 1; let req = 500; let gap = 500;
            while(xp >= req) { lvl++; gap += 50; req += gap; }
            return { level: lvl, nextReq: req, prevReq: req - gap };
        }

        function showToast(msg, isLoss) {
            const t = document.getElementById('xp-toast');
            t.querySelector('span').innerText = msg;
            t.className = isLoss ? 'loss' : '';
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0px) scale(1)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 10px)'; }, 3000);
        }

        function checkUnlocks(level) {
            const unlockAll = prestige > 0;
            const locks = {
                'theme-wolf': 5, 'theme-neon': 10, 'theme-aperture': 12, 'theme-horror': 15,
                'theme-vapor': 18, 'theme-blueprint': 20, 'theme-terminal': 25, 'theme-gold': 30,
                'theme-nebula': 999, 'theme-midas': 999, 'theme-glitch': 999, 
                'feat-status': 2, 'feat-zen': 8, 'feat-prestige': 50,
                'fx-star': 10, 'fx-coin': 20, 'fx-gem': 30
            };
            for(let id in locks) {
                const btn = document.getElementById(id);
                if(!btn) continue;
                let isUnlocked = false;
                if(id === 'theme-nebula') isUnlocked = prestige >= 1;
                else if(id === 'theme-midas') isUnlocked = prestige >= 2;
                else if(id === 'theme-glitch') isUnlocked = prestige >= 3;
                else isUnlocked = unlockAll || level >= locks[id];
                
                if(isUnlocked) { btn.classList.remove('dd-locked'); if(btn.innerText.includes('üîí')) btn.innerText = btn.innerText.replace(' üîí', ''); } 
                else { btn.classList.add('dd-locked'); if(!btn.innerText.includes('üîí')) btn.innerText += ' üîí'; }
            }
        }

        function setTheme(name, force) {
            const stats = getLevel(userXP);
            const reqs = { 'wolf': 5, 'neon': 10, 'aperture': 12, 'horror': 15, 'vapor': 18, 'blueprint': 20, 'terminal': 25, 'gold': 30 };
            const pReqs = { 'nebula': 1, 'midas': 2, 'glitch': 3 };
            if(!force) {
                if(pReqs[name] && prestige < pReqs[name]) return alert(`LOCKED! Reach Prestige ${pReqs[name]} to unlock.`);
                if(reqs[name] && prestige === 0 && stats.level < reqs[name]) return alert(`LOCKED! Reach Level ${reqs[name]} to unlock.`);
            }
            document.body.className = ''; 
            if(name !== 'default') document.body.classList.add(`theme-${name}`);
            currentTheme = name;
            localStorage.setItem('theme', name);
        }

        function setConfetti(type) {
            const stats = getLevel(userXP);
            const reqs = { 'star': 10, 'coin': 20, 'gem': 30 };
            if(prestige === 0 && reqs[type] && stats.level < reqs[type]) return alert(`Locked until Level ${reqs[type]}`);
            confettiStyle = type;
            localStorage.setItem('mc_fx', type);
        }

        function launchConfetti() {
            const emojis = { 'square': '', 'star': '‚≠ê', 'coin': 'ü™ô', 'gem': 'üíé' };
            const icon = emojis[confettiStyle];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.innerText = icon;
                c.style.left = Math.random()*100 + 'vw';
                if(confettiStyle === 'square') {
                    c.style.width = '10px'; c.style.height = '10px';
                    c.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                }
                c.style.animation = `fall ${Math.random()*1+1}s linear forwards`;
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 2000);
            }
        }
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
        document.head.appendChild(styleSheet);

        // --- FILTERING ---
        function filterTasks() {
            searchTerm = document.getElementById('radar-search').value.toLowerCase();
            render();
        }

        // --- RENDER ENGINE ---
        function render() {
            [0, 1, 2].forEach(i => { document.getElementById(`col-${i}`).innerHTML = ''; document.getElementById(`count-${i}`).innerText = '0'; });
            const today = new Date().toISOString().split('T')[0];
            
            let activeCount = 0;
            let highPrioCount = 0;

            tasks.forEach(t => {
                if (showArchive && !t.archived) return;
                if (!showArchive && t.archived) return;
                
                // DEEP SEARCH: TITLE + TAG + STEPS
                const tag = t.tag || '';
                const stepsMatch = t.steps.some(s => s.text.toLowerCase().includes(searchTerm));
                if(searchTerm && !t.title.toLowerCase().includes(searchTerm) && !tag.toLowerCase().includes(searchTerm) && !stepsMatch) {
                    return;
                }

                if(t.col === 1 && !t.archived) {
                    activeCount++;
                    if(t.prio === 'High') highPrioCount++;
                }

                const total = t.steps.length;
                const done = t.steps.filter(s => s.done).length;
                const pct = total === 0 ? 0 : (done / total) * 100;
                
                let dateHtml = '';
                if(t.date) {
                    const isOverdue = t.date < today && t.col !== 2;
                    const dateObj = new Date(t.date + 'T00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    dateHtml = `<span class="card-date ${isOverdue?'overdue':''}">${dateStr}</span>`;
                }

                const div = document.createElement('div');
                div.className = `card slide-enter p-${t.prio||'Med'}`;
                div.id = `card-${t.id}`;
                div.onclick = () => openViewer(t.id);
                
                const tagHtml = t.tag ? `<span class="tag-pill">${t.tag}</span>` : '';

                div.innerHTML = `<div class="card-top"><span class="card-title">${t.title}</span>${dateHtml}</div>
                                 <div style="margin-bottom:5px;">
                                    <span class="prio-pill pill-${t.prio}">${t.prio}</span>
                                    ${tagHtml}
                                 </div>
                                 <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                                 <div class="card-meta"><span>${done}/${total} Steps</span><span>${pct.toFixed(0)}%</span></div>
                                 <div class="card-actions">
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, -1)">‚Üê</div>
                                    <div class="btn-quick edit-btn" onclick="event.stopPropagation(); openEditor('${t.id}')">‚úèÔ∏è</div>
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, 1)">‚Üí</div>
                                 </div>`;
                const colId = t.col !== undefined ? t.col : 0;
                document.getElementById(`col-${colId}`).appendChild(div);
            });
            
            [0, 1, 2].forEach(i => { 
                const col = document.getElementById(`col-${i}`);
                if(col.innerHTML === '') col.innerHTML = `<div class="empty-msg">Awaiting Orders...</div>`;
                document.getElementById(`count-${i}`).innerText = tasks.filter(t => (t.col||0) === i && !t.archived).length; 
            });
            document.querySelector('h1').innerText = showArchive ? "Cryo-Storage üßä" : "Mission Control üöÄ";
            
            document.getElementById('briefing-text').innerText = `Active: ${activeCount} | Critical: ${highPrioCount}`;
        }

        // --- CAMERA TRACKING ---
        function scrollToColumn(colIdx) {
            const board = document.getElementById('main-board');
            const cols = document.querySelectorAll('.column');
            if (cols[colIdx]) {
                const isMobile = window.innerWidth < 600;
                const scrollLeft = isMobile ? cols[colIdx].offsetLeft - 10 : cols[colIdx].offsetLeft;
                board.scrollTo({ left: scrollLeft, behavior: 'smooth' });
            }
        }

        // --- VIEWER ---
        function openViewer(id) {
            const t = tasks.find(x => x.id === id);
            if(!t) return;
            currentViewId = id;
            document.getElementById('v-title').innerText = t.title;
            document.getElementById('v-prio').innerText = t.prio;
            document.getElementById('v-prio').className = `prio-pill pill-${t.prio}`;
            
            const tagEl = document.getElementById('v-tag');
            if(t.tag) { tagEl.innerText = t.tag; tagEl.style.display = 'inline-block'; } 
            else { tagEl.style.display = 'none'; }

            if(t.date) {
                const dateObj = new Date(t.date + 'T00:00');
                document.getElementById('v-date').innerText = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else { document.getElementById('v-date').innerText = "No Deadline"; }
            
            const container = document.getElementById('v-checks');
            container.innerHTML = '';
            t.steps.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `<div class="check-box ${s.done?'checked':''}" onclick="toggleStepDone('${id}', ${idx})"></div><span class="check-text" style="border:none;">${s.text}</span>`;
                container.appendChild(div);
            });
            document.getElementById('viewer').style.display = 'flex';
        }

        function toggleStepDone(taskId, stepIdx) {
            const t = tasks.find(x => x.id === taskId);
            t.steps[stepIdx].done = !t.steps[stepIdx].done;
            if(t.steps[stepIdx].done) { showToast("+10 XP", false); updateLiveXP(10); }
            else { showToast("-10 XP", true); updateLiveXP(-10); }
            save(); openViewer(taskId); render(); 
        }

        function switchToEdit() { closeViewer(); openEditor(currentViewId); }
        function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

        // --- EDITOR ---
        function openEditor(id = null) {
            const t = id ? tasks.find(x => x.id === id) : { id: '', title: '', steps: [], col: 0, prio:'Med', date:'', tag: '', archived:false };
            document.getElementById('e-id').value = t.id;
            document.getElementById('e-title').value = t.title;
            document.getElementById('e-date').value = t.date;
            document.getElementById('e-prio').value = t.prio || 'Med';
            document.getElementById('e-tag').value = t.tag || '';
            document.getElementById('btn-archive-toggle').innerText = t.archived ? "üî• Thaw" : "üßä Archive";
            const container = document.getElementById('e-checks');
            container.innerHTML = '';
            t.steps.forEach(s => addEditStep(s.text, s.done));
            document.getElementById('editor').style.display = 'flex';
        }

        function addEditStep(text = '', done = false) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `<div class="check-box ${done?'checked':''}" onclick="this.classList.toggle('checked')"></div><input type="text" class="check-text" value="${text}" placeholder="Step..."><span class="check-del" onclick="this.parentElement.remove()">‚úï</span>`;
            document.getElementById('e-checks').appendChild(div);
        }

        function handleStepEnter(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('new-step-input');
                if(input.value.trim()) { addEditStep(input.value.trim()); input.value = ''; input.focus(); }
            }
        }

        function saveCard() {
            const id = document.getElementById('e-id').value;
            const title = document.getElementById('e-title').value;
            if(!title) return alert("Title required");
            const steps = [];
            document.querySelectorAll('#e-checks .check-item').forEach(el => {
                steps.push({ text: el.querySelector('.check-text').value.trim(), done: el.querySelector('.check-box').classList.contains('checked') });
            });
            const tag = document.getElementById('e-tag').value.trim();

            if(id) {
                const idx = tasks.findIndex(x => x.id === id);
                tasks[idx] = { ...tasks[idx], title, steps, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag };
            } else {
                tasks.push({ id: Date.now().toString(), title, steps, col: 0, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag, archived: false });
            }
            save(); closeEditor(); render();
        }

        // --- CONFIRMATION ---
        function confirmDelete() {
            taskToDeleteId = document.getElementById('e-id').value;
            if(!taskToDeleteId) return; 
            document.getElementById('confirm-yes-btn').onclick = executeDelete;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; taskToDeleteId = null; }

        function executeDelete() {
            if(taskToDeleteId) {
                const t = tasks.find(x => x.id === taskToDeleteId);
                const sunkXP = t.steps.filter(s=>s.done).length * 10;
                const totalLoss = sunkXP + 50;
                tasks = tasks.filter(x => x.id !== taskToDeleteId);
                updateLiveXP(-totalLoss);
                showToast(`FAILED (-${totalLoss} XP)`, true);
                save(); closeConfirm(); closeEditor(); render();
            }
        }

        function deleteCard() { confirmDelete(); }
        function closeEditor() { document.getElementById('editor').style.display = 'none'; }
        
        function toggleArchiveTask() {
            const id = document.getElementById('e-id').value;
            const t = tasks.find(x => x.id === id);
            t.archived = !t.archived; save(); closeEditor(); render();
        }

        function moveCardLogic(idx, dir) {
            let newCol = (tasks[idx].col || 0) + dir;
            if(newCol < 0) newCol = 0; if(newCol > 2) newCol = 2;
            const task = tasks[idx];
            if(task.col !== 2 && newCol === 2) { calculateFinishXP(task); launchConfetti(); task.winXP = calculateFinishValue(task); }
            if(task.col === 2 && newCol !== 2) { 
                const refund = task.winXP || 100;
                const totalLoss = refund + 50; 
                showToast(`RETREAT (-${totalLoss})`, true); updateLiveXP(-totalLoss); task.winXP = 0; 
            }
            task.col = newCol; save(); updateXP(); render();
            setTimeout(() => scrollToColumn(newCol), 100);
        }

        function calculateFinishValue(task) {
            let base = 100; if(task.prio === 'Med') base = 150; if(task.prio === 'High') base = 200;
            let multiplier = 1.0;
            if(task.date) {
                const due = new Date(task.date); const today = new Date();
                due.setHours(0,0,0,0); today.setHours(0,0,0,0);
                if(today < due) multiplier = 1.2; else if(today > due) multiplier = 0.8;
            }
            return Math.floor(base * multiplier);
        }

        function calculateFinishXP(task) {
            const total = calculateFinishValue(task);
            showToast(`VICTORY! (+${total} XP)`, false); updateLiveXP(total);
        }

        function updateLiveXP(amount) {
            const pMult = 1 + (prestige * 0.1); 
            let final = Math.floor(amount * pMult);
            if(amount > 0 && Math.random() < 0.05) { final += 50; showToast("CRITICAL SUCCESS! (+50)", false); showCodex(); }
            userXP += final; if(userXP < 0) userXP = 0; updateXP();
        }

        function updateXP() {
            localStorage.setItem('mc_xp', userXP); localStorage.setItem('mc_prestige', prestige);
            const stats = getLevel(userXP);
            const pct = Math.max(0, Math.min(100, ((userXP - stats.prevReq) / (stats.nextReq - stats.prevReq)) * 100));
            document.getElementById('lvl-badge').innerText = `LVL ${stats.level}`;
            document.getElementById('xp-fill').style.width = `${pct}%`;
            document.getElementById('xp-text').innerText = `${userXP} / ${stats.nextReq}`;
            checkUnlocks(stats.level);
        }

        function getLevel(xp) {
            let lvl = 1; let req = 500; let gap = 500;
            while(xp >= req) { lvl++; gap += 50; req += gap; }
            return { level: lvl, nextReq: req, prevReq: req - gap };
        }

        function showToast(msg, isLoss) {
            const t = document.getElementById('xp-toast');
            t.querySelector('span').innerText = msg;
            t.className = isLoss ? 'loss' : '';
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0px) scale(1)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 10px)'; }, 3000);
        }

        function checkUnlocks(level) {
            const unlockAll = prestige > 0;
            const locks = {
                'theme-wolf': 5, 'theme-neon': 10, 'theme-aperture': 12, 'theme-horror': 15,
                'theme-vapor': 18, 'theme-blueprint': 20, 'theme-terminal': 25, 'theme-gold': 30,
                'theme-nebula': 999, 'theme-midas': 999, 'theme-glitch': 999, 
                'feat-status': 2, 'feat-zen': 8, 'feat-prestige': 50,
                'fx-star': 10, 'fx-coin': 20, 'fx-gem': 30
            };
            for(let id in locks) {
                const btn = document.getElementById(id);
                if(!btn) continue;
                let isUnlocked = false;
                if(id === 'theme-nebula') isUnlocked = prestige >= 1;
                else if(id === 'theme-midas') isUnlocked = prestige >= 2;
                else if(id === 'theme-glitch') isUnlocked = prestige >= 3;
                else isUnlocked = unlockAll || level >= locks[id];
                
                if(isUnlocked) { btn.classList.remove('dd-locked'); if(btn.innerText.includes('üîí')) btn.innerText = btn.innerText.replace(' üîí', ''); } 
                else { btn.classList.add('dd-locked'); if(!btn.innerText.includes('üîí')) btn.innerText += ' üîí'; }
            }
        }

        function setTheme(name, force) {
            const stats = getLevel(userXP);
            const reqs = { 'wolf': 5, 'neon': 10, 'aperture': 12, 'horror': 15, 'vapor': 18, 'blueprint': 20, 'terminal': 25, 'gold': 30 };
            const pReqs = { 'nebula': 1, 'midas': 2, 'glitch': 3 };
            if(!force) {
                if(pReqs[name] && prestige < pReqs[name]) return alert(`LOCKED! Reach Prestige ${pReqs[name]} to unlock.`);
                if(reqs[name] && prestige === 0 && stats.level < reqs[name]) return alert(`LOCKED! Reach Level ${reqs[name]} to unlock.`);
            }
            document.body.className = ''; 
            if(name !== 'default') document.body.classList.add(`theme-${name}`);
            currentTheme = name;
            localStorage.setItem('theme', name);
        }

        function setConfetti(type) {
            const stats = getLevel(userXP);
            const reqs = { 'star': 10, 'coin': 20, 'gem': 30 };
            if(prestige === 0 && reqs[type] && stats.level < reqs[type]) return alert(`Locked until Level ${reqs[type]}`);
            confettiStyle = type;
            localStorage.setItem('mc_fx', type);
        }

        function launchConfetti() {
            const emojis = { 'square': '', 'star': '‚≠ê', 'coin': 'ü™ô', 'gem': 'üíé' };
            const icon = emojis[confettiStyle];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.innerText = icon;
                c.style.left = Math.random()*100 + 'vw';
                if(confettiStyle === 'square') {
                    c.style.width = '10px'; c.style.height = '10px';
                    c.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                }
                c.style.animation = `fall ${Math.random()*1+1}s linear forwards`;
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 2000);
            }
        }
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
        document.head.appendChild(styleSheet);

        // --- FILTERING ---
        function filterTasks() {
            searchTerm = document.getElementById('radar-search').value.toLowerCase();
            render();
        }

        // --- RENDER ENGINE ---
        function render() {
            [0, 1, 2].forEach(i => { document.getElementById(`col-${i}`).innerHTML = ''; document.getElementById(`count-${i}`).innerText = '0'; });
            const today = new Date().toISOString().split('T')[0];
            
            let activeCount = 0;
            let highPrioCount = 0;

            tasks.forEach(t => {
                if (showArchive && !t.archived) return;
                if (!showArchive && t.archived) return;
                
                // DEEP SEARCH: TITLE + TAG + STEPS
                const tag = t.tag || '';
                const stepsMatch = t.steps.some(s => s.text.toLowerCase().includes(searchTerm));
                if(searchTerm && !t.title.toLowerCase().includes(searchTerm) && !tag.toLowerCase().includes(searchTerm) && !stepsMatch) {
                    return;
                }

                if(t.col === 1 && !t.archived) {
                    activeCount++;
                    if(t.prio === 'High') highPrioCount++;
                }

                const total = t.steps.length;
                const done = t.steps.filter(s => s.done).length;
                const pct = total === 0 ? 0 : (done / total) * 100;
                
                let dateHtml = '';
                if(t.date) {
                    const isOverdue = t.date < today && t.col !== 2;
                    const dateObj = new Date(t.date + 'T00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    dateHtml = `<span class="card-date ${isOverdue?'overdue':''}">${dateStr}</span>`;
                }

                const div = document.createElement('div');
                div.className = `card slide-enter p-${t.prio||'Med'}`;
                div.id = `card-${t.id}`;
                div.onclick = () => openViewer(t.id);
                
                const tagHtml = t.tag ? `<span class="tag-pill">${t.tag}</span>` : '';

                div.innerHTML = `<div class="card-top"><span class="card-title">${t.title}</span>${dateHtml}</div>
                                 <div style="margin-bottom:5px;">
                                    <span class="prio-pill pill-${t.prio}">${t.prio}</span>
                                    ${tagHtml}
                                 </div>
                                 <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                                 <div class="card-meta"><span>${done}/${total} Steps</span><span>${pct.toFixed(0)}%</span></div>
                                 <div class="card-actions">
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, -1)">‚Üê</div>
                                    <div class="btn-quick edit-btn" onclick="event.stopPropagation(); openEditor('${t.id}')">‚úèÔ∏è</div>
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, 1)">‚Üí</div>
                                 </div>`;
                const colId = t.col !== undefined ? t.col : 0;
                document.getElementById(`col-${colId}`).appendChild(div);
            });
            
            [0, 1, 2].forEach(i => { 
                const col = document.getElementById(`col-${i}`);
                if(col.innerHTML === '') col.innerHTML = `<div class="empty-msg">Awaiting Orders...</div>`;
                document.getElementById(`count-${i}`).innerText = tasks.filter(t => (t.col||0) === i && !t.archived).length; 
            });
            document.querySelector('h1').innerText = showArchive ? "Cryo-Storage üßä" : "Mission Control üöÄ";
            
            document.getElementById('briefing-text').innerText = `Active: ${activeCount} | Critical: ${highPrioCount}`;
        }

        // --- CAMERA TRACKING ---
        function scrollToColumn(colIdx) {
            const board = document.getElementById('main-board');
            const cols = document.querySelectorAll('.column');
            if (cols[colIdx]) {
                const isMobile = window.innerWidth < 600;
                const scrollLeft = isMobile ? cols[colIdx].offsetLeft - 10 : cols[colIdx].offsetLeft;
                board.scrollTo({ left: scrollLeft, behavior: 'smooth' });
            }
        }

        // --- VIEWER ---
        function openViewer(id) {
            const t = tasks.find(x => x.id === id);
            if(!t) return;
            currentViewId = id;
            document.getElementById('v-title').innerText = t.title;
            document.getElementById('v-prio').innerText = t.prio;
            document.getElementById('v-prio').className = `prio-pill pill-${t.prio}`;
            
            const tagEl = document.getElementById('v-tag');
            if(t.tag) { tagEl.innerText = t.tag; tagEl.style.display = 'inline-block'; } 
            else { tagEl.style.display = 'none'; }

            if(t.date) {
                const dateObj = new Date(t.date + 'T00:00');
                document.getElementById('v-date').innerText = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else { document.getElementById('v-date').innerText = "No Deadline"; }
            
            const container = document.getElementById('v-checks');
            container.innerHTML = '';
            t.steps.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `<div class="check-box ${s.done?'checked':''}" onclick="toggleStepDone('${id}', ${idx})"></div><span class="check-text" style="border:none;">${s.text}</span>`;
                container.appendChild(div);
            });
            document.getElementById('viewer').style.display = 'flex';
        }

        function toggleStepDone(taskId, stepIdx) {
            const t = tasks.find(x => x.id === taskId);
            t.steps[stepIdx].done = !t.steps[stepIdx].done;
            if(t.steps[stepIdx].done) { showToast("+10 XP", false); updateLiveXP(10); }
            else { showToast("-10 XP", true); updateLiveXP(-10); }
            save(); openViewer(taskId); render(); 
        }

        function switchToEdit() { closeViewer(); openEditor(currentViewId); }
        function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

        // --- EDITOR ---
        function openEditor(id = null) {
            const t = id ? tasks.find(x => x.id === id) : { id: '', title: '', steps: [], col: 0, prio:'Med', date:'', tag: '', archived:false };
            document.getElementById('e-id').value = t.id;
            document.getElementById('e-title').value = t.title;
            document.getElementById('e-date').value = t.date;
            document.getElementById('e-prio').value = t.prio || 'Med';
            document.getElementById('e-tag').value = t.tag || '';
            document.getElementById('btn-archive-toggle').innerText = t.archived ? "üî• Thaw" : "üßä Archive";
            const container = document.getElementById('e-checks');
            container.innerHTML = '';
            t.steps.forEach(s => addEditStep(s.text, s.done));
            document.getElementById('editor').style.display = 'flex';
        }

        function addEditStep(text = '', done = false) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `<div class="check-box ${done?'checked':''}" onclick="this.classList.toggle('checked')"></div><input type="text" class="check-text" value="${text}" placeholder="Step..."><span class="check-del" onclick="this.parentElement.remove()">‚úï</span>`;
            document.getElementById('e-checks').appendChild(div);
        }

        function handleStepEnter(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('new-step-input');
                if(input.value.trim()) { addEditStep(input.value.trim()); input.value = ''; input.focus(); }
            }
        }

        function saveCard() {
            const id = document.getElementById('e-id').value;
            const title = document.getElementById('e-title').value;
            if(!title) return alert("Title required");
            const steps = [];
            document.querySelectorAll('#e-checks .check-item').forEach(el => {
                steps.push({ text: el.querySelector('.check-text').value.trim(), done: el.querySelector('.check-box').classList.contains('checked') });
            });
            const tag = document.getElementById('e-tag').value.trim();

            if(id) {
                const idx = tasks.findIndex(x => x.id === id);
                tasks[idx] = { ...tasks[idx], title, steps, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag };
            } else {
                tasks.push({ id: Date.now().toString(), title, steps, col: 0, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag, archived: false });
            }
            save(); closeEditor(); render();
        }

        // --- CONFIRMATION ---
        function confirmDelete() {
            taskToDeleteId = document.getElementById('e-id').value;
            if(!taskToDeleteId) return; 
            document.getElementById('confirm-yes-btn').onclick = executeDelete;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; taskToDeleteId = null; }

        function executeDelete() {
            if(taskToDeleteId) {
                const t = tasks.find(x => x.id === taskToDeleteId);
                const sunkXP = t.steps.filter(s=>s.done).length * 10;
                const totalLoss = sunkXP + 50;
                tasks = tasks.filter(x => x.id !== taskToDeleteId);
                updateLiveXP(-totalLoss);
                showToast(`FAILED (-${totalLoss} XP)`, true);
                save(); closeConfirm(); closeEditor(); render();
            }
        }

        function deleteCard() { confirmDelete(); }
        function closeEditor() { document.getElementById('editor').style.display = 'none'; }
        
        function toggleArchiveTask() {
            const id = document.getElementById('e-id').value;
            const t = tasks.find(x => x.id === id);
            t.archived = !t.archived; save(); closeEditor(); render();
        }

        function moveCardLogic(idx, dir) {
            let newCol = (tasks[idx].col || 0) + dir;
            if(newCol < 0) newCol = 0; if(newCol > 2) newCol = 2;
            const task = tasks[idx];
            if(task.col !== 2 && newCol === 2) { calculateFinishXP(task); launchConfetti(); task.winXP = calculateFinishValue(task); }
            if(task.col === 2 && newCol !== 2) { 
                const refund = task.winXP || 100;
                const totalLoss = refund + 50; 
                showToast(`RETREAT (-${totalLoss})`, true); updateLiveXP(-totalLoss); task.winXP = 0; 
            }
            task.col = newCol; save(); updateXP(); render();
            setTimeout(() => scrollToColumn(newCol), 100);
        }

        function calculateFinishValue(task) {
            let base = 100; if(task.prio === 'Med') base = 150; if(task.prio === 'High') base = 200;
            let multiplier = 1.0;
            if(task.date) {
                const due = new Date(task.date); const today = new Date();
                due.setHours(0,0,0,0); today.setHours(0,0,0,0);
                if(today < due) multiplier = 1.2; else if(today > due) multiplier = 0.8;
            }
            return Math.floor(base * multiplier);
        }

        function calculateFinishXP(task) {
            const total = calculateFinishValue(task);
            showToast(`VICTORY! (+${total} XP)`, false); updateLiveXP(total);
        }

        function updateLiveXP(amount) {
            const pMult = 1 + (prestige * 0.1); 
            let final = Math.floor(amount * pMult);
            if(amount > 0 && Math.random() < 0.05) { final += 50; showToast("CRITICAL SUCCESS! (+50)", false); showCodex(); }
            userXP += final; if(userXP < 0) userXP = 0; updateXP();
        }

        function updateXP() {
            localStorage.setItem('mc_xp', userXP); localStorage.setItem('mc_prestige', prestige);
            const stats = getLevel(userXP);
            const pct = Math.max(0, Math.min(100, ((userXP - stats.prevReq) / (stats.nextReq - stats.prevReq)) * 100));
            document.getElementById('lvl-badge').innerText = `LVL ${stats.level}`;
            document.getElementById('xp-fill').style.width = `${pct}%`;
            document.getElementById('xp-text').innerText = `${userXP} / ${stats.nextReq}`;
            checkUnlocks(stats.level);
        }

        function getLevel(xp) {
            let lvl = 1; let req = 500; let gap = 500;
            while(xp >= req) { lvl++; gap += 50; req += gap; }
            return { level: lvl, nextReq: req, prevReq: req - gap };
        }

        function showToast(msg, isLoss) {
            const t = document.getElementById('xp-toast');
            t.querySelector('span').innerText = msg;
            t.className = isLoss ? 'loss' : '';
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0px) scale(1)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 10px)'; }, 3000);
        }

        function checkUnlocks(level) {
            const unlockAll = prestige > 0;
            const locks = {
                'theme-wolf': 5, 'theme-neon': 10, 'theme-aperture': 12, 'theme-horror': 15,
                'theme-vapor': 18, 'theme-blueprint': 20, 'theme-terminal': 25, 'theme-gold': 30,
                'theme-nebula': 999, 'theme-midas': 999, 'theme-glitch': 999, 
                'feat-status': 2, 'feat-zen': 8, 'feat-prestige': 50,
                'fx-star': 10, 'fx-coin': 20, 'fx-gem': 30
            };
            for(let id in locks) {
                const btn = document.getElementById(id);
                if(!btn) continue;
                let isUnlocked = false;
                if(id === 'theme-nebula') isUnlocked = prestige >= 1;
                else if(id === 'theme-midas') isUnlocked = prestige >= 2;
                else if(id === 'theme-glitch') isUnlocked = prestige >= 3;
                else isUnlocked = unlockAll || level >= locks[id];
                
                if(isUnlocked) { btn.classList.remove('dd-locked'); if(btn.innerText.includes('üîí')) btn.innerText = btn.innerText.replace(' üîí', ''); } 
                else { btn.classList.add('dd-locked'); if(!btn.innerText.includes('üîí')) btn.innerText += ' üîí'; }
            }
        }

        function setTheme(name, force) {
            const stats = getLevel(userXP);
            const reqs = { 'wolf': 5, 'neon': 10, 'aperture': 12, 'horror': 15, 'vapor': 18, 'blueprint': 20, 'terminal': 25, 'gold': 30 };
            const pReqs = { 'nebula': 1, 'midas': 2, 'glitch': 3 };
            if(!force) {
                if(pReqs[name] && prestige < pReqs[name]) return alert(`LOCKED! Reach Prestige ${pReqs[name]} to unlock.`);
                if(reqs[name] && prestige === 0 && stats.level < reqs[name]) return alert(`LOCKED! Reach Level ${reqs[name]} to unlock.`);
            }
            document.body.className = ''; 
            if(name !== 'default') document.body.classList.add(`theme-${name}`);
            currentTheme = name;
            localStorage.setItem('theme', name);
        }

        function setConfetti(type) {
            const stats = getLevel(userXP);
            const reqs = { 'star': 10, 'coin': 20, 'gem': 30 };
            if(prestige === 0 && reqs[type] && stats.level < reqs[type]) return alert(`Locked until Level ${reqs[type]}`);
            confettiStyle = type;
            localStorage.setItem('mc_fx', type);
        }

        function launchConfetti() {
            const emojis = { 'square': '', 'star': '‚≠ê', 'coin': 'ü™ô', 'gem': 'üíé' };
            const icon = emojis[confettiStyle];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.innerText = icon;
                c.style.left = Math.random()*100 + 'vw';
                if(confettiStyle === 'square') {
                    c.style.width = '10px'; c.style.height = '10px';
                    c.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                }
                c.style.animation = `fall ${Math.random()*1+1}s linear forwards`;
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 2000);
            }
        }
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
        document.head.appendChild(styleSheet);

        // --- FILTERING ---
        function filterTasks() {
            searchTerm = document.getElementById('radar-search').value.toLowerCase();
            render();
        }

        // --- RENDER ENGINE ---
        function render() {
            [0, 1, 2].forEach(i => { document.getElementById(`col-${i}`).innerHTML = ''; document.getElementById(`count-${i}`).innerText = '0'; });
            const today = new Date().toISOString().split('T')[0];
            
            let activeCount = 0;
            let highPrioCount = 0;

            tasks.forEach(t => {
                if (showArchive && !t.archived) return;
                if (!showArchive && t.archived) return;
                
                // DEEP SEARCH: TITLE + TAG + STEPS
                const tag = t.tag || '';
                const stepsMatch = t.steps.some(s => s.text.toLowerCase().includes(searchTerm));
                if(searchTerm && !t.title.toLowerCase().includes(searchTerm) && !tag.toLowerCase().includes(searchTerm) && !stepsMatch) {
                    return;
                }

                if(t.col === 1 && !t.archived) {
                    activeCount++;
                    if(t.prio === 'High') highPrioCount++;
                }

                const total = t.steps.length;
                const done = t.steps.filter(s => s.done).length;
                const pct = total === 0 ? 0 : (done / total) * 100;
                
                let dateHtml = '';
                if(t.date) {
                    const isOverdue = t.date < today && t.col !== 2;
                    const dateObj = new Date(t.date + 'T00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    dateHtml = `<span class="card-date ${isOverdue?'overdue':''}">${dateStr}</span>`;
                }

                const div = document.createElement('div');
                div.className = `card slide-enter p-${t.prio||'Med'}`;
                div.id = `card-${t.id}`;
                div.onclick = () => openViewer(t.id);
                
                const tagHtml = t.tag ? `<span class="tag-pill">${t.tag}</span>` : '';

                div.innerHTML = `<div class="card-top"><span class="card-title">${t.title}</span>${dateHtml}</div>
                                 <div style="margin-bottom:5px;">
                                    <span class="prio-pill pill-${t.prio}">${t.prio}</span>
                                    ${tagHtml}
                                 </div>
                                 <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                                 <div class="card-meta"><span>${done}/${total} Steps</span><span>${pct.toFixed(0)}%</span></div>
                                 <div class="card-actions">
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, -1)">‚Üê</div>
                                    <div class="btn-quick edit-btn" onclick="event.stopPropagation(); openEditor('${t.id}')">‚úèÔ∏è</div>
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, 1)">‚Üí</div>
                                 </div>`;
                const colId = t.col !== undefined ? t.col : 0;
                document.getElementById(`col-${colId}`).appendChild(div);
            });
            
            [0, 1, 2].forEach(i => { 
                const col = document.getElementById(`col-${i}`);
                if(col.innerHTML === '') col.innerHTML = `<div class="empty-msg">Awaiting Orders...</div>`;
                document.getElementById(`count-${i}`).innerText = tasks.filter(t => (t.col||0) === i && !t.archived).length; 
            });
            document.querySelector('h1').innerText = showArchive ? "Cryo-Storage üßä" : "Mission Control üöÄ";
            
            document.getElementById('briefing-text').innerText = `Active: ${activeCount} | Critical: ${highPrioCount}`;
        }

        // --- CAMERA TRACKING ---
        function scrollToColumn(colIdx) {
            const board = document.getElementById('main-board');
            const cols = document.querySelectorAll('.column');
            if (cols[colIdx]) {
                const isMobile = window.innerWidth < 600;
                const scrollLeft = isMobile ? cols[colIdx].offsetLeft - 10 : cols[colIdx].offsetLeft;
                board.scrollTo({ left: scrollLeft, behavior: 'smooth' });
            }
        }

        // --- VIEWER ---
        function openViewer(id) {
            const t = tasks.find(x => x.id === id);
            if(!t) return;
            currentViewId = id;
            document.getElementById('v-title').innerText = t.title;
            document.getElementById('v-prio').innerText = t.prio;
            document.getElementById('v-prio').className = `prio-pill pill-${t.prio}`;
            
            const tagEl = document.getElementById('v-tag');
            if(t.tag) { tagEl.innerText = t.tag; tagEl.style.display = 'inline-block'; } 
            else { tagEl.style.display = 'none'; }

            if(t.date) {
                const dateObj = new Date(t.date + 'T00:00');
                document.getElementById('v-date').innerText = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else { document.getElementById('v-date').innerText = "No Deadline"; }
            
            const container = document.getElementById('v-checks');
            container.innerHTML = '';
            t.steps.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `<div class="check-box ${s.done?'checked':''}" onclick="toggleStepDone('${id}', ${idx})"></div><span class="check-text" style="border:none;">${s.text}</span>`;
                container.appendChild(div);
            });
            document.getElementById('viewer').style.display = 'flex';
        }

        function toggleStepDone(taskId, stepIdx) {
            const t = tasks.find(x => x.id === taskId);
            t.steps[stepIdx].done = !t.steps[stepIdx].done;
            if(t.steps[stepIdx].done) { showToast("+10 XP", false); updateLiveXP(10); }
            else { showToast("-10 XP", true); updateLiveXP(-10); }
            save(); openViewer(taskId); render(); 
        }

        function switchToEdit() { closeViewer(); openEditor(currentViewId); }
        function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

        // --- EDITOR ---
        function openEditor(id = null) {
            const t = id ? tasks.find(x => x.id === id) : { id: '', title: '', steps: [], col: 0, prio:'Med', date:'', tag: '', archived:false };
            document.getElementById('e-id').value = t.id;
            document.getElementById('e-title').value = t.title;
            document.getElementById('e-date').value = t.date;
            document.getElementById('e-prio').value = t.prio || 'Med';
            document.getElementById('e-tag').value = t.tag || '';
            document.getElementById('btn-archive-toggle').innerText = t.archived ? "üî• Thaw" : "üßä Archive";
            const container = document.getElementById('e-checks');
            container.innerHTML = '';
            t.steps.forEach(s => addEditStep(s.text, s.done));
            document.getElementById('editor').style.display = 'flex';
        }

        function addEditStep(text = '', done = false) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `<div class="check-box ${done?'checked':''}" onclick="this.classList.toggle('checked')"></div><input type="text" class="check-text" value="${text}" placeholder="Step..."><span class="check-del" onclick="this.parentElement.remove()">‚úï</span>`;
            document.getElementById('e-checks').appendChild(div);
        }

        function handleStepEnter(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('new-step-input');
                if(input.value.trim()) { addEditStep(input.value.trim()); input.value = ''; input.focus(); }
            }
        }

        function saveCard() {
            const id = document.getElementById('e-id').value;
            const title = document.getElementById('e-title').value;
            if(!title) return alert("Title required");
            const steps = [];
            document.querySelectorAll('#e-checks .check-item').forEach(el => {
                steps.push({ text: el.querySelector('.check-text').value.trim(), done: el.querySelector('.check-box').classList.contains('checked') });
            });
            const tag = document.getElementById('e-tag').value.trim();

            if(id) {
                const idx = tasks.findIndex(x => x.id === id);
                tasks[idx] = { ...tasks[idx], title, steps, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag };
            } else {
                tasks.push({ id: Date.now().toString(), title, steps, col: 0, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag, archived: false });
            }
            save(); closeEditor(); render();
        }

        // --- CONFIRMATION ---
        function confirmDelete() {
            taskToDeleteId = document.getElementById('e-id').value;
            if(!taskToDeleteId) return; 
            document.getElementById('confirm-yes-btn').onclick = executeDelete;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; taskToDeleteId = null; }

        function executeDelete() {
            if(taskToDeleteId) {
                const t = tasks.find(x => x.id === taskToDeleteId);
                const sunkXP = t.steps.filter(s=>s.done).length * 10;
                const totalLoss = sunkXP + 50;
                tasks = tasks.filter(x => x.id !== taskToDeleteId);
                updateLiveXP(-totalLoss);
                showToast(`FAILED (-${totalLoss} XP)`, true);
                save(); closeConfirm(); closeEditor(); render();
            }
        }

        function deleteCard() { confirmDelete(); }
        function closeEditor() { document.getElementById('editor').style.display = 'none'; }
        
        function toggleArchiveTask() {
            const id = document.getElementById('e-id').value;
            const t = tasks.find(x => x.id === id);
            t.archived = !t.archived; save(); closeEditor(); render();
        }

        function moveCardLogic(idx, dir) {
            let newCol = (tasks[idx].col || 0) + dir;
            if(newCol < 0) newCol = 0; if(newCol > 2) newCol = 2;
            const task = tasks[idx];
            if(task.col !== 2 && newCol === 2) { calculateFinishXP(task); launchConfetti(); task.winXP = calculateFinishValue(task); }
            if(task.col === 2 && newCol !== 2) { 
                const refund = task.winXP || 100;
                const totalLoss = refund + 50; 
                showToast(`RETREAT (-${totalLoss})`, true); updateLiveXP(-totalLoss); task.winXP = 0; 
            }
            task.col = newCol; save(); updateXP(); render();
            setTimeout(() => scrollToColumn(newCol), 100);
        }

        function calculateFinishValue(task) {
            let base = 100; if(task.prio === 'Med') base = 150; if(task.prio === 'High') base = 200;
            let multiplier = 1.0;
            if(task.date) {
                const due = new Date(task.date); const today = new Date();
                due.setHours(0,0,0,0); today.setHours(0,0,0,0);
                if(today < due) multiplier = 1.2; else if(today > due) multiplier = 0.8;
            }
            return Math.floor(base * multiplier);
        }

        function calculateFinishXP(task) {
            const total = calculateFinishValue(task);
            showToast(`VICTORY! (+${total} XP)`, false); updateLiveXP(total);
        }

        function updateLiveXP(amount) {
            const pMult = 1 + (prestige * 0.1); 
            let final = Math.floor(amount * pMult);
            if(amount > 0 && Math.random() < 0.05) { final += 50; showToast("CRITICAL SUCCESS! (+50)", false); showCodex(); }
            userXP += final; if(userXP < 0) userXP = 0; updateXP();
        }

        function updateXP() {
            localStorage.setItem('mc_xp', userXP); localStorage.setItem('mc_prestige', prestige);
            const stats = getLevel(userXP);
            const pct = Math.max(0, Math.min(100, ((userXP - stats.prevReq) / (stats.nextReq - stats.prevReq)) * 100));
            document.getElementById('lvl-badge').innerText = `LVL ${stats.level}`;
            document.getElementById('xp-fill').style.width = `${pct}%`;
            document.getElementById('xp-text').innerText = `${userXP} / ${stats.nextReq}`;
            checkUnlocks(stats.level);
        }

        function getLevel(xp) {
            let lvl = 1; let req = 500; let gap = 500;
            while(xp >= req) { lvl++; gap += 50; req += gap; }
            return { level: lvl, nextReq: req, prevReq: req - gap };
        }

        function showToast(msg, isLoss) {
            const t = document.getElementById('xp-toast');
            t.querySelector('span').innerText = msg;
            t.className = isLoss ? 'loss' : '';
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0px) scale(1)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 10px)'; }, 3000);
        }

        function checkUnlocks(level) {
            const unlockAll = prestige > 0;
            const locks = {
                'theme-wolf': 5, 'theme-neon': 10, 'theme-aperture': 12, 'theme-horror': 15,
                'theme-vapor': 18, 'theme-blueprint': 20, 'theme-terminal': 25, 'theme-gold': 30,
                'theme-nebula': 999, 'theme-midas': 999, 'theme-glitch': 999, 
                'feat-status': 2, 'feat-zen': 8, 'feat-prestige': 50,
                'fx-star': 10, 'fx-coin': 20, 'fx-gem': 30
            };
            for(let id in locks) {
                const btn = document.getElementById(id);
                if(!btn) continue;
                let isUnlocked = false;
                if(id === 'theme-nebula') isUnlocked = prestige >= 1;
                else if(id === 'theme-midas') isUnlocked = prestige >= 2;
                else if(id === 'theme-glitch') isUnlocked = prestige >= 3;
                else isUnlocked = unlockAll || level >= locks[id];
                
                if(isUnlocked) { btn.classList.remove('dd-locked'); if(btn.innerText.includes('üîí')) btn.innerText = btn.innerText.replace(' üîí', ''); } 
                else { btn.classList.add('dd-locked'); if(!btn.innerText.includes('üîí')) btn.innerText += ' üîí'; }
            }
        }

        function setTheme(name, force) {
            const stats = getLevel(userXP);
            const reqs = { 'wolf': 5, 'neon': 10, 'aperture': 12, 'horror': 15, 'vapor': 18, 'blueprint': 20, 'terminal': 25, 'gold': 30 };
            const pReqs = { 'nebula': 1, 'midas': 2, 'glitch': 3 };
            if(!force) {
                if(pReqs[name] && prestige < pReqs[name]) return alert(`LOCKED! Reach Prestige ${pReqs[name]} to unlock.`);
                if(reqs[name] && prestige === 0 && stats.level < reqs[name]) return alert(`LOCKED! Reach Level ${reqs[name]} to unlock.`);
            }
            document.body.className = ''; 
            if(name !== 'default') document.body.classList.add(`theme-${name}`);
            currentTheme = name;
            localStorage.setItem('theme', name);
        }

        function setConfetti(type) {
            const stats = getLevel(userXP);
            const reqs = { 'star': 10, 'coin': 20, 'gem': 30 };
            if(prestige === 0 && reqs[type] && stats.level < reqs[type]) return alert(`Locked until Level ${reqs[type]}`);
            confettiStyle = type;
            localStorage.setItem('mc_fx', type);
        }

        function launchConfetti() {
            const emojis = { 'square': '', 'star': '‚≠ê', 'coin': 'ü™ô', 'gem': 'üíé' };
            const icon = emojis[confettiStyle];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.innerText = icon;
                c.style.left = Math.random()*100 + 'vw';
                if(confettiStyle === 'square') {
                    c.style.width = '10px'; c.style.height = '10px';
                    c.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                }
                c.style.animation = `fall ${Math.random()*1+1}s linear forwards`;
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 2000);
            }
        }
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
        document.head.appendChild(styleSheet);

        // --- FILTERING ---
        function filterTasks() {
            searchTerm = document.getElementById('radar-search').value.toLowerCase();
            render();
        }

        // --- RENDER ENGINE ---
        function render() {
            [0, 1, 2].forEach(i => { document.getElementById(`col-${i}`).innerHTML = ''; document.getElementById(`count-${i}`).innerText = '0'; });
            const today = new Date().toISOString().split('T')[0];
            
            let activeCount = 0;
            let highPrioCount = 0;

            tasks.forEach(t => {
                if (showArchive && !t.archived) return;
                if (!showArchive && t.archived) return;
                
                // DEEP SEARCH: TITLE + TAG + STEPS
                const tag = t.tag || '';
                const stepsMatch = t.steps.some(s => s.text.toLowerCase().includes(searchTerm));
                if(searchTerm && !t.title.toLowerCase().includes(searchTerm) && !tag.toLowerCase().includes(searchTerm) && !stepsMatch) {
                    return;
                }

                if(t.col === 1 && !t.archived) {
                    activeCount++;
                    if(t.prio === 'High') highPrioCount++;
                }

                const total = t.steps.length;
                const done = t.steps.filter(s => s.done).length;
                const pct = total === 0 ? 0 : (done / total) * 100;
                
                let dateHtml = '';
                if(t.date) {
                    const isOverdue = t.date < today && t.col !== 2;
                    const dateObj = new Date(t.date + 'T00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    dateHtml = `<span class="card-date ${isOverdue?'overdue':''}">${dateStr}</span>`;
                }

                const div = document.createElement('div');
                div.className = `card slide-enter p-${t.prio||'Med'}`;
                div.id = `card-${t.id}`;
                div.onclick = () => openViewer(t.id);
                
                const tagHtml = t.tag ? `<span class="tag-pill">${t.tag}</span>` : '';

                div.innerHTML = `<div class="card-top"><span class="card-title">${t.title}</span>${dateHtml}</div>
                                 <div style="margin-bottom:5px;">
                                    <span class="prio-pill pill-${t.prio}">${t.prio}</span>
                                    ${tagHtml}
                                 </div>
                                 <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                                 <div class="card-meta"><span>${done}/${total} Steps</span><span>${pct.toFixed(0)}%</span></div>
                                 <div class="card-actions">
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, -1)">‚Üê</div>
                                    <div class="btn-quick edit-btn" onclick="event.stopPropagation(); openEditor('${t.id}')">‚úèÔ∏è</div>
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, 1)">‚Üí</div>
                                 </div>`;
                const colId = t.col !== undefined ? t.col : 0;
                document.getElementById(`col-${colId}`).appendChild(div);
            });
            
            [0, 1, 2].forEach(i => { 
                const col = document.getElementById(`col-${i}`);
                if(col.innerHTML === '') col.innerHTML = `<div class="empty-msg">Awaiting Orders...</div>`;
                document.getElementById(`count-${i}`).innerText = tasks.filter(t => (t.col||0) === i && !t.archived).length; 
            });
            document.querySelector('h1').innerText = showArchive ? "Cryo-Storage üßä" : "Mission Control üöÄ";
            
            document.getElementById('briefing-text').innerText = `Active: ${activeCount} | Critical: ${highPrioCount}`;
        }

        // --- CAMERA TRACKING ---
        function scrollToColumn(colIdx) {
            const board = document.getElementById('main-board');
            const cols = document.querySelectorAll('.column');
            if (cols[colIdx]) {
                const isMobile = window.innerWidth < 600;
                const scrollLeft = isMobile ? cols[colIdx].offsetLeft - 10 : cols[colIdx].offsetLeft;
                board.scrollTo({ left: scrollLeft, behavior: 'smooth' });
            }
        }

        // --- VIEWER ---
        function openViewer(id) {
            const t = tasks.find(x => x.id === id);
            if(!t) return;
            currentViewId = id;
            document.getElementById('v-title').innerText = t.title;
            document.getElementById('v-prio').innerText = t.prio;
            document.getElementById('v-prio').className = `prio-pill pill-${t.prio}`;
            
            const tagEl = document.getElementById('v-tag');
            if(t.tag) { tagEl.innerText = t.tag; tagEl.style.display = 'inline-block'; } 
            else { tagEl.style.display = 'none'; }

            if(t.date) {
                const dateObj = new Date(t.date + 'T00:00');
                document.getElementById('v-date').innerText = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else { document.getElementById('v-date').innerText = "No Deadline"; }
            
            const container = document.getElementById('v-checks');
            container.innerHTML = '';
            t.steps.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `<div class="check-box ${s.done?'checked':''}" onclick="toggleStepDone('${id}', ${idx})"></div><span class="check-text" style="border:none;">${s.text}</span>`;
                container.appendChild(div);
            });
            document.getElementById('viewer').style.display = 'flex';
        }

        function toggleStepDone(taskId, stepIdx) {
            const t = tasks.find(x => x.id === taskId);
            t.steps[stepIdx].done = !t.steps[stepIdx].done;
            if(t.steps[stepIdx].done) { showToast("+10 XP", false); updateLiveXP(10); }
            else { showToast("-10 XP", true); updateLiveXP(-10); }
            save(); openViewer(taskId); render(); 
        }

        function switchToEdit() { closeViewer(); openEditor(currentViewId); }
        function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

        // --- EDITOR ---
        function openEditor(id = null) {
            const t = id ? tasks.find(x => x.id === id) : { id: '', title: '', steps: [], col: 0, prio:'Med', date:'', tag: '', archived:false };
            document.getElementById('e-id').value = t.id;
            document.getElementById('e-title').value = t.title;
            document.getElementById('e-date').value = t.date;
            document.getElementById('e-prio').value = t.prio || 'Med';
            document.getElementById('e-tag').value = t.tag || '';
            document.getElementById('btn-archive-toggle').innerText = t.archived ? "üî• Thaw" : "üßä Archive";
            const container = document.getElementById('e-checks');
            container.innerHTML = '';
            t.steps.forEach(s => addEditStep(s.text, s.done));
            document.getElementById('editor').style.display = 'flex';
        }

        function addEditStep(text = '', done = false) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `<div class="check-box ${done?'checked':''}" onclick="this.classList.toggle('checked')"></div><input type="text" class="check-text" value="${text}" placeholder="Step..."><span class="check-del" onclick="this.parentElement.remove()">‚úï</span>`;
            document.getElementById('e-checks').appendChild(div);
        }

        function handleStepEnter(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('new-step-input');
                if(input.value.trim()) { addEditStep(input.value.trim()); input.value = ''; input.focus(); }
            }
        }

        function saveCard() {
            const id = document.getElementById('e-id').value;
            const title = document.getElementById('e-title').value;
            if(!title) return alert("Title required");
            const steps = [];
            document.querySelectorAll('#e-checks .check-item').forEach(el => {
                steps.push({ text: el.querySelector('.check-text').value.trim(), done: el.querySelector('.check-box').classList.contains('checked') });
            });
            const tag = document.getElementById('e-tag').value.trim();

            if(id) {
                const idx = tasks.findIndex(x => x.id === id);
                tasks[idx] = { ...tasks[idx], title, steps, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag };
            } else {
                tasks.push({ id: Date.now().toString(), title, steps, col: 0, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag, archived: false });
            }
            save(); closeEditor(); render();
        }

        // --- CONFIRMATION ---
        function confirmDelete() {
            taskToDeleteId = document.getElementById('e-id').value;
            if(!taskToDeleteId) return; 
            document.getElementById('confirm-yes-btn').onclick = executeDelete;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; taskToDeleteId = null; }

        function executeDelete() {
            if(taskToDeleteId) {
                const t = tasks.find(x => x.id === taskToDeleteId);
                const sunkXP = t.steps.filter(s=>s.done).length * 10;
                const totalLoss = sunkXP + 50;
                tasks = tasks.filter(x => x.id !== taskToDeleteId);
                updateLiveXP(-totalLoss);
                showToast(`FAILED (-${totalLoss} XP)`, true);
                save(); closeConfirm(); closeEditor(); render();
            }
        }

        function deleteCard() { confirmDelete(); }
        function closeEditor() { document.getElementById('editor').style.display = 'none'; }
        
        function toggleArchiveTask() {
            const id = document.getElementById('e-id').value;
            const t = tasks.find(x => x.id === id);
            t.archived = !t.archived; save(); closeEditor(); render();
        }

        function moveCardLogic(idx, dir) {
            let newCol = (tasks[idx].col || 0) + dir;
            if(newCol < 0) newCol = 0; if(newCol > 2) newCol = 2;
            const task = tasks[idx];
            if(task.col !== 2 && newCol === 2) { calculateFinishXP(task); launchConfetti(); task.winXP = calculateFinishValue(task); }
            if(task.col === 2 && newCol !== 2) { 
                const refund = task.winXP || 100;
                const totalLoss = refund + 50; 
                showToast(`RETREAT (-${totalLoss})`, true); updateLiveXP(-totalLoss); task.winXP = 0; 
            }
            task.col = newCol; save(); updateXP(); render();
            setTimeout(() => scrollToColumn(newCol), 100);
        }

        function calculateFinishValue(task) {
            let base = 100; if(task.prio === 'Med') base = 150; if(task.prio === 'High') base = 200;
            let multiplier = 1.0;
            if(task.date) {
                const due = new Date(task.date); const today = new Date();
                due.setHours(0,0,0,0); today.setHours(0,0,0,0);
                if(today < due) multiplier = 1.2; else if(today > due) multiplier = 0.8;
            }
            return Math.floor(base * multiplier);
        }

        function calculateFinishXP(task) {
            const total = calculateFinishValue(task);
            showToast(`VICTORY! (+${total} XP)`, false); updateLiveXP(total);
        }

        function updateLiveXP(amount) {
            const pMult = 1 + (prestige * 0.1); 
            let final = Math.floor(amount * pMult);
            if(amount > 0 && Math.random() < 0.05) { final += 50; showToast("CRITICAL SUCCESS! (+50)", false); showCodex(); }
            userXP += final; if(userXP < 0) userXP = 0; updateXP();
        }

        function updateXP() {
            localStorage.setItem('mc_xp', userXP); localStorage.setItem('mc_prestige', prestige);
            const stats = getLevel(userXP);
            const pct = Math.max(0, Math.min(100, ((userXP - stats.prevReq) / (stats.nextReq - stats.prevReq)) * 100));
            document.getElementById('lvl-badge').innerText = `LVL ${stats.level}`;
            document.getElementById('xp-fill').style.width = `${pct}%`;
            document.getElementById('xp-text').innerText = `${userXP} / ${stats.nextReq}`;
            checkUnlocks(stats.level);
        }

        function getLevel(xp) {
            let lvl = 1; let req = 500; let gap = 500;
            while(xp >= req) { lvl++; gap += 50; req += gap; }
            return { level: lvl, nextReq: req, prevReq: req - gap };
        }

        function showToast(msg, isLoss) {
            const t = document.getElementById('xp-toast');
            t.querySelector('span').innerText = msg;
            t.className = isLoss ? 'loss' : '';
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0px) scale(1)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 10px)'; }, 3000);
        }

        function checkUnlocks(level) {
            const unlockAll = prestige > 0;
            const locks = {
                'theme-wolf': 5, 'theme-neon': 10, 'theme-aperture': 12, 'theme-horror': 15,
                'theme-vapor': 18, 'theme-blueprint': 20, 'theme-terminal': 25, 'theme-gold': 30,
                'theme-nebula': 999, 'theme-midas': 999, 'theme-glitch': 999, 
                'feat-status': 2, 'feat-zen': 8, 'feat-prestige': 50,
                'fx-star': 10, 'fx-coin': 20, 'fx-gem': 30
            };
            for(let id in locks) {
                const btn = document.getElementById(id);
                if(!btn) continue;
                let isUnlocked = false;
                if(id === 'theme-nebula') isUnlocked = prestige >= 1;
                else if(id === 'theme-midas') isUnlocked = prestige >= 2;
                else if(id === 'theme-glitch') isUnlocked = prestige >= 3;
                else isUnlocked = unlockAll || level >= locks[id];
                
                if(isUnlocked) { btn.classList.remove('dd-locked'); if(btn.innerText.includes('üîí')) btn.innerText = btn.innerText.replace(' üîí', ''); } 
                else { btn.classList.add('dd-locked'); if(!btn.innerText.includes('üîí')) btn.innerText += ' üîí'; }
            }
        }

        function setTheme(name, force) {
            const stats = getLevel(userXP);
            const reqs = { 'wolf': 5, 'neon': 10, 'aperture': 12, 'horror': 15, 'vapor': 18, 'blueprint': 20, 'terminal': 25, 'gold': 30 };
            const pReqs = { 'nebula': 1, 'midas': 2, 'glitch': 3 };
            if(!force) {
                if(pReqs[name] && prestige < pReqs[name]) return alert(`LOCKED! Reach Prestige ${pReqs[name]} to unlock.`);
                if(reqs[name] && prestige === 0 && stats.level < reqs[name]) return alert(`LOCKED! Reach Level ${reqs[name]} to unlock.`);
            }
            document.body.className = ''; 
            if(name !== 'default') document.body.classList.add(`theme-${name}`);
            currentTheme = name;
            localStorage.setItem('theme', name);
        }

        function setConfetti(type) {
            const stats = getLevel(userXP);
            const reqs = { 'star': 10, 'coin': 20, 'gem': 30 };
            if(prestige === 0 && reqs[type] && stats.level < reqs[type]) return alert(`Locked until Level ${reqs[type]}`);
            confettiStyle = type;
            localStorage.setItem('mc_fx', type);
        }

        function launchConfetti() {
            const emojis = { 'square': '', 'star': '‚≠ê', 'coin': 'ü™ô', 'gem': 'üíé' };
            const icon = emojis[confettiStyle];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.innerText = icon;
                c.style.left = Math.random()*100 + 'vw';
                if(confettiStyle === 'square') {
                    c.style.width = '10px'; c.style.height = '10px';
                    c.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                }
                c.style.animation = `fall ${Math.random()*1+1}s linear forwards`;
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 2000);
            }
        }
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
        document.head.appendChild(styleSheet);

        // --- FILTERING ---
        function filterTasks() {
            searchTerm = document.getElementById('radar-search').value.toLowerCase();
            render();
        }

        // --- RENDER ENGINE ---
        function render() {
            [0, 1, 2].forEach(i => { document.getElementById(`col-${i}`).innerHTML = ''; document.getElementById(`count-${i}`).innerText = '0'; });
            const today = new Date().toISOString().split('T')[0];
            
            let activeCount = 0;
            let highPrioCount = 0;

            tasks.forEach(t => {
                if (showArchive && !t.archived) return;
                if (!showArchive && t.archived) return;
                
                // DEEP SEARCH: TITLE + TAG + STEPS
                const tag = t.tag || '';
                const stepsMatch = t.steps.some(s => s.text.toLowerCase().includes(searchTerm));
                if(searchTerm && !t.title.toLowerCase().includes(searchTerm) && !tag.toLowerCase().includes(searchTerm) && !stepsMatch) {
                    return;
                }

                if(t.col === 1 && !t.archived) {
                    activeCount++;
                    if(t.prio === 'High') highPrioCount++;
                }

                const total = t.steps.length;
                const done = t.steps.filter(s => s.done).length;
                const pct = total === 0 ? 0 : (done / total) * 100;
                
                let dateHtml = '';
                if(t.date) {
                    const isOverdue = t.date < today && t.col !== 2;
                    const dateObj = new Date(t.date + 'T00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    dateHtml = `<span class="card-date ${isOverdue?'overdue':''}">${dateStr}</span>`;
                }

                const div = document.createElement('div');
                div.className = `card slide-enter p-${t.prio||'Med'}`;
                div.id = `card-${t.id}`;
                div.onclick = () => openViewer(t.id);
                
                const tagHtml = t.tag ? `<span class="tag-pill">${t.tag}</span>` : '';

                div.innerHTML = `<div class="card-top"><span class="card-title">${t.title}</span>${dateHtml}</div>
                                 <div style="margin-bottom:5px;">
                                    <span class="prio-pill pill-${t.prio}">${t.prio}</span>
                                    ${tagHtml}
                                 </div>
                                 <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                                 <div class="card-meta"><span>${done}/${total} Steps</span><span>${pct.toFixed(0)}%</span></div>
                                 <div class="card-actions">
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, -1)">‚Üê</div>
                                    <div class="btn-quick edit-btn" onclick="event.stopPropagation(); openEditor('${t.id}')">‚úèÔ∏è</div>
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, 1)">‚Üí</div>
                                 </div>`;
                const colId = t.col !== undefined ? t.col : 0;
                document.getElementById(`col-${colId}`).appendChild(div);
            });
            
            [0, 1, 2].forEach(i => { 
                const col = document.getElementById(`col-${i}`);
                if(col.innerHTML === '') col.innerHTML = `<div class="empty-msg">Awaiting Orders...</div>`;
                document.getElementById(`count-${i}`).innerText = tasks.filter(t => (t.col||0) === i && !t.archived).length; 
            });
            document.querySelector('h1').innerText = showArchive ? "Cryo-Storage üßä" : "Mission Control üöÄ";
            
            document.getElementById('briefing-text').innerText = `Active: ${activeCount} | Critical: ${highPrioCount}`;
        }

        // --- CAMERA TRACKING ---
        function scrollToColumn(colIdx) {
            const board = document.getElementById('main-board');
            const cols = document.querySelectorAll('.column');
            if (cols[colIdx]) {
                const isMobile = window.innerWidth < 600;
                const scrollLeft = isMobile ? cols[colIdx].offsetLeft - 10 : cols[colIdx].offsetLeft;
                board.scrollTo({ left: scrollLeft, behavior: 'smooth' });
            }
        }

        // --- VIEWER ---
        function openViewer(id) {
            const t = tasks.find(x => x.id === id);
            if(!t) return;
            currentViewId = id;
            document.getElementById('v-title').innerText = t.title;
            document.getElementById('v-prio').innerText = t.prio;
            document.getElementById('v-prio').className = `prio-pill pill-${t.prio}`;
            
            const tagEl = document.getElementById('v-tag');
            if(t.tag) { tagEl.innerText = t.tag; tagEl.style.display = 'inline-block'; } 
            else { tagEl.style.display = 'none'; }

            if(t.date) {
                const dateObj = new Date(t.date + 'T00:00');
                document.getElementById('v-date').innerText = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else { document.getElementById('v-date').innerText = "No Deadline"; }
            
            const container = document.getElementById('v-checks');
            container.innerHTML = '';
            t.steps.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `<div class="check-box ${s.done?'checked':''}" onclick="toggleStepDone('${id}', ${idx})"></div><span class="check-text" style="border:none;">${s.text}</span>`;
                container.appendChild(div);
            });
            document.getElementById('viewer').style.display = 'flex';
        }

        function toggleStepDone(taskId, stepIdx) {
            const t = tasks.find(x => x.id === taskId);
            t.steps[stepIdx].done = !t.steps[stepIdx].done;
            if(t.steps[stepIdx].done) { showToast("+10 XP", false); updateLiveXP(10); }
            else { showToast("-10 XP", true); updateLiveXP(-10); }
            save(); openViewer(taskId); render(); 
        }

        function switchToEdit() { closeViewer(); openEditor(currentViewId); }
        function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

        // --- EDITOR ---
        function openEditor(id = null) {
            const t = id ? tasks.find(x => x.id === id) : { id: '', title: '', steps: [], col: 0, prio:'Med', date:'', tag: '', archived:false };
            document.getElementById('e-id').value = t.id;
            document.getElementById('e-title').value = t.title;
            document.getElementById('e-date').value = t.date;
            document.getElementById('e-prio').value = t.prio || 'Med';
            document.getElementById('e-tag').value = t.tag || '';
            document.getElementById('btn-archive-toggle').innerText = t.archived ? "üî• Thaw" : "üßä Archive";
            const container = document.getElementById('e-checks');
            container.innerHTML = '';
            t.steps.forEach(s => addEditStep(s.text, s.done));
            document.getElementById('editor').style.display = 'flex';
        }

        function addEditStep(text = '', done = false) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `<div class="check-box ${done?'checked':''}" onclick="this.classList.toggle('checked')"></div><input type="text" class="check-text" value="${text}" placeholder="Step..."><span class="check-del" onclick="this.parentElement.remove()">‚úï</span>`;
            document.getElementById('e-checks').appendChild(div);
        }

        function handleStepEnter(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('new-step-input');
                if(input.value.trim()) { addEditStep(input.value.trim()); input.value = ''; input.focus(); }
            }
        }

        function saveCard() {
            const id = document.getElementById('e-id').value;
            const title = document.getElementById('e-title').value;
            if(!title) return alert("Title required");
            const steps = [];
            document.querySelectorAll('#e-checks .check-item').forEach(el => {
                steps.push({ text: el.querySelector('.check-text').value.trim(), done: el.querySelector('.check-box').classList.contains('checked') });
            });
            const tag = document.getElementById('e-tag').value.trim();

            if(id) {
                const idx = tasks.findIndex(x => x.id === id);
                tasks[idx] = { ...tasks[idx], title, steps, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag };
            } else {
                tasks.push({ id: Date.now().toString(), title, steps, col: 0, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag, archived: false });
            }
            save(); closeEditor(); render();
        }

        // --- CONFIRMATION ---
        function confirmDelete() {
            taskToDeleteId = document.getElementById('e-id').value;
            if(!taskToDeleteId) return; 
            document.getElementById('confirm-yes-btn').onclick = executeDelete;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; taskToDeleteId = null; }

        function executeDelete() {
            if(taskToDeleteId) {
                const t = tasks.find(x => x.id === taskToDeleteId);
                const sunkXP = t.steps.filter(s=>s.done).length * 10;
                const totalLoss = sunkXP + 50;
                tasks = tasks.filter(x => x.id !== taskToDeleteId);
                updateLiveXP(-totalLoss);
                showToast(`FAILED (-${totalLoss} XP)`, true);
                save(); closeConfirm(); closeEditor(); render();
            }
        }

        function deleteCard() { confirmDelete(); }
        function closeEditor() { document.getElementById('editor').style.display = 'none'; }
        
        function toggleArchiveTask() {
            const id = document.getElementById('e-id').value;
            const t = tasks.find(x => x.id === id);
            t.archived = !t.archived; save(); closeEditor(); render();
        }

        function moveCardLogic(idx, dir) {
            let newCol = (tasks[idx].col || 0) + dir;
            if(newCol < 0) newCol = 0; if(newCol > 2) newCol = 2;
            const task = tasks[idx];
            if(task.col !== 2 && newCol === 2) { calculateFinishXP(task); launchConfetti(); task.winXP = calculateFinishValue(task); }
            if(task.col === 2 && newCol !== 2) { 
                const refund = task.winXP || 100;
                const totalLoss = refund + 50; 
                showToast(`RETREAT (-${totalLoss})`, true); updateLiveXP(-totalLoss); task.winXP = 0; 
            }
            task.col = newCol; save(); updateXP(); render();
            setTimeout(() => scrollToColumn(newCol), 100);
        }

        function calculateFinishValue(task) {
            let base = 100; if(task.prio === 'Med') base = 150; if(task.prio === 'High') base = 200;
            let multiplier = 1.0;
            if(task.date) {
                const due = new Date(task.date); const today = new Date();
                due.setHours(0,0,0,0); today.setHours(0,0,0,0);
                if(today < due) multiplier = 1.2; else if(today > due) multiplier = 0.8;
            }
            return Math.floor(base * multiplier);
        }

        function calculateFinishXP(task) {
            const total = calculateFinishValue(task);
            showToast(`VICTORY! (+${total} XP)`, false); updateLiveXP(total);
        }

        function updateLiveXP(amount) {
            const pMult = 1 + (prestige * 0.1); 
            let final = Math.floor(amount * pMult);
            if(amount > 0 && Math.random() < 0.05) { final += 50; showToast("CRITICAL SUCCESS! (+50)", false); showCodex(); }
            userXP += final; if(userXP < 0) userXP = 0; updateXP();
        }

        function updateXP() {
            localStorage.setItem('mc_xp', userXP); localStorage.setItem('mc_prestige', prestige);
            const stats = getLevel(userXP);
            const pct = Math.max(0, Math.min(100, ((userXP - stats.prevReq) / (stats.nextReq - stats.prevReq)) * 100));
            document.getElementById('lvl-badge').innerText = `LVL ${stats.level}`;
            document.getElementById('xp-fill').style.width = `${pct}%`;
            document.getElementById('xp-text').innerText = `${userXP} / ${stats.nextReq}`;
            checkUnlocks(stats.level);
        }

        function getLevel(xp) {
            let lvl = 1; let req = 500; let gap = 500;
            while(xp >= req) { lvl++; gap += 50; req += gap; }
            return { level: lvl, nextReq: req, prevReq: req - gap };
        }

        function showToast(msg, isLoss) {
            const t = document.getElementById('xp-toast');
            t.querySelector('span').innerText = msg;
            t.className = isLoss ? 'loss' : '';
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0px) scale(1)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 10px)'; }, 3000);
        }

        function checkUnlocks(level) {
            const unlockAll = prestige > 0;
            const locks = {
                'theme-wolf': 5, 'theme-neon': 10, 'theme-aperture': 12, 'theme-horror': 15,
                'theme-vapor': 18, 'theme-blueprint': 20, 'theme-terminal': 25, 'theme-gold': 30,
                'theme-nebula': 999, 'theme-midas': 999, 'theme-glitch': 999, 
                'feat-status': 2, 'feat-zen': 8, 'feat-prestige': 50,
                'fx-star': 10, 'fx-coin': 20, 'fx-gem': 30
            };
            for(let id in locks) {
                const btn = document.getElementById(id);
                if(!btn) continue;
                let isUnlocked = false;
                if(id === 'theme-nebula') isUnlocked = prestige >= 1;
                else if(id === 'theme-midas') isUnlocked = prestige >= 2;
                else if(id === 'theme-glitch') isUnlocked = prestige >= 3;
                else isUnlocked = unlockAll || level >= locks[id];
                
                if(isUnlocked) { btn.classList.remove('dd-locked'); if(btn.innerText.includes('üîí')) btn.innerText = btn.innerText.replace(' üîí', ''); } 
                else { btn.classList.add('dd-locked'); if(!btn.innerText.includes('üîí')) btn.innerText += ' üîí'; }
            }
        }

        function setTheme(name, force) {
            const stats = getLevel(userXP);
            const reqs = { 'wolf': 5, 'neon': 10, 'aperture': 12, 'horror': 15, 'vapor': 18, 'blueprint': 20, 'terminal': 25, 'gold': 30 };
            const pReqs = { 'nebula': 1, 'midas': 2, 'glitch': 3 };
            if(!force) {
                if(pReqs[name] && prestige < pReqs[name]) return alert(`LOCKED! Reach Prestige ${pReqs[name]} to unlock.`);
                if(reqs[name] && prestige === 0 && stats.level < reqs[name]) return alert(`LOCKED! Reach Level ${reqs[name]} to unlock.`);
            }
            document.body.className = ''; 
            if(name !== 'default') document.body.classList.add(`theme-${name}`);
            currentTheme = name;
            localStorage.setItem('theme', name);
        }

        function setConfetti(type) {
            const stats = getLevel(userXP);
            const reqs = { 'star': 10, 'coin': 20, 'gem': 30 };
            if(prestige === 0 && reqs[type] && stats.level < reqs[type]) return alert(`Locked until Level ${reqs[type]}`);
            confettiStyle = type;
            localStorage.setItem('mc_fx', type);
        }

        function launchConfetti() {
            const emojis = { 'square': '', 'star': '‚≠ê', 'coin': 'ü™ô', 'gem': 'üíé' };
            const icon = emojis[confettiStyle];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.innerText = icon;
                c.style.left = Math.random()*100 + 'vw';
                if(confettiStyle === 'square') {
                    c.style.width = '10px'; c.style.height = '10px';
                    c.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                }
                c.style.animation = `fall ${Math.random()*1+1}s linear forwards`;
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 2000);
            }
        }
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
        document.head.appendChild(styleSheet);

        // --- FILTERING ---
        function filterTasks() {
            searchTerm = document.getElementById('radar-search').value.toLowerCase();
            render();
        }

        // --- RENDER ENGINE ---
        function render() {
            [0, 1, 2].forEach(i => { document.getElementById(`col-${i}`).innerHTML = ''; document.getElementById(`count-${i}`).innerText = '0'; });
            const today = new Date().toISOString().split('T')[0];
            
            let activeCount = 0;
            let highPrioCount = 0;

            tasks.forEach(t => {
                if (showArchive && !t.archived) return;
                if (!showArchive && t.archived) return;
                
                // DEEP SEARCH: TITLE + TAG + STEPS
                const tag = t.tag || '';
                const stepsMatch = t.steps.some(s => s.text.toLowerCase().includes(searchTerm));
                if(searchTerm && !t.title.toLowerCase().includes(searchTerm) && !tag.toLowerCase().includes(searchTerm) && !stepsMatch) {
                    return;
                }

                if(t.col === 1 && !t.archived) {
                    activeCount++;
                    if(t.prio === 'High') highPrioCount++;
                }

                const total = t.steps.length;
                const done = t.steps.filter(s => s.done).length;
                const pct = total === 0 ? 0 : (done / total) * 100;
                
                let dateHtml = '';
                if(t.date) {
                    const isOverdue = t.date < today && t.col !== 2;
                    const dateObj = new Date(t.date + 'T00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    dateHtml = `<span class="card-date ${isOverdue?'overdue':''}">${dateStr}</span>`;
                }

                const div = document.createElement('div');
                div.className = `card slide-enter p-${t.prio||'Med'}`;
                div.id = `card-${t.id}`;
                div.onclick = () => openViewer(t.id);
                
                const tagHtml = t.tag ? `<span class="tag-pill">${t.tag}</span>` : '';

                div.innerHTML = `<div class="card-top"><span class="card-title">${t.title}</span>${dateHtml}</div>
                                 <div style="margin-bottom:5px;">
                                    <span class="prio-pill pill-${t.prio}">${t.prio}</span>
                                    ${tagHtml}
                                 </div>
                                 <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                                 <div class="card-meta"><span>${done}/${total} Steps</span><span>${pct.toFixed(0)}%</span></div>
                                 <div class="card-actions">
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, -1)">‚Üê</div>
                                    <div class="btn-quick edit-btn" onclick="event.stopPropagation(); openEditor('${t.id}')">‚úèÔ∏è</div>
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, 1)">‚Üí</div>
                                 </div>`;
                const colId = t.col !== undefined ? t.col : 0;
                document.getElementById(`col-${colId}`).appendChild(div);
            });
            
            [0, 1, 2].forEach(i => { 
                const col = document.getElementById(`col-${i}`);
                if(col.innerHTML === '') col.innerHTML = `<div class="empty-msg">Awaiting Orders...</div>`;
                document.getElementById(`count-${i}`).innerText = tasks.filter(t => (t.col||0) === i && !t.archived).length; 
            });
            document.querySelector('h1').innerText = showArchive ? "Cryo-Storage üßä" : "Mission Control üöÄ";
            
            document.getElementById('briefing-text').innerText = `Active: ${activeCount} | Critical: ${highPrioCount}`;
        }

        // --- CAMERA TRACKING ---
        function scrollToColumn(colIdx) {
            const board = document.getElementById('main-board');
            const cols = document.querySelectorAll('.column');
            if (cols[colIdx]) {
                const isMobile = window.innerWidth < 600;
                const scrollLeft = isMobile ? cols[colIdx].offsetLeft - 10 : cols[colIdx].offsetLeft;
                board.scrollTo({ left: scrollLeft, behavior: 'smooth' });
            }
        }

        // --- VIEWER ---
        function openViewer(id) {
            const t = tasks.find(x => x.id === id);
            if(!t) return;
            currentViewId = id;
            document.getElementById('v-title').innerText = t.title;
            document.getElementById('v-prio').innerText = t.prio;
            document.getElementById('v-prio').className = `prio-pill pill-${t.prio}`;
            
            const tagEl = document.getElementById('v-tag');
            if(t.tag) { tagEl.innerText = t.tag; tagEl.style.display = 'inline-block'; } 
            else { tagEl.style.display = 'none'; }

            if(t.date) {
                const dateObj = new Date(t.date + 'T00:00');
                document.getElementById('v-date').innerText = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else { document.getElementById('v-date').innerText = "No Deadline"; }
            
            const container = document.getElementById('v-checks');
            container.innerHTML = '';
            t.steps.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `<div class="check-box ${s.done?'checked':''}" onclick="toggleStepDone('${id}', ${idx})"></div><span class="check-text" style="border:none;">${s.text}</span>`;
                container.appendChild(div);
            });
            document.getElementById('viewer').style.display = 'flex';
        }

        function toggleStepDone(taskId, stepIdx) {
            const t = tasks.find(x => x.id === taskId);
            t.steps[stepIdx].done = !t.steps[stepIdx].done;
            if(t.steps[stepIdx].done) { showToast("+10 XP", false); updateLiveXP(10); }
            else { showToast("-10 XP", true); updateLiveXP(-10); }
            save(); openViewer(taskId); render(); 
        }

        function switchToEdit() { closeViewer(); openEditor(currentViewId); }
        function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

        // --- EDITOR ---
        function openEditor(id = null) {
            const t = id ? tasks.find(x => x.id === id) : { id: '', title: '', steps: [], col: 0, prio:'Med', date:'', tag: '', archived:false };
            document.getElementById('e-id').value = t.id;
            document.getElementById('e-title').value = t.title;
            document.getElementById('e-date').value = t.date;
            document.getElementById('e-prio').value = t.prio || 'Med';
            document.getElementById('e-tag').value = t.tag || '';
            document.getElementById('btn-archive-toggle').innerText = t.archived ? "üî• Thaw" : "üßä Archive";
            const container = document.getElementById('e-checks');
            container.innerHTML = '';
            t.steps.forEach(s => addEditStep(s.text, s.done));
            document.getElementById('editor').style.display = 'flex';
        }

        function addEditStep(text = '', done = false) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `<div class="check-box ${done?'checked':''}" onclick="this.classList.toggle('checked')"></div><input type="text" class="check-text" value="${text}" placeholder="Step..."><span class="check-del" onclick="this.parentElement.remove()">‚úï</span>`;
            document.getElementById('e-checks').appendChild(div);
        }

        function handleStepEnter(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('new-step-input');
                if(input.value.trim()) { addEditStep(input.value.trim()); input.value = ''; input.focus(); }
            }
        }

        function saveCard() {
            const id = document.getElementById('e-id').value;
            const title = document.getElementById('e-title').value;
            if(!title) return alert("Title required");
            const steps = [];
            document.querySelectorAll('#e-checks .check-item').forEach(el => {
                steps.push({ text: el.querySelector('.check-text').value.trim(), done: el.querySelector('.check-box').classList.contains('checked') });
            });
            const tag = document.getElementById('e-tag').value.trim();

            if(id) {
                const idx = tasks.findIndex(x => x.id === id);
                tasks[idx] = { ...tasks[idx], title, steps, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag };
            } else {
                tasks.push({ id: Date.now().toString(), title, steps, col: 0, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag, archived: false });
            }
            save(); closeEditor(); render();
        }

        // --- CONFIRMATION ---
        function confirmDelete() {
            taskToDeleteId = document.getElementById('e-id').value;
            if(!taskToDeleteId) return; 
            document.getElementById('confirm-yes-btn').onclick = executeDelete;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; taskToDeleteId = null; }

        function executeDelete() {
            if(taskToDeleteId) {
                const t = tasks.find(x => x.id === taskToDeleteId);
                const sunkXP = t.steps.filter(s=>s.done).length * 10;
                const totalLoss = sunkXP + 50;
                tasks = tasks.filter(x => x.id !== taskToDeleteId);
                updateLiveXP(-totalLoss);
                showToast(`FAILED (-${totalLoss} XP)`, true);
                save(); closeConfirm(); closeEditor(); render();
            }
        }

        function deleteCard() { confirmDelete(); }
        function closeEditor() { document.getElementById('editor').style.display = 'none'; }
        
        function toggleArchiveTask() {
            const id = document.getElementById('e-id').value;
            const t = tasks.find(x => x.id === id);
            t.archived = !t.archived; save(); closeEditor(); render();
        }

        function moveCardLogic(idx, dir) {
            let newCol = (tasks[idx].col || 0) + dir;
            if(newCol < 0) newCol = 0; if(newCol > 2) newCol = 2;
            const task = tasks[idx];
            if(task.col !== 2 && newCol === 2) { calculateFinishXP(task); launchConfetti(); task.winXP = calculateFinishValue(task); }
            if(task.col === 2 && newCol !== 2) { 
                const refund = task.winXP || 100;
                const totalLoss = refund + 50; 
                showToast(`RETREAT (-${totalLoss})`, true); updateLiveXP(-totalLoss); task.winXP = 0; 
            }
            task.col = newCol; save(); updateXP(); render();
            setTimeout(() => scrollToColumn(newCol), 100);
        }

        function calculateFinishValue(task) {
            let base = 100; if(task.prio === 'Med') base = 150; if(task.prio === 'High') base = 200;
            let multiplier = 1.0;
            if(task.date) {
                const due = new Date(task.date); const today = new Date();
                due.setHours(0,0,0,0); today.setHours(0,0,0,0);
                if(today < due) multiplier = 1.2; else if(today > due) multiplier = 0.8;
            }
            return Math.floor(base * multiplier);
        }

        function calculateFinishXP(task) {
            const total = calculateFinishValue(task);
            showToast(`VICTORY! (+${total} XP)`, false); updateLiveXP(total);
        }

        function updateLiveXP(amount) {
            const pMult = 1 + (prestige * 0.1); 
            let final = Math.floor(amount * pMult);
            if(amount > 0 && Math.random() < 0.05) { final += 50; showToast("CRITICAL SUCCESS! (+50)", false); showCodex(); }
            userXP += final; if(userXP < 0) userXP = 0; updateXP();
        }

        function updateXP() {
            localStorage.setItem('mc_xp', userXP); localStorage.setItem('mc_prestige', prestige);
            const stats = getLevel(userXP);
            const pct = Math.max(0, Math.min(100, ((userXP - stats.prevReq) / (stats.nextReq - stats.prevReq)) * 100));
            document.getElementById('lvl-badge').innerText = `LVL ${stats.level}`;
            document.getElementById('xp-fill').style.width = `${pct}%`;
            document.getElementById('xp-text').innerText = `${userXP} / ${stats.nextReq}`;
            checkUnlocks(stats.level);
        }

        function getLevel(xp) {
            let lvl = 1; let req = 500; let gap = 500;
            while(xp >= req) { lvl++; gap += 50; req += gap; }
            return { level: lvl, nextReq: req, prevReq: req - gap };
        }

        function showToast(msg, isLoss) {
            const t = document.getElementById('xp-toast');
            t.querySelector('span').innerText = msg;
            t.className = isLoss ? 'loss' : '';
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0px) scale(1)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 10px)'; }, 3000);
        }

        function checkUnlocks(level) {
            const unlockAll = prestige > 0;
            const locks = {
                'theme-wolf': 5, 'theme-neon': 10, 'theme-aperture': 12, 'theme-horror': 15,
                'theme-vapor': 18, 'theme-blueprint': 20, 'theme-terminal': 25, 'theme-gold': 30,
                'theme-nebula': 999, 'theme-midas': 999, 'theme-glitch': 999, 
                'feat-status': 2, 'feat-zen': 8, 'feat-prestige': 50,
                'fx-star': 10, 'fx-coin': 20, 'fx-gem': 30
            };
            for(let id in locks) {
                const btn = document.getElementById(id);
                if(!btn) continue;
                let isUnlocked = false;
                if(id === 'theme-nebula') isUnlocked = prestige >= 1;
                else if(id === 'theme-midas') isUnlocked = prestige >= 2;
                else if(id === 'theme-glitch') isUnlocked = prestige >= 3;
                else isUnlocked = unlockAll || level >= locks[id];
                
                if(isUnlocked) { btn.classList.remove('dd-locked'); if(btn.innerText.includes('üîí')) btn.innerText = btn.innerText.replace(' üîí', ''); } 
                else { btn.classList.add('dd-locked'); if(!btn.innerText.includes('üîí')) btn.innerText += ' üîí'; }
            }
        }

        function setTheme(name, force) {
            const stats = getLevel(userXP);
            const reqs = { 'wolf': 5, 'neon': 10, 'aperture': 12, 'horror': 15, 'vapor': 18, 'blueprint': 20, 'terminal': 25, 'gold': 30 };
            const pReqs = { 'nebula': 1, 'midas': 2, 'glitch': 3 };
            if(!force) {
                if(pReqs[name] && prestige < pReqs[name]) return alert(`LOCKED! Reach Prestige ${pReqs[name]} to unlock.`);
                if(reqs[name] && prestige === 0 && stats.level < reqs[name]) return alert(`LOCKED! Reach Level ${reqs[name]} to unlock.`);
            }
            document.body.className = ''; 
            if(name !== 'default') document.body.classList.add(`theme-${name}`);
            currentTheme = name;
            localStorage.setItem('theme', name);
        }

        function setConfetti(type) {
            const stats = getLevel(userXP);
            const reqs = { 'star': 10, 'coin': 20, 'gem': 30 };
            if(prestige === 0 && reqs[type] && stats.level < reqs[type]) return alert(`Locked until Level ${reqs[type]}`);
            confettiStyle = type;
            localStorage.setItem('mc_fx', type);
        }

        function launchConfetti() {
            const emojis = { 'square': '', 'star': '‚≠ê', 'coin': 'ü™ô', 'gem': 'üíé' };
            const icon = emojis[confettiStyle];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.innerText = icon;
                c.style.left = Math.random()*100 + 'vw';
                if(confettiStyle === 'square') {
                    c.style.width = '10px'; c.style.height = '10px';
                    c.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                }
                c.style.animation = `fall ${Math.random()*1+1}s linear forwards`;
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 2000);
            }
        }
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
        document.head.appendChild(styleSheet);

        // --- FILTERING ---
        function filterTasks() {
            searchTerm = document.getElementById('radar-search').value.toLowerCase();
            render();
        }

        // --- RENDER ENGINE ---
        function render() {
            [0, 1, 2].forEach(i => { document.getElementById(`col-${i}`).innerHTML = ''; document.getElementById(`count-${i}`).innerText = '0'; });
            const today = new Date().toISOString().split('T')[0];
            
            let activeCount = 0;
            let highPrioCount = 0;

            tasks.forEach(t => {
                if (showArchive && !t.archived) return;
                if (!showArchive && t.archived) return;
                
                // DEEP SEARCH: TITLE + TAG + STEPS
                const tag = t.tag || '';
                const stepsMatch = t.steps.some(s => s.text.toLowerCase().includes(searchTerm));
                if(searchTerm && !t.title.toLowerCase().includes(searchTerm) && !tag.toLowerCase().includes(searchTerm) && !stepsMatch) {
                    return;
                }

                if(t.col === 1 && !t.archived) {
                    activeCount++;
                    if(t.prio === 'High') highPrioCount++;
                }

                const total = t.steps.length;
                const done = t.steps.filter(s => s.done).length;
                const pct = total === 0 ? 0 : (done / total) * 100;
                
                let dateHtml = '';
                if(t.date) {
                    const isOverdue = t.date < today && t.col !== 2;
                    const dateObj = new Date(t.date + 'T00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    dateHtml = `<span class="card-date ${isOverdue?'overdue':''}">${dateStr}</span>`;
                }

                const div = document.createElement('div');
                div.className = `card slide-enter p-${t.prio||'Med'}`;
                div.id = `card-${t.id}`;
                div.onclick = () => openViewer(t.id);
                
                const tagHtml = t.tag ? `<span class="tag-pill">${t.tag}</span>` : '';

                div.innerHTML = `<div class="card-top"><span class="card-title">${t.title}</span>${dateHtml}</div>
                                 <div style="margin-bottom:5px;">
                                    <span class="prio-pill pill-${t.prio}">${t.prio}</span>
                                    ${tagHtml}
                                 </div>
                                 <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                                 <div class="card-meta"><span>${done}/${total} Steps</span><span>${pct.toFixed(0)}%</span></div>
                                 <div class="card-actions">
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, -1)">‚Üê</div>
                                    <div class="btn-quick edit-btn" onclick="event.stopPropagation(); openEditor('${t.id}')">‚úèÔ∏è</div>
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, 1)">‚Üí</div>
                                 </div>`;
                const colId = t.col !== undefined ? t.col : 0;
                document.getElementById(`col-${colId}`).appendChild(div);
            });
            
            [0, 1, 2].forEach(i => { 
                const col = document.getElementById(`col-${i}`);
                if(col.innerHTML === '') col.innerHTML = `<div class="empty-msg">Awaiting Orders...</div>`;
                document.getElementById(`count-${i}`).innerText = tasks.filter(t => (t.col||0) === i && !t.archived).length; 
            });
            document.querySelector('h1').innerText = showArchive ? "Cryo-Storage üßä" : "Mission Control üöÄ";
            
            document.getElementById('briefing-text').innerText = `Active: ${activeCount} | Critical: ${highPrioCount}`;
        }

        // --- CAMERA TRACKING ---
        function scrollToColumn(colIdx) {
            const board = document.getElementById('main-board');
            const cols = document.querySelectorAll('.column');
            if (cols[colIdx]) {
                const isMobile = window.innerWidth < 600;
                const scrollLeft = isMobile ? cols[colIdx].offsetLeft - 10 : cols[colIdx].offsetLeft;
                board.scrollTo({ left: scrollLeft, behavior: 'smooth' });
            }
        }

        // --- VIEWER ---
        function openViewer(id) {
            const t = tasks.find(x => x.id === id);
            if(!t) return;
            currentViewId = id;
            document.getElementById('v-title').innerText = t.title;
            document.getElementById('v-prio').innerText = t.prio;
            document.getElementById('v-prio').className = `prio-pill pill-${t.prio}`;
            
            const tagEl = document.getElementById('v-tag');
            if(t.tag) { tagEl.innerText = t.tag; tagEl.style.display = 'inline-block'; } 
            else { tagEl.style.display = 'none'; }

            if(t.date) {
                const dateObj = new Date(t.date + 'T00:00');
                document.getElementById('v-date').innerText = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else { document.getElementById('v-date').innerText = "No Deadline"; }
            
            const container = document.getElementById('v-checks');
            container.innerHTML = '';
            t.steps.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `<div class="check-box ${s.done?'checked':''}" onclick="toggleStepDone('${id}', ${idx})"></div><span class="check-text" style="border:none;">${s.text}</span>`;
                container.appendChild(div);
            });
            document.getElementById('viewer').style.display = 'flex';
        }

        function toggleStepDone(taskId, stepIdx) {
            const t = tasks.find(x => x.id === taskId);
            t.steps[stepIdx].done = !t.steps[stepIdx].done;
            if(t.steps[stepIdx].done) { showToast("+10 XP", false); updateLiveXP(10); }
            else { showToast("-10 XP", true); updateLiveXP(-10); }
            save(); openViewer(taskId); render(); 
        }

        function switchToEdit() { closeViewer(); openEditor(currentViewId); }
        function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

        // --- EDITOR ---
        function openEditor(id = null) {
            const t = id ? tasks.find(x => x.id === id) : { id: '', title: '', steps: [], col: 0, prio:'Med', date:'', tag: '', archived:false };
            document.getElementById('e-id').value = t.id;
            document.getElementById('e-title').value = t.title;
            document.getElementById('e-date').value = t.date;
            document.getElementById('e-prio').value = t.prio || 'Med';
            document.getElementById('e-tag').value = t.tag || '';
            document.getElementById('btn-archive-toggle').innerText = t.archived ? "üî• Thaw" : "üßä Archive";
            const container = document.getElementById('e-checks');
            container.innerHTML = '';
            t.steps.forEach(s => addEditStep(s.text, s.done));
            document.getElementById('editor').style.display = 'flex';
        }

        function addEditStep(text = '', done = false) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `<div class="check-box ${done?'checked':''}" onclick="this.classList.toggle('checked')"></div><input type="text" class="check-text" value="${text}" placeholder="Step..."><span class="check-del" onclick="this.parentElement.remove()">‚úï</span>`;
            document.getElementById('e-checks').appendChild(div);
        }

        function handleStepEnter(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('new-step-input');
                if(input.value.trim()) { addEditStep(input.value.trim()); input.value = ''; input.focus(); }
            }
        }

        function saveCard() {
            const id = document.getElementById('e-id').value;
            const title = document.getElementById('e-title').value;
            if(!title) return alert("Title required");
            const steps = [];
            document.querySelectorAll('#e-checks .check-item').forEach(el => {
                steps.push({ text: el.querySelector('.check-text').value.trim(), done: el.querySelector('.check-box').classList.contains('checked') });
            });
            const tag = document.getElementById('e-tag').value.trim();

            if(id) {
                const idx = tasks.findIndex(x => x.id === id);
                tasks[idx] = { ...tasks[idx], title, steps, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag };
            } else {
                tasks.push({ id: Date.now().toString(), title, steps, col: 0, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag, archived: false });
            }
            save(); closeEditor(); render();
        }

        // --- CONFIRMATION ---
        function confirmDelete() {
            taskToDeleteId = document.getElementById('e-id').value;
            if(!taskToDeleteId) return; 
            document.getElementById('confirm-yes-btn').onclick = executeDelete;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; taskToDeleteId = null; }

        function executeDelete() {
            if(taskToDeleteId) {
                const t = tasks.find(x => x.id === taskToDeleteId);
                const sunkXP = t.steps.filter(s=>s.done).length * 10;
                const totalLoss = sunkXP + 50;
                tasks = tasks.filter(x => x.id !== taskToDeleteId);
                updateLiveXP(-totalLoss);
                showToast(`FAILED (-${totalLoss} XP)`, true);
                save(); closeConfirm(); closeEditor(); render();
            }
        }

        function deleteCard() { confirmDelete(); }
        function closeEditor() { document.getElementById('editor').style.display = 'none'; }
        
        function toggleArchiveTask() {
            const id = document.getElementById('e-id').value;
            const t = tasks.find(x => x.id === id);
            t.archived = !t.archived; save(); closeEditor(); render();
        }

        function moveCardLogic(idx, dir) {
            let newCol = (tasks[idx].col || 0) + dir;
            if(newCol < 0) newCol = 0; if(newCol > 2) newCol = 2;
            const task = tasks[idx];
            if(task.col !== 2 && newCol === 2) { calculateFinishXP(task); launchConfetti(); task.winXP = calculateFinishValue(task); }
            if(task.col === 2 && newCol !== 2) { 
                const refund = task.winXP || 100;
                const totalLoss = refund + 50; 
                showToast(`RETREAT (-${totalLoss})`, true); updateLiveXP(-totalLoss); task.winXP = 0; 
            }
            task.col = newCol; save(); updateXP(); render();
            setTimeout(() => scrollToColumn(newCol), 100);
        }

        function calculateFinishValue(task) {
            let base = 100; if(task.prio === 'Med') base = 150; if(task.prio === 'High') base = 200;
            let multiplier = 1.0;
            if(task.date) {
                const due = new Date(task.date); const today = new Date();
                due.setHours(0,0,0,0); today.setHours(0,0,0,0);
                if(today < due) multiplier = 1.2; else if(today > due) multiplier = 0.8;
            }
            return Math.floor(base * multiplier);
        }

        function calculateFinishXP(task) {
            const total = calculateFinishValue(task);
            showToast(`VICTORY! (+${total} XP)`, false); updateLiveXP(total);
        }

        function updateLiveXP(amount) {
            const pMult = 1 + (prestige * 0.1); 
            let final = Math.floor(amount * pMult);
            if(amount > 0 && Math.random() < 0.05) { final += 50; showToast("CRITICAL SUCCESS! (+50)", false); showCodex(); }
            userXP += final; if(userXP < 0) userXP = 0; updateXP();
        }

        function updateXP() {
            localStorage.setItem('mc_xp', userXP); localStorage.setItem('mc_prestige', prestige);
            const stats = getLevel(userXP);
            const pct = Math.max(0, Math.min(100, ((userXP - stats.prevReq) / (stats.nextReq - stats.prevReq)) * 100));
            document.getElementById('lvl-badge').innerText = `LVL ${stats.level}`;
            document.getElementById('xp-fill').style.width = `${pct}%`;
            document.getElementById('xp-text').innerText = `${userXP} / ${stats.nextReq}`;
            checkUnlocks(stats.level);
        }

        function getLevel(xp) {
            let lvl = 1; let req = 500; let gap = 500;
            while(xp >= req) { lvl++; gap += 50; req += gap; }
            return { level: lvl, nextReq: req, prevReq: req - gap };
        }

        function showToast(msg, isLoss) {
            const t = document.getElementById('xp-toast');
            t.querySelector('span').innerText = msg;
            t.className = isLoss ? 'loss' : '';
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0px) scale(1)';
            setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 10px)'; }, 3000);
        }

        function checkUnlocks(level) {
            const unlockAll = prestige > 0;
            const locks = {
                'theme-wolf': 5, 'theme-neon': 10, 'theme-aperture': 12, 'theme-horror': 15,
                'theme-vapor': 18, 'theme-blueprint': 20, 'theme-terminal': 25, 'theme-gold': 30,
                'theme-nebula': 999, 'theme-midas': 999, 'theme-glitch': 999, 
                'feat-status': 2, 'feat-zen': 8, 'feat-prestige': 50,
                'fx-star': 10, 'fx-coin': 20, 'fx-gem': 30
            };
            for(let id in locks) {
                const btn = document.getElementById(id);
                if(!btn) continue;
                let isUnlocked = false;
                if(id === 'theme-nebula') isUnlocked = prestige >= 1;
                else if(id === 'theme-midas') isUnlocked = prestige >= 2;
                else if(id === 'theme-glitch') isUnlocked = prestige >= 3;
                else isUnlocked = unlockAll || level >= locks[id];
                
                if(isUnlocked) { btn.classList.remove('dd-locked'); if(btn.innerText.includes('üîí')) btn.innerText = btn.innerText.replace(' üîí', ''); } 
                else { btn.classList.add('dd-locked'); if(!btn.innerText.includes('üîí')) btn.innerText += ' üîí'; }
            }
        }

        function setTheme(name, force) {
            const stats = getLevel(userXP);
            const reqs = { 'wolf': 5, 'neon': 10, 'aperture': 12, 'horror': 15, 'vapor': 18, 'blueprint': 20, 'terminal': 25, 'gold': 30 };
            const pReqs = { 'nebula': 1, 'midas': 2, 'glitch': 3 };
            if(!force) {
                if(pReqs[name] && prestige < pReqs[name]) return alert(`LOCKED! Reach Prestige ${pReqs[name]} to unlock.`);
                if(reqs[name] && prestige === 0 && stats.level < reqs[name]) return alert(`LOCKED! Reach Level ${reqs[name]} to unlock.`);
            }
            document.body.className = ''; 
            if(name !== 'default') document.body.classList.add(`theme-${name}`);
            currentTheme = name;
            localStorage.setItem('theme', name);
        }

        function setConfetti(type) {
            const stats = getLevel(userXP);
            const reqs = { 'star': 10, 'coin': 20, 'gem': 30 };
            if(prestige === 0 && reqs[type] && stats.level < reqs[type]) return alert(`Locked until Level ${reqs[type]}`);
            confettiStyle = type;
            localStorage.setItem('mc_fx', type);
        }

        function launchConfetti() {
            const emojis = { 'square': '', 'star': '‚≠ê', 'coin': 'ü™ô', 'gem': 'üíé' };
            const icon = emojis[confettiStyle];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.innerText = icon;
                c.style.left = Math.random()*100 + 'vw';
                if(confettiStyle === 'square') {
                    c.style.width = '10px'; c.style.height = '10px';
                    c.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                }
                c.style.animation = `fall ${Math.random()*1+1}s linear forwards`;
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 2000);
            }
        }
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
        document.head.appendChild(styleSheet);

        // --- FILTERING ---
        function filterTasks() {
            searchTerm = document.getElementById('radar-search').value.toLowerCase();
            render();
        }

        // --- RENDER ENGINE ---
        function render() {
            [0, 1, 2].forEach(i => { document.getElementById(`col-${i}`).innerHTML = ''; document.getElementById(`count-${i}`).innerText = '0'; });
            const today = new Date().toISOString().split('T')[0];
            
            let activeCount = 0;
            let highPrioCount = 0;

            tasks.forEach(t => {
                if (showArchive && !t.archived) return;
                if (!showArchive && t.archived) return;
                
                // DEEP SEARCH: TITLE + TAG + STEPS
                const tag = t.tag || '';
                const stepsMatch = t.steps.some(s => s.text.toLowerCase().includes(searchTerm));
                if(searchTerm && !t.title.toLowerCase().includes(searchTerm) && !tag.toLowerCase().includes(searchTerm) && !stepsMatch) {
                    return;
                }

                if(t.col === 1 && !t.archived) {
                    activeCount++;
                    if(t.prio === 'High') highPrioCount++;
                }

                const total = t.steps.length;
                const done = t.steps.filter(s => s.done).length;
                const pct = total === 0 ? 0 : (done / total) * 100;
                
                let dateHtml = '';
                if(t.date) {
                    const isOverdue = t.date < today && t.col !== 2;
                    const dateObj = new Date(t.date + 'T00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    dateHtml = `<span class="card-date ${isOverdue?'overdue':''}">${dateStr}</span>`;
                }

                const div = document.createElement('div');
                div.className = `card slide-enter p-${t.prio||'Med'}`;
                div.id = `card-${t.id}`;
                div.onclick = () => openViewer(t.id);
                
                const tagHtml = t.tag ? `<span class="tag-pill">${t.tag}</span>` : '';

                div.innerHTML = `<div class="card-top"><span class="card-title">${t.title}</span>${dateHtml}</div>
                                 <div style="margin-bottom:5px;">
                                    <span class="prio-pill pill-${t.prio}">${t.prio}</span>
                                    ${tagHtml}
                                 </div>
                                 <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                                 <div class="card-meta"><span>${done}/${total} Steps</span><span>${pct.toFixed(0)}%</span></div>
                                 <div class="card-actions">
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, -1)">‚Üê</div>
                                    <div class="btn-quick edit-btn" onclick="event.stopPropagation(); openEditor('${t.id}')">‚úèÔ∏è</div>
                                    <div class="btn-quick" onclick="event.stopPropagation(); moveCardLogic(${tasks.indexOf(t)}, 1)">‚Üí</div>
                                 </div>`;
                const colId = t.col !== undefined ? t.col : 0;
                document.getElementById(`col-${colId}`).appendChild(div);
            });
            
            [0, 1, 2].forEach(i => { 
                const col = document.getElementById(`col-${i}`);
                if(col.innerHTML === '') col.innerHTML = `<div class="empty-msg">Awaiting Orders...</div>`;
                document.getElementById(`count-${i}`).innerText = tasks.filter(t => (t.col||0) === i && !t.archived).length; 
            });
            document.querySelector('h1').innerText = showArchive ? "Cryo-Storage üßä" : "Mission Control üöÄ";
            
            document.getElementById('briefing-text').innerText = `Active: ${activeCount} | Critical: ${highPrioCount}`;
        }

        // --- CAMERA TRACKING ---
        function scrollToColumn(colIdx) {
            const board = document.getElementById('main-board');
            const cols = document.querySelectorAll('.column');
            if (cols[colIdx]) {
                const isMobile = window.innerWidth < 600;
                const scrollLeft = isMobile ? cols[colIdx].offsetLeft - 10 : cols[colIdx].offsetLeft;
                board.scrollTo({ left: scrollLeft, behavior: 'smooth' });
            }
        }

        // --- VIEWER ---
        function openViewer(id) {
            const t = tasks.find(x => x.id === id);
            if(!t) return;
            currentViewId = id;
            document.getElementById('v-title').innerText = t.title;
            document.getElementById('v-prio').innerText = t.prio;
            document.getElementById('v-prio').className = `prio-pill pill-${t.prio}`;
            
            const tagEl = document.getElementById('v-tag');
            if(t.tag) { tagEl.innerText = t.tag; tagEl.style.display = 'inline-block'; } 
            else { tagEl.style.display = 'none'; }

            if(t.date) {
                const dateObj = new Date(t.date + 'T00:00');
                document.getElementById('v-date').innerText = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } else { document.getElementById('v-date').innerText = "No Deadline"; }
            
            const container = document.getElementById('v-checks');
            container.innerHTML = '';
            t.steps.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = 'check-item';
                div.innerHTML = `<div class="check-box ${s.done?'checked':''}" onclick="toggleStepDone('${id}', ${idx})"></div><span class="check-text" style="border:none;">${s.text}</span>`;
                container.appendChild(div);
            });
            document.getElementById('viewer').style.display = 'flex';
        }

        function toggleStepDone(taskId, stepIdx) {
            const t = tasks.find(x => x.id === taskId);
            t.steps[stepIdx].done = !t.steps[stepIdx].done;
            if(t.steps[stepIdx].done) { showToast("+10 XP", false); updateLiveXP(10); }
            else { showToast("-10 XP", true); updateLiveXP(-10); }
            save(); openViewer(taskId); render(); 
        }

        function switchToEdit() { closeViewer(); openEditor(currentViewId); }
        function closeViewer() { document.getElementById('viewer').style.display = 'none'; }

        // --- EDITOR ---
        function openEditor(id = null) {
            const t = id ? tasks.find(x => x.id === id) : { id: '', title: '', steps: [], col: 0, prio:'Med', date:'', tag: '', archived:false };
            document.getElementById('e-id').value = t.id;
            document.getElementById('e-title').value = t.title;
            document.getElementById('e-date').value = t.date;
            document.getElementById('e-prio').value = t.prio || 'Med';
            document.getElementById('e-tag').value = t.tag || '';
            document.getElementById('btn-archive-toggle').innerText = t.archived ? "üî• Thaw" : "üßä Archive";
            const container = document.getElementById('e-checks');
            container.innerHTML = '';
            t.steps.forEach(s => addEditStep(s.text, s.done));
            document.getElementById('editor').style.display = 'flex';
        }

        function addEditStep(text = '', done = false) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `<div class="check-box ${done?'checked':''}" onclick="this.classList.toggle('checked')"></div><input type="text" class="check-text" value="${text}" placeholder="Step..."><span class="check-del" onclick="this.parentElement.remove()">‚úï</span>`;
            document.getElementById('e-checks').appendChild(div);
        }

        function handleStepEnter(e) {
            if(e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('new-step-input');
                if(input.value.trim()) { addEditStep(input.value.trim()); input.value = ''; input.focus(); }
            }
        }

        function saveCard() {
            const id = document.getElementById('e-id').value;
            const title = document.getElementById('e-title').value;
            if(!title) return alert("Title required");
            const steps = [];
            document.querySelectorAll('#e-checks .check-item').forEach(el => {
                steps.push({ text: el.querySelector('.check-text').value.trim(), done: el.querySelector('.check-box').classList.contains('checked') });
            });
            const tag = document.getElementById('e-tag').value.trim();

            if(id) {
                const idx = tasks.findIndex(x => x.id === id);
                tasks[idx] = { ...tasks[idx], title, steps, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag };
            } else {
                tasks.push({ id: Date.now().toString(), title, steps, col: 0, prio: document.getElementById('e-prio').value, date: document.getElementById('e-date').value, tag, archived: false });
            }
            save(); closeEditor(); render();
        }

        // --- CONFIRMATION ---
        function confirmDelete() {
            taskToDeleteId = document.getElementById('e-id').value;
            if(!taskToDeleteId) return; 
            document.getElementById('confirm-yes-btn').onclick = executeDelete;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeConfirm() { document.getElementById('confirm-modal').style.display = 'none'; taskToDeleteId = null; }

        function executeDelete() {
            if(taskToDeleteId) {
                const t = tasks.find(x => x.id === taskToDeleteId);
                const sunkXP = t.steps.filter(s=>s.done).length * 10;
                const totalLoss = sunkXP + 50;
                tasks = tasks.filter(x => x.id !== taskToDeleteId);
                updateLiveXP(-totalLoss);
                showToast(`FAILED (-${totalLoss} XP)`, true);
                save(); closeConfirm(); closeEditor(); render();
            }
        }

        function deleteCard() { confirmDelete(); }
        function closeEditor() { document.getElementById('editor').style.display = 'none'; }
        
        function toggleArchiveTask() {
            const id = document.getElementById('e-id').value;
            const t = tasks.find(x => x.id === id);
            t.archived = !t.archived; save(); closeEditor(); render();
        }

        function moveCardLogic(idx, dir) {
            let newCol = (tasks[idx].col || 0) + dir;
            if(newCol < 0) newCol = 0; if(newCol > 2) newCol = 2;
            const task = tasks[idx];
            if(task.col !== 2 && newCol === 2) { calculateFinishXP(task); launchConfetti(); task.winXP = calculateFinishValue(task); }
            if(task.col === 2 && newCol !== 2) { 
                const refund = task.winXP || 100;
                const totalLoss = refund + 50; 
                showToast(`RETREAT (-${totalLoss})`, true); updateLiveXP(-totalLoss); task.winXP = 0; 
            }
            task.col = newCol; save(); updateXP(); render();
            setTimeout(() => scrollToColumn(newCol), 100);
        }

        function calculateFinishValue(task) {
            let base = 100; if(task.prio === 'Med') base = 150; if(task.prio === 'High') base = 200;
            let multiplier = 1.0;
            if(task.date) {
                const due = new Date(task.date); const today = new Date();
                due.setHours(0,0,0,0); today.setHours(0,0,0,0);
                if(today < due) multiplier = 1.2; else if(today > due) multiplier = 0.8;
            }
            return Math.floor(base * multiplier);
        }

        function calculateFinishXP(task) {
            const total = calculateFinishValue(task);
            showToast(`VICTORY! (+${total} XP)`, false); updateLiveXP(total);
        }

        function updateLiveXP(amount) {
            const pMult = 1 + (prestige * 0.1); 
            let final = Math
