<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuestBoard RPG</title>
    <style>
        :root {
            /* --- THEME: LIGHT (Pastel Dream) --- */
            --bg-color: #fff0f5;
            --column-bg: #e6e6fa;
            --card-bg: #fff9fb;
            --text-color: #2d3436; /* Darkened generally */
            --text-sub: #636e72;   /* Darkened for dates */
            
            --prio-low: #74b9ff;
            --prio-med: #00b894;
            --prio-high: #ff7675;
            
            --accent: #00b894;
            --accent-glow: #55efc4;
            --danger: #ff7675;
            
            --input-bg: #ffffff;
            --input-border: #dfe6e9;
            --group-logistics-bg: #e3f2fd; 
            --group-logistics-border: #90caf9;
            --group-objectives-bg: #e8f5e9;
            --group-objectives-border: #a5d6a7;
            
            --modal-text: #2d3436;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --radius: 16px;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* --- THEME: DARK (Midnight Neon) --- */
        body.dark-mode {
            --bg-color: #13131f;
            --column-bg: #1e1e2e;
            --card-bg: #2a2a3c;
            --text-color: #e0e0ff;     
            --text-sub: #a0a0c0; /* Lighter in dark mode for contrast */
            
            --prio-low: #4facfe;
            --prio-med: #00e5ff;
            --prio-high: #ff0055;
            
            --accent: #00e5ff;
            --accent-glow: #00e5ff;
            --danger: #ff4757;

            --input-bg: #1a1a26;
            --input-border: #404055;
            
            --group-logistics-bg: rgba(0, 100, 255, 0.15);
            --group-logistics-border: #0056b3;
            --group-objectives-bg: rgba(0, 255, 127, 0.1);
            --group-objectives-border: #00b894;
            
            --modal-text: #f5f6fa;
        }

        /* Theme Overrides */
        body.theme-wolf { --bg-color: #3e3b36; --column-bg: #5c5549; --card-bg: #4a453d; --text-color: #dcdccc; --prio-med: #dcdccc; --accent: #8c7b6c; --text-sub: #c0c0b0; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; font-family: var(--font); background: var(--bg-color); color: var(--text-color); transition: background 0.3s, color 0.3s; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* HUD */
        #hud { flex-shrink: 0; padding: 15px; background: var(--card-bg); z-index: 100; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 10px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;}
        .hud-top { display: flex; justify-content: space-between; align-items: center; }
        .level-badge { font-weight: 800; font-size: 1.4rem; color: var(--accent); letter-spacing: -0.5px; text-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .progress-container { width: 100%; height: 12px; background: rgba(0,0,0,0.1); border-radius: 6px; overflow: hidden; margin-top: 5px; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-glow)); width: 0%; transition: width 0.5s ease; border-radius: 6px; }
        .progress-bar.glowing { animation: glowPulse 0.8s ease-in-out infinite; }
        @keyframes glowPulse { 0% { box-shadow: 0 0 5px var(--accent); filter: brightness(1); } 50% { box-shadow: 0 0 15px var(--accent), 0 0 5px white; filter: brightness(1.3); } 100% { box-shadow: 0 0 5px var(--accent); filter: brightness(1); } }

        /* FAB */
        .fab {
            position: fixed; bottom: 30px; right: 25px;
            width: 65px; height: 65px;
            background: var(--accent); color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 500; cursor: pointer; transition: transform 0.2s; border: none;
        }
        .fab:active { transform: scale(0.9); }

        /* Buttons */
        button { background: var(--accent); color: #fff; border: none; padding: 10px 18px; border-radius: var(--radius); font-weight: 700; cursor: pointer; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        button.secondary { background: var(--column-bg); color: var(--text-color); border: 1px solid rgba(0,0,0,0.1); }
        button.danger { background: var(--danger); color: white; }
        .icon-btn { padding: 8px; font-size: 1.2rem; background: transparent; color: var(--text-color); border: none; text-transform: none;}

        /* Search */
        #search-bar { width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid transparent; background: var(--column-bg); color: var(--text-color); font-size: 1rem; }
        #search-bar:focus { border-color: var(--accent); background: var(--card-bg); }

        /* Board Layout */
        .board { flex-grow: 1; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding: 15px; scroll-behavior: smooth; height: 100%; }
        .column { min-width: 85vw; background: var(--column-bg); border-radius: var(--radius); padding: 15px; display: flex; flex-direction: column; scroll-snap-align: center; height: 100%; max-height: 100%; }
        .column-header { flex-shrink: 0; font-weight: 800; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-color); opacity: 0.8; }
        .task-list { overflow-y: auto; flex-grow: 1; padding-bottom: 80px; padding-right: 5px; }

        /* Empty State */
        .empty-state {
            opacity: 0.4; text-align: center; padding: 40px 20px;
            font-style: italic; font-weight: bold; border: 2px dashed rgba(0,0,0,0.1);
            border-radius: var(--radius); margin-top: 20px;
        }
        body.dark-mode .empty-state { border-color: rgba(255,255,255,0.1); }

        /* Cards */
        .card { background: var(--card-bg); padding: 20px; margin-bottom: 15px; border-radius: var(--radius); box-shadow: var(--shadow); position: relative; border-left: 8px solid transparent; }
        .card.priority-High { border-left-color: var(--prio-high); }
        .card.priority-Med { border-left-color: var(--prio-med); }
        .card.priority-Low { border-left-color: var(--prio-low); }
        .card h3 { margin: 0 0 8px 0; font-size: 1.2rem; color: var(--text-color); }
        .card-meta { font-size: 0.85rem; color: var(--text-sub); font-weight: 600; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .prio-badge { padding: 4px 8px; border-radius: 6px; color: #fff; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; }
        .prio-badge.High { background: var(--prio-high); }
        .prio-badge.Med { background: var(--prio-med); }
        .prio-badge.Low { background: var(--prio-low); }

        /* Tags */
        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .tag-pill { border-radius: 12px; padding: 3px 10px; font-size: 0.75rem; color: #333; font-weight: 700; border: 1px solid rgba(0,0,0,0.05); }

        /* Objectives */
        .objective-list { list-style: none; padding: 0; margin: 15px 0; }
        .objective-box { background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.05); padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; color: var(--text-color); }
        body.dark-mode .objective-box { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .objective-check { width: 22px; height: 22px; cursor: pointer; accent-color: var(--accent); }

        /* Action Buttons */
        .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .action-group { display: flex; gap: 12px; } /* Added gap here */
        .action-btn { font-size: 0.75rem; padding: 8px 12px; border-radius: 20px;}

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--card-bg); width: 90%; max-width: 500px; padding: 25px; border-radius: 25px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.4); color: var(--modal-text); }
        
        .field-group { padding: 15px; border-radius: 12px; margin-bottom: 15px; border-width: 1px; border-style: solid; }
        .group-logistics { background: var(--group-logistics-bg); border-color: var(--group-logistics-border); }
        .group-objectives { background: var(--group-objectives-bg); border-color: var(--group-objectives-border); }
        .field-group label { display: block; margin-bottom: 8px; font-weight: 800; font-size: 0.85rem; text-transform: uppercase; color: var(--accent); letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 1rem; }
        .dyn-input-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .dyn-del-btn { background: var(--danger); color: white; width: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; }

        /* Toasts & FX */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; pointer-events: none; width: 90%; max-width: 400px; }
        .toast-msg { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--accent); color: var(--accent); padding: 15px; border-radius: 20px; margin-bottom: 10px; text-align: center; font-weight: 800; font-size: 1.1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideDown 0.5s ease-out forwards; }
        body.dark-mode .toast-msg { background: rgba(30, 30, 50, 0.9); }
        @keyframes slideDown { 0% { opacity: 0; transform: translateY(-20px); } 100% { opacity: 1; transform: translateY(0); } }
        
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }
        @keyframes sinkDown { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(50px) scale(0.8); } }
        .xp-floater { position: fixed; left: 50%; top: 40%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: 900; pointer-events: none; z-index: 4000; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .xp-gain { color: #ffeaa7; animation: floatUp 1.5s forwards; }
        .xp-loss { color: var(--danger); animation: sinkDown 1.5s forwards; }

        /* Zen */
        body.zen-mode #hud, body.zen-mode .board, body.zen-mode .fab { display: none; }
        body.zen-mode #zen-active-container { display: flex; flex-direction: column; align-items: center; padding: 20px; height: 100vh; background: var(--bg-color); }
        #zen-exit { position: fixed; bottom: 30px; left: 30px; opacity: 0.5; width: 50px; height: 50px; cursor: pointer; border: 2px solid var(--text-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--text-color); font-size: 20px; }
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 2000; }
        .story-text { font-family: "Georgia", serif; line-height: 1.6; font-size: 1.1rem; white-space: pre-wrap; color: var(--text-color); }
    </style>
</head>
<body>

<script>
    // Global Error Handler
    window.onerror = function(msg, url, line, col, error) {
        alert("SYSTEM MALFUNCTION:\n" + msg + "\nLine: " + line);
        return false;
    };
</script>

<canvas id="confetti-canvas"></canvas>
<div id="toast-container"></div>
<button class="fab" onclick="openAddTask()">+</button>

<div id="hud">
    <div class="hud-top">
        <div id="level-display" class="level-badge">LVL 1</div>
        <div style="display:flex; gap:10px;">
             <button class="icon-btn" onclick="toggleThemeMode()">‚óë</button>
             <button class="icon-btn" onclick="openMenu()">‚ò∞</button>
        </div>
    </div>
    <div class="progress-container">
        <div id="xp-bar" class="progress-bar"></div>
    </div>
    <input type="text" id="search-bar" placeholder="Scan Tags, Missions, Objectives..." onkeyup="renderBoard()">
</div>

<div class="board" id="main-board">
    <div class="column" id="col-staging">
        <div class="column-header">Staging Area</div>
        <div class="task-list" id="list-staging"></div>
    </div>
    <div class="column" id="col-active">
        <div class="column-header">Active Mission</div>
        <div class="task-list" id="list-active"></div>
    </div>
    <div class="column" id="col-victory">
        <div class="column-header">Victory</div>
        <div class="task-list" id="list-victory"></div>
    </div>
</div>

<div id="zen-active-container" style="display:none;">
    <h2 style="opacity:0.5; margin-bottom:30px; letter-spacing:2px; color:var(--text-color);">FOCUS MODE</h2>
    <div id="zen-list" style="width:100%;"></div>
    <div id="zen-exit" onclick="toggleZen(false)">‚úï</div>
</div>

<div class="modal-overlay" id="menu-modal">
    <div class="modal">
        <h2>System Config</h2>
        <div id="utility-stats" style="display:none; padding:15px; background:var(--column-bg); border-radius:var(--radius); margin-bottom:15px;">
            <h3>üìä Status Report</h3>
            <p>Total XP: <span id="stat-total-xp">0</span></p>
            <p>Missions Completed: <span id="stat-tasks">0</span></p>
            <p>Prestige Rank: <span id="stat-prestige">0</span></p>
        </div>
        <h3>Visuals</h3>
        <button class="secondary" onclick="toggleZen(true)" id="btn-zen" style="display:none; width:100%; margin-bottom:10px;">Engage Zen Mode</button>
        <select id="theme-selector" onchange="changeTheme(this.value)" style="width:100%; margin-bottom:10px;">
            <option value="default">Pastel / Midnight (Default)</option>
            <option value="wolf" disabled>üîí Lvl 5: The Wolf</option>
            <option value="neon" disabled>üîí Lvl 10: Neon City</option>
            <option value="aperture" disabled>üîí Lvl 12: Aperture</option>
            <option value="eldritch" disabled>üîí Lvl 15: Eldritch</option>
            <option value="vaporwave" disabled>üîí Lvl 18: Vaporwave</option>
            <option value="blueprint" disabled>üîí Lvl 20: Blueprint</option>
            <option value="terminal" disabled>üîí Lvl 25: Terminal</option>
            <option value="gold" disabled>üîí Lvl 30: Gold Standard</option>
        </select>
        <h3>Data Management</h3>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="secondary" onclick="exportData()">Backup</button>
            <button class="secondary" onclick="triggerImport()">Restore</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(this)">
        </div>
        <div id="prestige-section" style="display:none; border-top:1px solid var(--text-color); padding-top:20px;">
            <button class="danger" style="width:100%" onclick="prestigeReset()">üéñÔ∏è PRESTIGE RESET</button>
        </div>
        <div id="story-library-btn" style="display:none; margin-top:15px;">
            <button style="width:100%; background: purple;" onclick="openStoryModal()">üìñ The Archives</button>
        </div>
        <button onclick="closeModal('menu-modal')" style="width:100%; margin-top:20px;">Disengage</button>
    </div>
</div>

<div class="modal-overlay" id="task-modal">
    <div class="modal">
        <h2 id="modal-title" style="color:var(--accent); margin-top:0;">New Mission</h2>
        <div class="field-group group-logistics">
            <label>Logistics</label>
            <div style="margin-bottom:10px;"><input type="text" id="inp-title" placeholder="Mission Name"></div>
            <div style="margin-bottom:10px;"><input type="text" id="inp-tags" placeholder="Tags (comma separated)..."></div>
            <div style="margin-bottom:10px;">
                <select id="inp-priority">
                    <option value="Low">Low Priority (100 XP)</option>
                    <option value="Med">Med Priority (150 XP)</option>
                    <option value="High">High Priority (200 XP)</option>
                </select>
            </div>
            <div><input type="date" id="inp-deadline"></div>
        </div>
        <div class="field-group group-objectives">
            <label>Objectives</label>
            <div id="objectives-container"></div>
            <button class="secondary" style="width:100%; margin-top:5px; font-size:0.8rem;" onclick="addObjectiveInput()">+ Add Objective</button>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="secondary" onclick="closeModal('task-modal')">Disengage</button>
            <button onclick="saveTask()">Initialize</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="story-modal">
    <div class="modal">
        <h2>The Archives</h2>
        <div id="story-content" class="story-text"></div>
        <button onclick="closeModal('story-modal')" style="width:100%; margin-top:20px;">Return</button>
    </div>
</div>

<script>
    let player = { level: 1, xp: 0, prestige: 0, totalXpEarned: 0, completedTasks: 0, settings: { darkMode: false, theme: 'default' } };
    let tasks = [];
    let editingId = null;

    window.onload = function() {
        if(localStorage.getItem('qb_player')) {
            player = JSON.parse(localStorage.getItem('qb_player'));
            tasks = JSON.parse(localStorage.getItem('qb_tasks'));
        }
        applySettings();
        checkUnlocks();
        renderBoard();
        updateStats();
    };

    function saveData() {
        localStorage.setItem('qb_player', JSON.stringify(player));
        localStorage.setItem('qb_tasks', JSON.stringify(tasks));
        checkUnlocks();
        updateStats();
    }

    // --- UTILS ---
    function getTagColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const hue = Math.abs(hash % 360);
        return `hsl(${hue}, 85%, 80%)`;
    }

    function addXP(amount) {
        let mult = 1 + (player.prestige * 0.1);
        let finalAmount = Math.floor(amount * mult);
        if(amount > 0 && Math.random() < 0.05) { finalAmount += 50; showToast("CRITICAL SUCCESS! +50 XP"); }
        
        player.xp += finalAmount;
        if(amount > 0) player.totalXpEarned += finalAmount;
        if(player.xp < 0) player.xp = 0;

        const bar = document.getElementById('xp-bar');
        bar.classList.add('glowing');
        setTimeout(() => bar.classList.remove('glowing'), 1500);
        
        spawnFloatingXP(finalAmount, finalAmount > 0 ? 'gain' : 'loss');

        let req = getXpRequired(player.level);
        if (player.xp >= req) {
            player.xp -= req; player.level++;
            showToast(`LEVEL UP! WELCOME TO LEVEL ${player.level}`);
            fireConfetti('level');
        }
        saveData();
    }
    
    function spawnFloatingXP(amount, type) {
        const div = document.createElement('div');
        div.className = `xp-floater ${type === 'gain' ? 'xp-gain' : 'xp-loss'}`;
        div.innerText = type === 'gain' ? `+${amount} XP` : `${amount} XP`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1500);
    }

    function getXpRequired(lvl) { return 500 + ((lvl - 1) * 50); }

    function checkUnlocks() {
        const unlocks = [
            { lvl: 2, id: 'utility-stats', type: 'el' }, { lvl: 5, val: 'wolf', type: 'theme' },
            { lvl: 8, id: 'btn-zen', type: 'el' }, { lvl: 10, val: 'neon', type: 'theme' },
            { lvl: 12, val: 'aperture', type: 'theme' }, { lvl: 15, val: 'eldritch', type: 'theme' },
            { lvl: 18, val: 'vaporwave', type: 'theme' }, { lvl: 20, val: 'blueprint', type: 'theme' },
            { lvl: 25, val: 'terminal', type: 'theme' }, { lvl: 30, val: 'gold', type: 'theme' },
            { lvl: 50, id: 'prestige-section', type: 'el' }
        ];
        if(player.prestige >= 1) document.getElementById('story-library-btn').style.display = 'block';
        unlocks.forEach(u => {
            if (player.level >= u.lvl) {
                if(u.type === 'el') document.getElementById(u.id).style.display = 'block';
                if(u.type === 'theme') {
                    let opt = document.querySelector(`option[value="${u.val}"]`);
                    if(opt) { opt.disabled = false; opt.text = opt.text.replace('üîí ', ''); }
                }
            }
        });
    }

    function addObjectiveInput(value = "") {
        const container = document.getElementById('objectives-container');
        const div = document.createElement('div');
        div.className = 'dyn-input-row';
        div.innerHTML = `<input type="text" class="obj-input" placeholder="Objective data..." value="${value}"><div class="dyn-del-btn" onclick="this.parentElement.remove()">‚úï</div>`;
        container.appendChild(div);
        const inp = div.querySelector('input');
        if(value === "") inp.focus();
        inp.addEventListener('keydown', function(e) { if(e.key === 'Enter') { e.preventDefault(); addObjectiveInput(); }});
    }

    function saveTask() {
        const title = document.getElementById('inp-title').value;
        if(!title) return;
        const objInputs = document.querySelectorAll('.obj-input');
        const subtasks = Array.from(objInputs).map(inp => ({ text: inp.value.trim(), done: false })).filter(o => o.text !== "");
        
        if(editingId) {
            const oldTask = tasks.find(t => t.id === editingId);
            subtasks.forEach(newSub => {
                const match = oldTask.subtasks.find(oldSub => oldSub.text === newSub.text);
                if(match) newSub.done = match.done;
            });
        }

        const tagStr = document.getElementById('inp-tags').value;
        const tags = tagStr.split(',').map(t => t.trim()).filter(t => t !== "");

        const newTask = {
            id: editingId || Date.now(),
            title: title,
            tags: tags,
            priority: document.getElementById('inp-priority').value,
            deadline: document.getElementById('inp-deadline').value,
            subtasks: subtasks,
            status: editingId ? tasks.find(t => t.id === editingId).status : 'staging',
            winXP: editingId ? tasks.find(t => t.id === editingId).winXP : 0,
            completedDate: editingId ? tasks.find(t => t.id === editingId).completedDate : null
        };

        if(editingId) { tasks[tasks.findIndex(t => t.id === editingId)] = newTask; editingId = null; }
        else { tasks.push(newTask); }
        closeModal('task-modal');
        saveData();
        renderBoard();
        if(!editingId) document.getElementById('col-staging').scrollIntoView({ behavior: 'smooth', inline: 'center' });
    }

    function moveTask(id, dest) {
        const t = tasks.find(x => x.id === id);
        if (t.status === 'victory' && dest !== 'victory') {
            if(!confirm("CONFIRM PROTOCOL: Retreat? XP penalty will be applied.")) return;
            addXP(- (t.winXP + 50));
            t.winXP = 0; t.completedDate = null; player.completedTasks--;
        }

        if (dest === 'victory' && t.status !== 'victory') {
            let base = t.priority === 'High' ? 200 : t.priority === 'Med' ? 150 : 100;
            let bonusMsg = "";
            if(t.deadline) {
                const now = new Date(); const due = new Date(t.deadline); now.setHours(0,0,0,0); due.setHours(0,0,0,0);
                const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24)); 
                if (diffDays >= 1) { base = Math.floor(base * 1.2); bonusMsg += " (Early)"; }
                else if (diffDays < 0) { base = Math.floor(base * 0.8); bonusMsg += " (Late)"; }
            }
            addXP(base);
            t.winXP = base; t.completedDate = new Date().toISOString();
            player.completedTasks++;
            let fx = player.level >= 30 ? 'gem' : player.level >= 20 ? 'coin' : player.level >= 10 ? 'star' : 'paper';
            fireConfetti(fx);
        }

        t.status = dest;
        saveData();
        renderBoard();
        const destCol = document.getElementById(`col-${dest}`);
        setTimeout(() => { destCol.scrollIntoView({ behavior: 'smooth', inline: 'center' }); }, 100);
    }

    function toggleSubtask(taskId, subIdx) {
        const t = tasks.find(x => x.id === taskId);
        const wasDone = t.subtasks[subIdx].done;
        t.subtasks[subIdx].done = !wasDone;
        if(!wasDone) addXP(10); else addXP(-10);
        saveData(); renderBoard();
    }

    function deleteTask(id) {
        if(confirm("CONFIRM PROTOCOL: Abort Mission Permanently?")) {
            tasks = tasks.filter(t => t.id !== id);
            saveData(); renderBoard();
        }
    }

    function openEditTask(id) {
        const t = tasks.find(x => x.id === id);
        editingId = id;
        document.getElementById('modal-title').innerText = "Edit Mission Data";
        document.getElementById('inp-title').value = t.title;
        document.getElementById('inp-tags').value = t.tags ? t.tags.join(', ') : "";
        document.getElementById('inp-priority').value = t.priority;
        document.getElementById('inp-deadline').value = t.deadline;
        const container = document.getElementById('objectives-container');
        container.innerHTML = "";
        t.subtasks.forEach(s => addObjectiveInput(s.text));
        document.getElementById('task-modal').style.display = 'flex';
    }

    function renderBoard() {
        const filter = document.getElementById('search-bar').value.toLowerCase();
        ['staging', 'active', 'victory'].forEach(col => {
            const container = document.getElementById(`list-${col}`);
            const zenContainer = document.getElementById('zen-list');
            if(col === 'active') zenContainer.innerHTML = ''; 
            container.innerHTML = '';
            
            const colTasks = tasks.filter(t => t.status === col);
            if(colTasks.length === 0 && !filter) {
                let msg = col === 'staging' ? "Quest Log Empty" : col === 'active' ? "No Current Objective" : "Hall of Heroes Empty";
                container.innerHTML = `<div class="empty-state">${msg}</div>`;
            }

            colTasks.forEach(t => {
                let match = t.title.toLowerCase().includes(filter);
                t.subtasks.forEach(s => { if(s.text.toLowerCase().includes(filter)) match = true; });
                if(t.tags) t.tags.forEach(tag => { if(tag.toLowerCase().includes(filter)) match = true; });
                
                if(!match) return;
                const card = createCardHTML(t);
                container.appendChild(card);
                if(col === 'active') zenContainer.appendChild(createCardHTML(t));
            });
        });
    }

    function createCardHTML(t) {
        const div = document.createElement('div');
        div.className = `card priority-${t.priority}`;
        if(player.settings.theme === 'blueprint') div.style.borderStyle = "dashed";
        let dateStr = "";
        if(t.deadline) {
            const parts = t.deadline.split('-');
            if(parts.length === 3) dateStr = new Date(parts[0], parts[1]-1, parts[2]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        let tagsHtml = "";
        if(t.tags && t.tags.length > 0) {
            tagsHtml = '<div class="tag-container">';
            t.tags.forEach(tag => { tagsHtml += `<span class="tag-pill" style="background:${getTagColor(tag)}">${tag}</span>`; });
            tagsHtml += '</div>';
        }

        let subHtml = '<ul class="objective-list">';
        t.subtasks.forEach((s, i) => {
            subHtml += `<li class="objective-box"><input type="checkbox" class="objective-check" ${s.done ? 'checked' : ''} onchange="toggleSubtask(${t.id}, ${i})"><span style="${s.done ? 'text-decoration:line-through; opacity:0.6' : ''}">${s.text}</span></li>`;
        });
        subHtml += '</ul>';

        let btns = '';
        if(t.status === 'staging') btns = `<button class="action-btn" onclick="moveTask(${t.id}, 'active')">Engage</button>`;
        if(t.status === 'active') btns = `<button class="action-btn secondary" onclick="moveTask(${t.id}, 'staging')">Standby</button><button class="action-btn" onclick="moveTask(${t.id}, 'victory')">Complete</button>`;
        if(t.status === 'victory') btns = `<button class="action-btn danger" onclick="moveTask(${t.id}, 'active')">Retreat</button>`;
        
        let leftActions = `<div class="action-group"><button class="action-btn secondary" onclick="deleteTask(${t.id})">Abort</button><button class="action-btn secondary" onclick="openEditTask(${t.id})">‚úé</button></div>`;
        if(t.status === 'victory') leftActions = `<div class="action-group"><button class="action-btn secondary" onclick="openEditTask(${t.id})">‚úé</button></div>`;

        div.innerHTML = `<h3>${t.title}</h3>${tagsHtml}<div class="card-meta"><span class="prio-badge ${t.priority}">${t.priority}</span><span>${dateStr ? 'üìÖ ' + dateStr : ''}</span></div>${subHtml}<div class="card-actions">${leftActions}<div class="action-group">${btns}</div></div>`;
        return div;
    }

    function updateStats() {
        document.getElementById('level-display').innerText = `LVL ${player.level} ${player.prestige > 0 ? '‚ú™'.repeat(player.prestige) : ''}`;
        const req = getXpRequired(player.level);
        document.getElementById('xp-bar').style.width = `${(player.xp / req) * 100}%`;
        document.getElementById('stat-total-xp').innerText = player.totalXpEarned;
        document.getElementById('stat-tasks').innerText = player.completedTasks;
        document.getElementById('stat-prestige').innerText = player.prestige;
    }

    function toggleThemeMode() { player.settings.darkMode = !player.settings.darkMode; applySettings(); saveData(); }
    function changeTheme(val) { player.settings.theme = val; applySettings(); saveData(); }
    function applySettings() {
        const body = document.body;
        if(player.settings.darkMode) body.classList.add('dark-mode'); else body.classList.remove('dark-mode');
        body.className = body.className.replace(/theme-\w+/g, '');
        if(player.settings.theme !== 'default') body.classList.add(`theme-${player.settings.theme}`);
        document.getElementById('theme-selector').value = player.settings.theme;
        if(player.settings.darkMode) body.classList.add('dark-mode');
    }

    function toggleZen(active) {
        if(active) document.body.classList.add('zen-mode'); else document.body.classList.remove('zen-mode');
        closeModal('menu-modal');
    }

    function openAddTask() {
        document.getElementById('modal-title').innerText = "New Mission";
        document.getElementById('inp-title').value = "";
        document.getElementById('inp-tags').value = "";
        document.getElementById('inp-priority').value = "Med";
        document.getElementById('inp-deadline').value = "";
        document.getElementById('objectives-container').innerHTML = ""; 
        addObjectiveInput();
        editingId = null;
        document.getElementById('task-modal').style.display = 'flex';
        document.getElementById('inp-title').focus();
    }

    function openMenu() { document.getElementById('menu-modal').style.display = 'flex'; updateStats(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showToast(msg) {
        const container = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = 'toast-msg';
        t.innerText = msg;
        container.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({player, tasks}));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "questboard_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }
    function triggerImport() { document.getElementById('import-file').click(); }
    function importData(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if(json.player && json.tasks) { player = json.player; tasks = json.tasks; saveData(); location.reload(); }
            } catch(err) { alert("Data Corrupted."); }
        };
        reader.readAsText(file);
    }
    function prestigeReset() {
        if(!confirm("‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è\nReset Level to 1 & XP to 0?\n+10% XP multiplier.\nConfirm?")) return;
        player.level = 1; player.xp = 0; player.prestige++; saveData(); location.reload();
    }

    // --- FX ---
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    function fireConfetti(type) {
        const count = type === 'level' ? 200 : 50;
        for(let i=0; i<count; i++) {
            particles.push({
                x: Math.random() * canvas.width, y: type === 'level' ? canvas.height + 10 : -10,
                vx: (Math.random() - 0.5) * 10, vy: type === 'level' ? (Math.random() * -15) - 5 : (Math.random() * 5) + 2,
                size: Math.random() * 8 + 4, color: `hsl(${Math.random()*360}, 100%, 70%)`, type: type, life: 100
            });
        }
        animateConfetti();
    }
    function animateConfetti() {
        if(particles.length === 0) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life--;
            ctx.fillStyle = p.color; ctx.beginPath();
            if(p.type === 'star') drawStar(ctx, p.x, p.y, 5, p.size, p.size/2);
            else if (p.type === 'coin') ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            else ctx.fillRect(p.x, p.y, p.size, p.size);
            ctx.fill();
        });
        particles = particles.filter(p => p.life > 0 && p.y < canvas.height + 20);
        if(particles.length > 0) requestAnimationFrame(animateConfetti);
        else ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    function drawStar(cx, cy, cx_x, cy_y, spikes, outerRadius, innerRadius) {
        let rot = Math.PI / 2 * 3; let x = cx; let y = cy; let step = Math.PI / spikes;
        ctx.beginPath(); ctx.moveTo(cx, cy - outerRadius);
        for (let i = 0; i < spikes; i++) {
            x = cx + Math.cos(rot) * outerRadius; y = cy + Math.sin(rot) * outerRadius; ctx.lineTo(x, y); rot += step;
            x = cx + Math.cos(rot) * innerRadius; y = cy + Math.sin(rot) * innerRadius; ctx.lineTo(x, y); rot += step;
        }
        ctx.lineTo(cx, cy - outerRadius); ctx.closePath();
    }
    const stories = { 1: `<h3>Chapter I: The Frost and the Flame</h3><p>The wind howled outside...</p>` };
    function openStoryModal() {
        let content = "";
        if(player.prestige >= 1) content += stories[1];
        document.getElementById('story-content').innerHTML = content || "<p>You must Prestige to unlock the Archives.</p>";
        document.getElementById('story-modal').style.display = 'flex';
    }
</script>
</body>
</html>
