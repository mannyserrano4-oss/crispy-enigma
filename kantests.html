<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1e2e">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öîÔ∏è</text></svg>">

    <title>QuestBoard RPG</title>
    <style>
        /* --- GLOBAL BASE VARIABLES --- */
        :root {
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --radius: 16px;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            
            /* Fallbacks (Pastel Dream) */
            --bg-color: #fff0f5;
            --column-bg: #e6e6fa;
            --card-bg: #fff9fb;
            --text-color: #2d3436;
            --text-sub: #636e72;
            --accent: #00b894;
            --accent-glow: #55efc4;
            --danger: #ff7675;
            --input-bg: #ffffff;
            --input-border: #dfe6e9;
            --group-logistics-bg: #e3f2fd;
            --group-logistics-border: #90caf9;
            --group-objectives-bg: #e8f5e9;
            --group-objectives-border: #a5d6a7;
            --modal-text: #2d3436;
            --prio-low: #74b9ff; --prio-med: #00b894; --prio-high: #ff7675; --prio-boss: #a55eea;
        }

        /* --- 1. DARK MODE (High Contrast) --- */
        body.dark-mode {
            --bg-color: #0d0d15; --column-bg: #161622; --card-bg: #1e1e2e;
            --text-color: #ffffff; --text-sub: #b0b0c0;
            --accent: #00e5ff; --accent-glow: #00e5ff; --danger: #ff4757;
            --input-bg: #12121a; --input-border: #404055;
            --group-logistics-bg: rgba(0, 100, 255, 0.1); --group-logistics-border: #0056b3;
            --group-objectives-bg: rgba(0, 255, 127, 0.05); --group-objectives-border: #00b894;
            --prio-low: #4facfe; --prio-med: #00e5ff; --prio-high: #ff0055; --prio-boss: #d63031;
        }

        /* --- THEME OVERRIDES --- */
        body.theme-wolf { --bg-color: #e8e4d9; --column-bg: #dcd6c5; --card-bg: #f4f1ea; --text-color: #4a4036; --accent: #556b2f; --prio-boss: #800000; }
        body.theme-wolf.dark-mode { --bg-color: #1c1815; --column-bg: #2b2520; --card-bg: #362f29; --text-color: #f0e6d2; --accent: #8fbc8f; }
        
        body.theme-neon { --bg-color: #f0f0f0; --column-bg: #ffffff; --card-bg: #fff; --text-color: #111; --accent: #ff00ff; }
        body.theme-neon.dark-mode { --bg-color: #000; --column-bg: #0a0a0a; --card-bg: #141414; --text-color: #fff; --accent: #0ff; }

        body.theme-aperture { --bg-color: #dce0e6; --column-bg: #edf2f7; --card-bg: #fff; --text-color: #2d3748; --accent: #ed8936; --radius: 4px; }
        body.theme-aperture.dark-mode { --bg-color: #11151c; --column-bg: #1a202c; --card-bg: #2d3748; --text-color: #fff; --accent: #4299e1; }

        body.theme-eldritch { --bg-color: #e3dac9; --column-bg: #dcd0b8; --card-bg: #f3e9d7; --text-color: #3e2723; --accent: #880e4f; font-family: "Georgia", serif; }
        body.theme-eldritch.dark-mode { --bg-color: #0f020e; --column-bg: #1f051d; --card-bg: #2d0a2a; --text-color: #e0c0e0; --accent: #00ff66; }

        body.theme-vaporwave { --bg-color: #ffecf2; --column-bg: #e0f7fa; --card-bg: #fff; --text-color: #6a1b9a; --accent: #00bcd4; }
        body.theme-vaporwave.dark-mode { --bg-color: #1a0524; --column-bg: #2b0f36; --card-bg: #3f1a52; --text-color: #8affff; --accent: #ff00ff; }

        body.theme-blueprint { --bg-color: #f0f4f8; --column-bg: #d9e2ec; --card-bg: #fff; --text-color: #102a43; --accent: #0055ff; --radius: 2px; }
        body.theme-blueprint.dark-mode { --bg-color: #002244; --column-bg: #003366; --card-bg: #004488; --text-color: #fff; --accent: #66b3ff; }
        body.theme-blueprint .card { border-style: dashed; border-width: 2px; }

        body.theme-terminal { --bg-color: #2b2b2b; --column-bg: #333; --card-bg: #444; --text-color: #ffb000; --accent: #ffb000; font-family: "Courier New", monospace; }
        body.theme-terminal.dark-mode { --bg-color: #000; --column-bg: #0a0a0a; --card-bg: #111; --text-color: #0f0; --accent: #0f0; }

        body.theme-gold { --bg-color: #fafafa; --column-bg: #f5f5f5; --card-bg: #fff; --text-color: #b8860b; --accent: #daa520; }
        body.theme-gold.dark-mode { --bg-color: #0a0a0a; --column-bg: #141414; --card-bg: #1c1c1c; --text-color: #ffe066; --accent: #ffd700; }

        /* PRESTIGE */
        body.theme-nebula { --bg-color: #f3e7ff; --column-bg: #eaddff; --card-bg: #fff; --text-color: #4a148c; --accent: #6200ea; }
        body.theme-nebula.dark-mode { --bg-color: #120621; --column-bg: #200f36; --card-bg: #2d164d; --text-color: #fff; --accent: #b388ff; }
        body.theme-midas { --bg-color: #fdfdfd; --column-bg: #fdfcf5; --card-bg: #fff; --text-color: #bfa15f; --accent: #d4af37; }
        body.theme-midas.dark-mode { --bg-color: #000; --column-bg: #0a0a0a; --card-bg: #141414; --text-color: #ffed4a; --accent: #d4af37; }
        body.theme-glitch { --bg-color: #fff; --column-bg: #f0f0f0; --card-bg: #fff; --text-color: #000; --accent: #ff0055; font-family: "Courier New", monospace; }
        body.theme-glitch.dark-mode { --bg-color: #000; --column-bg: #050505; --card-bg: #0f0f0f; --text-color: #00ff41; --accent: #00ff41; }

        /* --- LAYOUT --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; font-family: var(--font); background: var(--bg-color); color: var(--text-color); transition: background 0.3s, color 0.3s; height: 100vh; overflow: hidden; display: flex; flex-direction: column; touch-action: manipulation; }

        #hud { flex-shrink: 0; padding: 15px; padding-top: max(15px, env(safe-area-inset-top)); background: var(--card-bg); z-index: 100; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 10px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;}
        .hud-top { display: flex; justify-content: space-between; align-items: center; }
        .level-badge { font-weight: 800; font-size: 1.4rem; color: var(--accent); letter-spacing: -0.5px; text-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .streak-display { font-size: 0.9rem; font-weight: bold; color: var(--danger); display: flex; align-items: center; gap: 5px; }
        
        .progress-container { width: 100%; height: 16px; background: rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; margin-top: 5px; position: relative; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-glow)); width: 0%; transition: width 0.5s ease; border-radius: 8px; }
        .progress-bar.glowing { animation: glowPulse 0.8s ease-in-out infinite; }
        .xp-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 900; color: rgba(0,0,0,0.5); z-index: 2; letter-spacing: 0.5px; }
        @keyframes glowPulse { 0% { box-shadow: 0 0 5px var(--accent); filter: brightness(1); } 50% { box-shadow: 0 0 15px var(--accent), 0 0 5px white; filter: brightness(1.3); } 100% { box-shadow: 0 0 5px var(--accent); filter: brightness(1); } }

        .fab { position: fixed; bottom: 30px; right: 25px; width: 65px; height: 65px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); z-index: 500; cursor: pointer; transition: transform 0.1s; border: none; padding-bottom: env(safe-area-inset-bottom); }
        .fab:active { transform: scale(0.9); }

        button { background: var(--accent); color: #fff; border: none; padding: 10px 16px; border-radius: var(--radius); font-weight: 700; cursor: pointer; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; transition: transform 0.1s ease; }
        button:active { transform: scale(0.95); }
        button.secondary { background: var(--column-bg); color: var(--text-color); border: 1px solid var(--input-border); }
        button.danger { background: var(--danger); color: white; }
        .icon-btn { padding: 8px; font-size: 1.2rem; background: transparent; color: var(--text-color); border: none; text-transform: none; transition: transform 0.1s ease;}
        .icon-btn:active { transform: scale(0.9); }

        #search-bar { width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid var(--input-border); background: var(--column-bg); color: var(--text-color); font-size: 1rem; }
        #search-bar:focus { border-color: var(--accent); background: var(--card-bg); }

        .board { flex-grow: 1; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding: 15px; scroll-behavior: smooth; height: 100%; }
        .column { min-width: 85vw; background: var(--column-bg); border-radius: var(--radius); padding: 15px; display: flex; flex-direction: column; scroll-snap-align: center; height: 100%; max-height: 100%; border: 1px solid var(--input-border); }
        .column-header { flex-shrink: 0; font-weight: 800; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-color); opacity: 0.8; }
        .task-list { overflow-y: auto; flex-grow: 1; padding-bottom: 80px; padding-right: 5px; }
        .empty-state { opacity: 0.4; text-align: center; padding: 40px 20px; font-style: italic; font-weight: bold; border: 2px dashed var(--text-sub); border-radius: var(--radius); margin-top: 20px; color: var(--text-color); }

        .card { background: var(--card-bg); padding: 18px; margin-bottom: 15px; border-radius: var(--radius); box-shadow: var(--shadow); position: relative; border-left: 8px solid transparent; color: var(--text-color); }
        .card.priority-High { border-left-color: var(--prio-high); }
        .card.priority-Med { border-left-color: var(--prio-med); }
        .card.priority-Low { border-left-color: var(--prio-low); }
        .card.priority-Boss { border-left-color: var(--prio-boss); box-shadow: 0 0 15px var(--prio-boss); border: 2px solid var(--prio-boss); } 

        .card h3 { margin: 0 0 8px 0; font-size: 1.15rem; color: var(--text-color); word-wrap: break-word; }
        .card-meta { font-size: 0.85rem; color: var(--text-sub); font-weight: 600; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .prio-badge { padding: 4px 8px; border-radius: 6px; color: #fff; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; }
        .prio-badge.High { background: var(--prio-high); }
        .prio-badge.Med { background: var(--prio-med); }
        .prio-badge.Low { background: var(--prio-low); }
        .prio-badge.Boss { background: var(--prio-boss); letter-spacing: 1px; }

        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .tag-pill { border-radius: 12px; padding: 3px 10px; font-size: 0.75rem; color: var(--text-color); font-weight: 700; border: 1px solid var(--text-sub); opacity: 0.8; }

        .objective-list { list-style: none; padding: 0; margin: 15px 0; }
        .objective-box { background: rgba(0,0,0,0.03); border: 1px solid var(--input-border); padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; color: var(--text-color); }
        .objective-check { width: 22px; height: 22px; cursor: pointer; accent-color: var(--accent); flex-shrink: 0; }

        .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; height: 32px; gap: 15px; flex-wrap: nowrap; }
        .action-group { display: flex; gap: 5px; align-items: center; }
        .action-btn { font-size: 0.65rem; padding: 8px 10px; border-radius: 12px; letter-spacing: 0.5px; }
        
        .btn-ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--input-border); }
        .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
        .btn-abort { color: var(--danger); border-color: var(--danger); opacity: 0.7; }
        .btn-abort:hover { background: var(--danger); color: white; opacity: 1; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--card-bg); width: 90%; max-width: 500px; padding: 25px; border-radius: 25px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.4); color: var(--modal-text); border: 1px solid var(--input-border); }
        .field-group { padding: 15px; border-radius: 12px; margin-bottom: 15px; border-width: 1px; border-style: solid; }
        .group-logistics { background: var(--group-logistics-bg); border-color: var(--group-logistics-border); }
        .group-objectives { background: var(--group-objectives-bg); border-color: var(--group-objectives-border); }
        .field-group label { display: block; margin-bottom: 8px; font-weight: 800; font-size: 0.85rem; text-transform: uppercase; color: var(--accent); letter-spacing: 0.5px; }
        .sub-label { display: block; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 4px; font-weight: 600; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-color); font-size: 1rem; box-sizing: border-box; max-width: 100%; }
        .dyn-input-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .dyn-del-btn { background: var(--danger); color: white; width: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; flex-shrink: 0; transition: transform 0.1s ease; }
        .dyn-del-btn:active { transform: scale(0.95); }

        #confirm-modal .modal { text-align: center; border: 2px solid var(--accent); }
        .confirm-btn-group { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .confirm-msg { font-size: 1.1rem; margin: 15px 0; font-weight: 600; color: var(--text-color); }

        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; pointer-events: none; width: 90%; max-width: 400px; }
        .toast-msg { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--accent); color: var(--accent); padding: 15px; border-radius: 20px; margin-bottom: 10px; text-align: center; font-weight: 800; font-size: 1.1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideDown 0.5s ease-out forwards; }
        body.dark-mode .toast-msg { background: rgba(30, 30, 50, 0.9); }
        @keyframes slideDown { 0% { opacity: 0; transform: translateY(-20px); } 100% { opacity: 1; transform: translateY(0); } }
        
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }
        @keyframes sinkDown { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(50px) scale(0.8); } }
        .xp-floater { position: fixed; left: 50%; top: 40%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: 900; pointer-events: none; z-index: 4000; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .xp-gain { color: #ffeaa7; animation: floatUp 1.5s forwards; }
        .xp-loss { color: var(--danger); animation: sinkDown 1.5s forwards; }

        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 2000; }
        .story-text { font-family: "Georgia", serif; line-height: 1.6; font-size: 1.1rem; white-space: pre-wrap; color: var(--text-color); }
    </style>
</head>
<body>

<script>
    window.onerror = function(msg, url, line, col, error) { alert("SYSTEM MALFUNCTION:\n" + msg + "\nLine: " + line); return false; };
    document.addEventListener("touchstart", function() {}, true);
</script>

<canvas id="confetti-canvas"></canvas>
<div id="toast-container"></div>
<button class="fab" onclick="openAddTask()">+</button>

<div id="hud">
    <div class="hud-top">
        <div style="display:flex; align-items:center; gap:10px;">
            <div id="level-display" class="level-badge">LVL 1</div>
            <div id="streak-display" class="streak-display">üî• 0</div>
        </div>
        <div style="display:flex; gap:10px;">
             <button class="icon-btn" onclick="toggleThemeMode()">‚óë</button>
             <button class="icon-btn" onclick="openMenu()">‚ò∞</button>
        </div>
    </div>
    <div class="progress-container">
        <div id="xp-bar" class="progress-bar"></div>
        <div id="xp-text" class="xp-text">0 / 500 XP</div>
    </div>
    <input type="text" id="search-bar" placeholder="Scan Tags, Missions, Objectives..." onkeyup="renderBoard()">
</div>

<div class="board" id="main-board">
    <div class="column" id="col-staging">
        <div class="column-header">Staging Area</div>
        <div class="task-list" id="list-staging"></div>
    </div>
    <div class="column" id="col-active">
        <div class="column-header">Active Mission</div>
        <div class="task-list" id="list-active"></div>
    </div>
    <div class="column" id="col-victory">
        <div class="column-header">Victory</div>
        <div class="task-list" id="list-victory"></div>
    </div>
</div>

<div class="modal-overlay" id="menu-modal">
    <div class="modal">
        <h2>System Config</h2>
        <div id="utility-stats" style="display:none; padding:15px; background:var(--column-bg); border-radius:var(--radius); margin-bottom:15px;">
            <h3>üìä Status Report</h3>
            <p>Total XP: <span id="stat-total-xp">0</span></p>
            <p>Missions Completed: <span id="stat-tasks">0</span></p>
            <p>Prestige Rank: <span id="stat-prestige">0</span></p>
            <p>Current Streak: <span id="stat-streak">0</span> Days</p>
        </div>
        <h3>Visuals</h3>
        <select id="theme-selector" onchange="changeTheme(this.value)" style="width:100%; margin-bottom:10px;">
            <option value="default">Pastel / Midnight (Default)</option>
            <option value="wolf" disabled>üîí Lvl 5: Wolf</option>
            <option value="neon" disabled>üîí Lvl 10: Neon</option>
            <option value="aperture" disabled>üîí Lvl 12: Aperture</option>
            <option value="eldritch" disabled>üîí Lvl 15: Eldritch</option>
            <option value="vaporwave" disabled>üîí Lvl 18: Vaporwave</option>
            <option value="blueprint" disabled>üîí Lvl 20: Blueprint</option>
            <option value="terminal" disabled>üîí Lvl 25: Terminal</option>
            <option value="gold" disabled>üîí Lvl 30: Gold</option>
            <option value="nebula" disabled>üîí Prestige 1: Nebula</option>
            <option value="midas" disabled>üîí Prestige 2: Midas</option>
            <option value="glitch" disabled>üîí Prestige 3: Glitch</option>
        </select>
        <h3>Data Management</h3>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="secondary" onclick="exportData()">Backup</button>
            <button class="secondary" onclick="triggerImport()">Restore</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(this)">
        </div>
        <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px; margin-bottom:10px;">
            <button class="secondary" style="border-color:var(--accent);" onclick="openAchievements()">üèÜ Hall of Legends</button>
            <button class="secondary" style="border-color:var(--text-sub);" onclick="openHelp()">‚ùì How to Play</button>
        </div>
        <div id="prestige-section" style="display:none; border-top:1px solid var(--text-color); padding-top:20px;">
            <button class="danger" style="width:100%" onclick="prestigeReset()">üéñÔ∏è PRESTIGE RESET</button>
        </div>
        <div style="display:none; border-top:1px dashed var(--text-sub); margin-top:10px; padding-top:10px;">
            <h3 style="font-size:0.9rem; opacity:0.7">üöß DEBUG / CHEATS</h3>
            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                <button class="secondary" style="font-size:0.7rem;" onclick="addXP(1000)">+1000 XP</button>
                <button class="secondary" style="font-size:0.7rem;" onclick="player.level=50; player.xp=0; saveData(); location.reload();">Force Lvl 50</button>
                <button class="secondary" style="font-size:0.7rem;" onclick="unlockAllThemes()">Unlock All</button>
            </div>
        </div>
        <div id="story-library-btn" style="display:none; margin-top:15px;">
            <button style="width:100%; background: purple;" onclick="openStoryModal()">üìñ The Archives</button>
        </div>
        <button onclick="closeModal('menu-modal')" style="width:100%; margin-top:20px;">Disengage</button>
    </div>
</div>

<div class="modal-overlay" id="help-modal">
    <div class="modal">
        <h2 style="color:var(--accent);">Manual</h2>
        <div style="font-size:0.9rem; line-height:1.5;">
            <p><strong>1. The Board:</strong> Move tasks from <em>Staging</em> (Backlog) to <em>Active</em> (Doing) to <em>Victory</em> (Done).</p>
            <p><strong>2. XP & Levels:</strong> 
                <br>‚Ä¢ Low Prio: 100 XP
                <br>‚Ä¢ Med Prio: 150 XP
                <br>‚Ä¢ High Prio: 200 XP
                <br>‚Ä¢ Boss: 500 XP
                <br>‚Ä¢ <em>Subtask:</em> 10 XP each.
            </p>
            <p><strong>3. Streaks:</strong> Open the app daily to build your üî• Streak. Each day adds a 1% XP bonus (max 10%).</p>
            <p><strong>4. Prestige:</strong> At Level 50, you can reset to Level 1. You keep badges and gain a permanent +10% XP multiplier.</p>
        </div>
        <button onclick="closeModal('help-modal')" style="width:100%; margin-top:20px;">Got it</button>
    </div>
</div>

<div class="modal-overlay" id="task-modal">
    <div class="modal">
        <h2 id="modal-title" style="color:var(--accent); margin-top:0;">New Mission</h2>
        <div class="field-group group-logistics">
            <label>Logistics</label>
            <input type="text" id="inp-title" placeholder="Mission Name" style="margin-bottom:10px;">
            <input type="text" id="inp-tags" placeholder="Tags (comma separated)..." style="margin-bottom:15px;">
            <span class="sub-label">Priority Level</span>
            <select id="inp-priority" style="margin-bottom:10px;">
                <option value="Low">Low Priority (100 XP)</option>
                <option value="Med">Med Priority (150 XP)</option>
                <option value="High">High Priority (200 XP)</option>
                <option value="Boss">‚ò†Ô∏è BOSS (500 XP)</option>
            </select>
            <span class="sub-label">Repetition Mode</span>
            <select id="inp-recurrence" style="margin-bottom:10px;">
                <option value="none">One-Time Mission</option>
                <option value="daily">Daily Reset üîÑ</option>
                <option value="weekly">Weekly Reset üîÑ</option>
                <option value="monthly">Monthly Reset üîÑ</option>
            </select>
            <span class="sub-label">Deadline</span>
            <input type="date" id="inp-deadline">
        </div>
        <div class="field-group group-objectives">
            <label>Objectives</label>
            <div id="objectives-container"></div>
            <button class="secondary" style="width:100%; margin-top:5px; font-size:0.8rem;" onclick="addObjectiveInput()">+ Add Objective</button>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="secondary" onclick="closeModal('task-modal')">Disengage</button>
            <button onclick="saveTask()">Initialize</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="achievement-modal">
    <div class="modal">
        <h2 style="color:var(--accent); text-align:center;">Hall of Legends</h2>
        <div id="achievement-list" style="display:flex; flex-direction:column; gap:10px; max-height:60vh; overflow-y:auto;"></div>
        <button onclick="closeModal('achievement-modal')" style="width:100%; margin-top:20px;">Close</button>
    </div>
</div>

<div class="modal-overlay" id="confirm-modal">
    <div class="modal">
        <h2 style="color:var(--danger); margin-top:0;">SYSTEM ALERT</h2>
        <p id="confirm-text" class="confirm-msg">Are you sure?</p>
        <div class="confirm-btn-group">
            <button class="secondary" onclick="closeConfirm(false)">DENY</button>
            <button id="confirm-yes-btn" onclick="closeConfirm(true)">CONFIRM</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="story-modal">
    <div class="modal">
        <h2>The Archives</h2>
        <div id="story-content" class="story-text"></div>
        <button onclick="closeModal('story-modal')" style="width:100%; margin-top:20px;">Return</button>
    </div>
</div>

<script>
    let player = { level: 1, xp: 0, prestige: 0, totalXpEarned: 0, completedTasks: 0, streak: 0, lastLogin: null, achievements: [], settings: { darkMode: false, theme: 'default' } };
    let tasks = [];
    let editingId = null;
    let pendingCallback = null;

    // --- ACHIEVEMENTS DATA ---
    const ACHIEVEMENT_DATA = [
        { id: 'first_blood', icon: '‚öîÔ∏è', title: 'First Blood', desc: 'Complete your first mission.', cond: p => p.completedTasks >= 1 },
        { id: 'veteran', icon: 'üéñÔ∏è', title: 'Veteran', desc: 'Complete 50 missions.', cond: p => p.completedTasks >= 50 },
        { id: 'legend', icon: 'üëë', title: 'Living Legend', desc: 'Complete 500 missions.', cond: p => p.completedTasks >= 500 },
        { id: 'streak_7', icon: 'üî•', title: 'On Fire', desc: 'Reach a 7-day streak.', cond: p => p.streak >= 7 },
        { id: 'streak_30', icon: '‚ö°', title: 'Unstoppable', desc: 'Reach a 30-day streak.', cond: p => p.streak >= 30 },
        { id: 'prestige', icon: 'üöÄ', title: 'Ascension', desc: 'Prestige for the first time.', cond: p => p.prestige >= 1 },
        { id: 'level_10', icon: '‚≠ê', title: 'Rising Star', desc: 'Reach Level 10.', cond: p => p.level >= 10 },
        { id: 'level_50', icon: 'üåü', title: 'Level Cap', desc: 'Reach Level 50.', cond: p => p.level >= 50 }
    ];

    window.onload = function() {
        if(localStorage.getItem('qb_player')) {
            player = JSON.parse(localStorage.getItem('qb_player'));
            tasks = JSON.parse(localStorage.getItem('qb_tasks'));
        }
        if(!player.achievements) player.achievements = []; 
        checkStreak();
        applySettings();
        checkUnlocks();
        renderBoard();
        updateStats();
    };

    // FIXED: LINEAR LOGIC (No Loop)
    function saveData() {
        checkAchievements(); // 1. Check for awards first
        localStorage.setItem('qb_player', JSON.stringify(player)); // 2. Save data
        localStorage.setItem('qb_tasks', JSON.stringify(tasks));
        checkUnlocks(); // 3. Update UI
        updateStats(); // 4. Update UI
    }

    function getTagColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        const hue = Math.abs(hash % 360);
        return `hsl(${hue}, 85%, 80%)`;
    }

    function checkStreak() {
        const today = new Date().toDateString();
        if (player.lastLogin !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (player.lastLogin === yesterday.toDateString()) {
                player.streak++;
                showToast(`Daily Streak: ${player.streak} Days! üî•`);
            } else {
                if(player.streak > 0) showToast("Streak Lost! Reset to 1.");
                player.streak = 1;
            }
            player.lastLogin = today;
            saveData();
        }
    }

    function checkAchievements() {
        if (!player.achievements) player.achievements = [];
        ACHIEVEMENT_DATA.forEach(ach => {
            if (!player.achievements.includes(ach.id) && ach.cond(player)) {
                player.achievements.push(ach.id);
                showToast(`üèÜ UNLOCKED: ${ach.title}`);
                fireConfetti('star');
            }
        });
        // REMOVED recursive saveData() call here
    }

    function openAchievements() {
        const container = document.getElementById('achievement-list');
        container.innerHTML = '';
        ACHIEVEMENT_DATA.forEach(ach => {
            const unlocked = player.achievements.includes(ach.id);
            const div = document.createElement('div');
            div.style.cssText = `padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px; background: ${unlocked ? 'var(--card-bg)' : 'rgba(0,0,0,0.05)'}; border: 2px solid ${unlocked ? 'var(--accent)' : 'transparent'}; opacity: ${unlocked ? '1' : '0.5'};`;
            div.innerHTML = `<div style="font-size: 2rem;">${unlocked ? ach.icon : 'üîí'}</div><div><div style="font-weight:bold; color:var(--text-color);">${ach.title}</div><div style="font-size:0.8rem; color:var(--text-sub);">${ach.desc}</div></div>`;
            container.appendChild(div);
        });
        document.getElementById('achievement-modal').style.display = 'flex';
    }

    function openHelp() { document.getElementById('help-modal').style.display = 'flex'; }

    function openAddTask() {
        document.getElementById('modal-title').innerText = "New Mission";
        document.getElementById('inp-title').value = "";
        document.getElementById('inp-tags').value = "";
        document.getElementById('inp-priority').value = "Med";
        document.getElementById('inp-recurrence').value = "none";
        document.getElementById('inp-deadline').value = "";
        document.getElementById('objectives-container').innerHTML = ""; 
        addObjectiveInput();
        editingId = null;
        document.getElementById('task-modal').style.display = 'flex';
        document.getElementById('inp-title').focus();
    }

    function addToCalendar(taskId) {
        const t = tasks.find(x => x.id === taskId);
        if(!t.deadline) return;
        const title = `QuestBoard: ${t.title}`;
        const desc = t.subtasks.map(s => `[${s.done ? 'x' : ' '}] ${s.text}`).join('\\n');
        const startDate = t.deadline.replace(/-/g, '') + 'T090000';
        const endDate = t.deadline.replace(/-/g, '') + 'T100000';
        const icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nSUMMARY:${title}\nDESCRIPTION:${desc}\nDTSTART:${startDate}\nDTEND:${endDate}\nEND:VEVENT\nEND:VCALENDAR`;
        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.setAttribute('download', `${t.title}.ics`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function addXP(amount) {
        let streakBonus = Math.min(player.streak, 10) * 0.01;
        let mult = 1 + (player.prestige * 0.1) + streakBonus;
        let finalAmount = Math.floor(amount * mult);
        if(amount > 0 && Math.random() < 0.05) { finalAmount += 50; showToast("CRITICAL SUCCESS! +50 XP"); }
        
        player.xp += finalAmount;
        if(amount > 0) player.totalXpEarned += finalAmount;
        if(player.xp < 0) player.xp = 0;

        const bar = document.getElementById('xp-bar');
        bar.classList.add('glowing');
        setTimeout(() => bar.classList.remove('glowing'), 1500);
        spawnFloatingXP(finalAmount, finalAmount > 0 ? 'gain' : 'loss');

        let req = getXpRequired(player.level);
        if (player.xp >= req) {
            player.xp -= req; player.level++;
            showToast(`LEVEL UP! WELCOME TO LEVEL ${player.level}`);
            fireConfetti('level');
        }
        saveData();
    }
    
    function spawnFloatingXP(amount, type) {
        const div = document.createElement('div');
        div.className = `xp-floater ${type === 'gain' ? 'xp-gain' : 'xp-loss'}`;
        div.innerText = type === 'gain' ? `+${amount} XP` : `${amount} XP`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1500);
    }

    function getXpRequired(lvl) { return Math.floor(500 + (lvl * 100) + (Math.pow(lvl, 1.5) * 20)); }

    function unlockAllThemes() {
        const opts = document.getElementById('theme-selector').options;
        for(let i=0; i<opts.length; i++) { opts[i].disabled = false; opts[i].text = opts[i].text.replace('üîí ', ''); }
        showToast("DEV MODE: All Themes Unlocked");
    }

    function checkUnlocks() {
        const unlocks = [ { lvl: 2, id: 'utility-stats', type: 'el' }, { lvl: 5, val: 'wolf', type: 'theme' }, { lvl: 10, val: 'neon', type: 'theme' }, { lvl: 12, val: 'aperture', type: 'theme' }, { lvl: 15, val: 'eldritch', type: 'theme' }, { lvl: 18, val: 'vaporwave', type: 'theme' }, { lvl: 20, val: 'blueprint', type: 'theme' }, { lvl: 25, val: 'terminal', type: 'theme' }, { lvl: 30, val: 'gold', type: 'theme' }, { lvl: 50, id: 'prestige-section', type: 'el' } ];
        if(player.prestige >= 1) enableThemeOption('nebula');
        if(player.prestige >= 2) enableThemeOption('midas');
        if(player.prestige >= 3) enableThemeOption('glitch');
        if(player.prestige >= 1) document.getElementById('story-library-btn').style.display = 'block';
        unlocks.forEach(u => {
            if (player.level >= u.lvl) {
                if(u.type === 'el') document.getElementById(u.id).style.display = 'block';
                if(u.type === 'theme') enableThemeOption(u.val);
            }
        });
    }

    function enableThemeOption(val) {
        let opt = document.querySelector(`option[value="${val}"]`);
        if(opt) { opt.disabled = false; opt.text = opt.text.replace('üîí ', ''); }
    }

    function saveTask() {
        const title = document.getElementById('inp-title').value;
        if(!title) return;
        const objInputs = document.querySelectorAll('.obj-input');
        const subtasks = Array.from(objInputs).map(inp => ({ text: inp.value.trim(), done: false })).filter(o => o.text !== "");
        
        if(editingId) {
            const oldTask = tasks.find(t => t.id === editingId);
            subtasks.forEach(newSub => {
                const match = oldTask.subtasks.find(oldSub => oldSub.text === newSub.text);
                if(match) newSub.done = match.done;
            });
        }

        const tagStr = document.getElementById('inp-tags').value;
        const tags = tagStr.split(',').map(t => t.trim()).filter(t => t !== "");

        const newTask = {
            id: editingId || Date.now(),
            title: title,
            tags: tags,
            priority: document.getElementById('inp-priority').value,
            recurrence: document.getElementById('inp-recurrence').value,
            deadline: document.getElementById('inp-deadline').value,
            subtasks: subtasks,
            status: editingId ? tasks.find(t => t.id === editingId).status : 'staging',
            winXP: editingId ? tasks.find(t => t.id === editingId).winXP : 0,
            completedDate: editingId ? tasks.find(t => t.id === editingId).completedDate : null
        };

        if(editingId) { tasks[tasks.findIndex(t => t.id === editingId)] = newTask; editingId = null; }
        else { tasks.push(newTask); }
        closeModal('task-modal');
        saveData();
        renderBoard();
        if(!editingId) document.getElementById('col-staging').scrollIntoView({ behavior: 'smooth', inline: 'center' });
    }

    function moveTask(id, dest) {
        const t = tasks.find(x => x.id === id);
        if (t.status === 'victory' && dest !== 'victory') {
            customConfirm("CONFIRM PROTOCOL: Retreat? XP penalty will be applied.", () => {
                addXP(- (t.winXP + 50));
                t.winXP = 0; t.completedDate = null; player.completedTasks--;
                t.status = dest;
                saveData(); renderBoard();
                const destCol = document.getElementById(`col-${dest}`);
                setTimeout(() => { destCol.scrollIntoView({ behavior: 'smooth', inline: 'center' }); }, 100);
            });
            return;
        }

        if (dest === 'victory' && t.status !== 'victory') {
            let base = t.priority === 'High' ? 200 : t.priority === 'Med' ? 150 : 100;
            if(t.priority === 'Boss') base = 500; 

            if(t.deadline) {
                const now = new Date(); const due = new Date(t.deadline); now.setHours(0,0,0,0); due.setHours(0,0,0,0);
                const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24)); 
                if (diffDays >= 1) base = Math.floor(base * 1.2); 
                else if (diffDays < 0) base = Math.floor(base * 0.8); 
            }
            addXP(base);
            t.winXP = base; t.completedDate = new Date().toISOString();
            player.completedTasks++;
            let fx = player.level >= 30 ? 'gem' : player.level >= 20 ? 'coin' : player.level >= 10 ? 'star' : 'paper';
            fireConfetti(fx);

            if(t.recurrence && t.recurrence !== 'none') {
                const nextTask = JSON.parse(JSON.stringify(t)); 
                nextTask.id = Date.now(); nextTask.status = 'staging'; nextTask.winXP = 0; nextTask.completedDate = null;
                nextTask.subtasks.forEach(s => s.done = false); 
                if(t.deadline) {
                    const d = new Date(t.deadline);
                    if(t.recurrence === 'daily') d.setDate(d.getDate() + 1);
                    if(t.recurrence === 'weekly') d.setDate(d.getDate() + 7);
                    if(t.recurrence === 'monthly') d.setMonth(d.getMonth() + 1);
                    nextTask.deadline = d.toISOString().split('T')[0];
                }
                tasks.push(nextTask);
                showToast("Recurring Mission Rescheduled üîÑ");
            }
        }

        t.status = dest;
        saveData();
        renderBoard();
        const destCol = document.getElementById(`col-${dest}`);
        setTimeout(() => { destCol.scrollIntoView({ behavior: 'smooth', inline: 'center' }); }, 100);
    }

    function renderBoard() {
        const filter = document.getElementById('search-bar').value.toLowerCase();
        const emptyMsgMap = { 'staging': "Quest Log Empty. Awaiting new orders.", 'active': "The realm is at peace.", 'victory': "No legends recorded yet." };

        const victoryTasks = tasks.filter(t => t.status === 'victory');
        if (victoryTasks.length > 20) {
            victoryTasks.sort((a, b) => new Date(a.completedDate) - new Date(b.completedDate));
            const toRemove = victoryTasks.slice(0, victoryTasks.length - 20);
            tasks = tasks.filter(t => !toRemove.includes(t));
            saveData();
        }

        ['staging', 'active', 'victory'].forEach(col => {
            const container = document.getElementById(`list-${col}`);
            container.innerHTML = '';
            const colTasks = tasks.filter(t => t.status === col);
            if(colTasks.length === 0 && !filter) {
                container.innerHTML = `<div class="empty-state">${emptyMsgMap[col]}</div>`;
            }
            colTasks.forEach(t => {
                let match = t.title.toLowerCase().includes(filter);
                t.subtasks.forEach(s => { if(s.text.toLowerCase().includes(filter)) match = true; });
                if(t.tags) t.tags.forEach(tag => { if(tag.toLowerCase().includes(filter)) match = true; });
                if(!match) return;
                container.appendChild(createCardHTML(t));
            });
        });
    }

    function createCardHTML(t) {
        const div = document.createElement('div');
        div.className = `card priority-${t.priority}`;
        if(player.settings.theme === 'blueprint') div.style.borderStyle = "dashed";
        let dateStr = ""; let calBtn = "";
        
        if(t.deadline) {
            const parts = t.deadline.split('-');
            if(parts.length === 3) dateStr = new Date(parts[0], parts[1]-1, parts[2]).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            calBtn = `<button class="icon-btn" style="font-size:0.9rem; padding:2px 6px; border:1px solid var(--text-sub); border-radius:6px; margin-left:8px;" onclick="addToCalendar(${t.id})">üìÖ</button>`;
        }
        
        let recurIcon = (t.recurrence && t.recurrence !== 'none') ? `<span style="margin-left:5px; font-size:0.9rem">üîÑ</span>` : "";
        
        let tagsHtml = "";
        if(t.tags && t.tags.length > 0) {
            tagsHtml = '<div class="tag-container">';
            t.tags.forEach(tag => { tagsHtml += `<span class="tag-pill" style="background:${getTagColor(tag)}">${tag}</span>`; });
            tagsHtml += '</div>';
        }

        let subHtml = '<ul class="objective-list">';
        t.subtasks.forEach((s, i) => {
            subHtml += `<li class="objective-box"><input type="checkbox" class="objective-check" ${s.done ? 'checked' : ''} onchange="toggleSubtask(${t.id}, ${i})"><span style="${s.done ? 'text-decoration:line-through; opacity:0.6' : ''}">${s.text}</span></li>`;
        });
        subHtml += '</ul>';

        let btns = '';
        if(t.status === 'staging') btns = `<button class="action-btn" onclick="moveTask(${t.id}, 'active')">Engage</button>`;
        if(t.status === 'active') btns = `<button class="action-btn secondary" onclick="moveTask(${t.id}, 'staging')">Standby</button><button class="action-btn" onclick="moveTask(${t.id}, 'victory')">Complete</button>`;
        if(t.status === 'victory') btns = `<button class="action-btn danger" onclick="moveTask(${t.id}, 'active')">Retreat</button>`;
        
        let leftActions = `<div class="action-group"><button class="action-btn btn-ghost btn-abort" onclick="deleteTask(${t.id})">ABORT</button><button class="action-btn btn-ghost" onclick="openEditTask(${t.id})">EDIT</button></div>`;
        if(t.status === 'victory') leftActions = `<div class="action-group"><button class="action-btn btn-ghost" onclick="openEditTask(${t.id})">EDIT</button></div>`;

        div.innerHTML = `<h3>${t.title} ${recurIcon}</h3>${tagsHtml}<div class="card-meta"><div><span class="prio-badge ${t.priority}">${t.priority}</span></div><div style="display:flex; align-items:center;"><span>${dateStr}</span>${calBtn}</div></div>${subHtml}<div class="card-actions">${leftActions}<div class="action-group">${btns}</div></div>`;
        return div;
    }

    function toggleSubtask(taskId, subIdx) {
        const t = tasks.find(x => x.id === taskId);
        const wasDone = t.subtasks[subIdx].done;
        t.subtasks[subIdx].done = !wasDone;
        if(!wasDone) addXP(10); else addXP(-10);
        saveData(); renderBoard();
    }
    function deleteTask(id) { customConfirm("CONFIRM PROTOCOL: Abort Mission Permanently?", () => { tasks = tasks.filter(t => t.id !== id); saveData(); renderBoard(); }); }
    function openEditTask(id) {
        const t = tasks.find(x => x.id === id); editingId = id;
        document.getElementById('modal-title').innerText = "Edit Mission Data";
        document.getElementById('inp-title').value = t.title;
        document.getElementById('inp-tags').value = t.tags ? t.tags.join(', ') : "";
        document.getElementById('inp-priority').value = t.priority;
        document.getElementById('inp-recurrence').value = t.recurrence || 'none';
        document.getElementById('inp-deadline').value = t.deadline;
        const container = document.getElementById('objectives-container'); container.innerHTML = "";
        t.subtasks.forEach(s => addObjectiveInput(s.text));
        document.getElementById('task-modal').style.display = 'flex';
    }
    function addObjectiveInput(value = "") {
        const container = document.getElementById('objectives-container');
        const div = document.createElement('div'); div.className = 'dyn-input-row';
        div.innerHTML = `<input type="text" class="obj-input" placeholder="Objective data..." value="${value}"><div class="dyn-del-btn" onclick="this.parentElement.remove()">‚úï</div>`;
        container.appendChild(div);
        const inp = div.querySelector('input'); if(value === "") inp.focus();
        inp.addEventListener('keydown', function(e) { if(e.key === 'Enter') { e.preventDefault(); addObjectiveInput(); }});
    }
    
    // UPDATED: No recursive loop
    function updateStats() {
        document.getElementById('level-display').innerText = `LVL ${player.level} ${player.prestige > 0 ? '‚ú™'.repeat(player.prestige) : ''}`;
        document.getElementById('streak-display').innerText = `üî• ${player.streak || 0}`;
        const req = getXpRequired(player.level);
        document.getElementById('xp-bar').style.width = `${(player.xp / req) * 100}%`;
        document.getElementById('xp-text').innerText = `${player.xp} / ${req} XP`;
        document.getElementById('stat-total-xp').innerText = player.totalXpEarned;
        document.getElementById('stat-tasks').innerText = player.completedTasks;
        document.getElementById('stat-prestige').innerText = player.prestige;
        document.getElementById('stat-streak').innerText = player.streak || 0;
    }
    
    function toggleThemeMode() { player.settings.darkMode = !player.settings.darkMode; applySettings(); saveData(); }
    function changeTheme(val) { player.settings.theme = val; applySettings(); saveData(); }
    function applySettings() {
        const body = document.body;
        if(player.settings.darkMode) body.classList.add('dark-mode'); else body.classList.remove('dark-mode');
        body.className = body.className.replace(/theme-\w+/g, '');
        if(player.settings.theme !== 'default') body.classList.add(`theme-${player.settings.theme}`);
        document.getElementById('theme-selector').value = player.settings.theme;
        if(player.settings.darkMode) body.classList.add('dark-mode');
    }
    function openMenu() { document.getElementById('menu-modal').style.display = 'flex'; updateStats(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showToast(msg) {
        const container = document.getElementById('toast-container');
        const t = document.createElement('div'); t.className = 'toast-msg'; t.innerText = msg;
        container.appendChild(t); setTimeout(() => t.remove(), 4000);
    }
    function customConfirm(msg, callback) { document.getElementById('confirm-text').innerText = msg; pendingCallback = callback; document.getElementById('confirm-modal').style.display = 'flex'; }
    function closeConfirm(result) { document.getElementById('confirm-modal').style.display = 'none'; if(result && pendingCallback) pendingCallback(); pendingCallback = null; }
    function triggerImport() { document.getElementById('import-file').click(); }
    function importData(input) {
        const file = input.files[0]; const reader = new FileReader();
        reader.onload = function(e) { try { const json = JSON.parse(e.target.result); if(json.player && json.tasks) { player = json.player; tasks = json.tasks; saveData(); location.reload(); } } catch(err) { alert("Data Corrupted."); } };
        reader.readAsText(file);
    }
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({player, tasks}));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "questboard_backup.json");
        document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove();
    }
    function prestigeReset() {
        customConfirm("‚ö†Ô∏è RESET LEVEL & XP? +10% MULTIPLIER", () => {
            player.level = 1; player.xp = 0; player.prestige++; 
            saveData(); location.reload();
        });
    }
    // FX
    const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d'); let particles = [];
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();
    function fireConfetti(type) {
        const count = type === 'level' ? 200 : 50;
        for(let i=0; i<count; i++) {
            particles.push({ x: Math.random() * canvas.width, y: type === 'level' ? canvas.height + 10 : -10, vx: (Math.random() - 0.5) * 10, vy: type === 'level' ? (Math.random() * -15) - 5 : (Math.random() * 5) + 2, size: Math.random() * 8 + 4, color: `hsl(${Math.random()*360}, 100%, 70%)`, type: type, life: 100 });
        } animateConfetti();
    }
    function animateConfetti() {
        if(particles.length === 0) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life--;
            ctx.fillStyle = p.color; ctx.beginPath();
            if(p.type === 'star') drawStar(ctx, p.x, p.y, 5, p.size, p.size/2); else if (p.type === 'coin') ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); else ctx.fillRect(p.x, p.y, p.size, p.size);
            ctx.fill();
        });
        particles = particles.filter(p => p.life > 0 && p.y < canvas.height + 20);
        if(particles.length > 0) requestAnimationFrame(animateConfetti); else ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    function drawStar(cx, cy, cx_x, cy_y, spikes, outerRadius, innerRadius) {
        let rot = Math.PI / 2 * 3; let x = cx; let y = cy; let step = Math.PI / spikes; ctx.beginPath(); ctx.moveTo(cx, cy - outerRadius);
        for (let i = 0; i < spikes; i++) { x = cx + Math.cos(rot) * outerRadius; y = cy + Math.sin(rot) * outerRadius; ctx.lineTo(x, y); rot += step; x = cx + Math.cos(rot) * innerRadius; y = cy + Math.sin(rot) * innerRadius; ctx.lineTo(x, y); rot += step; }
        ctx.lineTo(cx, cy - outerRadius); ctx.closePath();
    }
    const stories = { 1: `<h3>Chapter I: The Frost and the Flame</h3><p>The wind howled outside...</p>`, 2: `<h3>Chapter II: The Golden Cage</h3><p>You had ascended...</p>`, 3: `<h3>Chapter III: The Glitch in the Weave</h3><p>The sky flickered...</p>`, 4: `<h3>Finale: The Architect</h3><p>There is no snow anymore...</p>` };
    function openStoryModal() {
        let content = ""; if(player.prestige >= 1) content += stories[1]; if(player.prestige >= 2) content += stories[2]; if(player.prestige >= 3) content += stories[3]; if(player.prestige >= 4) content += stories[4];
        document.getElementById('story-content').innerHTML = content || "<p>You must Prestige to unlock the Archives.</p>";
        document.getElementById('story-modal').style.display = 'flex';
    }
</script>
</body>
</html>
